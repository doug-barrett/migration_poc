fileVersion: 1
id: 9daa8592-c990-495e-bb91-b5cec122ada6
name: S_CAREPLAN_CONTRACT_VOLUMES_V_COPY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0e76f570-301d-4ada-a144-5f4d055aaa46
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 33bd56ea-ae41-4931-9d1e-e450537221fd
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa0b5efa-5746-42e4-91b5-92b7e883ba98
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: links back to encounter in fact careplan community
        name: SOURCE_ENCOUNTER_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 139026fd-2b27-43b7-a55d-76d5dae362e0
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: based on the careplan identifier altered to reflect the contract grain
        name: ACTIVE_CAREPLAN_MONTH_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f10d2d19-0aea-4617-92d5-ab2f01c7185c
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b76870a-74aa-48be-8db9-ad6412a0dd9b
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_DOMICILE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 95b21462-11c7-4a56-9369-f7f7ebd3ca33
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: phase_start_date
        name: PHASE_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a7809a68-ffad-411b-b5d7-73c828314118
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: phase_end_date
        name: PHASE_END_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 45095c64-f89b-4f4b-8520-5bda847e16c3
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_CONTRACT_MONTH_DATE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dfef3ac5-f509-41e3-b8d2-5a0caa18493a
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CONTRACT_MONTH_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: db2dd764-539c-429c-898c-8d8593a7b6fd
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: purchase_unit_volume
        name: PURCHASE_UNIT_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4bb7925e-ce11-475b-bdb7-c784b439bab9
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_CAREPLAN_COMMUNITY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4c241e08-275a-4227-8ace-441f78e7c38e
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: YEAR_OFFSET
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4b5fca78-0c4c-4b55-809d-666897de3f3e
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: presenting_issue_category_desc
        name: PRESENTING_ISSUE_CATEGORY_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 780a79b6-9443-499a-b370-9c91ba849a64
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e8ce6da3-759f-41e8-9654-e69276c60a41
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: careplan_month
        name: CAREPLAN_MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eaf92845-978a-4e79-a7f3-e3e00300f531
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: INT
        defaultValue: ""
        description: NNPAC_volume, is one volume for the first month in the year the careplan is open
        name: NNPAC_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e75af07d-b416-488d-b140-0d87ec53688e
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: SEEN_BY_CLINICIAN_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 82e0ebd9-3677-40c1-b528-4f2b6d6b9f04
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5a4fbe50-a0e7-4787-a641-5d36b478f21e
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PURCHASER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b6030c0e-2979-4e22-8827-828b8fd609ef
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a7959e31-8308-4074-b14c-3b496f0846fb
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 99640e93-62fe-456b-900c-97045cbd23b8
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 304d8e1f-3e0e-40c5-8410-a44f58ee79c0
          stepCounter: 9daa8592-c990-495e-bb91-b5cec122ada6
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15d7f47c-feb3-4f95-8990-e83e38e84930
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT task_request_id ,
                   contact_encounter_ID source_encounter_id ,
                   'K' + RIGHT('0000000000000'+CAST(task_request_id AS VARCHAR(13))+ + RIGHT(cast(dim_date.cal_month AS varchar(6)),4),13) active_careplan_month_id ,
                   patient_NHI ,
                   dim_domicile_key ,
                   phase_start_date ,
                   phase_end_date ,
                   dim_date_key dim_contract_month_date_key ,
                   calendar_date contract_month_date ,
                   1 contract_volume ,
                   dim_careplan_community.dim_careplan_community_key ,
                   dim_date.year_offset ,
                   dim_careplan_community.presenting_issue_category_desc ,
                   puc.purchase_Unit_code ,
                   dim_date.cal_month careplan_month -- , case when datename(month,calendar_date) = 'July' then 1
            --  when datediff(month,calendar_date,phase_start_date)=0 then 1
            --  else 0 end  NNPAC_Volume
            ,
                   1 NNPAC_Volume --   ,ro.role_code
            ,
                   s_careplan_community_20.seen_by_clinician_reference_no ,
                   s_careplan_community_20.purchaser ,
                   s_careplan_community_20.referral_encounter_id ,
                   s_careplan_community_20.IDF_class
              FROM s_careplan_community_20
             INNER JOIN dim.dim_careplan_community dim_careplan_community
                ON dim_careplan_community.dim_careplan_community_key = s_careplan_community_20.dim_careplan_community_key
             INNER JOIN dim.dim_date dim_date
                ON dim_date.calendar_date = cast(phase_start_date AS date)
             INNER JOIN dim.dim_role_community ro
                ON ro.dim_role_community_key = s_careplan_community_20.dim_role_community_key
             INNER JOIN dim.dim_purchase_unit puc
                ON calendar_date BETWEEN puc.validity_start_date AND IFNULL(puc.validity_end_date,getdate())
               AND puc.purchase_unit_code = CASE WHEN dim_careplan_community.presenting_issue_category_code = 'CAPD'  THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'CAPDT' THEN 'M60005' --SR--

                        WHEN dim_careplan_community.presenting_issue_category_code = 'APDT'  THEN 'M60005' --

                        WHEN dim_careplan_community.presenting_issue_category_code = 'APD'   THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'Hom'   THEN 'M60006'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'HHT'   THEN 'M60007'
                         END
             WHERE dim_date.year_offset <6
               AND phase_start_date <> IFNULL(phase_end_date,phase_start_date +1)
               AND dim_careplan_community.presenting_issue_category_code IN('APD','APDT', 'CAPD', 'Hom','CAPDT','HHT')
               AND ro.role_code IN ('HDC','PDC')
            UNION ALL SELECT task_request_id ,
                   contact_encounter_ID source_encounter_id ,
                   'K' + RIGHT('0000000000000'+CAST(task_request_id AS VARCHAR(13))+ + RIGHT(cast(dim_date.cal_month AS varchar(6)),4),13) active_careplan_month_id ,
                   patient_NHI ,
                   dim_domicile_key ,
                   phase_start_date ,
                   phase_end_date ,
                   dim_date_key dim_contract_month_date_key ,
                   calendar_date contract_month_date ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 0
                        ELSE 1
                         END contract_volume ,
                   dim_careplan_community.dim_careplan_community_key ,
                   dim_date.year_offset ,
                   dim_careplan_community.presenting_issue_category_desc ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 'WDHB075'
                        ELSE puc.purchase_unit_code
                         END purchase_unit_code ,
                   dim_date.cal_month careplan_month -- , case when datename(month,calendar_date) = 'July' then 1
            --  when datediff(month,calendar_date,phase_start_date)=0 then 1
            --  else 0 end  NNPAC_Volume
            ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 0
                        ELSE 1
                         END NNPAC_Volume ,
                   s_careplan_community_20.seen_by_clinician_reference_no ,
                   s_careplan_community_20.purchaser ,
                   s_careplan_community_20.referral_encounter_id ,
                   s_careplan_community_20.IDF_class
              FROM s_careplan_community_20
             INNER JOIN dim.dim_careplan_community dim_careplan_community
                ON dim_careplan_community.dim_careplan_community_key = s_careplan_community_20.dim_careplan_community_key
             INNER JOIN dim.dim_date dim_date
                ON dim_date.calendar_date BETWEEN phase_start_date AND IFNULL(phase_end_date,getdate())
               AND dim_date.cal_day_in_month = 1
             INNER JOIN dim.dim_role_community ro
                ON ro.dim_role_community_key = s_careplan_community_20.dim_role_community_key
             INNER JOIN dim.dim_purchase_unit puc
                ON calendar_date BETWEEN puc.validity_start_date AND IFNULL(puc.validity_end_date,getdate())
               AND puc.purchase_unit_code = CASE WHEN dim_careplan_community.presenting_issue_category_code = 'CAPD'  THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'CAPDT' THEN 'M60005' --SR--

                        WHEN dim_careplan_community.presenting_issue_category_code = 'APDT'  THEN 'M60005' --

                        WHEN dim_careplan_community.presenting_issue_category_code = 'APD'   THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'Hom'   THEN 'M60006'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'HHT'   THEN 'M60007'
                         END
             WHERE dim_date.year_offset <6
               AND phase_start_date <> IFNULL(phase_end_date,phase_start_date +1)
               AND dim_careplan_community.presenting_issue_category_code IN('APD','APDT', 'CAPD', 'Hom','CAPDT','HHT')
               AND ro.role_code IN ('HDC','PDC')
        dependencies:
          - locationName: TGT
            nodeName: S_CAREPLAN_COMMUNITY_20
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_CAREPLAN_COMMUNITY_20') }}
        name: S_CAREPLAN_CONTRACT_VOLUMES_V_COPY
        noLinkRefs: []
  name: S_CAREPLAN_CONTRACT_VOLUMES_V_COPY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
