fileVersion: 1
id: 77268bca-79a1-447e-9f89-242f0cb48b67
name: OPC_CONTACT_HISTORY_MISSINGDATES
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: OMNIA_CONNECT_OPC
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9a6901cc-aade-48b6-aaae-614d1b28bb64
          stepCounter: 77268bca-79a1-447e-9f89-242f0cb48b67
        config: {}
        dataType: INT
        defaultValue: ""
        description: Level1 ForceId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LEVEL1FORCEID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d38a68c-2b4e-416e-8c3b-bc9ceb1c8f53
          stepCounter: 77268bca-79a1-447e-9f89-242f0cb48b67
        config: {}
        dataType: DATE
        defaultValue: ""
        description: Created Month
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CREATED_MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 38cfa4dd-20ef-4883-ba8a-df9d5e1f7508
          stepCounter: 77268bca-79a1-447e-9f89-242f0cb48b67
        config: {}
        dataType: INT
        defaultValue: ""
        description: Contact Count
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CONTACT_COUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ede37cbd-b991-4a4b-a799-5c304d5860a2
          stepCounter: 77268bca-79a1-447e-9f89-242f0cb48b67
        config: {}
        dataType: INT
        defaultValue: ""
        description: Running Contact Count
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: RUNNING_CONTACT_COUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          OPC_CONTACT_HISTORY_MISSINGDATES: 77268bca-79a1-447e-9f89-242f0cb48b67
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('OMNIA_CONNECT_OPC','OPC_CONTACT_HISTORY_MISSINGDATES') }} (Level1ForceId, Created_Month, Contact_Count, Running_Contact_Count) AS WITH cteDistinctLevel1s AS (
                    SELECT DISTINCT Level1ForceId
                      FROM OPC_Contact_History
                   ),
                   cteLTMDates AS (
                    SELECT CAST(CalendarDate AS DATE) AS Created_Month
                      FROM OMNIAPartnersDW_Dev.Dim.DimDate
                     WHERE CalendarDate BETWEEN LAST_DAY(DATEADD(MONTH,-12,CURRENT_DATE())) AND LAST_DAY(DATEADD(MONTH,-1,CURRENT_DATE()))
                       AND CalendarDate = LAST_DAY(CalendarDate)
                   ),
                   cteLevel1Dates AS (
                    SELECT Level1ForceId,
                           Created_Month
                      FROM cteDistinctLevel1s,
                           cteLTMDates
                   ),--SELECT * FROM cteLevel1Dates where level1forceid = 29951 order by created_month
             cteFullSet AS (
                    SELECT COALESCE(cteLevel1Dates.Level1ForceId,cteLevel1Dates.Level1ForceId) AS Level1ForceId,
                           COALESCE(OPC_Contact_History.Created_Month, cteLevel1Dates.Created_Month) Created_Month,
                           ZEROIFNULL(Contact_Count) AS Contact_Count,
                           ZEROIFNULL(SUM(Contact_Count) OVER(PARTITION BY COALESCE(OPC_Contact_History.Level1ForceId, cteLevel1Dates.Level1ForceId) ORDER BY COALESCE(OPC_Contact_History.Created_Month, cteLevel1Dates.Created_Month))) AS Running_Contact_Count
                      FROM OPC_Contact_History
                      FULL OUTER JOIN cteLevel1Dates
                        ON OPC_Contact_History.Level1ForceId = cteLevel1Dates.Level1ForceId
                       AND OPC_Contact_History.Created_Month = cteLevel1Dates.Created_Month
                   ) SELECT *
              FROM cteFullSet
             WHERE Contact_Count = 0
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: OPC_CONTACT_HISTORY_MISSINGDATES
        noLinkRefs: []
  name: OPC_CONTACT_HISTORY_MISSINGDATES
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
