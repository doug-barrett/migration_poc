fileVersion: 1
id: 23fefb9c-7e6b-48f7-b298-31adef161908
name: S_IN_PATIENT_DIAGNOSIS_PROCEDURE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31d1e2db-7846-4c5d-8ccb-f90b06869096
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0d23504a-0045-4609-8c74-c5b3a5dec0dc
                stepCounter: a7d7c8ec-88ee-49a8-b500-e3f4bce83e59
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 88c3487d-a318-42b1-9116-74f28c5d575b
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: EVENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a1c7a3a3-1474-4270-ae9b-54e5b66ee6e1
                stepCounter: a7d7c8ec-88ee-49a8-b500-e3f4bce83e59
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e90817f9-ad86-4d1b-9a84-4a3db255d21e
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ADMISSION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1125cf7f-7027-45ac-acc8-b3a92505c4da
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 43d54999-cfd7-4375-aec9-b95950f35c96
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: DGPRO_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f49ba7ec-9b7c-499d-ae59-ed3ecd3a63a5
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9d6ada32-423b-48f5-88c8-7a21f590b45c
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: SEEN_BY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7fb57b5-409b-4f23-8347-fe2e72525181
                stepCounter: cb8cd7bc-c5c1-4ee3-a1f5-2c0bda3624d5
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51833998-bc3f-4104-84c9-94e8a21cb6fe
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: PROF_CARER_EPISODE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9b69ca26-6ec2-45d1-b0dc-8b4d97fd2184
                stepCounter: cb8cd7bc-c5c1-4ee3-a1f5-2c0bda3624d5
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b8fa0510-bbcc-4731-b041-882c4862e8b0
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 474d7c94-2844-4fd3-a545-689f9362af17
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a19dcf6e-b77e-4567-8081-0bc09b6faebc
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: DISCHARGE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ee3a67e8-1a53-44ab-aa64-cafc588de09c
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 03da51c3-f683-41f0-8b34-851ab5e5379d
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CODING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1d3ec50b-0cab-4f40-8ea9-6b0cdb3e4329
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: IFNULL(ds_pims_diagnosis_procedures.dgpro_dttm,ds_pims_diagnosis_procedures.end_dttm)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0860ea9-cdfe-478a-840d-7fd19ad15152
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f87da6a-ba39-4cad-9b23-1b0a86aeb84b
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 985f0ba0-97cf-4152-a49b-7e86cb71409e
                stepCounter: d52dd438-7899-4242-9e38-539d2a1447df
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: efcb6014-037d-4705-97cc-03286b0c9363
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9962a01b-5f3d-4c1a-b371-997edef38d0f
                stepCounter: d52dd438-7899-4242-9e38-539d2a1447df
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 785b7ba5-9ebf-42b4-9c00-c64d3966f501
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: MEDICAL_PROBLEM_LEVEL_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7dcad9a6-52b1-402a-a292-1118300823b9
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1beaaa92-d82e-4391-8e74-2acfadbf7277
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: MEDICAL_PROBLEM_LEVEL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c492e7c4-fba7-43b1-8287-d23da54e4d89
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(5)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 271efe56-3d39-4d18-b5a7-7e1dcc80d250
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05776f0b-08f6-4b94-8be4-a742f541bced
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_SUBTYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5a6669fa-d0b2-442e-8c58-2e6c620b4893
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: CLINICAL_CLASSIFICATION_XREF_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ecc036db-91d2-4737-b93c-f3e449aa298e
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01c567a2-a621-4a70-843c-b0430d041ef3
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CLINICAL_CLASSIFICATION_XREF_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a5d0176-4271-4fb2-9c24-a184e94a67d9
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ae1a398a-9c7b-4fad-b7e2-8e105705ec6f
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15704b9a-c12d-453d-8f0c-b991be4c278f
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b4c372ad-7e3b-459a-89ad-ec53d1b8cb49
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c31e3347-eec2-48c5-aac7-4c77ca629879
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.prvsp_refno=ds_pims_provider_spells.prvsp_refno
        name: PATIENT_DIAGNOSIS_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: |-
              CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'DIAGN' THEN ROW_NUMBER() OVER (PARTITION BY ds_pims_provider_spells.patnt_refno, (CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'DIAGN' THEN 1 ELSE NULL END) ORDER BY ds_pims_diagnosis_procedures.sort_order,ds_pims_provider_spells.admit_dttm)
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8e4f1825-421b-401a-a4db-08fb103c05aa
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.prvsp_refno=ds_pims_provider_spells.prvsp_refno
        name: PATIENT_DIAGNOSIS_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: |-
              CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'DIAGN' THEN COUNT(1) OVER (PARTITION BY ds_pims_provider_spells.patnt_refno, (CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'DIAGN' THEN 1 ELSE NULL END))
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8611806c-66a8-4781-a1cb-01f3e902d387
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.prvsp_refno=ds_pims_provider_spells.prvsp_refno
        name: PATIENT_PROCEDURE_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: |-
              CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'PROCE' THEN ROW_NUMBER() OVER (PARTITION BY ds_pims_provider_spells.patnt_refno, (CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'PROCE' THEN 1 ELSE NULL END) ORDER BY ds_pims_diagnosis_procedures.sort_order,ds_pims_provider_spells.admit_dttm)
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47812b8d-f2cd-4a90-a29d-177213ec169f
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.prvsp_refno=ds_pims_provider_spells.prvsp_refno
        name: PATIENT_PROCEDURE_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: |-
              CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'PROCE' THEN COUNT(1) OVER (PARTITION BY ds_pims_provider_spells.patnt_refno, (CASE WHEN ds_pims_diagnosis_procedures.dptyp_code = 'PROCE' THEN 1 ELSE NULL END))
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cec0fd6c-a85b-447a-a401-2ffda0ab9136
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CREATE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 614e95dd-dc83-4fb6-80e2-eae0b812a7b5
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2e2ba4b9-62e7-424e-b74e-315adba4efe1
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: CREATE_USER_LOGIN_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9f2de421-29ae-4da9-a753-3f3076972d72
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 95f4611e-7188-4570-b7aa-944d7d72a8a2
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.create_user_login_code=dim_create_user_login.create_user_login_code
        name: DIM_CREATE_USER_LOGIN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2dfe5e14-cc2f-4748-8352-a6d1621289af
                stepCounter: 70bd6ed5-e21b-440f-9079-7fe305bc4f30
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: abb9adb7-36ee-4c24-beb6-160076f21ae3
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: MODIFY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6decebff-eb31-4277-aa08-3a795ec793df
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 190b84cc-0161-4f92-8884-47b42e47e98c
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: MODIFY_USER_LOGIN_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0018f473-59d0-4576-9d88-96374fcf8639
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ab30b93-7442-4e61-906d-ddce26e10cec
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.modify_user_login_code=dim_modify_user_login.modify_user_login_code
        name: DIM_MODIFY_USER_LOGIN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ceaa34a6-dd0b-40fb-bc61-9df93cc05e7b
                stepCounter: bef0768d-dddb-4d02-af8d-03160de42b62
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e029a274-0ca6-4828-bf2b-69e7d62014be
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PROF_CARER_EPISODE_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: '1'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e9b5ca8-a8ba-4c95-baf1-31f494d31551
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3622ad56-aec4-472b-b12f-72766235ae0f
          stepCounter: 23fefb9c-7e6b-48f7-b298-31adef161908
        config: {}
        dataType: 'INTEGER '
        defaultValue: ""
        description: s_in_patient_diagnosis_procedure.diagnosis_procedure_reference_no=dim_diagnosis_procedure.diagnosis_procedure_reference_no
        name: DIM_DIAGNOSIS_PROCEDURE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 24cebf11-1bcf-4240-a364-9b0f51cffc73
                stepCounter: 5c3dba16-610b-4df4-a82e-a17b4d31bb68
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_INPATIENT_CHANGES
        join:
          joinCondition: |-
            FROM s_inpatient_changes
              JOIN ds_pims_provider_spells
                ON s_inpatient_changes.prvsp_refno = ds_pims_provider_spells.prvsp_refno
              JOIN [ds_pims_prof_carer_episodes]
                ON ds_pims_provider_spells.prvsp_refno = ds_pims_prof_carer_episodes.prvsp_refno
               AND ds_pims_prof_carer_episodes.start_dttm = ds_pims_provider_spells.admit_dttm
               AND ds_pims_prof_carer_episodes.archv_flag = 'N'
              JOIN ds_pims_diagnosis_procedures
                ON ds_pims_prof_carer_episodes.prcae_refno = ds_pims_diagnosis_procedures. SORCE_REFNO
               AND ds_pims_diagnosis_procedures.sorce_code = 'PRCAE'
               AND ds_pims_diagnosis_procedures.archv_flag = 'N'
              LEFT OUTER JOIN ds_pims_reference_values ds_pims_reference_values1
                ON ds_pims_reference_values1.rfval_refno = ds_pims_diagnosis_procedures.mplev_refno
              LEFT OUTER JOIN ds_pims_reference_values ds_pims_reference_values2
                ON ds_pims_reference_values2.rfval_refno = ds_pims_diagnosis_procedures.cptyp_refno
              LEFT OUTER JOIN ds_pims_reference_values ds_pims_reference_values3
                ON ds_pims_reference_values3.main_code = ds_pims_diagnosis_procedures.CCSXT_Code
               AND ds_pims_reference_values3.rfvdm_code = 'CCSXT'
        name: S_IN_PATIENT_DIAGNOSIS_PROCEDURE
        noLinkRefs: []
  name: S_IN_PATIENT_DIAGNOSIS_PROCEDURE
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
