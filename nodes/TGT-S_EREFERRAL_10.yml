fileVersion: 1
id: 501255ce-6b18-4d47-bcf2-cee8263cd442
name: S_EREFERRAL_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Procedure [EREF].[p_BUILD_EREF_IPM_MATCH]"
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51f8a338-5b79-44b3-9649-e005b14a4856
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(15)
        defaultValue: ""
        description: ""
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST ('' AS varchar(15))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 32ae5640-700f-436a-ae27-0982d43d576c
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: MATCH_REFERENCE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS int)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b433be7b-23f0-43ad-a7aa-63f2be46c6a8
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: EREFUID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 83a3164c-c41e-43a7-8f56-e324fe268e1e
                stepCounter: 85b7be89-0863-4607-a138-a7cfd86a44e4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d99fc6eb-d00a-4b8b-9797-625cbe4bd022
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: MATCH_CERTAINTY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS int)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: add86752-8ace-4708-b614-e227eda22a3d
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: EXTERNAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8afac337-1381-4495-a25c-02c1efb378c4
                stepCounter: 85b7be89-0863-4607-a138-a7cfd86a44e4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 99dbbe56-cfb8-40b0-8f17-5bcd2033776b
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(200)
        defaultValue: ""
        description: ""
        name: CURRENT_SERVICE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d71a9da4-0cdb-480c-9cff-2367c26f8ce8
                stepCounter: 6e5f86ec-860d-4b48-baca-9c13f1859e07
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69ebdc0b-a3db-4b16-baa8-564ec046ccf8
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(200)
        defaultValue: ""
        description: ""
        name: MATCH_REASON
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST ('' AS varchar(200))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 60a2d52e-dd3b-4c4b-b622-89091aadbebb
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: PIMS_REFERRAL_REFERENCE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS int)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 12b5c161-7748-497f-8fd9-b88b57493d31
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(50)
        defaultValue: ""
        description: ""
        name: CURRENT_SERVICE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 166b366e-2d55-4003-abf6-5c123fcb693c
                stepCounter: 6e5f86ec-860d-4b48-baca-9c13f1859e07
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e50d406f-8fde-4274-bc46-3efaa501b997
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(50)
        defaultValue: ""
        description: ""
        name: EREFNHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 10db5da5-43e8-424e-93f3-6652cff8b210
                stepCounter: 85b7be89-0863-4607-a138-a7cfd86a44e4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e187ce70-6190-4154-9be4-aaaf12c80531
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PIMS_PATIENT_REFERENCE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS int)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eea3c001-4686-460a-a596-96c2a4e77952
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(5)
        defaultValue: ""
        description: ""
        name: MERGED_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST ('' AS varchar(5))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a77ca369-5716-45ae-9eaf-5cac4278da46
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(50)
        defaultValue: ""
        description: ""
        name: STATUS_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fab456a9-3407-4efe-bce5-298edc34af95
                stepCounter: 8095d170-1f14-409d-b317-a4ee62b26ffe
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f9051ac5-d739-4bba-951d-09a2738b11bd
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(200)
        defaultValue: ""
        description: ""
        name: STATUS_DESCRIPTION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 361a9faf-c42b-4cf6-a9a1-27d6d11ece90
                stepCounter: 8095d170-1f14-409d-b317-a4ee62b26ffe
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 888fe061-02ce-45fd-9d38-1651baf11b5d
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PIMS_SPECIALTY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST ('' AS varchar(50))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b55d2481-71a3-49fb-b593-2054332e475b
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: PIMS_REFERRAL_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS datetime)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 28b9544e-1800-42bb-bad5-ca0dc0cd8102
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(50)
        defaultValue: ""
        description: ""
        name: RFA_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8862d320-e4c4-4064-b0b3-91394a416d9f
                stepCounter: 02749d1b-0752-467f-8406-957f3ef05ff1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 501b90e4-c48b-4015-ab5c-8a03d59fca73
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(200)
        defaultValue: ""
        description: ""
        name: RFA_DESCRIPTION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ce57da51-92a2-41c7-bdc9-74e88394d8b6
                stepCounter: 02749d1b-0752-467f-8406-957f3ef05ff1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9ffbcf4a-0743-4613-a7fa-7c1d3b6f77f9
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DAYS_BETWEEN
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: CAST (NULL AS int)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d4c101c-05e3-4724-a9fc-a9701586a9af
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: CASE WHEN (referralHistory.historyTypeCode IS NULL)                         THEN LK_subservice.code ELSE 'NULL' END
        name: CURRENT_SUBSERVICE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ff3c10a-a00b-4e13-8810-2f927012d845
                stepCounter: 60ce7d5a-1652-46f8-b5a9-484bf1d44793
            transform: |-
              CASE WHEN (LastestForward.historyTypeCode IS NULL) THEN ss.code
                          ELSE 'NULL'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 334eeb2d-62fc-49f7-94f9-d54c88a64888
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: case when LK_staus.code in ('D', 'X' )  then LK_staus.sortOrder + 10  when s.code in ('C' ) and ReasonForAction.code = 'DECL' then LK_staus..sortOrder + 10 elseLK_staus.sortOrder end
        name: STATUS_SORT_ORDER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN s.code IN ('D', 'X')                              THEN s.sortOrder + 10
                          WHEN s.code IN ('C') AND ReasonForAction.code = 'DECL' THEN s.sortOrder + 10
                          ELSE s.sortOrder
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ad017098-4809-4299-88e9-c17bd575428d
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: INT
        defaultValue: ""
        description: dhbid from l_ReferralHistory
        name: DHB_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3fdd0361-fae2-44b3-90c5-b0976778329c
                stepCounter: 60ce7d5a-1652-46f8-b5a9-484bf1d44793
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a3c9899d-2e10-44ed-b0f7-5de58e74b569
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(200)
        defaultValue: ""
        description: ""
        name: FCT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a8c609e0-7d6c-4f75-b71a-c573dbf918ca
                stepCounter: ecfdd90f-d7eb-45c8-8055-f1cf8bcd8a06
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2140d46a-f429-47ee-b2a0-80cae08336fe
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: NVARCHAR(50)
        defaultValue: ""
        description: ""
        name: STATUS_CHANGED_BY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15362e09-d118-4649-a94c-8a2e8dbd8ca1
                stepCounter: 244e53f9-449b-4fe6-87f5-18542b22b4ea
            transform: |-
              CASE WHEN Registeredby.namespace = 'archive' THEN username
                          ELSE substring(IFNULL(Registeredby.familyName,'')+', '+ IFNULL(Registeredby.givenName,''),1,100)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bea2de7b-dfa1-4f03-b34a-f5ac18f91c0c
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REGISTERED_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4996a544-ecca-4e7d-94be-8e7a14b77e25
                stepCounter: 60ce7d5a-1652-46f8-b5a9-484bf1d44793
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5842c915-207e-40e6-a455-61e094ccf4f9
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: IFNULL(Addendum.receivedDateTime,  referral. submissionDate)
        name: SUBMISSION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: IFNULL(Addendum.receivedDateTime, eref.submissionDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c645013-8624-4931-90e5-cf3037457490
          stepCounter: 501255ce-6b18-4d47-bcf2-cee8263cd442
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies: []
        join:
          joinCondition: |-
            FROM [s_eReferral_patient_05] eref
              LEFT OUTER JOIN (
                    SELECT l_Addendum.id ,
                           l_Addendum.referralId ,
                           l_Addendum.version ,
                           l_Addendum.receivedDateTime ,
                           ROW_NUMBER() OVER (PARTITION BY referralId ORDER BY VERSION DESC) AS versionRank
                      FROM l_Addendum
                   )AS [Addendum]
                ON eref.id = Addendum.referralId
               AND Addendum.versionRank = 1
             INNER JOIN (
                    SELECT [referralId] ,
                           [statusId] ,
                           [serviceId] ,
                           [dhbId] ,
                           [reasonForActionId] ,
                           [subserviceId] ,
                           ROW_NUMBER() OVER (PARTITION BY referralId ORDER BY [updateDateTime] DESC, id DESC) AS update_seq
                      FROM ds_ReferralHistory
                     WHERE [historyTypeCode] <> 'P'
                   ) AS rh
                ON [rh].[referralId] = eref.[id]
               AND rh.update_seq = 1
              LEFT OUTER JOIN l_ReasonForAction AS ReasonForAction
                ON rh.reasonForActionId = ReasonForAction.id
             INNER JOIN l_LK_Status AS s
                ON rh.[statusId] = s.[id]
             INNER JOIN l_LK_Service AS cs
                ON rh.[serviceId] = cs.[id]
             INNER JOIN l_LK_DHB AS cd
                ON rh.[dhbId] = cd.[id]
              LEFT OUTER JOIN (
                    SELECT [referralId] ,
                           userId ,
                           updatedatetime AS RegisteredDate ,
                           ROW_NUMBER() OVER (PARTITION BY referralId ORDER BY [updateDateTime] ASC, id ASC) AS update_seq
                      FROM ds_ReferralHistory
                     WHERE [historyTypeCode] <> 'P'
                       AND statusId = 14
                   ) AS Registered
                ON Registered.[referralId] = eref.[id]
               AND Registered.update_seq = 1
              LEFT OUTER JOIN (
                    SELECT [referralId] ,
                           userId ,
                           updatedatetime ,
                           CustomFieldValue.description AS FCT ,
                           ROW_NUMBER() OVER (PARTITION BY referralId ORDER BY [updateDateTime] DESC, [ReferralHistory].id DESC) AS update_seq
                      FROM ds_ReferralHistory AS ReferralHistory
                     INNER JOIN l_TriageCustomFieldValue AS TriageCustomFieldValue
                        ON TriageCustomFieldValue.triageId = ReferralHistory.triageId
                     INNER JOIN l_CustomFieldValue AS CustomFieldValue
                        ON CustomFieldValue.id = TriageCustomFieldValue.customFieldValueId
                     INNER JOIN l_CustomField AS CustomField
                        ON CustomField.id = CustomFieldValue.customFieldId
                       AND CustomField.code = 'FCTP'
                     WHERE [historyTypeCode] <> 'P'
                       AND ReferralHistory.triageId IS NOT NULL
                   ) AS rh_FCT
                ON [rh_FCT].[referralId] = eref.[id]
               AND rh_FCT.update_seq = 1
              LEFT OUTER JOIN l_User AS RegisteredBy
                ON Registered.userId = RegisteredBy.id
              LEFT OUTER JOIN l_LK_Subservice ss
                ON rh.[subserviceId] = ss.[id]
              LEFT OUTER JOIN (
                    SELECT [referralId] ,
                           historyTypeCode ,
                           ROW_NUMBER() OVER (PARTITION BY referralId ORDER BY [updateDateTime] DESC, id DESC) AS update_seq
                      FROM ds_ReferralHistory
                     WHERE [historyTypeCode] = 'A'
                   ) AS LastestForward
                ON LastestForward.[referralId] = eref.[id]
               AND LastestForward.update_seq = 1
        name: S_EREFERRAL_10
        noLinkRefs: []
  name: S_EREFERRAL_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
