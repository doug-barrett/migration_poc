fileVersion: 1
id: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
name: S_CONSOLIDATE_1
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e73b486-d476-44c7-a897-a1cf4644c1ce
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4523affd-6b1c-42a1-97a2-39457fc5c638
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7e22d64c-7e19-47ba-adfb-b67da88828c6
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a8a0cf40-5c4d-4cc1-92bd-4a25ff4ba65a
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4f04d204-d490-4bac-b816-1ebb17810901
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d1f8524-6a4c-429e-8523-b86e498bd2b4
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5451d217-ff57-46c0-b73d-be179bcb5ff7
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: START_DATE_ONLY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fd09645b-6682-4f24-8ad3-f874ce74dc05
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: END_DATE_ONLY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7de995d8-99bb-462f-94d6-30efebace0ad
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: abecc889-5337-4651-b864-d54896832dd4
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 49a5b943-c32b-416b-9067-5c05682d3e88
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: WAITLIST_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 692c7e6a-499c-4685-bec5-86831ce4744a
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: HOSPITAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 88092bbf-f5a2-4820-af73-35c695c3e868
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_PURCHASE_UNIT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 087ac9d4-7b92-4b6c-9e0f-e9affe42cd99
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5a0d144-488b-424c-95d8-708763fd40cd
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(2)
        defaultValue: ""
        description: ""
        name: PATIENT_TYPE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a0ee388f-62be-4a70-843d-8fac5b1947cd
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: facbdc2e-0fcb-4f8e-99c9-3672e1e5a2fa
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SOURCE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 932166a2-054c-4d99-bfb9-45f71f0e0ef9
          stepCounter: bf1fae08-34d0-48b2-bec2-0d1f4aa380bd
        config: {}
        dataType: BIT
        defaultValue: ""
        description: Was this a visit that has occured
        name: ATTENDED
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT event_encounter_id ,
                   patient_NHI ,
                   event_encounter_id Match_encounter_id ,
                   admission_date Start_date ,
                   IFNULL(discharge_date,getdate() +1) end_date ,
                   cast(admission_date AS date) Start_date_only ,
                   cast(IFNULL(discharge_date,getdate() +1) AS date) End_date_only ,
                   referral_encounter_id ,
                   waitlist_encounter_id ,
                   hospital_id ,
                   ip.dim_purchase_unit_key ,
                   p.purchase_unit_code ,
                   CASE WHEN p.unit_of_measure = 'Attendance' THEN 'OP'
                        ELSE 'IP'
                         END PatientType ,
                   discharge_health_specialty_code specialty_code ,
                   'IPM inpatients' SOURCE ,
                   cast(1 AS bit) attended
              FROM Fact.fact_inpatient_event IP
             INNER JOIN dim.dim_purchase_unit p
                ON p.dim_purchase_unit_key = ip.dim_purchase_unit_key
             INNER JOIN dim.dim_discharge_specialty ds
                ON ds.dim_discharge_specialty_key = ip.dim_discharge_specialty_key
             INNER JOIN dim.dim_hospital dh
                ON dh.dim_hospital_key = ip.dim_hospital_key
             WHERE ip.dss_update_time > (
                    SELECT convert(datetime, dss_parameter_value)
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.outpatient_appointment_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   CASE WHEN p.purchase_unit_code like '%PRE' THEN (SELECT event_encounter_id enc FROM (SELECT event_encounter_id, row_number() OVER (PARTITION BY ip.referral_encounter_id ORDER BY admit_date) rn FROM s_in_patient_event_05 IP WHERE ip.referral_encounter_id = op.referral_encounter_id AND admit_date > OP.appointment_start_date)d WHERE rn = 1)
                        ELSE op.outpatient_appointment_encounter_id
                         END Match_encounter_id ,
                   op.appointment_start_date Start_date ,
                   op.appointment_end_date end_date ,
                   cast(appointment_start_date AS date) Start_date_only ,
                   cast(appointment_end_date AS date) End_date_only ,
                   op.referral_encounter_id ,
                   op.waitlist_encounter_id ,
                   hospital_id ,
                   op.dim_purchase_unit_key ,
                   p.purchase_unit_code ,
                   'OP' PatientType ,
                   Os.outpatient_health_specialty_code ,
                   'IPM outpatients' SOURCE ,
                   attended_appointment_count attended
              FROM fact.fact_outpatient_appointment OP
             INNER JOIN dim.dim_purchase_unit p
                ON p.dim_purchase_unit_key = OP.dim_purchase_unit_key
             INNER JOIN dim.dim_outpatient_specialty os
                ON os.dim_outpatient_specialty_key = op.dim_outpatient_specialty_key
             INNER JOIN dim.dim_outpatient_clinic dh
                ON dh.dim_outpatient_clinic_key = op.dim_outpatient_clinic_key
             WHERE op.dss_update_time > (
                    SELECT convert(datetime, dss_parameter_value)
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.attendance_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   IFNULL(op.IP_encounter_id,op.attendance_encounter_id) Match_encounter_id ,
                   op.attendance_arrived_date Start_date ,
                   op.departure_ED_ADU end_date ,
                   cast(attendance_arrived_date AS date) Start_date_only ,
                   cast(departure_ED_ADU AS date) End_date_only ,
                   op.referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   hospital_id ,
                   op.dim_purchase_unit_key ,
                   p.purchase_unit_code ,
                   'AE' PatientType ,
                   NULL ,
                   'IPM Emergency' SOURCE ,
                   1 attended
              FROM fact.fact_emergency_department_attendance OP
             INNER JOIN dim.dim_purchase_unit p
                ON p.dim_purchase_unit_key = OP.dim_purchase_unit_key
             INNER JOIN dim.dim_discharge_location dh
                ON dh.dim_discharge_location_key = op.dim_discharge_location_key
             WHERE op.attendance_arrived_date > (
                    SELECT dateadd(MM, -3, convert(datetime, dss_parameter_value))
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.contact_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   (OP.contact_encounter_id) Match_encounter_id ,
                   op.contact_start_date Start_date ,
                   op.contact_start_date end_date ,
                   cast(contact_start_date AS date) Start_date_only ,
                   cast(contact_start_date AS date) End_date_only ,
                   op.referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   '1021' hospital_id ,
                   op.dim_purchase_unit_key ,
                   p.purchase_unit_code ,
                   'CO' PatientType ,
                   NULL ,
                   'CDSSWE Contact' SOURCE ,
                   CASE WHEN contact_type_desc = 'DNA' THEN 0
                        ELSE 1
                         END attended
              FROM s_contact_community_20 OP
             INNER JOIN dim.dim_purchase_unit p
                ON p.dim_purchase_unit_key = OP.dim_purchase_unit_key
             WHERE op.contact_start_date > (
                    SELECT dateadd(MM, -3, convert(datetime, dss_parameter_value))
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.contact_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   (OP.contact_encounter_id) Match_encounter_id ,
                   op.contact_start_date Start_date ,
                   op.contact_end_date end_date ,
                   cast(contact_start_date AS date) Start_date_only ,
                   cast(contact_end_date AS date) End_date_only ,
                   op.referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   '1021' hospital_id ,
                   op.dim_purchase_unit_key ,
                   p.purchase_unit_code ,
                   'CO' PatientType ,
                   s.contact_health_specialty_code specialty_code ,
                   'iPM Contact' SOURCE ,
                   CASE WHEN ss.contact_status_code = 'OCCRD' THEN 0
                        ELSE 1
                         END Attended
              FROM fact.fact_contact_event OP
             INNER JOIN dim.dim_purchase_unit p
                ON p.dim_purchase_unit_key = OP.dim_purchase_unit_key
             INNER JOIN dim.dim_contact_specialty s
                ON s.dim_contact_specialty_key = op.dim_contact_specialty_key
             INNER JOIN dim.dim_contact_status ss
                ON ss.dim_contact_status_key = op.dim_contact_status_key
             WHERE op.contact_start_date > (
                    SELECT dateadd(MM, -3, convert(datetime, dss_parameter_value))
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.referral_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   NULL Match_encounter_id ,
                   op.referral_start_date Start_date ,
                   op.referral_completion_date end_date ,
                   cast(referral_start_date AS date) Start_date_only ,
                   cast(referral_completion_date AS date) End_date_only ,
                   NULL referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   '1021' hospital_id ,
                   NULL dim_purchase_unit_key ,
                   NULL purchase_unit_code ,
                   'RE' PatientType ,
                   s.referred_to_health_specialty_code specialty_code ,
                   'iPM Referral' SOURCE ,
                   1 Attended
              FROM fact.fact_referral OP
             INNER JOIN dim.dim_referred_to_specialty s
                ON s.dim_referred_to_specialty_key = OP.dim_referred_to_specialty_key --where op.dss_update_time > (select convert(datetime, dss_parameter_value) from dss_parameter where dss_parameter_name = 'pa_Consolidate_Incremental')

             WHERE op.date_specialty_last_update > (
                    SELECT convert(datetime, dss_parameter_value)
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.waitlist_encounter_id event_encounter_id ,
                   op.patient_NHI patient_NHI ,
                   NULL Match_encounter_id ,
                   op.waiting_start_date Start_date ,
                   op.waiting_end_date end_date ,
                   cast(op.waiting_start_date AS date) Start_date_only ,
                   cast(op.waiting_end_date AS date) End_date_only ,
                   referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   '1021' hospital_id ,
                   NULL dim_purchase_unit_key ,
                   NULL purchase_unit_code ,
                   'WL' PatientType ,
                   s.waitlist_health_specialty_code specialty_code ,
                   'iPM Waitlist' SOURCE ,
                   NULL Attended
              FROM fact.fact_waitlist OP
             INNER JOIN dim.dim_waitlist_specialty s
                ON s.dim_waitlist_specialty_key = OP.dim_waitlist_specialty_key
             WHERE op.dss_update_time > (
                    SELECT convert(datetime, dss_parameter_value)
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
            UNION ALL SELECT op.theatre_visit_encounter_id event_encounter_id ,
                   op.patient_NHI ,
                   (OP.theatre_visit_encounter_id) Match_encounter_id ,
                   op.into_theatre_date Start_date ,
                   op.out_of_theatre_date end_date ,
                   cast(into_theatre_date AS date) Start_date_only ,
                   cast(out_of_theatre_date AS date) End_date_only ,
                   op.referral_encounter_id ,
                   NULL waitlist_encounter_id ,
                   '1021' hospital_id ,
                   0 AS dim_purchase_unit_key ,
                   '' AS purchase_unit_code ,
                   'TH' PatientType ,
                   NULL ,
                   'iPM Theatre' SOURCE ,
                   CASE WHEN op.cancellation_reason_date IS NOT NULL THEN 0
                        ELSE 1
                         END attended
              FROM fact.fact_theatre_visit OP
             WHERE op.dss_update_time > (
                    SELECT convert(datetime, dss_parameter_value)
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'pa_Consolidate_Incremental'
                   )
        dependencies:
          - locationName: TGT
            nodeName: S_REFERRAL_30
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_REFERRAL_30') }}
        name: S_CONSOLIDATE_1
        noLinkRefs: []
  name: S_CONSOLIDATE_1
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
