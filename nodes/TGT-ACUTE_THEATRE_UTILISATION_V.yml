fileVersion: 1
id: 4331184c-91bf-4690-944f-f8ed0b1fc729
name: ACUTE_THEATRE_UTILISATION_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4bd1ebc3-8fa8-49ac-878f-08a8ca24bd3f
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: THEATRE_SESSION_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8a2d1e11-3147-43a0-ab30-b3929303774d
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e9d86223-5fd3-487f-aa33-512113fd8527
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: DOW
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9fedc035-c4de-4168-88e0-dd0ab46ea0a1
                stepCounter: c664c368-d518-4499-b563-9b0cbfa632c3
            transform: DATENAME(dw,fact_theatre_visit.into_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6d7eae1-65b0-4105-b172-f4da608fcfd6
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IN_HOURS_CASES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 03d0e6c8-bd47-4ce6-a47e-a172eb3bc9b0
                stepCounter: c664c368-d518-4499-b563-9b0cbfa632c3
            transform: COUNT(fact_theatre_visit.theatre_visit_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4c13086b-1f5a-4b1f-a8c1-827683e350d9
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: in_hours_sessions
        name: IN_HOURS_SESSIONS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 972fbce2-6d7f-4496-a3ba-7cf83e27b557
                stepCounter: c664c368-d518-4499-b563-9b0cbfa632c3
            transform: count(DISTINCT fact_theatre_visit.theatre_session_reference_no)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ea2459b7-8965-4dd9-946e-b6e245b20ad1
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: SESSION_START
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a4475feb-82f9-4b2b-b25d-8fe74f86dd1c
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 72cd8279-7603-40c2-ad62-9b4bdeeda58a
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: SESSION_END
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0da040b8-eebb-4662-9e0e-2ac37e2efa10
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ed4df3a6-404c-40c1-b109-ab70e866b3fa
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_IN
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4f860532-0d79-45b3-ae61-a6bc95e1dd73
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 21d01d5a-06f0-403d-ab48-8d298eaaf717
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_READY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e956e52d-fe53-427b-909f-bdfb6602cc57
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ba4b47bd-d4bf-45c5-986a-998e8872652f
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_OUT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e902fc44-13c2-4f16-9181-456f6e49dd25
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 50e905dd-5d2d-4850-9d0f-485ffb4a4aa6
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: session_duration
        name: SESSION_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 433b4a48-3414-49d8-afec-9da7962d0c81
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: |-
              CASE WHEN fact_theatre_session.session_duration > 540 THEN 540
                          ELSE fact_theatre_session.session_duration
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5884edab-be8f-4f48-9cf9-b09d550e86bd
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: denominator
        name: DENOMINATOR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 433b4a48-3414-49d8-afec-9da7962d0c81
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: |-
              CASE WHEN fact_theatre_session.session_duration > 540 THEN 540
                          ELSE fact_theatre_session.session_duration
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15f402ac-d9ec-4227-a5f6-2d09ba00db03
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: NUMERATOR_IN
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4f860532-0d79-45b3-ae61-a6bc95e1dd73
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: datediff(MINUTE, fact_theatre_session.first_patient_into_theatre_date, fact_theatre_session.last_patient_out_of_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d2be98b8-25bb-4251-a22a-d538672ba9e2
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: NUMERATOR_READY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4f860532-0d79-45b3-ae61-a6bc95e1dd73
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: datediff(MINUTE, fact_theatre_session.first_patient_ready_date, fact_theatre_session.last_patient_out_of_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f727827b-8655-494f-9b4c-30f12152616c
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: in_hours_turnaround_mins
        name: IN_HOURS_TURNAROUND_MINS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 433b4a48-3414-49d8-afec-9da7962d0c81
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: sum(datediff(MINUTE,fact_theatre_visit.out_of_theatre_date,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR datepart(HOUR,fact_theatre_visit.session_next_into_theatre_date) NOT BETWEEN 8 AND 17 THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e39a371-08a9-44de-872f-b55f6c6bfcc8
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: in_hours_turnaround_cases
        name: IN_HOURS_TURNAROUND_CASES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 433b4a48-3414-49d8-afec-9da7962d0c81
                stepCounter: c63043da-07dc-422e-975d-5d5d36f997fc
            transform: count(CASE WHEN fact_theatre_visit.cancellation_reason_date IS NOT NULL THEN NULL ELSE CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR datepart(HOUR,fact_theatre_visit.session_next_into_theatre_date) NOT BETWEEN 8 AND 17 THEN NULL ELSE fact_theatre_visit.theatre_visit_encounter_id END END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dec94ffb-9a0b-4c48-b0be-59989f064506
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INT
        defaultValue: ""
        description: TurnAroundOver30Mins_InHrs
        name: TURNAROUNDOVER30MINS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: SUM (CASE WHEN datediff(MINUTE,fact_theatre_visit.out_of_theatre_date,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR datepart(HOUR,fact_theatre_visit.session_next_into_theatre_date) NOT BETWEEN 8 AND 17 THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END) > 30 THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c9253ca-50e1-43bd-a80d-721f677f19ff
          stepCounter: 4331184c-91bf-4690-944f-f8ed0b1fc729
        config: {}
        dataType: INT
        defaultValue: ""
        description: TurnAroundOver60Mins_InHrs
        name: TURNAROUNDOVER60MINS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: SUM (CASE WHEN datediff(MINUTE,fact_theatre_visit.out_of_theatre_date,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR datepart(HOUR,fact_theatre_visit.session_next_into_theatre_date) NOT BETWEEN 8 AND 17 THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END) > 60 THEN 1 ELSE 0 END)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(theatre_session_reference_no, DoW, in_hours_cases, in_hours_sessions, session_start, session_end, first_in, first_ready, last_out, session_duration, denominator, numerator_in, numerator_ready, in_hours_turnaround_mins, in_hours_turnaround_cases, TurnAroundOver30Mins_InHrs, TurnAroundOver60Mins_InHrs) AS SELECT fact_theatre_session.theatre_session_reference_no,
                   DATENAME(dw,fact_theatre_visit.into_theatre_date),
                   COUNT(fact_theatre_visit.theatre_visit_encounter_id),
                   count(DISTINCT fact_theatre_visit.theatre_session_reference_no),
                   fact_theatre_session.session_start_date,
                   fact_theatre_session.session_end_date,
                   fact_theatre_session.first_patient_into_theatre_date,
                   fact_theatre_session.first_patient_ready_date,
                   fact_theatre_session.last_patient_out_of_theatre_date,
                   CASE WHEN fact_theatre_session.session_duration > 540 THEN 540
                        ELSE fact_theatre_session.session_duration
                         END,
                   CASE WHEN fact_theatre_session.session_duration > 540 THEN 540
                        ELSE fact_theatre_session.session_duration
                         END,
                   datediff(MINUTE, fact_theatre_session.first_patient_into_theatre_date, fact_theatre_session.last_patient_out_of_theatre_date),
                   datediff(MINUTE, fact_theatre_session.first_patient_ready_date, fact_theatre_session.last_patient_out_of_theatre_date),
                   sum(datediff(MINUTE,fact_theatre_visit.out_of_theatre_date,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR cast(fact_theatre_visit.session_next_into_theatre_date AS TIME) NOT BETWEEN '08:00' AND '17:30' THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END)),
                   count(CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR datepart(HOUR,fact_theatre_visit.session_next_into_theatre_date) NOT BETWEEN 8 AND 17 THEN NULL ELSE fact_theatre_visit.theatre_visit_encounter_id END),
                   SUM (CASE WHEN datediff (MINUTE ,fact_theatre_visit.out_of_theatre_date ,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR cast(fact_theatre_visit.session_next_into_theatre_date AS TIME) NOT BETWEEN '08:00' AND '17:30' THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END) > 30 THEN 1 ELSE 0 END), SUM (CASE WHEN datediff (MINUTE ,fact_theatre_visit.out_of_theatre_date ,CASE WHEN datename(dw,fact_theatre_visit.session_next_into_theatre_date) IN ('Saturday','Sunday') OR cast(fact_theatre_visit.session_next_into_theatre_date AS TIME) NOT BETWEEN '08:00' AND '17:30' THEN NULL ELSE fact_theatre_visit.session_next_into_theatre_date END) > 60 THEN 1 ELSE 0 END)
              FROM fact.fact_theatre_session fact_theatre_session
              JOIN dbo.ds_consolidate_theatre fact_theatre_visit
                ON fact_theatre_session.theatre_session_reference_no = fact_theatre_visit.theatre_session_reference_no
             WHERE fact_theatre_visit.session_status_code='a'
               AND fact_theatre_session.session_acute_flag='Y'
             GROUP BY fact_theatre_session.theatre_session_reference_no,
                      fact_theatre_session.session_start_date,
                      fact_theatre_session.session_end_date,
                      fact_theatre_session.first_patient_into_theatre_date,
                      fact_theatre_session.first_patient_ready_date,
                      fact_theatre_session.last_patient_out_of_theatre_date,
                      CASE WHEN fact_theatre_session.session_duration >540 THEN 540
                           ELSE fact_theatre_session.session_duration
                            END,
                      CASE WHEN fact_theatre_session.session_duration >540 THEN 540
                           ELSE fact_theatre_session.session_duration
                            END,
                      datename(dw,fact_theatre_visit.into_theatre_date)
        dependencies:
          - locationName: TGT
            nodeName: FACT_THEATRE_SESSION
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','FACT_THEATRE_SESSION') }}
        name: ACUTE_THEATRE_UTILISATION_V
        noLinkRefs: []
  name: ACUTE_THEATRE_UTILISATION_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
