fileVersion: 1
id: 98c50f7d-0481-470b-9405-485c09761000
name: VWBUDGETFORCEID
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 281717c9-3ebd-4640-abf8-7121d62a8b5e
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: TERRITORYID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47803602-5bf0-4efb-b5db-84a236f74524
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: BUDGETDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 36e444e3-d6a2-42e0-990d-b7b9ac3e7ae3
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ba72b502-a64c-40a4-8d36-daf4296c601b
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 520e5507-d7c2-4ef6-9a77-e86b710c332a
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: NUMERIC(18,18)
        defaultValue: ""
        description: ""
        name: FORCEIDDISTRIBUTION
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d326bdd0-bb58-4d8b-86aa-cf2ec6c500e7
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETFORCEIDSALESAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3e5d50c0-97cc-4aeb-8001-4274638b6b4c
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETFORCEIDREVENUEAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d04f587e-eed0-4b30-b30c-f5819c36b6ab
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: TERRITORYID_PY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a54acd15-432b-4717-b304-eb0586010766
          stepCounter: 98c50f7d-0481-470b-9405-485c09761000
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: BUDGETTYPE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            --------------------------------------------------------------------------------------------------------------------------
            \N--GET AMOUNTS TO USE BY 2019 BUDGET DATE
            \N--------------------------------------------------------------------------------------------------------------------------
            \N \NWITH CTEREPORTSSALESANDREVENUE \N AS (
                    SELECT \N ISNULL([SAR].[TERRITORYDIVISIONID], CASE--THIS CASE STATEMENT IS USED TO ASSIGN CORRECT DIVISION NAME WHEN TERRITORY ASSIGNMENT IS NULL DUE TO DATA OR HIERARCHY ISSUES
            \N WHEN [SAR].[ORGANIZATIONID] IN(1, 5, 6) THEN 1--PUBLIC
            \N WHEN [SAR].[ORGANIZATIONID] IN(2, 3, 4, 7) THEN 2--PRIVATE
            \N ELSE 1 \N END) AS [TERRITORYDIVISIONID], \N [SAR].[RECEIPTDATE], \N [SAR].[SALES], \N [SAR].[REVENUE], \N [SAR].[RECEIPTDATEKEY], \N [SAR].[FORCEID] \N
                      FROM [REPORTS].[SALESANDREVENUE] AS [SAR] \N
                     WHERE [SAR].[RECEIPTDATEKEY] BETWEEN 20190101 AND 20191231
                   ) \N--SELECT * FROM [CTEREPORTSSALESANDREVENUE]
            \N, \N CTEFORCEIDSALESREVENUE --GET ACTUALS BY FORCEID
            \N AS (
                    SELECT \N ISNULL([SAR].[TERRITORYDIVISIONID], 1) AS [TERRITORYDIVISIONID], \N [SAR].[RECEIPTDATE] AS [BUDGETDATE], \N ISNULL([SAR].[FORCEID], 0) AS [FORCEID], \N SUM([SAR].[SALES]) AS [BUDGETFORCEIDSALESAMOUNT], \N SUM([SAR].[REVENUE]) AS [BUDGETFORCEIDREVENUEAMOUNT] \N
                      FROM [CTEREPORTSSALESANDREVENUE] AS [SAR] \N
                     WHERE ISNULL([SAR].[TERRITORYDIVISIONID], 1) IN (1, 2) \N
                       AND NOT([SAR].[REVENUE] = 0) --[SAR].[FORCEID] IS NOT NULL --THERE ARE BUDGETS WHERE SALES HAS NOT HAPPENED
            \N
                     GROUP BY \N ISNULL([SAR].[TERRITORYDIVISIONID], 1), \N [SAR].[RECEIPTDATE], \N ISNULL([SAR].[FORCEID], 0)
                   ) \N --SELECT TOP 10 * FROM [CTEFORCEIDSALESREVENUE] AS [CFISR] WHERE FORCEIDREVENUE = 0
            \N --SELECT * FROM [CTEFORCEIDSALESREVENUE] AS CFISR GROUP BY BUDGETDATE
            \N --SELECT CFISR.BUDGETDATE,SUM(CFISR.[FORCEIDSALES]) , SUM([CFISR].[FORCEIDREVENUE]) FROM [CTEFORCEIDSALESREVENUE] AS CFISR GROUP BY CFISR.BUDGETDATE ORDER BY [CFISR].[BUDGETDATE]
            \N , \N --------------------------------------------------------------------------------------------------------------------
            \N CTEFORCEIDBUDGET_2019 \N AS (
                    SELECT --2019 BUDGET BY FORCEID
            \N ISNULL([CLB].[TERRITORYDIVISIONID], 1) AS [TERRITORYDIVISIONID], \N CASE \N
                                WHEN [DA].[TERRITORYID] IS NULL THEN CASE \N WHEN [CLB].[TERRITORYDIVISIONID] = 1 THEN 52 --PUBLIC\PUBLIC\HOUSE
            \N WHEN [CLB].[TERRITORYDIVISIONID] = 2 THEN 11 --PRIVATE\PRIVATE\HOUSE
            \N ELSE [DA].[TERRITORYID] \N END \N
                                ELSE [DA].[TERRITORYID] \N
                                 END AS [TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [DA].[LEVEL1FORCEID], \N [DA].[FORCEID], \N NULL AS [FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N NULL AS [GROWTH], \N [A].[TERRITORYID_PY] AS [TERRITORYID_PY], --2019 TERRITORYID
            \N CASE \N
                                WHEN [DA].[ORGANIZATIONID] = 7 THEN 'TERRITORY BUDGET - ISG' \N
                                ELSE 'TERRITORY BUDGET' \N
                                 END AS [BUDGETTYPE] \N
                      FROM [CTEFORCEIDSALESREVENUE] AS [CLB] \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT_NEXTYEAR] AS [A]
                        ON [CLB].[FORCEID] = [A].[FORCEID] --GET 2019 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT] AS [DA]
                        ON [CLB].[FORCEID] = [DA].[FORCEID] --GET 2020 TERRITORY FOR FORCEID
            \N
                   ) \N --SELECT [CSABBFI].[TERRITORYDIVISIONID], SUM(CSABBFI.[BUDGETFORCEIDREVENUEAMOUNT]) FROM [CTEFORCEIDBUDGET_2019] AS CSABBFI GROUP BY [CSABBFI].[TERRITORYDIVISIONID]
            \N --SELECT BUDGETDATE,[TERRITORYDIVISIONID], SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   CTEFORCEIDBUDGET_MASTER AS CFB  GROUP BY BUDGETDATE,[TERRITORYDIVISIONID] ORDER BY [CFB].[BUDGETDATE], [TERRITORYDIVISIONID]
            \N --SELECT BUDGETDATE, SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2019] AS CFB  GROUP BY BUDGETDATE ORDER BY [CFB].[BUDGETDATE]
            \N --SELECT BUDGETDATE,[TERRITORYDIVISIONID], SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2019] AS CFB  GROUP BY BUDGETDATE,[TERRITORYDIVISIONID] ORDER BY [CFB].[BUDGETDATE], [TERRITORYDIVISIONID]
            \N --------------------------------------------------------------------------------------------------------------------
            \N , \N CTEFORCEIDBUDGET_2020 \N AS (
                    SELECT --2020 BUDGET BY FORCEID
            \N [STNY].[TERRITORYDIVISIONID], \N [DA].[TERRITORYID] AS [TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE] AS [BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N NULL AS [FORCEIDDISTRIBUTION], \N [CLB].[BUDGETSALESAMOUNT] AS [BUDGETFORCEIDSALESAMOUNT], --[BUDGETFORCEIDSALESAMOUNT_2020]
            \N [CLB].[BUDGETREVENUEAMOUNT] AS [BUDGETFORCEIDREVENUEAMOUNT], --[BUDGETFORCEIDREVENUEAMOUNT_2020]
            \N NULL AS [GROWTH], \N [A].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] AS [BUDGETTYPE] \N
                      FROM [FACT].[REVENUEBUDGET] AS [CLB] \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT_NEXTYEAR] AS [A]
                        ON [CLB].[FORCEID] = [A].[FORCEID] --GET 2019 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT] AS [DA]
                        ON [CLB].[FORCEID] = [DA].[FORCEID] --GET 2020 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [DIM].[SALESTERRITORY_NEXTYEAR] AS [STNY]
                        ON [STNY].[TERRITORYID] = [DA].[TERRITORYID] \N --LEFT OUTER JOIN [DIM].[TERRITORYBUDGETGROWTH] AS [TBG] ON [TBG].[TERRITORYDIVISIONID] = ISNULL([STNY].[TERRITORYDIVISIONID], 1) AND [TBG].[BUDGETDATE] = [CLB].[BUDGETDATE]
            \N
                     WHERE [CLB].[BUDGETTYPE] LIKE 'TERRITORY BUDGET%' \N
                       AND [CLB].[BUDGETDATEKEY] BETWEEN 20200101 AND 20201231
                   ) \N --SELECT BUDGETDATE, SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2020] AS CFB  GROUP BY BUDGETDATE ORDER BY [CFB].[BUDGETDATE]
            \N SELECT \N [CLB].[TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N [CLB].[FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N [CLB].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] \N
              FROM [CTEFORCEIDBUDGET_2019] AS [CLB] \N
             UNION \N SELECT \N [CLB].[TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N [CLB].[FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N [CLB].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] \N
              FROM [CTEFORCEIDBUDGET_2020] AS [CLB]
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: VWBUDGETFORCEID
        noLinkRefs: []
  name: VWBUDGETFORCEID
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
