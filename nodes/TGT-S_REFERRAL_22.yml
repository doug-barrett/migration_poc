fileVersion: 1
id: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
name: S_REFERRAL_22
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Link MH referrals for teams created by merging other teams back to the referral from the original team.  Details of merged teams taken from l_mappings_MergedTeams."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15709a78-b5bf-4b6d-aebc-b8ed6b23e94b
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8be08d2a-f48f-430b-ba5e-6e6cc85b02a7
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 13861d80-9e6b-41f7-823e-a882bdc2ac2c
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 60d4112b-116d-4d0f-be03-07c6b9798b1c
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f53b524f-bfa7-4a8e-a9f4-880e1e63af1e
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers rows for each referral ID in linked referral start date order.
        name: ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8be08d2a-f48f-430b-ba5e-6e6cc85b02a7
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: ROW_NUMBER() OVER(PARTITION BY s_referral_20.referral_encounter_id ORDER BY LinkedRef.referral_received_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a378fbc7-f2aa-429b-84b1-f864344f9685
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REFERRAL_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5845f9a6-80fe-4aac-8540-51d53b8641d7
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8de3d33e-f31d-4954-a64d-408cc96ccb3c
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: referred_to_clinician_code
        name: REFERRED_TO_CLINICIAN_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e6d6d38f-ff06-47c2-a6b1-eaa0315f5af9
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51cf06d8-1bc9-4d6f-b8d9-ad5239229f53
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: MERGED_TEAM_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d541a7a1-dfa4-4649-a4ac-6c54ba432310
                stepCounter: cd6c2d39-0e7c-41e2-a502-40f2a616f7af
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b305f7ef-a498-4144-bf33-20f1915ab016
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MERGE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a12f83e-dace-40ba-994c-1fa3b52ad090
                stepCounter: cd6c2d39-0e7c-41e2-a502-40f2a616f7af
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 411e3b32-20f3-4089-90da-07224b260b5c
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: TEAM_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7beb1003-b258-4d92-95f1-eabdb816b092
                stepCounter: cd6c2d39-0e7c-41e2-a502-40f2a616f7af
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a027db66-87ce-4858-ae9f-b31f3ca2d12b
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Populated when the MH referral was created for a team that replaces old teams that have been merged.
        name: MH_LINKED_REFERRAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8be08d2a-f48f-430b-ba5e-6e6cc85b02a7
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: LinkedRef.referral_encounter_id
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5c493c29-7616-446c-bcea-7e26d65f2abb
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Start date of the referral that was closed when MH teams were merged.
        name: MH_LINKED_REFERRAL_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5845f9a6-80fe-4aac-8540-51d53b8641d7
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: LinkedRef.referral_received_date
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1a4dc3a4-acd3-487e-8c7b-6618ce5fce09
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: LINKED_REF_COMPLETION_REASON_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 04936346-edfd-447b-9595-201a9ae7529a
                stepCounter: 3f2053e5-a3d3-4a83-b312-9023276e13e7
            transform: LinkedRef.referral_completion_reason_code
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 897c2b8f-3018-4bc5-953e-228bfb6116aa
          stepCounter: d5a5d64a-e36a-4475-9bb8-b144e98abdc5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_REFERRAL_20: 3f2053e5-a3d3-4a83-b312-9023276e13e7
          L_MAPPINGS_MERGEDTEAMS: cd6c2d39-0e7c-41e2-a502-40f2a616f7af
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_REFERRAL_20
          - locationName: TGT
            nodeName: L_MAPPINGS_MERGEDTEAMS
        join:
          joinCondition: |-
            FROM {{ ref('TGT','S_REFERRAL_20') }} s_referral_20
              JOIN {{ ref('TGT','L_MAPPINGS_MERGEDTEAMS') }} l_mappings_MergedTeams
                ON s_referral_20.referred_to_clinician_code = l_mappings_MergedTeams.merged_team_code
               AND s_referral_20.referral_received_date = l_mappings_MergedTeams.merge_date
              JOIN {{ ref('TGT','S_REFERRAL_20') }} LinkedRef
                ON LinkedRef.patient_nhi = s_referral_20.patient_nhi
               AND LinkedRef.referral_completion_date = s_referral_20.referral_received_date
               AND LinkedRef.referred_to_clinician_code = l_mappings_MergedTeams.team_code
             WHERE s_referral_20.referral_received_date <> s_referral_20.referral_completion_date
               AND LinkedRef.referral_completion_reason_code IN ('TROFC','TTOHT') -- Transfer of Care, Transferred to other Team
        name: S_REFERRAL_22
        noLinkRefs: []
  name: S_REFERRAL_22
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
