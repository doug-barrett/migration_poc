fileVersion: 1
id: bff97753-5f67-49f0-9934-67e7b63ac5a2
name: S_ED_IN_PATIENT_STAY
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc401982-3c98-4265-8a75-4e23d2b7efc7
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PRVSP_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc57cb3b-ddad-41e0-aa89-1499f506679b
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 20589048-d6e7-4dbf-a530-c8631d928b6b
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: SSTAY_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4fc97f3a-689a-4512-9dbe-6c82df8c8a8f
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 40388fe8-3156-4ae2-ba07-b6f10b005c0f
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ED attendance reference in IP event when patient transferred to ward
        name: EVENT_AEATT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c7b026a5-4298-427c-b928-5fcffd3c77dc
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1558c35f-a7c4-4fc3-835c-5a965669e375
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IP_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2f06a6c-bc2b-4943-a499-b407228ccabd
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8eb4997-d93a-4d2b-af08-ae5c296e9551
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ED encounter reference in attendance
        name: ATTENDANCE_AEATT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cef54449-1bb0-4f97-8201-329a0dd19e48
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01a5b058-bff8-4da7-be37-cd323b3fd59f
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ED_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a2c1f3e7-e875-4f95-b6c6-c361f10b3844
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 16dc9e08-258f-45be-a5de-cbba684691f4
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ED_ARRIVED_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 47f1f3c3-0bde-4dc3-8add-8b0ba6091c5d
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc3ece3f-9972-40fc-8aab-32a79c1c86dc
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ED_DEPARTED_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6a67f1a1-8536-4985-b3c9-7c744ea4ac3e
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3aa874c8-4d3e-485a-ad18-f3c893369aa0
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ED_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ed930fe6-e10e-4e2c-8f27-abd9c35f1291
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18a5d14a-2170-4abb-9327-f838c0f6dce2
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ED_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 214703f5-38ec-4c14-a6b0-bcf2e4eef5cc
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d3590c8-04a4-480d-9115-d11d25baad07
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ED_PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b33f9195-428f-44f4-ad30-365c9bad125f
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 86bccaef-f04b-4497-aee7-40738e88a912
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ED_Service_Point_Code
        name: ED_SERVICE_POINT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 785fb0ed-30c6-4c09-9c3d-25e3cfe950ce
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1dab0881-3402-40ed-81f9-d83f129e80a7
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ED_health_org_code
        name: ED_HEALTH_ORG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 647932bd-0d83-498a-bccd-62849b5ef92e
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d34fec02-eec7-4539-952e-413c8cb977c4
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d46dc272-d88c-4e3d-87d7-c7d034283cc5
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a81084e6-9d1e-4ba7-943e-da806b2afba1
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f7376543-41c4-477c-9dea-f9381b7cc631
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: acf1501d-b3bf-4770-a8eb-377c17b5bb68
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eee90f05-c799-4c5c-abef-ee0fd7b4c126
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_SPONT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d472e0a-9450-43d9-8936-e9c7bcb46f38
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a7362dab-60da-41c4-ba54-7f2418b1da13
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP_Service_Point_Code
        name: IP_SERVICE_POINT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fd8b5dc7-5f8d-48f1-96e5-e9f85b2dc97c
                stepCounter: 331048bb-7ff9-400f-b8c4-4ac7cc91d7e8
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 02ca2d8b-9778-4f05-935a-8d751622e0ff
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: IP_Service_Point_desc
        name: IP_SERVICE_POINT_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 07438365-64af-42c6-8b15-fbe6ca5b666f
                stepCounter: 331048bb-7ff9-400f-b8c4-4ac7cc91d7e8
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c7a87d42-4e99-4e89-b108-06bdb90b5589
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP_health_org_code
        name: IP_HEALTH_ORG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a695067b-41a5-45f5-9479-aad869885f1e
                stepCounter: 331048bb-7ff9-400f-b8c4-4ac7cc91d7e8
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 43e1a8e9-66fe-429e-a2c3-e3cdee026db5
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_SPECT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5a1e57d-a116-42f9-aeab-92b2bd78279c
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 64b851e9-9b56-4740-a313-ba532574bbeb
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP_Specialty Code
        name: IP_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: acf7c8b3-5813-4be7-a8ca-91b0073451b4
                stepCounter: 4182a75e-d07b-4637-97fa-4c01e2878360
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bd44d369-a65b-4dd6-8b17-562bc6706ea3
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP_Health Specialty Code
        name: IP_HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab525339-3f36-4625-ba0c-d207897f094b
                stepCounter: 4182a75e-d07b-4637-97fa-4c01e2878360
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 98979ea8-21e6-433a-a838-5ce31c461ff5
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_PROCA_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 387fe979-349f-4207-b25a-b1a1ec419319
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 35efc3dd-95f2-4850-a484-da6f8fb375e4
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP_Healthcare_Professional_Code
        name: IP_HEALTHCARE_PROFESSIONAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e393c87d-2bfd-47b3-a557-82745248467a
                stepCounter: 2b7fcd6a-6a5f-4454-9d5e-f87e946f60fa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 952c57ef-af9e-464a-a2d4-86f50e1d6062
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: IP_Healthcare_Professional_Type_Code
        name: IP_HEALTHCARE_PROFESSIONAL_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fa3fdc05-7435-4789-b5a6-17cd11290cbb
                stepCounter: 2b7fcd6a-6a5f-4454-9d5e-f87e946f60fa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e1664595-dbb2-42ca-9951-2cd3f333c6ab
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: CHAR(1)
        defaultValue: ""
        description: IP_emergency_location_flag
        name: IP_EMERGENCY_LOCATION_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bb1c246c-210e-4a56-b67c-27174c489679
                stepCounter: 331048bb-7ff9-400f-b8c4-4ac7cc91d7e8
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6fd085cd-be05-4e24-8d80-96ee00668309
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_WARD_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a1d06b65-7554-4680-b998-2f4363653ee6
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1685eab3-d57f-43f6-8e08-1fedd303380d
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: STAY_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cef54449-1bb0-4f97-8201-329a0dd19e48
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: ROW_NUMBER() OVER(PARTITION BY s_ed_stay_05.aeatt_refno ORDER BY s_in_patient_stay_05.stay_start_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc18eff0-6a39-41b2-a47a-32d41e7e4e79
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: 'Stay count in ED and Non ED environment  '
        name: STAY_SEQ_NUM_NON_ED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cef54449-1bb0-4f97-8201-329a0dd19e48
                stepCounter: 98f05ebc-0bbd-408a-93d3-9ee096f24d3e
            transform: |-
              CASE WHEN dim_service_point.emergency_department_location_flag = 'N' THEN ROW_NUMBER() OVER(PARTITION BY s_ed_stay_05.aeatt_refno,dim_service_point.emergency_department_location_flag ORDER BY s_in_patient_stay_05.stay_start_date)
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b87020fe-86e3-4ac9-bf5e-f6e95646c8b7
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: STAY_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: COUNT(1) OVER (PARTITION BY s_ed_stay_05.aeatt_refno)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bec20fbd-a66d-49b1-b278-b1b0dbc3d8df
          stepCounter: bff97753-5f67-49f0-9934-67e7b63ac5a2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_IN_PATIENT_STAY_05
        join:
          joinCondition: |-
            FROM s_in_patient_stay_05
              JOIN s_ed_changes
                ON s_ed_changes.aeatt_refno= s_in_patient_stay_05.aeatt_refno
              LEFT OUTER JOIN dim.dim_service_point dim_service_point
                ON s_in_patient_stay_05.stay_spont_refno = dim_service_point.service_point_reference_no
               AND s_in_patient_stay_05.stay_start_date BETWEEN dim_service_point.dss_start_date AND dim_service_point.dss_end_date
              LEFT OUTER JOIN dim.dim_specialty dim_specialty
                ON s_in_patient_stay_05.event_spect_refno = dim_specialty.specialty_reference_no
               AND s_in_patient_stay_05.stay_start_date BETWEEN dim_specialty.dss_start_date AND dim_specialty.dss_end_date
              LEFT OUTER JOIN dim.dim_healthcare_professional dim_healthcare_professional
                ON s_in_patient_stay_05.stay_proca_refno = dim_healthcare_professional.healthcare_professional_reference_no
               AND s_in_patient_stay_05.stay_start_date BETWEEN dim_healthcare_professional.dss_start_date AND dim_healthcare_professional.dss_end_date
              JOIN (
                    SELECT s_ed_stay_05.*,
                           dim_service_point.health_org_level2_code
                      FROM s_ed_stay_05
                      LEFT OUTER JOIN dim.dim_service_point
                        ON s_ed_stay_05.spont_refno = dim_service_point.service_point_reference_no
                       AND s_ed_stay_05.start_date BETWEEN dim.dim_service_point.dss_start_date AND dim.dim_service_point.dss_end_date
                   ) s_ed_stay_05
                ON s_ed_stay_05.patnt_refno = s_in_patient_stay_05.stay_patnt_refno
               AND s_ed_stay_05.health_org_level2_code = dim_service_point.health_org_level2_code
               AND ( s_in_patient_stay_05.aeatt_refno = s_ed_stay_05.aeatt_refno -- Added for testing CBS    or  ((ABS(DATEDIFF(mi, s_in_patient_stay_05.stay_start_date, IFNULL(s_ed_stay_05.departed_date,GETDATE()))) < 180          OR  s_ed_stay_05.departed_date BETWEEN s_in_patient_stay_05.admit_date and s_in_patient_stay_05.disch_date)            and left(health_specialty_code,1) in ('M','S')) )
        name: S_ED_IN_PATIENT_STAY
        noLinkRefs: []
  name: S_ED_IN_PATIENT_STAY
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
