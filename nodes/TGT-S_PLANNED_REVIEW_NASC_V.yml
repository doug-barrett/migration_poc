fileVersion: 1
id: 9e89e89f-4fe9-4a5e-8b07-866623118452
name: S_PLANNED_REVIEW_NASC_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 44c05a6f-9fc8-480b-bdf6-29ae992908a9
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CONTACT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7570d12b-fd39-4264-b31d-03c84467ba42
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ad789b0-1af1-49e5-b06b-e698b88f786b
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 652c3c0c-9042-4f1b-904b-ffa6dd37e09d
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9bc6297d-00ed-48bb-952b-24c3544e139e
                stepCounter: 289da868-88f5-4e61-a975-de3b30517956
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aec16b68-bdd1-4c88-8e56-9c80a2ce106e
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: patient_programme_id
        name: PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1dc01ac2-a10c-49ca-90eb-ed32df22cd74
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 23780e84-24af-47c9-a52a-61be3e85e811
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: patient_programme_status
        name: PROGRAMME_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 68ae7343-6636-410f-8f54-d96cc55f2e09
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ec848d8b-bb59-4edf-a742-d4d88bd25a32
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TASK_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e5353c2d-4a44-4e11-bc07-37f02a977a35
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 71b4fd5a-880a-4479-986d-0220672f07bd
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: HEALTH_ORG_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c12f6696-6dfb-413d-a9e0-108fd7fdb031
                stepCounter: 05ed0e9e-67ad-49bf-b299-f8f341d6b3c4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 788b28a4-3aa0-437a-94b0-48f757be0904
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9668f55c-c7a5-4a58-a248-a09453e77eaa
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a89a406f-cb43-4ae6-a5cd-1645a681e6dd
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: HOSPITAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 980489a9-a2f2-4899-b808-e20222682081
                stepCounter: 0790fdf4-e815-4587-a9cd-954ea13f53c6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b49f65ac-33e0-4bb6-8854-b11147d85862
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PROVIDER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b64f71a4-6818-4fe2-8f71-79ea2097bd8d
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1bf22bba-9f79-4fda-a9df-7bd90f7d10e6
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PROVIDER_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e54c5b96-c200-4dd7-85cc-9dc969de2264
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 925809fe-a22f-4c4b-afe5-8ca54f2b15ee
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PROGRAMME_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d987929e-5376-4f54-8f22-634411f4e6d6
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: DEPARTMENT_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d7844938-b85f-4982-9eee-68dcb014fd0c
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SERVICE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a2f373f7-1c7e-4b2a-81bc-6e400af1e62c
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5de1023-9916-4569-ad46-d203d6bd8b59
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e3f6dc00-b716-4159-851f-cb45922c72e8
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EPISODE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a61b1e4e-250d-4353-8a0b-699237cac645
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 42c963fd-cf42-4899-a951-84b8b4ae2add
          stepCounter: 9e89e89f-4fe9-4a5e-8b07-866623118452
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PLANNED_REVIEW_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'NA'+SUBSTRING(CONVERT(varchar,10000000000+tr.taskrequest_id),2,10) contact_encounter_id,
                   tr.taskrequest_id task_request_id,
                   pt.NHI_number,
                   pp.patient_programme_id programme_id,
                   MAX(pp.patient_programme_status) programme_status,
                   LEFT(MAX(tt.display_name),30) task_desc,
                   MAX(cl.external_clinic_id) health_org_id, --MAX(ob.provider_nzmc) seen_by_clinician_id,
             MAX(CASE WHEN LEFT (tr.stream_id,1) = '1' THEN 'R' + tr.stream_id ELSE tr.stream_id END) referral_encounter_id,
                   MAX(CASE WHEN og.health_org_desc LIKE '%West%' THEN '3216' ELSE '3215' END) hospital_id,
                   MAX(pr.provider_id) provider_id,
                   MAX(pr.provider_role_code) provider_role_code,
                   LEFT(MAX(rl.name),50) programme_role_code,
                   LEFT(MAX(dp.name),50) department_desc,
                   LEFT(MAX(sv.name),50) service_desc,
                   MAX(tr.request_date) task_request_date,
                   MAX(pp.episode_start_date) episode_start_date,
                   NULL planned_review_type
              FROM ds_cdsswe_task_request tr
             INNER JOIN l_cdsswe_Task_Type tt
                ON tr.tasktype_id = tt.tasktype_id
               AND tt.name = 'Review'
             INNER JOIN ds_cdsswe_patient_programme pp
                ON tr.patient_programme_id = pp.patient_programme_id
               AND pp.patient_programme_status = 'ACTIVE'
             INNER JOIN l_cdsswe_programme rl
                ON rl.programme_id = pp.programme_id --AND rl.programme_id = 4452666405396  --'Needs Assessors in NASC'

             INNER JOIN l_cdsswe_patient pt
                ON pp.patient_id = pt.patient_id
              LEFT OUTER JOIN ds_cdsswe_observation_report ob
                ON tr.taskrequest_id = ob.taskrequest_id
               AND ob.record_status = 'A'
               AND ob.observation_report_status IN ('A','F','X','S') --LEFT OUTER JOIN ds_cdsswe_atomic_observation ov
            --ON ov.observation_report_id = ob.observation_report_id

              LEFT OUTER JOIN l_cdsswe_Patient_Programme_Provider pr
                ON pr.patient_programme_id = pp.patient_programme_id
               AND pr.record_status = 'A'
               AND pr.sequence_num = '1'
              LEFT OUTER JOIN l_cdsswe_clinic cl
                ON pr.clinic_id = cl.clinic_id
               AND cl.record_status = 'A'
               AND cl.clinic_type = 'CASETEAM'
              LEFT OUTER JOIN dim.dim_health_organisation og
                ON cl.external_clinic_id = og.health_org_reference_no
              LEFT OUTER JOIN l_cdsswe_programme dp
                ON dp.programme_id = rl.parent_programme_id
              LEFT OUTER JOIN l_cdsswe_programme sv
                ON sv.programme_id = dp.parent_programme_id
             WHERE ob.observation_report_id IS NULL
             GROUP BY tr.taskrequest_id,
                      pt.NHI_number,
                      pp.patient_programme_id
        dependencies:
          - locationName: TGT
            nodeName: DS_CDSSWE_TASK_REQUEST
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','DS_CDSSWE_TASK_REQUEST') }}
        name: S_PLANNED_REVIEW_NASC_V
        noLinkRefs: []
  name: S_PLANNED_REVIEW_NASC_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
