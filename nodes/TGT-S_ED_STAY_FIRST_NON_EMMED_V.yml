fileVersion: 1
id: 4426446d-7e6c-4735-8e0a-2b97040e9b11
name: S_ED_STAY_FIRST_NON_EMMED_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 566abfed-00f7-46d9-8cde-80eeb2c2775a
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: NUMERIC(10)
        defaultValue: ""
        description: ""
        name: AEATT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c4fad752-1852-49d6-b044-80a53e733657
                stepCounter: 519b7b54-37f3-47cb-b8ab-346649c612e9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8b4feb31-2997-477d-9da2-6d2026cdff8d
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EMMED_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 831cb2b7-7657-4a87-997e-de2fc3c72615
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: NON_EMMED_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f09f6393-578b-4e89-a91c-1fc14f6cb06e
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_RESPONSE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d5e3b998-1c58-42d7-b512-0e5bd20a33ec
                stepCounter: 519b7b54-37f3-47cb-b8ab-346649c612e9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f32e829-c37d-466b-bebf-ae31d7efa552
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_SEEN_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 50b22db6-c72f-49c3-8eae-1d787b78f9d1
                stepCounter: 519b7b54-37f3-47cb-b8ab-346649c612e9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f7a88923-4003-45ca-ab0a-198b6bd80a28
          stepCounter: 4426446d-7e6c-4735-8e0a-2b97040e9b11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: First EM_Clinician seen from the whiteoard
        name: EM_CLINICIAN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6e0c1254-8fc6-41d6-af66-914d86b06428
                stepCounter: e0bb5602-6936-4c6a-b32b-8c9a413726d4
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT t.aeatt_refno,
                   emmed_end_date,
                   non_emmed_start_date,
                   CASE WHEN ip_response_date3 < non_emmed_start_date THEN NULL
                        ELSE IFNULL(ip_response_date1, ip_response_date2)
                         END ip_response_date,
                   IFNULL(ip_seen_date1, ip_seen_date2) ip_seen_date ,
                   (
                    SELECT top 1 ss.seenbydoctorid
                      FROM s_ed_seen_by_05 ss
                     WHERE t.aeatt_refno = ss.aeatt_refno
                       AND ss.specialty_code = 'EMMED'
                     ORDER BY actiondttm DESC,
                              cachenumber
                   )EM_Clinician
              FROM (
                    SELECT aeatt_refno,
                           MAX(CASE WHEN specialty = 'EMMED' THEN end_date ELSE NULL END) emmed_end_date,
                           MIN(CASE WHEN specialty <> 'EMMED' THEN start_date ELSE NULL END) non_emmed_start_date,
                           MIN(CASE WHEN stay_start_reason_code LIKE '%[S]%' AND specialty <> 'EMMED' THEN seen_date ELSE NULL END) ip_response_date1,
                           MIN(CASE WHEN specialty <> 'EMMED' THEN seen_date ELSE NULL END) ip_response_date2,
                           MIN(seen_date) ip_response_date3,
                           MIN(CASE WHEN stay_start_reason_code LIKE '%[S]%' AND stay_end_reason_code LIKE '%[S]%' THEN end_date ELSE NULL END) ip_seen_date1,
                           MIN(CASE WHEN stay_end_reason_code LIKE '%[S]%' THEN end_date ELSE NULL END) ip_seen_date2
                      FROM s_ed_stay_30
                     GROUP BY aeatt_refno
                   ) t
        dependencies:
          - locationName: TGT
            nodeName: S_ED_STAY_30
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_ED_STAY_30') }}
        name: S_ED_STAY_FIRST_NON_EMMED_V
        noLinkRefs: []
  name: S_ED_STAY_FIRST_NON_EMMED_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
