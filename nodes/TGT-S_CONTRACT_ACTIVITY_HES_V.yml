fileVersion: 1
id: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
name: S_CONTRACT_ACTIVITY_HES_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bef229ce-adcf-4baa-ac5b-f614dab5d939
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Generated column used to join to correct Price Volume Schdule Line
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 11360876-04d6-4067-ba5b-bdbc7e384dfe
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bf0258ab-0361-4d2f-bb9c-8c6b7ba3e68f
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9c996af2-e011-488a-86b4-2cde2a9778cc
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: 'health_specialty_code '
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c0517c2a-947f-463c-a1fd-ed4a3eefecc5
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c9f5c5b8-67cc-439b-b14b-4756e65b9dde
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Has twelve months added. Mental Health data was 24 months old so 12 months added int his step and the s_contract_activity_10
        name: REPORTING_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b970579b-810f-4290-86b8-8edb0360e0ac
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e28e010-99f8-4f1d-b296-4d6dea6ceeeb
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ec05c5e5-222f-48f4-9295-7bd09f812dd4
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ee7c34a0-222e-44c6-aa35-6a37f29b28df
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5eca0f5d-564c-41e7-a600-5e43bee81ba3
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_in_patient_event_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c8adcbb5-4993-49ca-ad80-c2f9ed7885b1
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 169e5e94-1554-4166-a62e-39a7fd6f40f9
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0091da65-92cb-43f4-8a7a-19c7f79bf62f
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa1cfd87-c829-46de-8e13-5a8d77698e88
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9e4168f0-d3bb-4f17-9139-f5a96eab69fc
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dd01beee-67c0-4d9b-b1b0-4c5bb04ed7d9
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4178afdd-908f-4d8b-b833-d69d298e8979
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 359c140a-7275-4bf8-a6eb-981344b33b2d
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: Purchase unit volume derived from forecasting
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55e4e782-6de3-4e8e-a995-6a3fdde47d45
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05c44296-9a59-4693-96b1-f8cc46c2da70
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa0751f5-886a-4e38-91a7-2ab222dd3260
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce0b8a84-31c0-4132-82ee-3681ea37f4eb
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: discharging clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ccc98b1-efad-4e1a-b836-14d52a50896c
          stepCounter: dcda10a9-b5e1-4e9b-9add-8b91fdaf781c
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT t.provider_funder_split,
                   t.PUC_map_id,
                   t.responsibility_centre_code,
                   t.health_specialty_code,
                   t.facility_code,
                   t.reporting_date,
                   t.source_encounter,
                   t.funded_event_encounter,
                   t.event_encounter_type_code,
                   t.NHI,
                   t.dim_patient_key,
                   t.admin_category_reference_no,
                   t.contract_admit_type,
                   t.admission_type_code,
                   t.IDF_class,
                   t.domicile_code,
                   t.purchase_unit_code,
                   t.purchase_unit_volume,
                   t.estimated_purchase_unit_volume,
                   t.dim_age_group_key,
                   t.dim_planned_care_key,
                   t.DRG_code,
                   t.clinician_reference_no,
                   t.source_system
              FROM (
                    SELECT 'provider' provider_funder_split,
                           NULL PUC_map_id,
                           '115-1170' responsibility_centre_code,
                           'M10' health_specialty_code,
                           dh.hospital_id facility_code,
                           a.sdate reporting_date,
                           'HES' + RIGHT('000' + CAST(a.HESID AS VARCHAR(11)), 11) source_encounter,
                           'HES' + RIGHT('000' + CAST(a.HESID AS VARCHAR(11)), 11) funded_event_encounter,
                           'HES' event_encounter_type_code,
                           a.NHI,
                           IFNULL(dim_patient_key,0) dim_patient_key, -- wont have all patients
             '35' admin_category_reference_no,
                           'OTHER' contract_admit_type,
                           NULL admission_type_code,
                           spa.IDF_class,
                           spa.domicile_code,
                           'M10004' purchase_unit_code,
                           1 purchase_unit_volume,
                           0 estimated_purchase_unit_volume,
                           dag.dim_age_group_key dim_age_group_key,
                           0 dim_planned_care_key,
                           NULL DRG_code,
                           dc.clinician_reference_no,
                           'HES' AS [source_system],
                           ROW_NUMBER() OVER(PARTITION BY spa.patient_NHI, HESID ORDER BY spa.address_validity_start_date DESC) duplicate_addr_check
                      FROM [dbo].[ds_cvdis_HES] a
                      JOIN (
                            SELECT MIN(sdate) min_ref_date,
                                   NHI
                              FROM [dbo].[ds_cvdis_HES] a
                             WHERE 1 = 1
                               AND a.ReferralStatus = 'Accepted'
                               AND a.template IN ('Cardiac_Rehab', 'Cardiac_Rehab_v2')
                               AND a.sdate > '01-Jul-2009'
                             GROUP BY a.NHI
                           ) b
                        ON a.sdate = b.min_ref_date
                       AND a.NHI = b.NHI
                      LEFT JOIN dim.dim_patient
                        ON a.NHI = dim_patient.patient_NHI
                       AND NHI_sequence = 1
                      LEFT JOIN dim.dim_age_group dag
                        ON FLOOR(DATEDIFF(DAY, patient_date_of_birth, a.sdate) / 365.25) = dag. age_years
                      LEFT JOIN dbo.s_patient_address spa
                        ON a.NHI = spa.patient_NHI
                       AND a.sdate BETWEEN spa.address_validity_start_date AND IFNULL(spa. address_validity_end_date, GETDATE() + 1000)
                       AND spa.domicile_code IS NOT NULL
                      LEFT JOIN dim.dim_clinician dc
                        ON a.responsible_clinician = dc.clinician_fullname
                      LEFT JOIN dim.dim_hospital dh
                        ON a.refHospital = dh.hospital_desc
                     WHERE 1 = 1
                       AND a.ReferralStatus = 'Accepted'
                       AND a.template IN ('Cardiac_Rehab', 'Cardiac_Rehab_v2')
                       AND a.sdate > '01-Jul-2009'
                   ) t
             WHERE t.duplicate_addr_check = 1
        dependencies: []
        join:
          joinCondition: None
        name: S_CONTRACT_ACTIVITY_HES_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_HES_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
