fileVersion: 1
id: 99f53fcc-807b-4a8d-92f8-121e4271adfe
name: VWUCSPEND_MISSINGDATES
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 92069d4c-e1d3-476c-992b-b5bbf4e6df07
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Campus=UCCampus.UCCampus
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCAMPUSKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 953b406e-1004-42f8-ab98-70f2c3cbdcc5
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 084d0ed0-a088-49c2-9886-3cb73ae6d58a
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_1=UCCategoryLevel1.UCCategory_Level_1
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL1KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1b995379-8b0b-4a7d-9495-ccd1c2d5ecf9
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 79a1f7a4-966b-4a1d-9739-e231bc8b457c
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_2=UCCategoryLevel2.UCCategory_Level_2
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL2KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c48d845f-f80a-41f9-8691-ef302459bc59
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3721fcae-ac27-4cff-9360-f3e0dea6a0ae
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_3=UCCategoryLevel3.UCCategory_Level_3
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL3KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3583ad2-a7fd-4a81-bd6b-799f1553f535
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ff04600-4a34-4439-819d-40477d2293ae
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_4=UCCategoryLevel4.UCCategory_Level_4
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL4KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5f638e0a-d34e-4cc7-9f62-d62fd1a762d5
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c7b2504f-01f0-41c3-8444-a105abe87922
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Supplier=UCSupplier.UCSupplierName
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCSUPPLIERKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a1a98c4d-8bc1-4018-95ff-661060e4e2bf
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 94787ed2-a7d7-4d3f-b9cd-ea01baf176ca
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_1=UCTier1.UC_Tier_1
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER1KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d9464dd4-2287-42d8-a83b-d5f4545d907a
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6085e7c8-933e-4c65-8b0a-d4dd6105f2d7
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_2=UCTier2.UC_Tier_2
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER2KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4a9baca5-8617-44af-a3c9-4a9e09aef817
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5d570364-db0f-486b-b9f1-ed69c8c28be1
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_3=UCTier3.UC_Tier_3
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER3KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2630437-c7ac-4e0b-9544-6c4fdbbf5be3
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eeac82d6-36cf-4f28-8976-2c1f1ddbe220
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCOMPONENTKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b89cb751-6b0e-4c66-9456-c7218836e0fa
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f0758882-e1a6-4bd0-b104-5806a5728b16
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPSUPPLIERKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 47cba7f4-55ef-4e27-ae28-bea74a695b92
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 94933705-adad-41b5-a2b0-b47fa76bbb1d
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPSUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a71dded2-76f2-4ba5-bd56-1175d67698f2
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c4430b41-85b5-4cb9-8817-8c05632baa76
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e3798069-b23b-4fc2-b3f3-74bab214af9f
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 49b2c80e-5d53-438d-a072-7d3f9c91fec0
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4ecd6829-d8cc-4be2-9473-0d6606444004
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bb23f06b-7ad7-472a-97b4-c722b9ba5c49
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: OPContractMappingStatusId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTMAPPINGSTATUSID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a6e15c04-1334-40be-afe1-6a3baba8d521
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 90ae16f7-edae-42c1-9178-3927b9283bed
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCSPEND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 14eecfbb-e308-42a8-9833-39140d70b720
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 776beb8e-4fb3-40db-a294-5d6ba6ebfe19
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: INT
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.TransactionDate=DimTransactionDate.TransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: TRANSACTIONDATEKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 02b059d8-1371-4cba-ab9c-a763ea748d11
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 28d0b476-d1fd-4040-9b27-4a45f6b28f48
          stepCounter: 99f53fcc-807b-4a8d-92f8-121e4271adfe
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: TRANSACTIONDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 16e890b5-5300-4667-98ca-05e415f94bad
                stepCounter: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VWUCSPEND_MISSINGDATES: 99f53fcc-807b-4a8d-92f8-121e4271adfe
          DIMTRANSACTIONDATE: b6e4db47-031e-4b7e-9203-ae244b9a23e5
          MAXRECEIPTDATE: fbce89c3-3b61-4a90-815f-de48a5c22ad4
          UCCAMPUS: 2b3ad18b-05b2-417d-aa60-27bbb9a839ca
          AGGUCSPEND: 677f7c31-590f-4d3c-8f7f-a46c8e699c71
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('REPORTS','VWUCSPEND_MISSINGDATES') }} (UCCampusKey, UCCategoryLevel1Key, UCCategoryLevel2Key, UCCategoryLevel3Key, UCCategoryLevel4Key, UCSupplierKey, UCTier1Key, UCTier2Key, UCTier3Key, UCComponentKey, OPSupplierKey, OPSupplierId, OPContractKey, OPContractId, OPContractMappingStatusId, UCSpend, TransactionDateKey, TransactionDate) AS WITH cteAllTransDates AS (
                    SELECT dtd.TransactionDateKey,
                           dtd.TransactionDate
                      FROM {{ ref('DIM','DIMTRANSACTIONDATE') }} AS dtd
                     WHERE dtd.TransactionDateKey BETWEEN 20180101 AND (
                            SELECT REPLACE(MaxReceiptDate,'-','')
                              FROM {{ ref('FACT','MAXRECEIPTDATE') }}
                           )
                       AND dtd.TransactionDateKey LIKE '%01'
                   ),
                   cteAllCampuses AS (
                    SELECT UCCampusKey
                      FROM {{ ref('DIM','UCCAMPUS') }} AS u
                     WHERE u.UCCampusKey > 0
                   ),
                   cteAllUCRowsMinusTransDate AS (
                    SELECT DISTINCT au.UCCategoryLevel1Key,
                           au.UCCategoryLevel2Key,
                           au.UCCategoryLevel3Key,
                           au.UCCategoryLevel4Key,
                           au.UCSupplierKey,
                           au.UCTier1Key,
                           au.UCTier2Key,
                           au.UCTier3Key,
                           NULL AS UCComponentKey,
                           au.OPSupplierKey,
                           au.OPSupplierId,
                           au.OPContractKey,
                           au.OPContractId,
                           au.OPContractMappingStatusId
                      FROM {{ ref('REPORTS','AGGUCSPEND') }} AS au
                     WHERE au.OPContractMappingStatusId IN (1, 2)
                   ),
                   cteAllUCRowsAllDatesAllCampuses AS (
                    SELECT *
                      FROM cteAllUCRowsMinusTransDate AS caaumtd,
                           cteAllCampuses AS cac, --Cross join to generate rows for all Campuses and for all dates
              cteAllTransDates AS catd
                   ) --,
              --cteAllOPRows
              --AS (SELECT DISTINCT
              --		aoarbc.UCCampusKey AS UCCampusKey,
              --		--aoarbc.ContractKey AS OPContractKey,
              --		aoarbc.TransactionDateKey
              -- FROM   OmniaPartnersDW.Reports.AggOPSalesAndRevenueByContract AS aoarbc
              --		INNER JOIN cteAllTransDates AS catd ON aoarbc.TransactionDateKey = catd.TransactionDateKey)
              --cteAllOPRowsWithUCColumns
              --AS (SELECT
              --		cteUC.*
              -- FROM   cteAllUCRowsAllDatesAllCampuses AS cteUC
              --		INNER JOIN cteAllOPRows AS cteOP ON cteOP.UCCampusKey = cteUC.UCCampusKey
              --												AND cteOP.OPContractKey = cteUC.OPContractKey
              --												AND cteOP.TransactionDateKey = cteUC.TransactionDateKey
              -- WHERE  cteUC.UCCategoryLevel1Key IS NOT NULL),
              --SELECT * FROM ctealloprows
              SELECT cteAllUC.UCCampusKey,
                   cteAllUC.UCCategoryLevel1Key,
                   cteAllUC.UCCategoryLevel2Key,
                   cteAllUC.UCCategoryLevel3Key,
                   cteAllUC.UCCategoryLevel4Key,
                   cteAllUC.UCSupplierKey,
                   cteAllUC.UCTier1Key,
                   cteAllUC.UCTier2Key,
                   cteAllUC.UCTier3Key,
                   NULL AS UCComponentKey,
                   cteAllUC.OPSupplierKey,
                   cteAllUC.OPSupplierId,
                   cteAllUC.OPContractKey,
                   cteAllUC.OPContractId,
                   cteAllUC.OPContractMappingStatusId,
                   0 AS UCSpend,
                   cteAllUC.TransactionDateKey,
                   cteAllUC.TransactionDate
              FROM cteAllUCRowsAllDatesAllCampuses AS cteAllUC --INNER JOIN cteAllOPRows AS cteOP ON cteOP.UCCampusKey = cteAllUC.UCCampusKey AND cteOP.TransactionDateKey = cteAllUC.TransactionDateKey

            EXCEPT SELECT DISTINCT au.UCCampusKey,
                   au.UCCategoryLevel1Key,
                   au.UCCategoryLevel2Key,
                   au.UCCategoryLevel3Key,
                   au.UCCategoryLevel4Key,
                   au.UCSupplierKey,
                   au.UCTier1Key,
                   au.UCTier2Key,
                   au.UCTier3Key,
                   NULL AS UCComponentKey,
                   au.OPSupplierKey,
                   au.OPSupplierId,
                   au.OPContractKey,
                   au.OPContractId,
                   au.OPContractMappingStatusId,
                   0 AS UCSpend,
                   au.TransactionDateKey,
                   au.TransactionDate
              FROM {{ ref('REPORTS','AGGUCSPEND') }} AS au
        dependencies:
          - locationName: REPORTS
            nodeName: AGGUCSPEND
          - locationName: DIM
            nodeName: DIMTRANSACTIONDATE
          - locationName: FACT
            nodeName: MAXRECEIPTDATE
          - locationName: DIM
            nodeName: UCCAMPUS
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('REPORTS','AGGUCSPEND') }}
            {{ ref('DIM','DIMTRANSACTIONDATE') }}
            {{ ref('FACT','MAXRECEIPTDATE') }}
            {{ ref('DIM','UCCAMPUS') }}
        name: VWUCSPEND_MISSINGDATES
        noLinkRefs: []
  name: VWUCSPEND_MISSINGDATES
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
