fileVersion: 1
id: d1b6e0e7-0427-4013-b92a-4138e9695b0b
name: VWUCSPEND_MISSINGDATES
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3124b947-bd32-4881-aff5-900a53db6b1c
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Campus=UCCampus.UCCampus
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCAMPUSKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 168fe7a1-9144-47c8-b6fa-349681b446b5
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cbc42aef-5949-4dc7-ae7e-e953abb286b3
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_1=UCCategoryLevel1.UCCategory_Level_1
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL1KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 463968fa-834b-48b5-8e24-067bc2864636
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 39f0adbb-bed2-4e9e-95d8-8a3a46d6e9c9
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_2=UCCategoryLevel2.UCCategory_Level_2
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL2KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bc28a3be-a7bb-45ed-9712-815d4ac40473
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a410a995-846c-421f-bcc4-3beb31036288
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_3=UCCategoryLevel3.UCCategory_Level_3
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL3KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7f6ecacc-5b16-4a1b-94d0-fb74fe901ab3
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bbf354f8-262b-4666-ad5b-615d3a0d578b
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Category_Level_4=UCCategoryLevel4.UCCategory_Level_4
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCATEGORYLEVEL4KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2a308862-3580-4d54-bac1-e21bdfcfb20d
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 52783a31-0cc1-4c33-842b-c195acecb0fd
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.Supplier=UCSupplier.UCSupplierName
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCSUPPLIERKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b588c598-984f-4825-940b-6624d222b9dd
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4a3683ce-4d58-4d7d-9904-31bdf5f9fd46
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_1=UCTier1.UC_Tier_1
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER1KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c873735f-804c-4846-a759-0393bf699226
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 52306d31-5c0d-4b8a-9f57-b445a9909be8
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_2=UCTier2.UC_Tier_2
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER2KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6bb23761-7500-42af-a56a-e0b28e53a6c1
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc92a605-c2ef-43d0-bde5-bb90c5740707
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.UC_Tier_3=UCTier3.UC_Tier_3
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCTIER3KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6709dc67-3f5b-43aa-89d3-ed9fbb6fe69a
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a35bda0e-7da2-460d-a023-12bc52a5ff58
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCCOMPONENTKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2c70c1c9-a755-4516-8f2b-60b9cf524a04
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9e80e8e6-97e2-4124-8c7a-0f0295823f07
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPSUPPLIERKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e9db7063-e9cd-4dc3-af2a-c2fcea21605f
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 57985379-2903-4494-a088-5e7f648b2cb4
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPSUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 44fd9b17-bea3-4c13-8b9b-a81f508972bd
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a50c892c-34c8-47d9-8b81-c3b55d1bed36
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0010197b-b4ab-4a74-9d87-95f6e82142d6
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2c6f7ebf-db3b-4bae-b7fe-2032fd82df9b
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39e6d046-ac47-4006-acb9-bf49389e02f9
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 033a568c-71b1-4893-9ec1-d0d6af081d83
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: OPContractMappingStatusId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: OPCONTRACTMAPPINGSTATUSID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7904a618-be50-4600-8401-7782ee4169c2
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 760a52fc-ffba-4c7f-b5e9-8600ef9a1146
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: UCSPEND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 65c0f878-aaa8-40d8-afd2-9d46af83b860
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 403007db-3de8-4091-b6e2-d4c2dea95d1c
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: INT
        defaultValue: ""
        description: StageUCSpendReportingLineItems_AddKeys.TransactionDate=DimTransactionDate.TransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: TRANSACTIONDATEKEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b8de6f88-0739-4abc-8d90-02263ab2a6b3
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fc2ae1ab-1973-4818-becd-2123c2ab51b1
          stepCounter: d1b6e0e7-0427-4013-b92a-4138e9695b0b
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: TRANSACTIONDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d8420ef3-a11f-4587-b51f-57a9bd908ed4
                stepCounter: af092158-e3f1-41fa-8161-a5166038b69e
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VWUCSPEND_MISSINGDATES: d1b6e0e7-0427-4013-b92a-4138e9695b0b
          DIMTRANSACTIONDATE: 7cce1b6d-aeb7-48ba-bc34-41858737db13
          MAXRECEIPTDATE: 22f67685-c788-4d67-a598-ec0d20cd590e
          UCCAMPUS: ff8e6c8c-a21d-4105-b135-1e58792d1cdf
          AGGUCSPEND: af092158-e3f1-41fa-8161-a5166038b69e
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('REPORTS','VWUCSPEND_MISSINGDATES') }} (UCCampusKey, UCCategoryLevel1Key, UCCategoryLevel2Key, UCCategoryLevel3Key, UCCategoryLevel4Key, UCSupplierKey, UCTier1Key, UCTier2Key, UCTier3Key, UCComponentKey, OPSupplierKey, OPSupplierId, OPContractKey, OPContractId, OPContractMappingStatusId, UCSpend, TransactionDateKey, TransactionDate) AS WITH cteAllTransDates AS (
                    SELECT dtd.TransactionDateKey,
                           dtd.TransactionDate
                      FROM {{ ref('DIM','DIMTRANSACTIONDATE') }} AS dtd
                     WHERE dtd.TransactionDateKey BETWEEN 20180101 AND (
                            SELECT REPLACE(MaxReceiptDate,'-','')
                              FROM {{ ref('FACT','MAXRECEIPTDATE') }}
                           )
                       AND dtd.TransactionDateKey LIKE '%01'
                   ),
                   cteAllCampuses AS (
                    SELECT UCCampusKey
                      FROM {{ ref('DIM','UCCAMPUS') }} AS u
                     WHERE u.UCCampusKey > 0
                   ),
                   cteAllUCRowsMinusTransDate AS (
                    SELECT DISTINCT au.UCCategoryLevel1Key,
                           au.UCCategoryLevel2Key,
                           au.UCCategoryLevel3Key,
                           au.UCCategoryLevel4Key,
                           au.UCSupplierKey,
                           au.UCTier1Key,
                           au.UCTier2Key,
                           au.UCTier3Key,
                           NULL AS UCComponentKey,
                           au.OPSupplierKey,
                           au.OPSupplierId,
                           au.OPContractKey,
                           au.OPContractId,
                           au.OPContractMappingStatusId
                      FROM {{ ref('REPORTS','AGGUCSPEND') }} AS au
                     WHERE au.OPContractMappingStatusId IN (1, 2)
                   ),
                   cteAllUCRowsAllDatesAllCampuses AS (
                    SELECT *
                      FROM cteAllUCRowsMinusTransDate AS caaumtd,
                           cteAllCampuses AS cac, --Cross join to generate rows for all Campuses and for all dates
              cteAllTransDates AS catd
                   ) --,
              --cteAllOPRows
              --AS (SELECT DISTINCT
              --		aoarbc.UCCampusKey AS UCCampusKey,
              --		--aoarbc.ContractKey AS OPContractKey,
              --		aoarbc.TransactionDateKey
              -- FROM   OmniaPartnersDW.Reports.AggOPSalesAndRevenueByContract AS aoarbc
              --		INNER JOIN cteAllTransDates AS catd ON aoarbc.TransactionDateKey = catd.TransactionDateKey)
              --cteAllOPRowsWithUCColumns
              --AS (SELECT
              --		cteUC.*
              -- FROM   cteAllUCRowsAllDatesAllCampuses AS cteUC
              --		INNER JOIN cteAllOPRows AS cteOP ON cteOP.UCCampusKey = cteUC.UCCampusKey
              --												AND cteOP.OPContractKey = cteUC.OPContractKey
              --												AND cteOP.TransactionDateKey = cteUC.TransactionDateKey
              -- WHERE  cteUC.UCCategoryLevel1Key IS NOT NULL),
              --SELECT * FROM ctealloprows
              SELECT cteAllUC.UCCampusKey,
                   cteAllUC.UCCategoryLevel1Key,
                   cteAllUC.UCCategoryLevel2Key,
                   cteAllUC.UCCategoryLevel3Key,
                   cteAllUC.UCCategoryLevel4Key,
                   cteAllUC.UCSupplierKey,
                   cteAllUC.UCTier1Key,
                   cteAllUC.UCTier2Key,
                   cteAllUC.UCTier3Key,
                   NULL AS UCComponentKey,
                   cteAllUC.OPSupplierKey,
                   cteAllUC.OPSupplierId,
                   cteAllUC.OPContractKey,
                   cteAllUC.OPContractId,
                   cteAllUC.OPContractMappingStatusId,
                   0 AS UCSpend,
                   cteAllUC.TransactionDateKey,
                   cteAllUC.TransactionDate
              FROM cteAllUCRowsAllDatesAllCampuses AS cteAllUC --INNER JOIN cteAllOPRows AS cteOP ON cteOP.UCCampusKey = cteAllUC.UCCampusKey AND cteOP.TransactionDateKey = cteAllUC.TransactionDateKey

            EXCEPT SELECT DISTINCT au.UCCampusKey,
                   au.UCCategoryLevel1Key,
                   au.UCCategoryLevel2Key,
                   au.UCCategoryLevel3Key,
                   au.UCCategoryLevel4Key,
                   au.UCSupplierKey,
                   au.UCTier1Key,
                   au.UCTier2Key,
                   au.UCTier3Key,
                   NULL AS UCComponentKey,
                   au.OPSupplierKey,
                   au.OPSupplierId,
                   au.OPContractKey,
                   au.OPContractId,
                   au.OPContractMappingStatusId,
                   0 AS UCSpend,
                   au.TransactionDateKey,
                   au.TransactionDate
              FROM {{ ref('REPORTS','AGGUCSPEND') }} AS au
        dependencies:
          - locationName: REPORTS
            nodeName: AGGUCSPEND
          - locationName: DIM
            nodeName: DIMTRANSACTIONDATE
          - locationName: FACT
            nodeName: MAXRECEIPTDATE
          - locationName: DIM
            nodeName: UCCAMPUS
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('REPORTS','AGGUCSPEND') }}
            {{ ref('DIM','DIMTRANSACTIONDATE') }}
            {{ ref('FACT','MAXRECEIPTDATE') }}
            {{ ref('DIM','UCCAMPUS') }}
        name: VWUCSPEND_MISSINGDATES
        noLinkRefs: []
  name: VWUCSPEND_MISSINGDATES
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
