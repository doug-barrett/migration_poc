fileVersion: 1
id: f130a48b-afe0-4eda-855b-15fbc7ae5e43
name: VIEW_AGG_PRODUCT_STATUS_DAILY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_BUSINESS_VAULT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 747fb16e-1f31-421b-b85b-1450a068f201
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 40aa3c9e-9b85-4425-a47b-b0183cd58863
                stepCounter: 3f4b0133-f2a1-4a6f-8a9e-d1722827a6c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5f1cbe4-1cfd-4cd4-9e82-60b523d5212f
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0bcfb8bd-c450-4df1-ac89-7df194a687d5
                stepCounter: 3f4b0133-f2a1-4a6f-8a9e-d1722827a6c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69982050-9778-4f4e-bbc0-13d538bb696d
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a7de6f03-0ffd-477a-937b-88bf3b3ccae8
                stepCounter: 4e2a6ea6-d0f3-4eab-bbf8-8f009848b153
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a2203a3-a783-4f08-8aac-d61491e01c6f
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: VIRTUAL_TERMINAL_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f4edd2d9-6449-47d7-b268-59f617938674
                stepCounter: 4e2a6ea6-d0f3-4eab-bbf8-8f009848b153
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7858bf95-ccf9-43c1-9d6a-3583447e0b35
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b0ce37ba-7d5d-411e-9542-3c10d03146ab
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1b75c885-f165-45f7-81dd-c66170eeab48
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ATTRITION_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b1abc971-613b-411d-827c-1698c8347a72
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69e7c773-9ece-4b68-83d5-d8c252c9a8fa
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3ebb87f2-7920-43be-9a27-bd8275953506
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 97357559-5747-438c-a161-f3f676da7352
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f78b7147-c1d2-4514-8873-2d04b471b3f5
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_RETURNED_TERMINAL
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1c558407-6989-480c-9ede-7d49c67908fc
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6d79ff68-1580-4814-a4b7-102d695dc52d
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f5a26e56-9c64-4ce7-8b8c-d8a528602b10
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d806b194-353c-40a4-8e44-46fe76498757
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0b52f41-5cfe-48f6-8b64-37a76387b756
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c78d6c11-46d4-4975-830b-516b399abf77
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d2a2f0e0-1d42-4fdd-b8f6-30ad9f334681
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 76b1746f-2c41-43b2-8e45-6df68bcccb2a
          stepCounter: f130a48b-afe0-4eda-855b-15fbc7ae5e43
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          DIM_PRODUCT: 4e2a6ea6-d0f3-4eab-bbf8-8f009848b153
          DIM_DATE: 3f4b0133-f2a1-4a6f-8a9e-d1722827a6c7
          R_MERCHANT_PRODUCT: 7e66b47d-86e4-4dea-b98f-dae7b99f5659
          AGG_TERMINAL_STATUS_DAILY: 30542431-b4eb-4818-b026-e351856fefdd
          WHERESCAPE_HIGHWATERMARK: dfc9eeb5-e2d2-426f-a480-1c72f8910676
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ this }}(SNAPSHOT_DATE_ID, SNAPSHOT_DATE, DIM_PRODUCT_ID, VIRTUAL_TERMINAL_PRODUCT_IND, NUMBER_OF_MERCHANT, NUMBER_OF_NEW_MERCHANT, NUMBER_OF_ATTRITION_MERCHANT, NUMBER_OF_ACTIVE_MERCHANT, NUMBER_OF_INACTIVE_MERCHANT, NUMBER_OF_TERMINAL_ALLOCATED, NUMBER_OF_NEW_TERMINAL_ALLOCATED, NUMBER_OF_RETURNED_TERMINAL, NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_TERMINALS_ALLOCATED_USED, NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED, DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY, DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY, NUMBER_OF_SETTLED_TXN_DAILY, NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY)COPY GRANTS AS SELECT d.dim_date_id AS SNAPSHOT_DATE_ID,
                   d.date_desc_date AS SNAPSHOT_DATE,
                   m.DIM_PRODUCT_ID,
                   CASE WHEN m.product_type = 'VIRTUAL' THEN 1
                        ELSE 0
                         END AS VIRTUAL_TERMINAL_PRODUCT_IND,
                   mpd.NUMBER_OF_MERCHANT,
                   mpd.NUMBER_OF_NEW_MERCHANT,
                   mpd.NUMBER_OF_ATTRITION_MERCHANT,
                   COUNT (DISTINCT (CASE WHEN (ts.TERMINAL_ACTIVITY_STATUS) > 0 THEN ts.merchant_identification_number END)) AS NUMBER_OF_ACTIVE_MERCHANT,
                   mpd.NUMBER_OF_MERCHANT - NUMBER_OF_ACTIVE_MERCHANT AS NUMBER_OF_INACTIVE_MERCHANT,
                   count(DISTINCT concat(ts.terminal_serial_number,to_varchar(ts.merchant_identification_number))) AS NUMBER_OF_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.NEW_TERMINAL_INDICATOR = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_NEW_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.RETURNED_TERMINAL_INDICATOR = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_RETURNED_TERMINAL,
                   count(distinct(CASE WHEN ts.TERMINAL_ACTIVITY_STATUS = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.TERMINAL_ACTIVITY_STATUS = 0 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT (CASE WHEN ts.NUMBER_OF_SETTLED_TXN_DAILY > 0 AND m.dim_product_id = ts.dim_product_id THEN concat(ts.terminal_serial_number, to_varchar(ts.merchant_identification_number)) ELSE NULL END)) AS NUMBER_OF_TERMINALS_ALLOCATED_USED, //IF NO transactions THEN NO dim_product_id IN the ts TABLE NUMBER_OF_TERMINAL_ALLOCATED - NUMBER_OF_TERMINALS_ALLOCATED_USED AS NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY END) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY END) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.NUMBER_OF_SETTLED_TXN_DAILY END) AS NUMBER_OF_SETTLED_TXN_CAD_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY END) AS NUMBER_OF_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
              FROM {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} m
             CROSS JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d -- CG: 6/24 comment out join to R
             -- left join {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} mp
             --      on mp.dim_product_id = m.dim_product_id

              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
                ON ts.SNAPSHOT_DATE_ID = d.dim_date_id -- CG: 6/24 change join to use dim_product_key only
              -- and left(ts.terminal_serial_number,2) = m.product_prefix_code
              -- and ts.dim_merchant_id = mp.dim_merchant_id

               AND ts.dim_product_id=m.dim_product_id
              LEFT JOIN (
                    SELECT d.dim_date_id,
                           mp.product_nk,
                           mp.dim_product_id,
                           count(DISTINCT (CASE WHEN date_desc_date>=PRODUCT_ACQUISITION_DATE AND (date_desc_date<=PRODUCT_ATTRITION_DATE OR PRODUCT_ATTRITION_DATE IS NULL) THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_MERCHANT,
                           count(DISTINCT (CASE WHEN date_desc_date=PRODUCT_ACQUISITION_DATE THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_NEW_MERCHANT,
                           count(DISTINCT (CASE WHEN date_desc_date=PRODUCT_ATTRITION_DATE THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_ATTRITION_MERCHANT,

                      FROM {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} mp
                     CROSS JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                     WHERE d.date_desc_date >= (
                            SELECT HIGHWATERMARK
                              FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                             WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_PRODUCT_STATUS_DAILY'
                           )
                       AND d.date_desc_date<current_date()
                       AND d.date_desc_date BETWEEN mp.dss_start_date AND mp.dss_end_date
                       AND d.date_desc_date BETWEEN ifnull(mp.product_acquisition_date, to_date('1900-01-01','yyyy-mm-dd')) AND ifnull(mp.product_attrition_date, to_date('2900-01-01','yyyy-mm-dd'))
                     GROUP BY ALL
                   ) mpd
                ON mpd.dim_date_id = d.dim_date_id
               AND mpd.dim_product_id = m.dim_product_id
             WHERE (d.date_desc_date BETWEEN m.dss_start_date AND m.dss_end_date)--    and (d.date_desc_date between mp.dss_start_date and mp.dss_end_date)

               AND d.date_desc_date >= (
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_PRODUCT_STATUS_DAILY'
                   ) -- and d.date_desc_date<current_date()

               AND d.date_desc_date<(
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'F_SETTLED_TRANSACTIONS'
                   )
             GROUP BY ALL
        dependencies:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_PRODUCT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: R_MERCHANT_PRODUCT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: AGG_TERMINAL_STATUS_DAILY
          - locationName: DATAVAULT_LOAD
            nodeName: WHERESCAPE_HIGHWATERMARK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }}
            {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
        name: VIEW_AGG_PRODUCT_STATUS_DAILY
        noLinkRefs: []
  name: VIEW_AGG_PRODUCT_STATUS_DAILY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
