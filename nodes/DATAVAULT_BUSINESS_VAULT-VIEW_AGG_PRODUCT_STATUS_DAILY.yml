fileVersion: 1
id: 0984ff77-bf55-43e6-96f4-36fc892cd53b
name: VIEW_AGG_PRODUCT_STATUS_DAILY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_BUSINESS_VAULT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ddfb49dc-dd79-428d-a19b-d21c83938352
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f583aa90-1525-4b60-897c-b626691934da
                stepCounter: 5205e907-f7fe-42c2-9d8b-5f54fad2bc2d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 129b021c-a2ba-4482-9fed-e8816c73034e
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5bf8da3c-1443-47be-8b23-b7f2cfe377e1
                stepCounter: 5205e907-f7fe-42c2-9d8b-5f54fad2bc2d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 063efe72-4c47-4ef9-8cb1-6575eba442ec
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b6c79f15-09be-4485-bb06-429854f2fbd9
                stepCounter: 68b26aea-5844-4383-a6af-26567a1a0d03
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8d5c5db4-8505-4514-b8bb-cdac0817e272
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: VIRTUAL_TERMINAL_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0fc51379-3c17-4ee8-8ff6-c29ed0a1d21a
                stepCounter: 68b26aea-5844-4383-a6af-26567a1a0d03
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5cbd2a52-f13d-4c21-bd72-ecd80cee4fab
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a14e32c-5a03-461b-91c7-b10c7216748b
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7ddd818b-6c7d-450a-8c4f-211a7b0f0ff7
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ATTRITION_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69c3bc7b-76f4-4f6f-bd53-a891c98f1c1a
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 090a17d0-ed26-4473-b811-c265702fda61
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_MERCHANT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6305911-16db-4d6e-ac4f-0296e6da84e2
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b706a338-a381-44aa-8577-2a7cb729adc8
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 859348d3-3f98-4bbb-b1dd-9b1177cedabb
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_RETURNED_TERMINAL
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ef90b4ae-2605-47ee-abc2-c65ca90f5884
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 762ad8c2-c0f3-4113-b875-2e3d6c3e7017
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 82697cb7-1c3f-4e0f-9bff-088f5af2982d
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d578ea0-287e-4f6f-a2c1-51721cc0af8f
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 60fd5fd6-8552-4b05-ac3a-2a3e5029f947
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e7388dcc-4dbd-4d96-a81a-3740a4438458
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 668b7543-0bd3-47a0-ac22-4f8e4b9c00e3
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 536e4469-f8c1-4c9c-9a5b-7af37eca9144
          stepCounter: 0984ff77-bf55-43e6-96f4-36fc892cd53b
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          DIM_PRODUCT: 68b26aea-5844-4383-a6af-26567a1a0d03
          DIM_DATE: 5205e907-f7fe-42c2-9d8b-5f54fad2bc2d
          R_MERCHANT_PRODUCT: 57336d7c-e67a-4569-acd6-06b71f48cc6d
          AGG_TERMINAL_STATUS_DAILY: b029ce95-a38a-45e8-8844-b2e969005f44
          WHERESCAPE_HIGHWATERMARK: 843b61c6-a56b-4475-b286-0faf8df70518
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ this }}(SNAPSHOT_DATE_ID, SNAPSHOT_DATE, DIM_PRODUCT_ID, VIRTUAL_TERMINAL_PRODUCT_IND, NUMBER_OF_MERCHANT, NUMBER_OF_NEW_MERCHANT, NUMBER_OF_ATTRITION_MERCHANT, NUMBER_OF_ACTIVE_MERCHANT, NUMBER_OF_INACTIVE_MERCHANT, NUMBER_OF_TERMINAL_ALLOCATED, NUMBER_OF_NEW_TERMINAL_ALLOCATED, NUMBER_OF_RETURNED_TERMINAL, NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_TERMINALS_ALLOCATED_USED, NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED, DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY, DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY, NUMBER_OF_SETTLED_TXN_DAILY, NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY)COPY GRANTS AS SELECT d.dim_date_id AS SNAPSHOT_DATE_ID,
                   d.date_desc_date AS SNAPSHOT_DATE,
                   m.DIM_PRODUCT_ID,
                   CASE WHEN m.product_type = 'VIRTUAL' THEN 1
                        ELSE 0
                         END AS VIRTUAL_TERMINAL_PRODUCT_IND,
                   mpd.NUMBER_OF_MERCHANT,
                   mpd.NUMBER_OF_NEW_MERCHANT,
                   mpd.NUMBER_OF_ATTRITION_MERCHANT,
                   COUNT (DISTINCT (CASE WHEN (ts.TERMINAL_ACTIVITY_STATUS) > 0 THEN ts.merchant_identification_number END)) AS NUMBER_OF_ACTIVE_MERCHANT,
                   mpd.NUMBER_OF_MERCHANT - NUMBER_OF_ACTIVE_MERCHANT AS NUMBER_OF_INACTIVE_MERCHANT,
                   count(DISTINCT concat(ts.terminal_serial_number,to_varchar(ts.merchant_identification_number))) AS NUMBER_OF_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.NEW_TERMINAL_INDICATOR = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_NEW_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.RETURNED_TERMINAL_INDICATOR = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_RETURNED_TERMINAL,
                   count(distinct(CASE WHEN ts.TERMINAL_ACTIVITY_STATUS = 1 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED,
                   count(distinct(CASE WHEN ts.TERMINAL_ACTIVITY_STATUS = 0 THEN ts.TERMINAL_SERIAL_NUMBER ELSE NULL END)) AS NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT (CASE WHEN ts.NUMBER_OF_SETTLED_TXN_DAILY > 0 AND m.dim_product_id = ts.dim_product_id THEN concat(ts.terminal_serial_number, to_varchar(ts.merchant_identification_number)) ELSE NULL END)) AS NUMBER_OF_TERMINALS_ALLOCATED_USED, //IF NO transactions THEN NO dim_product_id IN the ts TABLE NUMBER_OF_TERMINAL_ALLOCATED - NUMBER_OF_TERMINALS_ALLOCATED_USED AS NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY END) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY END) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.NUMBER_OF_SETTLED_TXN_DAILY END) AS NUMBER_OF_SETTLED_TXN_CAD_DAILY,
                   sum(CASE WHEN m.dim_product_id = ts.dim_product_id THEN ts.NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY END) AS NUMBER_OF_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
              FROM {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} m
             CROSS JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d -- CG: 6/24 comment out join to R
             -- left join {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} mp
             --      on mp.dim_product_id = m.dim_product_id

              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
                ON ts.SNAPSHOT_DATE_ID = d.dim_date_id -- CG: 6/24 change join to use dim_product_key only
              -- and left(ts.terminal_serial_number,2) = m.product_prefix_code
              -- and ts.dim_merchant_id = mp.dim_merchant_id

               AND ts.dim_product_id=m.dim_product_id
              LEFT JOIN (
                    SELECT d.dim_date_id,
                           mp.product_nk,
                           mp.dim_product_id,
                           count(DISTINCT (CASE WHEN date_desc_date>=PRODUCT_ACQUISITION_DATE AND (date_desc_date<=PRODUCT_ATTRITION_DATE OR PRODUCT_ATTRITION_DATE IS NULL) THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_MERCHANT,
                           count(DISTINCT (CASE WHEN date_desc_date=PRODUCT_ACQUISITION_DATE THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_NEW_MERCHANT,
                           count(DISTINCT (CASE WHEN date_desc_date=PRODUCT_ATTRITION_DATE THEN mp.merchant_nk ELSE NULL END)) AS NUMBER_OF_ATTRITION_MERCHANT,

                      FROM {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} mp
                     CROSS JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                     WHERE d.date_desc_date >= (
                            SELECT HIGHWATERMARK
                              FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                             WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_PRODUCT_STATUS_DAILY'
                           )
                       AND d.date_desc_date<current_date()
                       AND d.date_desc_date BETWEEN mp.dss_start_date AND mp.dss_end_date
                       AND d.date_desc_date BETWEEN ifnull(mp.product_acquisition_date, to_date('1900-01-01','yyyy-mm-dd')) AND ifnull(mp.product_attrition_date, to_date('2900-01-01','yyyy-mm-dd'))
                     GROUP BY ALL
                   ) mpd
                ON mpd.dim_date_id = d.dim_date_id
               AND mpd.dim_product_id = m.dim_product_id
             WHERE (d.date_desc_date BETWEEN m.dss_start_date AND m.dss_end_date)--    and (d.date_desc_date between mp.dss_start_date and mp.dss_end_date)

               AND d.date_desc_date >= (
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_PRODUCT_STATUS_DAILY'
                   ) -- and d.date_desc_date<current_date()

               AND d.date_desc_date<(
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'F_SETTLED_TRANSACTIONS'
                   )
             GROUP BY ALL
        dependencies:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_PRODUCT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: R_MERCHANT_PRODUCT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: AGG_TERMINAL_STATUS_DAILY
          - locationName: DATAVAULT_LOAD
            nodeName: WHERESCAPE_HIGHWATERMARK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }}
            {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
        name: VIEW_AGG_PRODUCT_STATUS_DAILY
        noLinkRefs: []
  name: VIEW_AGG_PRODUCT_STATUS_DAILY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
