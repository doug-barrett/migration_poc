fileVersion: 1
id: 4bb9e18f-f298-4dcb-95d1-95b168315b70
name: AGG_CONTRACTUSAGEBYRECEIPTDATE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fb24fa63-f450-46c3-b236-20f9b2971e9e
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: INT
        defaultValue: ""
        description: UNIQUE IDENTIFIER FOR AN ACCOUNT. COMMONLY CALLED THE "FORCE ID"
        isBusinessKey: true
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7a3160ab-05f3-4f3a-9c6b-05cb492a0191
                stepCounter: cf63e7ee-ad3f-42c5-9d06-e2eea3cdc91e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 032e600f-2e51-4d64-b3ed-4474bdde62b0
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: PPACONTRACTNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 60f302b0-2a23-47c6-93e2-1f96acb5ecdc
                stepCounter: 84116e71-ebf6-4262-b818-71628fbd5079
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 81f97832-7fae-4656-a972-0b8bfe9a53af
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: THE RECEIPT DATE CALENDAR QUARTER REPRESENTATION. FORMAT YYYYQQ. EXAMPLE 200204.
        isBusinessKey: true
        name: RECEIPTDATECALQUARTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3bdc27de-bd3d-4377-a8ae-bf8a55c40557
                stepCounter: adf141a9-8097-453e-8fe9-345cd1cc4c90
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 40683b55-7e3f-4eb1-b21c-39d5d852b4c6
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: SALES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3593ab52-5241-4ba6-9c64-87170e135296
                stepCounter: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
            transform: SUM(SALESANDREVENUE.SALES)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dafd6ca6-b4cf-4d27-a38a-f4004443c5fa
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 19b36c8d-6f61-4475-beeb-42cf99c19490
                stepCounter: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
            transform: SUM(SALESANDREVENUE.REVENUE)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 717e0712-6f78-45e3-9296-a95f58cf873b
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: BOOLEAN
        defaultValue: ""
        description: ""
        name: ISFIRSTTIMEUSINGCONTRACT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3097ca9-a4fa-47b0-988e-e502e3f86508
                stepCounter: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
            transform: |-
              -- IS THIS THE VERY 1ST TIME USING THIS CONTRACT?
              \NIFF(LAG(RECEIPTDATECALQUARTER, 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,RECEIPTDATECALQUARTER) IS NULL, 1, 0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5f34fd8d-40b9-4ad4-90a4-216369e5e7f8
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: ISCONTRACTUSENEWORRECURRINGINTRAILING12MONTHS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3097ca9-a4fa-47b0-988e-e502e3f86508
                stepCounter: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
            transform: |-
              --NEW OR RECURRING IN A ROLLING 4 QUARTER TIMELINE
              \N IFF(\N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER, DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01'))) <= 4, 'RECURRING', 'NEW')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f7f62fb3-bf28-4686-8c70-d8920b93f1b8
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: QUARTERSSINCECONTRACTUSE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3097ca9-a4fa-47b0-988e-e502e3f86508
                stepCounter: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
            transform: |-
              --QUARTERS SINCE LAST USE
              \N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0e8f3c77-464a-40ad-9ffb-44afbb2a84db
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS CREATED IN THE DATA WAREHOUSE.
        name: DSSCREATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8557a7ed-2ce1-4824-b074-61bec0ba7e19
          stepCounter: 4bb9e18f-f298-4dcb-95d1-95b168315b70
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS UPDATED IN THE DATA WAREHOUSE.
        name: DSSUPDATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          SALESANDREVENUE: cd36f532-f0d8-47ba-b9d6-84ea35d998c4
          ACCOUNT: cf63e7ee-ad3f-42c5-9d06-e2eea3cdc91e
          CONTRACT: 84116e71-ebf6-4262-b818-71628fbd5079
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DIM
            nodeName: ACCOUNT
          - locationName: DIM
            nodeName: CONTRACT
          - locationName: DIM
            nodeName: DIM_RECEIPTDATE
          - locationName: FACT
            nodeName: SALESANDREVENUE
          - locationName: UNKNOWN
            nodeName: DIMRECEIPTDATE
        join:
          joinCondition: |-
            FROM {{ ref('FACT','SALESANDREVENUE') }} SALESANDREVENUE
              LEFT JOIN {{ ref('DIM','ACCOUNT') }} ACCOUNT
                ON SALESANDREVENUE.ACCOUNTKEY = ACCOUNT.ACCOUNTKEY
              LEFT JOIN {{ ref('DIM','CONTRACT') }} CONTRACT
                ON SALESANDREVENUE.CONTRACTKEY = CONTRACT.CONTRACTKEY
              LEFT JOIN {{ ref('UNKNOWN','DIMRECEIPTDATE') }} DIMRECEIPTDATE
                ON SALESANDREVENUE.RECEIPTDATEKEY = DIMRECEIPTDATE.RECEIPTDATEKEY
             GROUP BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
             ORDER BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
        name: AGGCONTRACTUSAGEBYRECEIPTDATE
        noLinkRefs: []
  name: AGG_CONTRACTUSAGEBYRECEIPTDATE
  overrideSQL: false
  schema: ""
  sqlType: Agreggate
  type: sql
  version: 1
type: Node
