fileVersion: 1
id: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
name: S_IN_PATIENT_PACKAGE_OF_CARE_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 02f96056-f453-4ae6-8b83-7e5fb5ea44d9
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2f06a6c-bc2b-4943-a499-b407228ccabd
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e8204349-c550-4d24-8215-7ad2ded0c28c
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PRVSP_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7cff4549-e4d1-4017-bf29-30b53f4821ef
                stepCounter: ab7b9f91-81b3-4d0a-bd4c-90aa5d071bb9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67d44230-1021-416b-9a74-0780601b6368
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: VISIT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a857c78-a6ec-4af5-930b-651e3af23ef1
                stepCounter: a455ee5e-c4dc-455f-9b22-78d1cfa0c2c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7e66ada4-fa57-4825-8d36-e81c8ae3305c
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: surgical_theatre_group
        name: SURGICAL_THEATRE_GROUP
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 83f665b1-5917-4560-bcc5-f026dceaf20f
                stepCounter: 50d37543-6dd1-4ea0-bfe9-dc03dfc2dacc
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8dbebfb8-f997-49db-a635-c48cbe8e8f06
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ADMET_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fe88ae47-348e-4763-a51d-6f659c2307ee
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17901391-c40b-49f0-80d3-42b32570a53e
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d98142f0-f261-4055-ad8c-581c6636e853
                stepCounter: 04c42cb2-f015-4d9e-ae6d-9feed9f13b97
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0fd90985-a793-42ed-b89a-2f3b6493404f
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: STAY_SPONT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d472e0a-9450-43d9-8936-e9c7bcb46f38
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 608671f1-8e6b-4c6b-8e16-447a71462541
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Service_Point_Code
        name: ADMISSION_WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1280e451-eee5-4077-9a68-99dfa6db80b6
                stepCounter: 0b4f315f-51cb-4593-8623-b32f3fc664aa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6d4772e6-aaec-4c27-8071-7d77ea95c67c
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: ""
        name: PACKAGE_OF_CARE_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: '1'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4b50d717-fd6f-4c04-8e06-92b9e6e90cd5
          stepCounter: 3535886b-7bb2-4ec9-ad3a-4e898296ea4f
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 541d5e00-ace7-4e03-80cc-5ec38ebe3b34
                stepCounter: a455ee5e-c4dc-455f-9b22-78d1cfa0c2c9
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT sty.event_encounter_id,
                   sty.prvsp_refno,
                   sch.start_date,
                   th.surgical_theatre_group,
                   sty.admet_refno,
                   ad.admission_type_code,
                   sty.stay_spont_refno,
                   sty.stay_service_point_code admission_ward_code,
                   CONVERT(varchar(1), 'Y') package_of_care_flag,
                   'iPM' source_system
              FROM ds_shared_schedule sch
              JOIN s_in_patient_stay_05 sty
                ON sty.prvsp_refno = sch.prvsp_refno
               AND sty.event_stay_seq_num = 1
              JOIN dim.dim_surgical_theatre th
                ON sch.ward_reference_no = th.surgical_theatre_reference_no
              JOIN dim.dim_admission_type ad
                ON sty.admet_refno = ad.admission_method_reference_no
               AND ad.dss_current_flag = 'Y'
             WHERE sch.schedule_type_code = 'THEAT'
               AND th.surgical_theatre_group = 'ESC'
               AND ad.admission_type_code <> 'AC'
               AND sty.stay_service_point_code IN ('ESCSU','ESCPU','ESCN')
            UNION ALL SELECT sty.event_encounter_id,
                   sty.prvsp_refno,
                   ct.visit_start_date,
                   th.surgical_theatre_group,
                   sty.admet_refno,
                   ty.admission_type_code,
                   sty.stay_spont_refno,
                   aw.admission_ward_code,
                   'Y' package_of_care_flag,
                   ct.source_system
              FROM s_consolidate_theatre ct
              JOIN dim.dim_surgical_theatre th
                ON ct.dim_surgical_theatre_key = th.dim_surgical_theatre_key
              JOIN s_in_patient_stay_05 sty
                ON ct.IP_Event_encounter_ID = sty.event_encounter_id
               AND sty.event_stay_seq_num = 1
              JOIN dim.dim_admission_type ty
                ON sty.admet_refno = ty.admission_method_reference_no
               AND ty.dss_current_flag = 'Y'
              JOIN dim.dim_admission_ward aw
                ON sty.stay_spont_refno = aw.admission_ward_reference_no
             WHERE ct.source_system = 'Nexus'
               AND ct.patient_theatre_visit_seq_num = 1
               AND th.surgical_theatre_group = 'ESC'
               AND ty.admission_type_code <> 'AC'
               AND aw.admission_ward_code IN ('ESCSU','ESCPU','ESCN')
        dependencies:
          - locationName: TGT
            nodeName: S_IN_PATIENT_STAY_05
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_IN_PATIENT_STAY_05') }}
        name: S_IN_PATIENT_PACKAGE_OF_CARE_V
        noLinkRefs: []
  name: S_IN_PATIENT_PACKAGE_OF_CARE_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
