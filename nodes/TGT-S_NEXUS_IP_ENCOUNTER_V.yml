fileVersion: 1
id: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
name: S_NEXUS_IP_ENCOUNTER_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d8dd87a8-81f2-486a-93e9-2775a5003cd9
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INT
        defaultValue: ""
        description: rnth
        name: RNTH
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: row_number() over(PARTITION BY event_encounter_id ORDER BY theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 63ec29c2-b1a6-4c3a-a04e-531de34d7936
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: THEATRE_VISIT_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 21fdd8a3-74d7-44a4-8117-34c976253c45
                stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a255f204-7771-4952-a19e-d47bc9ab32d9
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IP_EVENT_ENCOUNTER_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2f06a6c-bc2b-4943-a499-b407228ccabd
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1614fd8b-edcd-4f7e-8ac1-d7b9b37fb455
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_STAY_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4fc97f3a-689a-4512-9dbe-6c82df8c8a8f
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b87e0418-4af6-4942-aa3a-899ea9dbf3d6
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PATIENT_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4fc97f3a-689a-4512-9dbe-6c82df8c8a8f
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 030e9257-854e-4f96-bd4e-1ab24bc39b92
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_WARD_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d472e0a-9450-43d9-8936-e9c7bcb46f38
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 525a034e-6ba6-4a9b-9566-cd7b88a32769
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_ADMISSION_METHOD_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fe88ae47-348e-4763-a51d-6f659c2307ee
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c790a4ad-48d3-46e4-bb74-a254b1de6ec4
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IP_SPECIALTY_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5a1e57d-a116-42f9-aeab-92b2bd78279c
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ca1e2458-6ab8-4436-b9d8-ec6e81851b1f
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_STAY_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a81084e6-9d1e-4ba7-943e-da806b2afba1
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ffb9eea4-34c8-4ba4-be0c-490f0e5efb05
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: IP_STAY_END_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: acf1501d-b3bf-4770-a8eb-377c17b5bb68
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6405408d-c937-4547-858b-917a46c67ad6
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: THEATRE_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7349756b-de68-487e-8b06-19c2f376cf7e
                stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c1e45a03-fd67-4348-a923-11265ade6307
          stepCounter: 9c497e95-bd86-4a4c-b8ef-b9733209a38b
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ACC_CLAIM_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a9799d00-15a5-4b26-800d-2df2ea777c0b
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT row_number() over(PARTITION BY event_encounter_id ORDER BY theatre_date),
                   opnumber theatre_visit_reference_no,
                   event_encounter_id IP_event_encounter_id,
                   stay_patnt_refno patient_reference_no,
                   sstay_refno IP_stay_reference_no,
                   stay_spont_refno IP_ward_reference_no,
                   admet_refno IP_admission_method_reference_no,
                   event_spect_refno IP_specialty_reference_no,
                   stay_start_date IP_stay_start_date,
                   stay_end_date IP_stay_end_date,
                   theatre_date theatre_date,
                   ACC_Claim_no
              FROM (
                    SELECT stay_patnt_refno,
                           event_encounter_id,
                           opnumber,
                           IFNULL(stay_spont_refno,event_spont_refno) stay_spont_refno,
                           event_spect_refno,
                           sstay_refno,
                           admet_refno,
                           stay_start_date,
                           stay_end_date,
                           COALESCE ((SELECT min(i) FROM (VALUES(IFNULL(s_nexus_visit_05.anaesthetic_start_date,convert(datetime,'2044-12-30',120))) ,(IFNULL(s_nexus_visit_05.into_theatre_date,convert(datetime,'2044-12-30',120)))) AS T(i)),s_nexus_visit_05.arrived_Date,s_nexus_visit_05.theatre_start_date,s_nexus_visit_05.session_end_date) theatre_date ,
                           ACC_claim_no
                      FROM s_in_patient_stay_05
                     INNER JOIN ds_pims_patients
                        ON s_in_patient_stay_05.event_patnt_refno = ds_pims_patients.patnt_refno
                     INNER JOIN s_nexus_visit_05
                        ON s_nexus_visit_05.hospnumber = ds_pims_patients.pasid
                       AND (COALESCE ((SELECT min(i) FROM (VALUES(IFNULL(s_nexus_visit_05.anaesthetic_start_date,convert(datetime,'2044-12-30',120))),(IFNULL(s_nexus_visit_05.into_theatre_date,convert(datetime,'2044-12-30',120)))) AS T(i)),s_nexus_visit_05.arrived_Date,s_nexus_visit_05.theatre_start_date,s_nexus_visit_05.session_end_date) BETWEEN s_in_patient_stay_05.stay_start_date AND IFNULL(s_in_patient_stay_05.stay_end_date,GETDATE()) OR COALESCE ((SELECT min(i) FROM (VALUES(IFNULL(s_nexus_visit_05.anaesthetic_start_date,convert(datetime,'2044-12-30',120))),(IFNULL(s_nexus_visit_05.into_theatre_date,convert(datetime,'2044-12-30',120)))) AS T(i)),s_nexus_visit_05.arrived_Date,s_nexus_visit_05.session_end_date,s_nexus_visit_05.theatre_start_date) BETWEEN s_in_patient_stay_05.stay_start_date AND IFNULL(s_in_patient_stay_05.stay_end_date,GETDATE()))
                   ) s_in_patient_stay_05
        dependencies: []
        join:
          joinCondition: None
        name: S_NEXUS_IP_ENCOUNTER_V
        noLinkRefs: []
  name: S_NEXUS_IP_ENCOUNTER_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
