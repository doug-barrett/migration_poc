fileVersion: 1
id: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_BUSINESS_VAULT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 858b3823-2dcc-4fc7-8c43-b8aa36a01e61
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1c746faa-86fa-490b-b1d9-37bc29326233
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 030e22e3-ad21-4e38-b1ea-dd97286088e9
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d5575f85-54f0-4537-adf1-3caab7f0bce6
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8f12101a-d470-4f0a-bcda-0d991055e860
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5b5c1bc5-3bd2-441b-86b3-6223a6a71479
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e2da3053-00f8-4f8d-8afa-81e5b54452bc
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_MERCHANT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 080dc560-4d66-421a-96df-4dd4c3fde3ef
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8aa612a4-9c42-4fc3-b3de-8e8f6c481fbb
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: VIRTUAL_TERMINAL_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3b4493b3-f818-4552-b5b8-588ea8427ef1
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5c29e929-a6cf-4c0a-baa9-0d21ea8ead12
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: ACTIVE_MERCHANT_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3c56bf67-fbd7-4e8c-8972-e152b3508e2a
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b606651-ff87-4ab7-904b-d878a96c2893
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: PRODUCT_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 83dc955a-b87b-4edd-b898-5db46aaae1b7
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0494b262-b6c6-4332-b18d-20321a4372d7
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: PRODUCT_ACQUISITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 92021495-641c-40a5-a510-864c1aa715d0
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a78bebf4-1341-4a3c-a972-cd0576543402
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: PRODUCT_ATTRITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fb55cc98-7c8d-4469-a5be-79ea71867f3e
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 29b0642a-7e8e-4720-856d-deb1c50feaf4
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: PRODUCT_ATTRITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 50633519-98b3-48db-bc02-67f444b18f9d
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 06cadbc9-0754-48d2-8823-e2cc85b2746f
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_ACQUISITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f71af4e-922b-4876-9012-42daab2d32a4
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 877b44d9-6210-4320-8558-41ef9fcca633
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_ATTRITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cce6618e-2810-4156-8cdf-12f73c3311f3
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 09d0567b-1622-41d0-a37b-f1d6c1728f3c
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MONTH_ON_BOOK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d39a0c3a-3de1-45ef-b051-6f297c077e7d
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2008ec76-6215-4324-9924-9175047edaa3
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2fa7e255-da08-4725-bd34-5e9214dd097b
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18555e40-47a7-4d59-bbdc-5376c1b6bde4
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e52c28b3-f28c-4c89-845f-beaaaa4a8b3c
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 445fc466-6e3a-4c95-8c53-0268118f6e9b
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_RETURNED_TERMINAL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9e69ed69-e5b9-4096-ba0c-abbb182ea361
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8fc841fc-bd2c-4f6e-ac29-2f3e7783942a
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ababf4ff-c3ed-4a40-818a-3e5650e4c211
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5198e9c7-1b13-4c54-808e-ce88cd3de594
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4821e1be-7e70-4b2c-8b05-e4b936dc7ea6
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c623118-fb86-4198-897f-3529434bdddf
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 052f4344-9527-49ae-95ad-3d87510697d9
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 24d4f221-62e4-40dd-8359-54dd4d124c45
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 21820de8-09df-4fba-b398-584b7b8cb7e2
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fb642fc8-6f07-4be2-af29-47971176a84f
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 27dc8b48-6a7f-4f47-997b-59edc189f4a8
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 487c4e2b-7ec5-430f-bd79-78e58fb9ca5d
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b49460ca-92bd-406f-bd2d-9167e87a6ce8
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59faf659-a71b-4dd8-be3b-950a9ec3a429
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f58c4fce-04a9-49ee-935a-14ce96555583
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a3f3dd9-3cda-4ef7-b931-128c1886bc14
          stepCounter: 5c73c06c-7a61-4e2d-a4d4-c748e4dc75c6
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 55dffa18-a056-4609-a12f-bbffb94b3f70
                stepCounter: e1338155-b443-44b1-acf3-ee4747596067
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          AGG_MERCHANT_PRODUCT_STATUS_DAILY: e1338155-b443-44b1-acf3-ee4747596067
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ this }}(SNAPSHOT_DATE_ID, SNAPSHOT_DATE, DIM_PRODUCT_ID, DIM_MERCHANT_ID, VIRTUAL_TERMINAL_PRODUCT_IND, ACTIVE_MERCHANT_PRODUCT_IND, PRODUCT_ACQUISITION_DATE, PRODUCT_ACQUISITION_IND, PRODUCT_ATTRITION_DATE, PRODUCT_ATTRITION_IND, MERCHANT_ACQUISITION_IND, MERCHANT_ATTRITION_IND, MONTH_ON_BOOK, NUMBER_OF_TERMINAL_ALLOCATED, NUMBER_OF_NEW_TERMINAL_ALLOCATED, NUMBER_OF_RETURNED_TERMINAL, NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_TERMINALS_ALLOCATED_USED, NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED, DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY, DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY, NUMBER_OF_SETTLED_TXN_DAILY, NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY)COPY GRANTS AS WITH merchant_terminal_daily AS (
                    SELECT ts.SNAPSHOT_DATE_ID,
                           ts.dim_merchant_id,
                           left(ts.terminal_serial_number,2) AS PRODUCT_PREFIX_CODE,
                           count(DISTINCT terminal_serial_number) AS NUMBER_OF_TERMINAL_ALLOCATED,

                      FROM {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
                      JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                        ON dim_date_id = ts.snapshot_date_id
                     WHERE d.date_desc_date >= (
                            SELECT HIGHWATERMARK
                              FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                             WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_MERCHANT_PRODUCT_STATUS_DAILY'
                           )
                       AND d.date_desc_date<current_date() //
                       AND d.date_desc_date BETWEEN ifnull(mp.product_acquisition_date, to_date('1900-01-01','yyyy-mm-dd')) AND ifnull(mp.product_attrition_date, to_date('2900-01-01','yyyy-mm-dd')) --

                     GROUP BY ALL
                   ) ---end of get number of terminals--
             SELECT d.dim_date_id AS SNAPSHOT_DATE_ID,
                   d.date_desc_date AS SNAPSHOT_DATE,
                   ts.dim_product_id,
                   ts.DIM_MERCHANT_ID,
                   CASE WHEN p.product_type = 'VIRTUAL' THEN 1
                        ELSE 0
                         END AS VIRTUAL_TERMINAL_PRODUCT_IND,
                   CASE WHEN sum(ts.TERMINAL_ACTIVITY_STATUS)>0 THEN 1
                        ELSE 0
                         END ACTIVE_MERCHANT_PRODUCT_IND,
                   rmp.PRODUCT_ACQUISITION_DATE,
                   CASE WHEN rmp.PRODUCT_ACQUISITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS PRODUCT_ACQUISITION_IND,
                   rmp.PRODUCT_ATTRITION_DATE,
                   CASE WHEN rmp.PRODUCT_ATTRITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS PRODUCT_ATTRITION_IND,
                   CASE WHEN mr.MERCHANT_ACQUISITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS MERCHANT_ACQUISITION_IND,
                   CASE WHEN mr.MERCHANT_ATTRITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS MERCHANT_ATTRITION_IND,
                   DATEDIFF('month', mr.MERCHANT_ACQUISITION_DATE, d.DATE_DESC_DATE) + 1 AS MONTH_ON_BOOK,
                   mtd.NUMBER_OF_TERMINAL_ALLOCATED AS NUMBER_OF_TERMINAL_ALLOCATED,
                   sum(ts.NEW_TERMINAL_INDICATOR) AS NUMBER_OF_NEW_TERMINAL_ALLOCATED,
                   sum(ts.RETURNED_TERMINAL_INDICATOR) AS NUMBER_OF_RETURNED_TERMINAL,
                   count(DISTINCT CASE WHEN ts.TERMINAL_ACTIVITY_STATUS=1 THEN terminal_serial_number ELSE NULL END) AS NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT CASE WHEN ts.TERMINAL_ACTIVITY_STATUS=0 THEN terminal_serial_number ELSE NULL END) AS NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT (CASE WHEN ts.NUMBER_OF_SETTLED_TXN_DAILY>0 AND rmp.dim_product_id = ts.dim_product_id THEN concat(ts.terminal_serial_number, to_varchar(ts.merchant_identification_number)) ELSE NULL END)) AS NUMBER_OF_TERMINALS_ALLOCATED_USED, //IF NO transactions THEN NO dim_product_id IN the ts TABLE NUMBER_OF_TERMINAL_ALLOCATED - NUMBER_OF_TERMINALS_ALLOCATED_USED AS NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY END)) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY END)) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.NUMBER_OF_SETTLED_TXN_DAILY END)) AS NUMBER_OF_SETTLED_TXN_CAD_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY END)) AS NUMBER_OF_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
              FROM {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
              JOIN merchant_terminal_daily mtd
                ON mtd.dim_merchant_id = ts.dim_merchant_id
               AND mtd.product_prefix_code = left(ts.terminal_serial_number,2)
               AND mtd.SNAPSHOT_DATE_ID = ts.SNAPSHOT_DATE_ID
              JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                ON dim_date_id = ts.snapshot_date_id
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} p
                ON p.dim_product_id=ts.dim_product_id
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} rmp
                ON rmp.dim_product_id=ts.dim_product_id
               AND rmp.dim_merchant_id=ts.dim_merchant_id
               AND d.date_desc_date BETWEEN rmp.dss_start_date AND rmp.dss_end_date --SM 6/24/2025: removing subquery as it results in null product_ids
             /*

            left join

                (SELECT r.dim_merchant_id, p.dim_product_id, r.product_acquisition_date, r.product_attrition_date, p.product_prefix_code, p.product_type, p.dss_start_date, p.dss_end_date, r.dss_start_date as r_dss_start_date, r.dss_end_date as r_dss_end_date

              from {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} r

                join {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} p on p.dim_product_id = r.dim_product_id

            ) as rmp

                on   ts.dim_merchant_id = rmp.dim_merchant_id and rmp.product_prefix_code = left(ts.terminal_serial_number,2)

            and d.date_desc_date between rmp.dss_start_date and rmp.dss_end_date

            and d.date_desc_date between rmp.r_dss_start_date and rmp.r_dss_end_date

            */
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }} mr
                ON mr.dim_merchant_id = mtd.dim_merchant_id
               AND d.date_desc_date BETWEEN mr.dss_start_date AND mr.dss_end_date
             WHERE (d.date_desc_date BETWEEN mr.dss_start_date AND mr.dss_end_date)
               AND d.date_desc_date >= (
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_MERCHANT_PRODUCT_STATUS_DAILY'
                   ) -- and d.date_desc_date<current_date()

               AND d.date_desc_date<(
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'F_SETTLED_TRANSACTIONS'
                   )
             GROUP BY ALL
        dependencies:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: AGG_TERMINAL_STATUS_DAILY
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_MERCHANT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_PRODUCT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: R_MERCHANT_PRODUCT
          - locationName: DATAVAULT_LOAD
            nodeName: WHERESCAPE_HIGHWATERMARK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref_no_link('DATAVAULT_INFORMATION_MART','AGG_MERCHANT_PRODUCT_STATUS_DAILY') }}
            {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }}
            {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }}
        name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
        noLinkRefs: []
  name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
