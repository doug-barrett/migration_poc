fileVersion: 1
id: aa9c8681-2029-4348-9c34-14d0658efa69
name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_BUSINESS_VAULT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5680d459-0f6c-4fcf-8fcd-59aef667eb8d
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1b551e8b-ab21-47ea-bcdf-e43093de02d9
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d813e44c-b6f3-4bc2-b6c7-a3c0b034dbdc
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: SNAPSHOT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a2ef0c7d-08a0-49bc-87ed-f4ce8e959fd2
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1adab17c-5422-47f0-9a4b-6cba5b2331f8
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f69c08d-4c8f-4bca-9e5d-35192d823604
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7552acb2-bc7e-462a-854d-64a55a2ad1ca
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: DIM_MERCHANT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 16f7aff4-7d58-4dc9-bc21-bbc1d19d572f
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f456812-355a-4c61-85ef-d2ac5c7b67af
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: VIRTUAL_TERMINAL_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2231e221-285c-4882-9b3c-3d17b2fdd564
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c61eee83-dc1a-46be-82a6-2ce5c9b15c3d
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: ACTIVE_MERCHANT_PRODUCT_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4d461db4-fa6e-4d2c-9958-16287eec4f78
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6aec0740-3683-4c18-9161-5ed242609d96
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: PRODUCT_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dd1902d5-a2d1-4490-8c3a-c0bbc3a176e9
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0dfbb0a-4e05-4576-866b-3c9925a84cc1
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: PRODUCT_ACQUISITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 53c3b19b-dfe0-40c2-abee-75eae54fe397
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7819cf48-cee3-4af9-9387-5f9e21c91fba
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: PRODUCT_ATTRITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b245c08b-56f2-4d0a-8bf7-d0fd3154410e
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e3e3f564-8910-4761-aa62-540429a7a257
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: PRODUCT_ATTRITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 42ce567a-7765-4db7-98a5-c4728171a622
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce7b50c9-7584-46a9-aa92-a7ec0678d340
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_ACQUISITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2cd48b82-8bfa-496e-9bde-c876f60c7d7f
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 424b492a-db72-44ef-aac7-33f8664a94a1
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_ATTRITION_IND
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b1dec056-c0ee-4255-a685-7789c9d6af91
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 91425b27-61ed-4ca9-9621-18f6acce34ad
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MONTH_ON_BOOK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7354105-d882-4d0f-92dd-3f7448f7a6b0
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f87b0487-1950-4305-9eae-f82d2f4590b8
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 67b7b9fe-c25b-4622-8df2-ded65bd58453
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9272d7d5-5095-40d5-bd3d-b9dafb2af955
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_NEW_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5596f1f5-356d-4274-a7a3-3634ef651cdf
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc798824-3613-4b3d-b09f-b44eb62ff184
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_RETURNED_TERMINAL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6c4696c9-f4cf-4bb0-81fe-34d70c14da87
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 61c3c9eb-35bb-48d8-bcc5-de0b9cba53c4
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a102cbbc-2c81-4754-8664-f006027b4c1a
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 66dcd7fd-44cf-4f9e-bb6e-98143ce84e28
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1e4c9cc8-c97b-4709-801d-fc6d1fd240d9
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f9f1763-25a0-449b-9398-1c0d3891a553
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 25885213-918e-4f2c-b7fe-2664c108ea0e
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8248c6d7-13c3-4407-a28f-35a615590127
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a3dbc7d0-03ab-44c9-8121-06271d86fe38
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 52dcc19c-b9fa-48c2-bd78-202ac2fa0d3d
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6ff25148-9346-4795-ac09-e9261a080aa8
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e329858f-26e6-4844-83a2-090310d6e296
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d9004e7d-62de-4248-944b-355f6cc45f2b
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5fd926d9-1be8-4008-89ad-417ac7f58d94
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4ec4dfc2-6e87-4184-9737-24a1e1a45f18
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 74bb1203-8fb5-47c1-8c80-6be89de51a0b
          stepCounter: aa9c8681-2029-4348-9c34-14d0658efa69
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f2c9be31-583b-4351-970f-3919fade0ec2
                stepCounter: 14232eca-2d51-4e48-bbc7-93a5f305d005
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          AGG_MERCHANT_PRODUCT_STATUS_DAILY: 14232eca-2d51-4e48-bbc7-93a5f305d005
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ this }}(SNAPSHOT_DATE_ID, SNAPSHOT_DATE, DIM_PRODUCT_ID, DIM_MERCHANT_ID, VIRTUAL_TERMINAL_PRODUCT_IND, ACTIVE_MERCHANT_PRODUCT_IND, PRODUCT_ACQUISITION_DATE, PRODUCT_ACQUISITION_IND, PRODUCT_ATTRITION_DATE, PRODUCT_ATTRITION_IND, MERCHANT_ACQUISITION_IND, MERCHANT_ATTRITION_IND, MONTH_ON_BOOK, NUMBER_OF_TERMINAL_ALLOCATED, NUMBER_OF_NEW_TERMINAL_ALLOCATED, NUMBER_OF_RETURNED_TERMINAL, NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED, NUMBER_OF_TERMINALS_ALLOCATED_USED, NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED, DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY, DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY, NUMBER_OF_SETTLED_TXN_DAILY, NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY)COPY GRANTS AS WITH merchant_terminal_daily AS (
                    SELECT ts.SNAPSHOT_DATE_ID,
                           ts.dim_merchant_id,
                           left(ts.terminal_serial_number,2) AS PRODUCT_PREFIX_CODE,
                           count(DISTINCT terminal_serial_number) AS NUMBER_OF_TERMINAL_ALLOCATED,

                      FROM {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
                      JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                        ON dim_date_id = ts.snapshot_date_id
                     WHERE d.date_desc_date >= (
                            SELECT HIGHWATERMARK
                              FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                             WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_MERCHANT_PRODUCT_STATUS_DAILY'
                           )
                       AND d.date_desc_date<current_date() //
                       AND d.date_desc_date BETWEEN ifnull(mp.product_acquisition_date, to_date('1900-01-01','yyyy-mm-dd')) AND ifnull(mp.product_attrition_date, to_date('2900-01-01','yyyy-mm-dd')) --

                     GROUP BY ALL
                   ) ---end of get number of terminals--
             SELECT d.dim_date_id AS SNAPSHOT_DATE_ID,
                   d.date_desc_date AS SNAPSHOT_DATE,
                   ts.dim_product_id,
                   ts.DIM_MERCHANT_ID,
                   CASE WHEN p.product_type = 'VIRTUAL' THEN 1
                        ELSE 0
                         END AS VIRTUAL_TERMINAL_PRODUCT_IND,
                   CASE WHEN sum(ts.TERMINAL_ACTIVITY_STATUS)>0 THEN 1
                        ELSE 0
                         END ACTIVE_MERCHANT_PRODUCT_IND,
                   rmp.PRODUCT_ACQUISITION_DATE,
                   CASE WHEN rmp.PRODUCT_ACQUISITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS PRODUCT_ACQUISITION_IND,
                   rmp.PRODUCT_ATTRITION_DATE,
                   CASE WHEN rmp.PRODUCT_ATTRITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS PRODUCT_ATTRITION_IND,
                   CASE WHEN mr.MERCHANT_ACQUISITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS MERCHANT_ACQUISITION_IND,
                   CASE WHEN mr.MERCHANT_ATTRITION_DATE = d.DATE_DESC_DATE THEN 1
                        ELSE 0
                         END AS MERCHANT_ATTRITION_IND,
                   DATEDIFF('month', mr.MERCHANT_ACQUISITION_DATE, d.DATE_DESC_DATE) + 1 AS MONTH_ON_BOOK,
                   mtd.NUMBER_OF_TERMINAL_ALLOCATED AS NUMBER_OF_TERMINAL_ALLOCATED,
                   sum(ts.NEW_TERMINAL_INDICATOR) AS NUMBER_OF_NEW_TERMINAL_ALLOCATED,
                   sum(ts.RETURNED_TERMINAL_INDICATOR) AS NUMBER_OF_RETURNED_TERMINAL,
                   count(DISTINCT CASE WHEN ts.TERMINAL_ACTIVITY_STATUS=1 THEN terminal_serial_number ELSE NULL END) AS NUMBER_OF_ACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT CASE WHEN ts.TERMINAL_ACTIVITY_STATUS=0 THEN terminal_serial_number ELSE NULL END) AS NUMBER_OF_INACTIVE_TERMINAL_ALLOCATED,
                   count(DISTINCT (CASE WHEN ts.NUMBER_OF_SETTLED_TXN_DAILY>0 AND rmp.dim_product_id = ts.dim_product_id THEN concat(ts.terminal_serial_number, to_varchar(ts.merchant_identification_number)) ELSE NULL END)) AS NUMBER_OF_TERMINALS_ALLOCATED_USED, //IF NO transactions THEN NO dim_product_id IN the ts TABLE NUMBER_OF_TERMINAL_ALLOCATED - NUMBER_OF_TERMINALS_ALLOCATED_USED AS NUMBER_OF_TERMINALS_ALLOCATED_NOT_USED,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY END)) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY END)) AS DOLLAR_VALUE_SETTLED_TXN_CAD_DCC_ENABLED_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.NUMBER_OF_SETTLED_TXN_DAILY END)) AS NUMBER_OF_SETTLED_TXN_CAD_DAILY,
                   sum((CASE WHEN (rmp.dim_product_id = ts.dim_product_id OR rmp.dim_product_id IS NULL) THEN ts.NUMBER_OF_SETTLED_TXN_DCC_ENABLED_DAILY END)) AS NUMBER_OF_SETTLED_TXN_CAD_DCC_ENABLED_DAILY
              FROM {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }} ts
              JOIN merchant_terminal_daily mtd
                ON mtd.dim_merchant_id = ts.dim_merchant_id
               AND mtd.product_prefix_code = left(ts.terminal_serial_number,2)
               AND mtd.SNAPSHOT_DATE_ID = ts.SNAPSHOT_DATE_ID
              JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_DATE') }} d
                ON dim_date_id = ts.snapshot_date_id
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} p
                ON p.dim_product_id=ts.dim_product_id
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} rmp
                ON rmp.dim_product_id=ts.dim_product_id
               AND rmp.dim_merchant_id=ts.dim_merchant_id
               AND d.date_desc_date BETWEEN rmp.dss_start_date AND rmp.dss_end_date --SM 6/24/2025: removing subquery as it results in null product_ids
             /*

            left join

                (SELECT r.dim_merchant_id, p.dim_product_id, r.product_acquisition_date, r.product_attrition_date, p.product_prefix_code, p.product_type, p.dss_start_date, p.dss_end_date, r.dss_start_date as r_dss_start_date, r.dss_end_date as r_dss_end_date

              from {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }} r

                join {{ ref('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }} p on p.dim_product_id = r.dim_product_id

            ) as rmp

                on   ts.dim_merchant_id = rmp.dim_merchant_id and rmp.product_prefix_code = left(ts.terminal_serial_number,2)

            and d.date_desc_date between rmp.dss_start_date and rmp.dss_end_date

            and d.date_desc_date between rmp.r_dss_start_date and rmp.r_dss_end_date

            */
              LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }} mr
                ON mr.dim_merchant_id = mtd.dim_merchant_id
               AND d.date_desc_date BETWEEN mr.dss_start_date AND mr.dss_end_date
             WHERE (d.date_desc_date BETWEEN mr.dss_start_date AND mr.dss_end_date)
               AND d.date_desc_date >= (
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'AGG_MERCHANT_PRODUCT_STATUS_DAILY'
                   ) -- and d.date_desc_date<current_date()

               AND d.date_desc_date<(
                    SELECT HIGHWATERMARK
                      FROM {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
                     WHERE LOAD_TABLE_SOURCE_NAME = 'F_SETTLED_TRANSACTIONS'
                   )
             GROUP BY ALL
        dependencies:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: AGG_TERMINAL_STATUS_DAILY
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: R_MERCHANT_PRODUCT
          - locationName: DATAVAULT_LOAD
            nodeName: WHERESCAPE_HIGHWATERMARK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref_no_link('DATAVAULT_INFORMATION_MART','AGG_MERCHANT_PRODUCT_STATUS_DAILY') }}
            {{ ref('DATAVAULT_INFORMATION_MART','AGG_TERMINAL_STATUS_DAILY') }}
            {{ ref_no_link('DATAVAULT_INFORMATION_MART','DIM_DATE') }}
            {{ ref('DATAVAULT_LOAD','WHERESCAPE_HIGHWATERMARK') }}
            {{ ref_no_link('DATAVAULT_INFORMATION_MART','DIM_PRODUCT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','R_MERCHANT_PRODUCT') }}
            {{ ref_no_link('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }}
        name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
        noLinkRefs:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: AGG_MERCHANT_PRODUCT_STATUS_DAILY
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_MERCHANT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_PRODUCT
  name: VIEW_AGG_MERCHANT_PRODUCT_STATUS_DAILY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
