fileVersion: 1
id: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
name: S_SHARED_INPATIENT_CHANGES_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Find all events where something has changed in PIMS or Plato. There can be multiple rows per event in this table.  "
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8122ddb5-5c77-438f-a89e-2a27a272d2fd
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PRVSP_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 59d3088d-97f2-4c53-9ebc-ae021c7b49e2
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c9049824-2248-449b-a5d8-cf76256c041a
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Allows a distinct set of prvsp_refno values to be selected from this table
        name: PRVSP_ROWNUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 59d3088d-97f2-4c53-9ebc-ae021c7b49e2
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ROW_NUMBER() OVER(PARTITION BY ds_pims_provider_spells.prvsp_refno ORDER BY ds_pims_service_point_stays.sstay_refno)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 892d6c1d-9dcf-4a8f-9147-efe2af2c1d84
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc28819c-55e3-49c8-b08c-b1de8ea0eb0d
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a6e93b2-c03e-4539-aefa-b495cdda9d72
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PATNT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5cdafb1e-56d4-493d-af18-cf2a27cb2b65
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Allows a distinct set of patnt_refno values to be selected from this table
        name: PATNT_ROWNUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1f7b850f-ce72-4e87-b4f3-6e2838f4dd0a
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ROW_NUMBER() OVER(PARTITION BY ds_pims_provider_spells.patnt_refno ORDER BY ds_pims_provider_spells.admit_dttm)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7543c047-851e-4766-aca0-c6f7c9a9f8b8
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: ADMET_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0b9fc1ad-a8cc-4c29-bd6b-b55c9007f7ce
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: da2be842-ae32-42fe-8082-b64b8f3d785e
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: INMGT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 76ce2d66-f620-4545-bd3f-71d1e5604f03
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ed4db1e0-d5b9-4bc1-b593-405f26e5c507
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ADMIT_DTTM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1125cf7f-7027-45ac-acc8-b3a92505c4da
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f2134522-1e95-4def-9a53-2c43a5a0f85f
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: DISCH_DTTM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ee3a67e8-1a53-44ab-aa64-cafc588de09c
                stepCounter: 1206df94-8ac6-4021-a171-232e071d9dc2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d889f310-e17e-4acb-8171-483d4452ceb9
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: SSTAY_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 24eeb20d-18d1-4bd8-8f55-2f75643a24d3
                stepCounter: 33fe902a-f28a-4da8-b9d5-2e4311242008
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51bd2c56-7f8e-4168-a9be-4f9632cd7340
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: STAY_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 452bde5b-80ea-4630-80ea-516eda3c1ab9
                stepCounter: 3574e047-03db-4aba-af69-06f8858b99cd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2c20bcf2-d6dc-4893-850e-9ee82229a166
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PRCAE_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7fb57b5-409b-4f23-8347-fe2e72525181
                stepCounter: cb8cd7bc-c5c1-4ee3-a1f5-2c0bda3624d5
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a41a1179-03a4-4f8a-bb2d-f7ed519fdc74
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: SCHDL_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7b5ab558-a34e-4fd8-9b8e-311c0d96346a
                stepCounter: 91a0e39f-bf7f-4006-bd7b-65a534f637a9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3049047b-0374-49aa-87ed-18d795ddfe9e
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: START_DTTM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ec8fa2c5-ca35-4bea-9290-bc50185e05e7
                stepCounter: 91a0e39f-bf7f-4006-bd7b-65a534f637a9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ab62e85f-41f7-4b3f-8947-848bc14d8ba2
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: DGPRO_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f49ba7ec-9b7c-499d-ae59-ed3ecd3a63a5
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0d74001a-77e8-4a94-8173-29524e9e53c4
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: ODPCD_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b4c372ad-7e3b-459a-89ad-ec53d1b8cb49
                stepCounter: 1b5b9711-ab0c-474a-a7f0-a18e233b291c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a0dc1530-5d7e-41db-90ac-e156599bfdb1
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: HOMEL_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 231569e9-0ac1-4568-aa07-b0501058bee7
                stepCounter: 722adbeb-338a-4596-a2f1-da45fa35fba5
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d886f144-4580-4a40-932b-c5fceddec407
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: VARCHAR(5)
        defaultValue: ""
        description: ""
        name: PLATO_RECORDID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: faa838f8-d258-4b73-917a-d9c0bd6550bf
                stepCounter: e36e158e-c610-4da5-92bc-412a178a9d7a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3334ff70-5055-4ad7-a3f2-4f00599346b9
          stepCounter: f76e0ff7-f671-4ed5-aa55-e0ba3c97c1c9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: DS_PIMS_PROVIDER_SPELLS
        join:
          joinCondition: |-
            FROM ds_pims_provider_spells
              LEFT OUTER JOIN ds_pims_service_point_stays
                ON ds_pims_provider_spells.prvsp_refno = ds_pims_service_point_stays.prvsp_refno
              LEFT OUTER JOIN ds_pims_prof_carer_episodes
                ON ds_pims_provider_spells.prvsp_refno = ds_pims_prof_carer_episodes.prvsp_refno
              LEFT OUTER JOIN ds_pims_schedules
                ON ds_pims_schedules.patnt_refno = ds_pims_provider_spells.patnt_refno
               AND ds_pims_schedules.start_dttm BETWEEN ds_pims_provider_spells.admit_dttm AND IFNULL(disch_dttm, GETDATE())
               AND DATEDIFF(DD, ds_pims_provider_spells.admit_dttm, ds_pims_provider_spells.disch_dttm) = 0
               AND ds_pims_schedules.cancr_dttm IS NULL
              LEFT OUTER JOIN ds_pims_diagnosis_procedures
                ON ds_pims_diagnosis_procedures.sorce_refno = ds_pims_schedules.schdl_refno
               AND ds_pims_diagnosis_procedures.sorce_code = 'SCHDL'
              LEFT OUTER JOIN (
                    SELECT DISTINCT prvsp_refno
                      FROM ds_pims_home_leaves
                     WHERE dss_update_time > @v_pa_shared_incremental
                   ) ds_pims_home_leaves
                ON ds_pims_provider_spells.prvsp_refno = ds_pims_home_leaves.prvsp_refno
              LEFT OUTER JOIN ds_shared_inpatient_stay
                ON ds_shared_inpatient_stay.prvsp_refno = ds_pims_provider_spells.prvsp_refno
               AND ds_shared_inpatient_stay.event_stay_seq_num = ds_shared_inpatient_stay.event_stay_count
              LEFT OUTER JOIN ds_plato_event_details
                ON ds_pims_provider_spells.encounter_id = ds_plato_event_details.pimsencounter
             WHERE ds_pims_provider_spells .dss_update_time > @v_pa_shared_incremental
                OR ds_pims_service_point_stays .dss_update_time > @v_pa_shared_incremental
                OR ds_pims_prof_carer_episodes .dss_update_time > @v_pa_shared_incremental
                OR ds_pims_schedules .dss_update_time > @v_pa_shared_incremental
                OR ds_pims_diagnosis_procedures.dss_update_time > @v_pa_shared_incremental
                OR ds_plato_event_details .dss_update_time > @v_pa_shared_incremental
                OR ds_pims_home_leaves.prvsp_refno IS NOT NULL -- For events not discharged the end date of the current stay must be updated to today's date  OR (ds_pims_provider_spells.disch_dttm IS NULL   AND CONVERT(date, ds_shared_inpatient_stay.stay_end_date) < CONVERT(date, GETDATE()))
        name: S_SHARED_INPATIENT_CHANGES_10
        noLinkRefs: []
  name: S_SHARED_INPATIENT_CHANGES_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
