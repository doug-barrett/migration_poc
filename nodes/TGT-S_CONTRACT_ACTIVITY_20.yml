fileVersion: 1
id: 9378e4a4-ac4f-4373-a709-764a736c5b9d
name: S_CONTRACT_ACTIVITY_20
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9862be27-8b73-452f-af9a-79ce2b427d91
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Generated column used to join to correct Price Volume Schdule Line
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8d4e590d-d021-414b-8518-dae973e44e20
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8df2d25f-0223-4f1a-b8ca-cc8d361b13b0
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: Agency code for the providing organisation
        name: PROVIDER_AGENCY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e45becd0-96ee-41dc-b848-e1d5790a0310
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: |-
              CASE WHEN s_contract_activity_10.admin_category_reference_no IN (/*starship */ 1000002605, 1000002606, 1000002607) THEN '1022'
                          ELSE '1021'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0350787-3f14-47e6-b410-a99da0e69380
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: 'Agency code for the funding organisation. This could include ACC and Ministry of Health '
        name: FUNDER_AGENCY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ea463ba8-19fd-49d1-92ed-fe0e67736db7
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: |-
              CASE WHEN s_contract_activity_10.admin_category_reference_no = 1000000046                            THEN '1239' /*ACC*/
                          WHEN s_contract_activity_10.admin_category_reference_no IN (1400016240, 1000008240, 1400016240) THEN '1236' /*MoH*/
                          ELSE '1021'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e24ac981-5ccd-4038-afdd-aea3afc624c8
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fbb37cfb-96db-47ea-8a4f-b9bd1b59b8fd
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c010ef7e-c6b6-49eb-89cd-6831d3f57b23
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c465912c-f6ca-4a74-9c91-d3e5a05e5640
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d2c383dd-7682-44b4-a9df-88932212427a
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: health_specialty_code
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 99bd6c68-4945-4029-8963-0c10ac37b698
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 375aa674-b449-4e37-9b05-5f9c4dbd3acc
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.health_specialty_code=dim_MOH_health_specialty.health_specialty_code
        name: DIM_MOH_HEALTH_SPECIALTY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a4d7df87-2df3-4b57-8f52-ed903baa503c
                stepCounter: ee36cf91-4a1a-41fe-bd9f-1a939711cdc0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 82d56ae0-1eeb-457b-9922-e695c6996fdb
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.facility_code=dim_health_facility.health_facility_code
        name: DIM_HEALTH_FACILITY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6bf6bd17-b626-4e3a-ab8c-d3ff41850356
                stepCounter: 2f6f101b-8a09-4182-a969-06add4b17ff5
            transform: IFNULL(dim_health_facility.dim_health_facility_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1a15fb04-d30c-48c0-ba61-ac2c3daf76c9
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: facility_code
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e6bee6b0-deb1-4702-a0c7-1ab3c5ff2c19
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: abe35e53-1d30-46fe-8e66-09094457ebc8
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: SERVICE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2aaf5936-6d68-4140-a736-bed1293b38f8
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8344ac46-d066-412c-897b-d907c29cc22d
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0e111c50-5f0a-46a6-9b16-eb9063203f33
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f471265e-e464-430d-8c2d-abcaee386963
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 07a782a1-1cd8-41c0-ae1e-734f2ea6c1c1
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c18eaa37-27c9-4ad8-8182-db91b546cde9
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 23099204-9888-4c20-91d4-1fba6b36759e
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 89b44581-cd1f-4515-bc37-aaf9053a0bb0
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 411f5c9b-3195-4273-b817-e86116f0057d
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c9772b5d-8c69-47ea-933b-14e3152b88fd
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_ENCOUNTER_TYPE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3ba8df3-db2e-40a1-97dc-d5ad6a5186a7
                stepCounter: 1d0ea6a1-9563-4fb3-a1fa-9d43dbdf296e
            transform: IFNULL(dim_encounter_type.dim_encounter_type_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5e184949-ecd7-4851-8432-26acf94061b6
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ff3c2599-06c8-4b99-b2ff-c30e848a210f
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3ad1b870-86c6-4970-ba8d-432f8315d842
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_in_patient_event_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e082bc82-9f6f-427f-8ba6-63626c1ae4f2
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b06529c7-c2e2-47bd-ad76-68151b7003e5
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.admin_category_reference_no=dim_admin_category.admin_category_reference_no
        name: DIM_ADMIN_CATEGORY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e0b32e8b-90c1-4a7f-ba9c-3c56b846c3d0
                stepCounter: cb8ab7aa-8253-4425-bee9-afe3bc46851f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fdcfb70a-0b63-47e1-931a-b682902bed18
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4d809f8f-c7db-4e2a-b4bc-2c840542baba
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a23a57a0-f164-4fe7-a335-91b1de51dadc
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(2)
        defaultValue: ""
        description: ""
        name: PURCHASER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9ce7367a-f4c2-464a-892d-1113c64f272e
                stepCounter: a1739b5c-4d46-4e43-8d42-5d6c977147f2
            transform: IFNULL(l_mappings_AdCat_Purchaser.Purchaser,'35')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 362f0472-6a0f-4bbb-b7b8-3ffa9de0cc67
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3b41cc40-79e3-451a-8d0b-6e497f9e0cef
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0d5bb701-bc38-43bb-be4f-581c449cfd95
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 441b933e-15d6-403a-b21f-54511994a4d4
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc737284-14f4-452a-ac12-6adc5ba5718e
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b013aae2-00f1-4e2e-89ce-cac5b973a1bd
                stepCounter: 330ad0aa-b8b1-4da9-ab37-b4fe8f889452
            transform: |-
              CASE WHEN s_contract_activity_10.IDF_class IS NULL THEN 'Non-IDF'
                          ELSE s_contract_activity_10.IDF_class
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 22e17109-b8c2-4162-9d08-0dce00159f4c
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 13aacf86-f6b1-4e51-b0c1-751d689ca970
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: |-
              CASE WHEN s_contract_activity_10.domicile_code IS NULL THEN 'D021'
                          ELSE s_contract_activity_10.domicile_code
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ee3591b4-b91d-4354-b7f8-81c52900ada6
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: field for auditing purposes . exposed text value of purchase unit as it may not map correctly to valid value
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 88f1c0b8-d6c3-4164-8a13-6607a8cb0ee1
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e24cc067-ba09-47d8-88d7-cc6feb931272
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 96de77de-0f24-448a-b428-f294033a80bd
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dd34ae5f-2158-4ad1-88a9-aed35113cae1
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.  NNPAC counts client unit of measure with a volume 0 so whilst this volume counts it as 1 so that it the volumes can be reported in the cotnract volume reporting
        name: LOCAL_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 96de77de-0f24-448a-b428-f294033a80bd
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: |-
              CASE WHEN dim_purchase_unit.unit_of_measure ='Client'                      THEN CASE WHEN row_number() OVER (PARTITION BY dim_contract_reporting_date.contract_reporting_fin_year, NHI ORDER BY service_date)= 1 THEN 1 ELSE 0 END
                          WHEN dim_purchase_unit.unit_of_measure IN ('Patient','Patient Month') THEN CASE WHEN row_number() OVER (PARTITION BY dim_contract_reporting_date.contract_reporting_fin_year,dim_contract_reporting_date.contract_reporting_fin_month, NHI ORDER BY service_date)= 1 THEN 1 ELSE 0 END
                          ELSE s_contract_activity_10.purchase_unit_volume
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c63997d2-2356-4927-8629-4c0081bb6752
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bce355fa-e888-4c71-972d-70dffbbac083
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c38d0ce-5104-498b-9962-d30ec40825bf
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5901e8c7-6e90-40bb-b276-0ec631548e7f
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f1def154-f34e-4d4d-b167-dd4cf2aa42d8
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: ACTUAL_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.actual_cost
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c7d8166e-1470-49e1-ba9a-0632e37a7e9c
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: BUDGET_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.budget_cost
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 19df8653-fa46-42f0-a21c-5f8ff8999a85
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: MHOP_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.MHOP
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4b6de778-aea9-48ec-82b2-652ad92158d5
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: AMED_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.AMED
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fb39b38d-3f4c-4f3c-a6a5-7f7e2261fc18
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: SURG_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.SURG
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f336a0a2-a5fc-4db5-a48a-d8856a5fb4b8
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: CWF_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.CWF
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f2f953af-f72e-4c87-bf43-4126ae07480a
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: ESC_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.ESC
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 92945760-b9e2-44a5-817c-cfbf54234aca
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: OTH_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN dim_contract_reporting_date.contract_reporting_month_offset IN (0,1) THEN 0
                          ELSE fact_cost_encounter.OTH
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9d213fa-1e10-4cb4-b71f-0d2aa6b88dbb
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: Activity that matches a price volume schedule contract line. Y means that it is matched to funded contract line. N means that there is no match
        name: FUNDED_ACTIVITY_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a089622c-29df-43d2-a167-1f603c12c592
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: |-
              CASE WHEN IFNULL(dim_contract_line.dim_contract_line_key,0) = 0 THEN 'N'
                          ELSE 'Y'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f0805c49-679a-4c5f-ac9f-fea9337956fb
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: ""
        name: COSTED_ACTIVITY_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN IFNULL(fact_cost_encounter.actual_cost,0) =0 THEN 'N'
                          ELSE 'Y'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51e79422-8edb-4ac2-b3e9-938ccb2ce046
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: ""
        name: ESTIMATED_ACTIVITY_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c63997d2-2356-4927-8629-4c0081bb6752
                stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
            transform: |-
              CASE WHEN IFNULL(s_contract_activity_10.estimated_purchase_unit_volume,0) =0 THEN 'N'
                          ELSE 'Y'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9b81264e-7c7b-495f-a567-e39384ec3d90
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: 'Flags encounters that have purchase unit volume as Y and where there is no volume as N. Events can legitimately have no volume if they are not outcomed, patient DNAs or they occur in the future. '
        name: EVENTS_WITH_PURCHASE_UNIT_VOLUME_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN s_contract_activity_10.purchase_unit_volume = 0 THEN 'N'
                          ELSE 'Y'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8a77d6e3-3270-4f70-b6bc-4b916f64f1e4
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: MONEY
        defaultValue: ""
        description: the price the DHB funding arm is paying the provider
        name: PLANNED_PRICE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3ff5d403-1722-48a8-97ac-6af5064d38ac
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2f757e3a-d865-4370-a267-b97361937bc0
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: MONEY
        defaultValue: ""
        description: Planned price x purchase unit volume
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3ff5d403-1722-48a8-97ac-6af5064d38ac
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: |-
              CASE WHEN dim_contract_line.planned_price IS NULL THEN l_reference_Event_Purchase_Unit_History.revenue
                          ELSE dim_contract_line.planned_price * s_contract_activity_10.purchase_unit_volume
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 84b243af-88d0-4c72-a3a6-91d4657e0b4c
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: MONEY
        defaultValue: ""
        description: ""
        name: HISTORICAL_REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4fb4a54d-0b46-47df-a672-c2ae8a2922fe
                stepCounter: 93ea3ceb-09a5-43d1-b713-340d8e17a20a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f97e051-1cca-4503-9604-4f412f254262
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 95392d6d-ae3a-4797-bfb4-663405e89ecb
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9da425d0-9ed5-4e6d-a070-fa4250d50a9f
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.source_encounter=
        name: DIM_DOMICILE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4e049fc8-a2a3-4bad-9b91-11b9d158b35e
                stepCounter: 330ad0aa-b8b1-4da9-ab37-b4fe8f889452
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1c1ee3ff-d382-4e14-91a7-62e8a2ecef28
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5087eedf-dc28-4964-b866-0dbd5e23c7cd
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a88fb9e7-5dda-464f-a429-0daaffeaa615
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0d9985dd-d75d-443e-b2d4-7b67596a218a
                stepCounter: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51aef14f-3401-4f2e-92e9-67283d8009f3
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_CONTRACT_LINE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a089622c-29df-43d2-a167-1f603c12c592
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: IFNULL(dim_contract_line.dim_contract_line_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1f60ef0c-7b19-4bd6-9c80-6ac447725e84
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: business key for dim_contract_line, reqd for rekeying
        name: PVS_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 478d3b94-f12b-41c3-a240-03a15410b697
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: IFNULL(dim_contract_line.pvs_id,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e4b6506f-3e05-4189-bd70-830077ee4a17
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_ADMISSION_TYPE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d2e60128-b077-486c-b90e-18022d25b932
                stepCounter: 04c42cb2-f015-4d9e-ae6d-9feed9f13b97
            transform: IFNULL(dim_admission_type.dim_admission_type_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f3302170-022c-43d4-a6a1-c720bc789728
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.purchase_unit_code=dim_purchase_unit.purchase_unit_code
        name: DIM_PURCHASE_UNIT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2d9c041f-76d6-44c7-8d88-936673dfd7a0
                stepCounter: d198650d-0f77-489d-92ec-0c0257cd5a43
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ac5b05fa-c9ad-4c02-9838-642115bca3bf
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_CONTRACT_REPORTING_DATE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f69d67d-8fd0-4bb3-ac12-70d2be5c47ca
                stepCounter: 4f22f895-47c0-4e2a-9a51-f3051174cf24
            transform: IFNULL(dim_contract_reporting_date.dim_contract_reporting_date_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a45137a4-2854-4aeb-86f1-b4d8fa3d813e
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_20.clinician_reference_no=dim_clinician.clinician_reference_no
        name: DIM_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 911a8788-86e5-4a5c-a00a-a957d59070b8
                stepCounter: e8e4a684-3ef8-4076-846f-48d5689e824f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: acced659-bc17-4503-8585-123cb1b88609
          stepCounter: 9378e4a4-ac4f-4373-a709-764a736c5b9d
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_CONTRACT_ACTIVITY_10: 4ce7c19b-7661-4d0a-b366-25cd113e6dec
          DIM_CONTRACT_REPORTING_DATE: 4f22f895-47c0-4e2a-9a51-f3051174cf24
          L_MAPPINGS_ADCAT_PURCHASER: a1739b5c-4d46-4e43-8d42-5d6c977147f2
          DIM_CONTRACT_LINE: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
          DIM_ENCOUNTER_TYPE: 1d0ea6a1-9563-4fb3-a1fa-9d43dbdf296e
          L_REFERENCE_EVENT_PURCHASE_UNIT_HISTORY: 93ea3ceb-09a5-43d1-b713-340d8e17a20a
          DIM_DOMICILE: 330ad0aa-b8b1-4da9-ab37-b4fe8f889452
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_CONTRACT_ACTIVITY_10
          - locationName: TGT
            nodeName: DIM_CONTRACT_REPORTING_DATE
          - locationName: TGT
            nodeName: L_MAPPINGS_ADCAT_PURCHASER
          - locationName: TGT
            nodeName: DIM_CONTRACT_LINE
          - locationName: TGT
            nodeName: DIM_ENCOUNTER_TYPE
          - locationName: UNKNOWN
            nodeName: FACT_COST_ENCOUNTER
          - locationName: TGT
            nodeName: L_REFERENCE_EVENT_PURCHASE_UNIT_HISTORY
          - locationName: TGT
            nodeName: DIM_DOMICILE
        join:
          joinCondition: |-
            FROM {{ ref('TGT','S_CONTRACT_ACTIVITY_10') }}
              LEFT OUTER JOIN {{ ref('TGT','DIM_CONTRACT_REPORTING_DATE') }}
                ON s_contract_activity_10.reporting_date = dim_contract_reporting_date.calendar_date
              LEFT OUTER JOIN {{ ref('TGT','L_MAPPINGS_ADCAT_PURCHASER') }}
                ON s_contract_activity_10.admin_category_reference_no = l_mappings_AdCat_Purchaser.RFVAL_REFNO
               AND l_mappings_AdCat_Purchaser.end_date IS NULL
              LEFT OUTER JOIN {{ ref('TGT','DIM_CONTRACT_LINE') }}
                ON s_contract_activity_10.contract_admit_type = dim_contract_line.acute_elective_other
               AND IFNULL(s_contract_activity_10.IDF_class,'Non-IDF') = dim_contract_line.IDF_class
               AND s_contract_activity_10.purchase_unit_code = dim_contract_line.purchase_unit_code
               AND s_contract_activity_10.responsibility_centre_code = dim_contract_line.Planned_RC_code
               AND s_contract_activity_10.reporting_date = dim_contract_line.calendar_date
               AND CASE WHEN s_contract_activity_10.purchase_unit_code like 'NCSP%' THEN '34'
                        ELSE IFNULL(l_mappings_AdCat_Purchaser.purchaser,'35')
                         END = dim_contract_line.purchaser
              LEFT OUTER JOIN {{ ref('TGT','DIM_ENCOUNTER_TYPE') }}
                ON s_contract_activity_10.event_encounter_type_code = dim_encounter_type.encounter_type_code
              LEFT OUTER JOIN {{ ref('UNKNOWN','FACT_COST_ENCOUNTER') }}
                ON s_contract_activity_10.source_encounter = fact_cost_encounter.encounter_id
              LEFT OUTER JOIN {{ ref('TGT','L_REFERENCE_EVENT_PURCHASE_UNIT_HISTORY') }}
                ON s_contract_activity_10.source_encounter = l_reference_Event_Purchase_Unit_History.encounter
              LEFT OUTER JOIN {{ ref('TGT','DIM_DOMICILE') }}
                ON s_contract_activity_10.domicile_code = dim_domicile.domicile_code
               AND dim_domicile.dss_current_flag ='Y'
              LEFT OUTER JOIN [dim].dim_health_facility
                ON s_contract_activity_10.facility_code = dim_health_facility.health_facility_code
               AND dim_health_facility.dss_current_flag ='Y'
              LEFT OUTER JOIN [dim].[dim_admission_type]
                ON s_contract_activity_10.admission_type_code = [dim_admission_type].admission_type_code
               AND s_contract_activity_10.service_date BETWEEN dim_admission_type.admission_type_validity_start_date AND IFNULL(dim_admission_type.admission_type_validity_end_date,getdate()+1000)
               AND dim_admission_type.dss_current_flag ='Y'
        name: S_CONTRACT_ACTIVITY_20
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_20
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
