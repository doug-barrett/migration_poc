fileVersion: 1
id: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
name: S_CONTRACT_ACTIVITY_REFERRAL_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "Creates a record for every open year of a referral. Maps Client unit of measure to purchase units. Also forces event to being 35 DHB funded"
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c248af4-c261-4c95-ba0d-b769e4817fa5
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: PROVIDER_FUNDER_SPLIT
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: "'provider'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fd30ca37-d8c7-4800-a9c2-885af4e2b55f
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d13c1551-88b3-4ce0-94fb-394ea248f360
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 39bb1510-6881-4542-9fe4-3c3f3c1a7902
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: health_specialty_code
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b2d92597-3785-4a2d-a1e7-7cb11aa711ac
                stepCounter: 8cbba75c-bfb6-4f40-8f3c-ad41dfe782e6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a8456a89-5262-4db0-b2a8-03338de5dd26
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: facility_code
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: "'1021'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 835beb19-5269-44dc-a759-21dd12bd018a
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 143d2b16-da56-438c-b960-377ea3abfe3d
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: abecc889-5337-4651-b864-d54896832dd4
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51ae3cdf-ca42-4099-8476-f2030fc948e9
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 65f38813-292e-454f-9516-fd505e1e5e3e
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: "'R'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a55a3755-72b0-4015-9072-e2de542a1e5a
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c9186ecf-8354-43fe-87c7-8c09f1ad5eca
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_referral_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 891d1d09-4c05-4de3-a980-16f596831a9e
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1ed20cff-db5e-42d4-ac25-36de1bb8cdc9
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a3cfbdbb-ad36-4890-8980-f957387f7ba2
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b9f39ed-5374-4778-a674-bcb6c8becc90
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: "'OTHER'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 40dace33-9736-4e6e-8581-8e73ae0c9b6a
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4a3f7bd8-2b20-46fd-b892-b827c716d570
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: da1df2ed-bb77-4602-974b-c243064464c7
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 54fd819b-302e-4369-9752-03826e8ddf13
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5caa5b97-416f-467e-8d96-cee2400732f3
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05b9d66c-b8bc-4516-9a19-97e146bd1416
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6d993df2-a3c1-4fa8-8d96-537133cbccb9
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8463d6fc-393a-42cb-bf79-afb5f271be4c
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dcf2fcba-d3f2-4fcd-b185-63e0e3f71be3
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: '0'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 92650ae1-819b-40f0-9224-f6b8e9dfa5d3
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e3dc6016-76ed-42e7-b48c-cad747269ffc
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: contact clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 39bf259b-bdad-4997-a932-a6bf6f65c1a2
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8650e4df-3ca1-417b-8899-60cf96ea5d9f
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ACTIVE_REFERRAL
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f08f5a6-b967-465c-b181-2675960b0100
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: 'counts the referrals open within a specailty per fiscal year '
        name: OPEN_REFERRAL_SEQUENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a87775d4-c343-4446-a652-cff68f38f502
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: abecc889-5337-4651-b864-d54896832dd4
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 470c29b7-275e-4e81-b4f2-c342b880b56e
          stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bcd87a0f-b078-4ccc-ba19-80b6b9db5494
                stepCounter: aa6c1fa0-9008-489c-820a-ff5a35a3d0cb
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(provider_funder_split, puc_map_id, responsibility_centre_code, health_specialty_code, facility_code, reporting_date, source_encounter, funded_event_encounter, event_encounter_type_code, NHI, dim_patient_key, admin_category_reference_no, contract_admit_type, admission_type_code, IDF_class, domicile_code, purchase_unit_code, purchase_unit_volume, estimated_purchase_unit_volume, dim_age_group_key, dim_planned_care_key, DRG_code, clinician_reference_no, source_system, active_referral, open_referral_sequence_no, referral_encounter_id, referral_reference_no) AS SELECT provider_funder_split ,
                   PUC_map_id ,
                   responsibility_centre_code ,
                   health_specialty_code ,
                   facility_code ,
                   reporting_date ,
                   source_encounter ,
                   funded_event_encounter ,
                   event_encounter_type_code ,
                   NHI ,
                   dim_patient_key ,
                   admin_category_reference_no ,
                   contract_admit_type ,
                   admission_type_code ,
                   IDF_class ,
                   domicile_code ,
                   purchase_unit_code ,
                   purchase_unit_volume ,
                   estimated_purchase_unit_volume ,
                   dim_age_group_key ,
                   dim_planned_care_key ,
                   NULL DRG_code ,
                   clinician_reference_no ,
                   source_system ,
                   something ,
                   something_else ,
                   referral_encounter_id ,
                   referral_reference_no
              FROM (
                    SELECT 'provider' AS [provider_funder_split] ,
                           NULL AS PUC_map_id ,
                           '142-1460' AS [responsibility_centre_code] ,
                           referred_to_health_specialty_code AS [health_specialty_code] ,
                           '1021' AS [facility_code] ,
                           CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END AS reporting_date ,
                           referral_encounter_id + 'F' + RIGHT(fin_year_display,2) AS [source_encounter] ,
                           referral_encounter_id + 'F' + RIGHT(fin_year_display,2) AS [funded_event_encounter] ,
                           'R' AS [event_encounter_type_code] ,
                           s_referral_30.patient_NHI AS [NHI] ,
                           s_referral_30.[dim_patient_key] AS dim_patient_key ,
                           1000008180 AS [admin_category_reference_no] /*force to DHB Funded*/ ,
                           'OTHER' AS [contract_admit_type] ,
                           NULL admission_type_code ,
                           s_patient_address.IDF_Class AS [IDF_class] ,
                           s_patient_address.domicile_code AS [domicile_code] ,
                           'DOM103' AS [purchase_unit_code] ,
                           CASE WHEN referred_to_health_specialty_code = 'M96' AND row_number() OVER (PARTITION BY referred_to_health_specialty_code,s_referral_30.patient_NHI, fin_year_display,address_reference_no ORDER BY calendar_date) <> 1 THEN 0
                                ELSE 1
                                 END AS [purchase_unit_volume] ,
                           0 AS [estimated_purchase_unit_volume] ,
                           [dim_age_group].[dim_age_group_key] AS [dim_age_group_key] ,
                           0 AS [dim_planned_care_key] ,
                           referred_to_clinician_reference_no AS clinician_reference_no ,
                           'iPM REF_ANNL' AS [source_system] ,
                           NULL AS something ,
                           NULL AS something_else ,
                           referral_encounter_id ,
                           cast(replace(referral_encounter_id,'R','') AS int) referral_reference_no ,
                           row_number() OVER (PARTITION BY referral_encounter_id + 'F' + RIGHT(fin_year_display,2) ORDER BY s_patient_address.idf_class DESC, address_row_num) filter_address
                      FROM fact.fact_referral s_Referral_30
                     INNER JOIN dim.dim_referred_to_specialty
                        ON s_Referral_30.dim_referred_to_specialty_key = dim_referred_to_specialty.dim_referred_to_specialty_key
                     INNER JOIN (
                            SELECT DISTINCT calendar_date ,
                                   fin_year_display
                              FROM dim.dim_date
                             WHERE fin_day_in_year = 0
                           ) first_fin_date
                        ON calendar_date BETWEEN CONCAT('01-jul-', CASE WHEN MONTH(referral_start_date) >6 THEN YEAR(referral_start_date) ELSE YEAR(referral_start_date) -1 END) AND isnull(s_Referral_30.referral_completion_date,getdate()+100)
                     INNER JOIN dim.dim_referred_to_clinician
                        ON s_Referral_30.dim_referred_to_clinician_key = dim_referred_to_clinician.dim_referred_to_clinician_key
                     INNER JOIN dim.dim_referral_start_date
                        ON s_Referral_30.dim_referral_start_date_key = dim_referral_start_date.dim_referral_start_date_key
                     INNER JOIN dim.dim_patient
                        ON s_Referral_30.dim_patient_key = dim_patient.dim_patient_key
                     INNER JOIN dim.dim_age_group
                        ON floor(datediff(DAY, dim_patient.patient_date_of_birth, CASE WHEN referral_start_date >= calendar_date THEN referral_start_date ELSE calendar_date END)/365.25) = dim_age_group.age_years
                     INNER JOIN s_patient_address
                        ON dim_patient.patient_reference_no = s_patient_address.patient_reference_no
                       AND CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END >= address_validity_start_date
                       AND CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END <isnull(address_validity_end_date,getdate()+1000)
                       AND address_role_code = 'HOME'
                     INNER JOIN dim.dim_referral_status
                        ON s_Referral_30.dim_referral_status_key = dim_referral_status.dim_referral_status_key
                     WHERE 1=1
                       AND dim_referral_status.referral_status_reference_no <> 50024 -- declined status

                       AND ((referred_to_health_specialty_code = 'D01' AND referred_to_clinician_type_code IN (/*'CO',*/'OY')))
                       AND CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END <= getdate()
                   ) t
             WHERE 1=1
               AND filter_address =1
        dependencies:
          - locationName: TGT
            nodeName: S_REFERRAL_30
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_REFERRAL_30') }}
        name: S_CONTRACT_ACTIVITY_REFERRAL_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_REFERRAL_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
