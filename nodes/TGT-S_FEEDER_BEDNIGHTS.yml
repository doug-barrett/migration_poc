fileVersion: 1
id: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
name: S_FEEDER_BEDNIGHTS
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 728e449f-f40e-4fef-b187-6d60cba640b9
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Unique event identifier
        name: ENCOUNTER_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 20051b9c-2c34-41a3-bcd6-00a315134443
                stepCounter: 0144b63b-d759-4042-a3e5-2629038325fe
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a937a1c4-e2a0-405a-8727-e92f1b1211ed
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date on which the activity took place
        name: ACTIVITY_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a84ab334-834a-472a-9c37-b7ded4c53c71
                stepCounter: 0144b63b-d759-4042-a3e5-2629038325fe
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8b98f743-04e7-4946-ada3-9e5257f4f68f
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: Patients National Health Identifier
        name: PATIENT_NHI
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a2e29104-45f1-456f-ac7b-56573033bf8c
                stepCounter: 0144b63b-d759-4042-a3e5-2629038325fe
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 82f26ff6-f290-4c50-94b9-dd7e15c1f9b8
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CLINICIAN_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: edbd9080-53d1-4289-a55e-064e4471e2a1
                stepCounter: e8e4a684-3ef8-4076-846f-48d5689e824f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dab5e57a-c44a-4227-956e-43ba8b95b0f3
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: Purchase Unit code used to identify product to cost
        name: FEEDER_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab7a8ee2-7413-4635-a87d-bfe9ceaa8498
                stepCounter: d198650d-0f77-489d-92ec-0c0257cd5a43
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2fe1d7b2-ddb4-4119-a3b1-67e3809e5373
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: MONEY
        defaultValue: ""
        description: ""
        name: QUANTITY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7086ceee-f437-42db-a034-72c89061d300
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: RC Code used as indicator of where cost originated
        name: FEEDER_DEPARTMENT
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bdc2b33d-c967-497f-8fae-4bb65998db84
                stepCounter: a84cf165-8cc6-4510-8bae-53366e2d4ff7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa86d521-1391-4971-a97b-ed4554a61c5c
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: charge_RC used as indicator of where cost should be charged to
        name: CHARGE_RC
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 79c01748-d950-4bde-a451-a6caf51f2fdf
                stepCounter: 5abfd600-5dd0-4ae2-9b8d-f5d80b479c2f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0e4f88ad-8a08-4d72-a89c-ad10b713bf95
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: FEEDER_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 12b25795-2a25-4db5-a1f3-3e41091fb927
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: SOURCE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 649e78cd-d91c-4619-8a8e-d0f4248000d3
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SOURCE_SYSTEM_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0fba43aa-e0f9-40f6-93b4-bda83374bb4f
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: FEEDER_SYSTEM_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31626c09-1167-4114-b6ae-34329f78161b
          stepCounter: 2fda192f-e20b-4e88-abd7-1254a6c14f3e
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SOURCE_REFERENCE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT sty.event_encounter_id encounter_id ,
                   dateadd(SECOND,-1,cast(cast(sty.stay_calendar_date AS date)AS datetime)) Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   CASE WHEN wa.calculate_as_hours = 1 THEN 'HOUR'
                        ELSE CASE WHEN ss.specialty_desc = 'HITH' THEN 'ON_STAY'+'_'+ ss.specialty_desc----spliting HITH patients stay ON IC wards. Medical patient AND there is no AH input for these patients.
             ELSE 'ON_STAY' END
                         END + CASE WHEN include_specialty = 1 THEN '_'+ ss.specialty_code
                        ELSE ''
                         END + CASE WHEN wa.include_ward_code_on_bed_product =1 THEN '_' +wa.ward_code
                        ELSE ''
                         END Feeder_code ,
                   1 Qty ,
                   IFNULL(wa.responsibility_centre_code,'Ward_RC_unk_'+wa.ward_desc) Feeder_Department ,
                   cl.planned_RC_code Charge_RC ,
                   'Overnight stay ON ward ' +wa.ward_desc +CASE WHEN include_specialty = 1 THEN ' '+ ss.specialty_desc +' specialty'
                        ELSE ''
                         END AS Feeder_desc ,
                   'Bednights' SOURCE,
                   sty.event_encounter_id AS source_system_key,
                   'Hospital stays' AS feeder_system_name,
                   cast(NULL AS varchar(50)) AS source_reference
              FROM fact.fact_inpatient_stay_detail sty
             INNER JOIN dim.dim_ward wa
                ON wa.dim_ward_key =sty.dim_ward_key
             INNER JOIN dim.dim_clinician pr
                ON pr.dim_clinician_key =sty.dim_clinician_key
             INNER JOIN dim.dim_specialty ss
                ON ss.dim_specialty_key =sty.dim_specialty_key
             INNER JOIN fact.fact_contract_activity_event ce
                ON ce.source_encounter = sty.event_encounter_id
             INNER JOIN dim.dim_contract_line cl
                ON cl.dim_contract_line_key = ce.dim_contract_line_key
             WHERE stay_calendar_date >= '01-Jul-2017'
               AND wa.include_in_costs = 1
               AND wa.calculate_as_hours = 0
               AND sty.overnight_stay_flag = 'Y'
            UNION ALL SELECT sty.event_encounter_id encounter_id ,
                   sty.stay_calendar_date Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   CASE WHEN wa.calculate_as_hours = 1 THEN'HOUR'
                        ELSE 'DAY_STAY'
                         END + CASE WHEN include_specialty = 1 THEN '_'+ ss.specialty_code
                        ELSE ''
                         END + CASE WHEN wa.include_ward_code_on_bed_product =1 THEN '_' +wa.ward_code
                        ELSE ''
                         END Feeder_code ,
                   1 Qty ,
                   IFNULL(wa.responsibility_centre_code,'Ward_RC_unk_'+wa.ward_desc) Feeder_Department ,
                   cl.planned_RC_code Charge_RC ,
                   'Day stay ON ward ' +wa.ward_desc +CASE WHEN include_specialty = 1 THEN ' '+ ss.specialty_desc +' specialty'
                        ELSE ''
                         END AS Feeder_desc ,
                   'Bednights daystay' AS SOURCE,
                   sty.event_encounter_id AS source_system_key,
                   'Hospital stays' AS feeder_system_name,
                   cast(NULL AS varchar(50)) AS source_reference
              FROM fact.fact_inpatient_stay_detail sty
             INNER JOIN fact.fact_inpatient_event e
                ON e.event_encounter_id = sty.event_encounter_id
             INNER JOIN dim.dim_ward wa
                ON wa.dim_ward_key =sty.dim_ward_key
             INNER JOIN dim.dim_clinician pr
                ON pr.dim_clinician_key =sty.dim_clinician_key
             INNER JOIN dim.dim_specialty ss
                ON ss.dim_specialty_key =sty.dim_specialty_key
             INNER JOIN fact.fact_contract_activity_event ce
                ON ce.source_encounter = sty.event_encounter_id
             INNER JOIN dim.dim_contract_line cl
                ON cl.dim_contract_line_key = ce.dim_contract_line_key
             WHERE stay_calendar_date >= '01-Jul-2017'
               AND datediff(DAY, e.admission_date, e.discharge_date)=0
               AND wa.include_in_costs = 1
               AND wa.calculate_as_hours = 0
               AND e.discharge_date = sty.stay_end_date
            UNION ALL SELECT sty.event_encounter_id encounter_id ,
                   dateadd(SECOND,-1,cast(cast(sty.stay_calendar_date AS date)AS datetime)) Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   'ON_SPEC' + CASE WHEN ss.incude_ward_in_feeder = 1 AND wa.include_ward_code_on_specialty_product = 1 THEN '_'+wa.ward_code
                        ELSE ''
                         END +CASE WHEN ss.include_clinician_type_on_feeder = 1 THEN '_'+ pr.clinician_type_code
                        ELSE ''
                         END Feeder_code ,
                   1 Qty ,
                   IFNULL(ss.specialty_code,'Ward_RC_unk') Feeder_Department ,
                   cl.planned_RC_code Charge_RC ,
                   'Overnight stay in Specialty ' +specialty_desc + CASE WHEN ss.incude_ward_in_feeder = 1 AND wa.include_ward_code_on_specialty_product = 1 THEN ' '+wa.ward_desc
                        ELSE ''
                         END + CASE WHEN ss.include_clinician_type_on_feeder = 1 THEN ' '+ pr.clinician_type_desc
                        ELSE ''
                         END AS Feeder_desc ,
                   'Spec BN' SOURCE,
                   sty.event_encounter_id AS source_system_key,
                   'Hospital stays' AS feeder_system_name,
                   cast(NULL AS varchar(50)) AS source_reference
              FROM fact.fact_inpatient_stay_detail sty
             INNER JOIN dim.dim_ward wa
                ON wa.dim_ward_key =sty.dim_ward_key
             INNER JOIN dim.dim_clinician pr
                ON pr.dim_clinician_key =sty.dim_clinician_key
             INNER JOIN dim.dim_specialty ss
                ON ss.dim_specialty_key =sty.dim_specialty_key
             INNER JOIN fact.fact_contract_activity_event ce
                ON ce.source_encounter = sty.event_encounter_id
             INNER JOIN dim.dim_contract_line cl
                ON cl.dim_contract_line_key = ce.dim_contract_line_key
              LEFT JOIN dbo.s_outsourced_invoiced_activity_v os
                ON os.encounter_id = sty.event_encounter_id
             WHERE stay_calendar_date >= '01-Jul-2017'
               AND ss.include_in_costs = 1
               AND wa.calculate_as_hours = 0
               AND wa.exclude_from_specialty_products = 0
               AND sty.overnight_stay_flag = 'Y'
               AND os.encounter_id IS NULL
            UNION ALL SELECT sty.event_encounter_id encounter_id ,
                   sty.stay_calendar_date Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   'DAY_SPEC' + CASE WHEN ss.incude_ward_in_feeder = 1 AND wa.include_ward_code_on_specialty_product = 1 AND wa.include_ward_code_on_specialty_product = 1 THEN '_'+wa.ward_code
                        ELSE ''
                         END +CASE WHEN ss.include_clinician_type_on_feeder = 1 THEN '_'+ pr.clinician_type_code
                        ELSE ''
                         END Feeder_code ,
                   1 Qty ,
                   IFNULL(ss.specialty_code,'Ward_RC_unk') Feeder_Department ,
                   cl.planned_RC_code Charge_RC ,
                   'Day stay in Specialty ' +specialty_desc + CASE WHEN ss.incude_ward_in_feeder = 1 THEN ' '+wa.ward_desc
                        ELSE ''
                         END + CASE WHEN ss.include_clinician_type_on_feeder = 1 THEN ' '+ pr.clinician_type_desc
                        ELSE ''
                         END AS Feeder_desc ,
                   'Spec DS' SOURCE,
                   sty.event_encounter_id AS source_system_key,
                   'Hospital stays' AS feeder_system_name,
                   cast(NULL AS varchar(50)) AS source_reference
              FROM fact.fact_inpatient_stay_detail sty
             INNER JOIN fact.fact_inpatient_event e
                ON e.event_encounter_id = sty.event_encounter_id
             INNER JOIN dim.dim_ward wa
                ON wa.dim_ward_key =sty.dim_ward_key
             INNER JOIN dim.dim_clinician pr
                ON pr.dim_clinician_key =sty.dim_clinician_key
             INNER JOIN dim.dim_specialty ss
                ON ss.dim_specialty_key =sty.dim_specialty_key
             INNER JOIN fact.fact_contract_activity_event ce
                ON ce.source_encounter = sty.event_encounter_id
             INNER JOIN dim.dim_contract_line cl
                ON cl.dim_contract_line_key = ce.dim_contract_line_key
              LEFT JOIN dbo.s_outsourced_invoiced_activity_v os
                ON os.encounter_id = sty.event_encounter_id
             WHERE stay_calendar_date >= '01-Jul-2017'
               AND datediff(DAY, e.admission_date, e.discharge_date) = 0
               AND ss.include_in_costs = 1
               AND wa.exclude_from_specialty_products = 0
               AND wa.calculate_as_hours = 0
               AND os.encounter_id IS NULL
               AND e.discharge_date = sty.stay_end_date
            UNION ALL SELECT sty.event_encounter_id encounter_id ,
                   dateadd(SECOND,-1,cast(cast(sty.stay_calendar_date AS date)AS datetime)) Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   'HOUR' +CASE WHEN include_specialty = 1 THEN '_'+ ss.specialty_code
                        ELSE ''
                         END Feeder_code ,
                   (sty.event_stay_duration+30)/60 Qty -- round hours to nearest hour
            ,
                   IFNULL(wa.responsibility_centre_code,'Ward_RC_unk_'+wa.ward_desc) Feeder_Department ,
                   cl.planned_RC_code Charge_RC ,
                   'Hours spent in ward ' +wa.ward_desc +CASE WHEN include_specialty = 1 THEN ' '+ ss.specialty_desc +' specialty'
                        ELSE ''
                         END AS Feeder_desc ,
                   'Hours' SOURCE,
                   sty.event_encounter_id AS source_system_key,
                   'Hospital stays' AS feeder_system_name,
                   cast(NULL AS varchar(50)) AS source_reference
              FROM fact.fact_inpatient_stay_detail sty
             INNER JOIN dim.dim_ward wa
                ON wa.dim_ward_key =sty.dim_ward_key
             INNER JOIN dim.dim_clinician pr
                ON pr.dim_clinician_key =sty.dim_clinician_key
             INNER JOIN dim.dim_specialty ss
                ON ss.dim_specialty_key =sty.dim_specialty_key
             INNER JOIN fact.fact_contract_activity_event ce
                ON ce.source_encounter = sty.event_encounter_id
             INNER JOIN dim.dim_contract_line cl
                ON cl.dim_contract_line_key = ce.dim_contract_line_key
              LEFT JOIN dbo.s_outsourced_invoiced_activity_v os
                ON os.encounter_id = sty.event_encounter_id
             WHERE stay_calendar_date >= '01-Jul-2017'
               AND wa.include_in_costs = 1
               AND wa.calculate_as_hours = 1
            UNION ALL SELECT sty.event_encounter_id encounter_id ,
                   dateadd(SECOND,-1,cast(cast(sty.stay_calendar_date AS date)AS datetime)) Activity_Date ,
                   sty.patient_NHI ,
                   pr.clinician_code ,
                   'Bed_Day'+ CASE WHEN wa.health_org_level1_code = 'WDHB' THEN '_' + wa.health_org_level2_code
                        ELSE ''
                         END AS Feeder_code ,
                   1 Qty ,
                   'BNF' AS Feeder_Department --***This is new stands for BedNightFacility. What should I use - I only want one feeder dept to come through. Should I use an existing one eg 'NCL"?**** 
             ,
                   cl.planned_RC_code Charge_RC ,
                   'Bednight Count by Facility'+ wa.health_org_level2_desc AS Feeder_desc ,
                   'Facility nights' SOURCE, 
                   sty.event_encounter_id AS source_system_key, 
                   'Hospital stays' AS feeder_system_name, 
                   cast(NULL AS varchar(50)) AS source_reference 
              FROM fact.fact_inpatient_stay_detail sty 
             INNER JOIN dim.dim_ward wa 
                ON wa.dim_ward_key =sty.dim_ward_key 
             INNER JOIN dim.dim_clinician pr 
                ON pr.dim_clinician_key =sty.dim_clinician_key 
             INNER JOIN fact.fact_contract_activity_event ce 
                ON ce.source_encounter = sty.event_encounter_id 
             INNER JOIN dim.dim_contract_line cl 
                ON cl.dim_contract_line_key = ce.dim_contract_line_key 
             WHERE stay_calendar_date >= '01-Jul-2019' 
               AND wa.include_in_costs = 1 
               AND sty.overnight_stay_flag = 'Y' --ensures fact is an overnight stay
        dependencies:
          - locationName: TGT
            nodeName: FACT_INPATIENT_STAY_DETAIL
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','FACT_INPATIENT_STAY_DETAIL') }}
        name: S_FEEDER_BEDNIGHTS
        noLinkRefs: []
  name: S_FEEDER_BEDNIGHTS
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
