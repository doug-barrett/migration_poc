fileVersion: 1
id: 1416d2ed-a7ef-4087-bced-3af27d691815
name: S_CONTRACT_ACTIVITY_INPATIENT_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 499947cb-9fa4-4467-8b04-d1290d914c48
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Generated column used to join to correct Price Volume Schdule Line
        name: PROVIDER_FUNDER_SPLIT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: "'Provider'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 91a4f857-7af1-4aaf-9b4e-617303f543ae
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Identifier for mapping rule that allocates the purchase unit
        name: PUC_MAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ce43525-4831-462c-990c-000ae6ec9f76
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 48ecd271-1b79-4f44-9032-ef4d0995c230
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 28a2ff3b-5729-4ac7-adac-fa3742fadb5f
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 824c85b0-6446-4c95-b1fd-9bfd2f6dd201
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: 'health_specialty_code '
        name: HEALTH_SPECIALTY_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 52835f9f-4af2-4514-8cbf-e79f91a677f1
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1014a144-acf6-4c19-aa9c-a63268b296bc
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FACILITY_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c58a79f9-b36f-4d77-96b1-8522082fb8f7
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0114885-a20e-4789-bb96-b5f9323ab316
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Has twelve months added. Mental Health data was 24 months old so 12 months added int his step and the s_contract_activity_10
        name: REPORTING_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1194b095-01da-420c-9d65-f3c14141c634
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 98c9bdfa-1455-4c81-8336-1fc71694c387
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 76b96fdf-6b9c-427c-8a80-def190a20d0b
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 98c9bdfa-1455-4c81-8336-1fc71694c387
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f011a41a-b68a-41b3-aa17-6d8f1a42dd29
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7fcf5f43-b303-4c9d-a7b1-7e649a7116f2
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa315440-26e3-41e5-bf98-dfb7a6b8b54d
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 01c61f5c-21f8-498c-8a9a-3bf9fc714db7
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 381bf1b7-89db-4263-a402-a711f2c08b7b
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_in_patient_event_05.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2690c1e2-0c8f-4db2-922d-c7269b52431d
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 03430bef-c241-49d4-93ef-0b9388526523
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8dd12cac-991a-49b8-8178-081cb1c04add
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d98142f0-f261-4055-ad8c-581c6636e853
                stepCounter: 04c42cb2-f015-4d9e-ae6d-9feed9f13b97
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cb62da1c-9160-4d25-b47b-12a0b7804b89
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: 'national admission type code '
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d98142f0-f261-4055-ad8c-581c6636e853
                stepCounter: 04c42cb2-f015-4d9e-ae6d-9feed9f13b97
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 71a81761-cf0b-4305-bd56-906266779b03
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b013aae2-00f1-4e2e-89ce-cac5b973a1bd
                stepCounter: 330ad0aa-b8b1-4da9-ab37-b4fe8f889452
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fcdb6ed7-d8be-45ee-8563-1f13b608d87d
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3978b2dc-2299-422d-a614-f8a65504fa1f
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5d3e3d6a-84f8-4b88-af17-2efdd6294049
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b113a0ee-c39c-4645-b322-d6fc9e8e91db
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dea98abe-cfd1-45b5-9f9b-8ce92bea5f6a
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 380659f3-6287-4ae4-90cb-122aa8b321d7
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: Purchase unit volume derived from forecasting
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: de0b6757-9a78-4ac0-b29f-6392343d6733
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 18bfabd7-19aa-4de0-9ce7-aa560645bce6
                stepCounter: 3d5ba8a8-80ec-4848-b58a-d31b34cc53ed
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f1306615-7b2f-4eae-835a-b862eb87ad09
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1f72de-9847-4770-8eda-48e40fdb696b
                stepCounter: 2c51f4f9-57b5-4407-b99a-a74174e84fac
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9463756-8802-47de-b7c4-61c4fa5c3af1
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9ad4c740-1a4d-4d09-86cd-7155c763d553
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3c468890-f598-41f1-ac14-42b41f543efc
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: discharging clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 80bd1376-527d-46ad-9692-afffab32b3ce
                stepCounter: 8df670f5-1ae7-4d72-aa3e-f032f348b011
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69b40597-8af7-42a4-9c0a-1617770eb465
          stepCounter: 1416d2ed-a7ef-4087-bced-3af27d691815
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: "'iPM-IP'"
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'Provider' provider_funder_split,
                   ev.PUC_map_id,
                   ev.responsibility_centre_code,
                   ev.discharge_health_specialty_code health_specialty_code,
                   ev.hospital_id facility_code,
                   ev.disch_date reporting_date,
                   ev.event_encounter_id source_encounter,
                   ev.event_encounter_id funded_event_encounter,
                   ev.event_encounter_type_code,
                   ev.patient_NHI NHI,
                   ev.dim_patient_key,
                   ev.adcat_refno admin_category_reference_no,
                   IIF(pu.unit_of_measure = 'Cost Weighted Discharge', CASE WHEN ad.admission_type_code = 'WN' THEN 'ELECTIVE' WHEN ad.admission_type_code = 'AC' THEN 'ACUTE' WHEN ad.admission_type_code = 'AA' THEN IIF(ev.disch_date >= '2020-07-01', 'ARRANGED', 'ACUTE') ELSE 'OTHER' END, 'OTHER') contract_admit_type,
                   ad.admission_type_code,
                   IIF(ev.disch_date <= CAST(GETDATE() AS date), IFNULL(dm.IDF_class, 'Non-IDF'), NULL) IDF_class,
                   ev.domicile_code,
                   ev.purchase_unit_code,
                   CASE WHEN ct.inpatient_purchaser IN ('35') THEN CASE WHEN pu.unit_of_measure = 'Cost Weighted Discharge' THEN IFNULL(ev.WIES, w.WIES_rating_avg) WHEN pu.unit_of_measure like '%bed day%' THEN ev.event_length_of_stay ELSE 1 END
                        ELSE 0
                         END purchase_unit_volume,
                   IIF(pu.unit_of_measure ='Cost Weighted Discharge' AND ev.DRG_code IS NULL, w.WIES_rating_avg, 0) estimated_purchase_unit_volume,
                   IFNULL(ag.dim_age_group_key, 0) dim_age_group_key,
                   IFNULL(pc.dim_planned_care_key, 0) dim_planned_care_key,
                   ev.DRG_code,
                   COALESCE(st.episode_proca_refno, st.stay_proca_refno) clinician_reference_no,
                   'iPM-IP' source_system
              FROM s_in_patient_event_05 ev
              JOIN s_in_patient_stay_05 st
                ON ev.event_encounter_id = st.event_encounter_id
               AND st.event_stay_seq_num = st.event_stay_count
              LEFT OUTER JOIN s_admin_category ac
                ON ev.adcat_refno = ac.admin_category_reference_no
              JOIN dim.dim_admission_type ad
                ON ev.admet_refno = ad.admission_method_reference_no
               AND ad.dss_current_flag = 'Y'
              JOIN dim.dim_intended_management_type mt
                ON ev.inmgt_refno = mt.intended_management_type_reference_no
               AND mt.dss_current_flag = 'Y'
              LEFT OUTER JOIN dim.dim_domicile dm
                ON ev.domicile_code = dm.domicile_code
               AND ev.admit_date BETWEEN dm.dss_start_date AND dm.dss_end_date
              LEFT OUTER JOIN dim.dim_purchase_unit pu
                ON ev.purchase_unit_code = pu.purchase_unit_code
               AND ev.disch_date BETWEEN pu.validity_start_date AND pu.validity_end_date
              LEFT OUTER JOIN dim.dim_age_group ag
                ON ev.patient_age_on_arrival_years = ag.age_years
               AND ag.dss_current_flag = 'Y'
              LEFT OUTER JOIN dim.dim_inpatient_admin_category ct
                ON ev.adcat_refno = ct.inpatient_admin_category_reference_no
               AND ct.dss_current_flag = 'Y' -- Need to join to dim_planned_care via l_mappings_planned_care_IP

              LEFT JOIN l_mappings_planned_care_IP lm
                ON lm.purchase_unit_code = ev.purchase_unit_code
               AND lm.purchaser_code = ac.purchaser
               AND lm.drg_code_char_2 = IFNULL(SUBSTRING(ev.DRG_code, 2, 1), 1)
               AND lm.admission_type_code = ev.admission_method_code
               AND ev.disch_date BETWEEN lm.start_date AND IFNULL(lm.end_date, GETDATE())
              LEFT JOIN dim.dim_planned_care pc
                ON pc.planned_care_intervention_component = lm.planned_care_intervention_component
              LEFT JOIN l_reference_LOS_Grouping g
                ON ev.event_length_of_stay = g.Day
              LEFT OUTER JOIN s_in_patient_coded_WIES_v w
                ON ev.hospital_id = w.hospital_id
               AND ev.admission_method_code = w.admission_method_code
               AND ev.health_specialty_code = w.health_specialty_code
               AND g.WIES_Grouping = w.WIES_Grouping
             WHERE 1=1
               AND intended_management_type_code <> 'OP'
        dependencies: []
        join:
          joinCondition: None
        name: S_CONTRACT_ACTIVITY_INPATIENT_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_INPATIENT_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
