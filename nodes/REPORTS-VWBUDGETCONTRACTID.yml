fileVersion: 1
id: c4409e0a-f729-4a23-aef5-d3ec08cb6955
name: VWBUDGETCONTRACTID
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3fa24c8c-abc7-4fb4-9eb4-8da8dbcd263d
          stepCounter: c4409e0a-f729-4a23-aef5-d3ec08cb6955
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CONTRACTID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 949ff2a9-9b82-4225-b093-dd09132e7057
          stepCounter: c4409e0a-f729-4a23-aef5-d3ec08cb6955
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: BUDGETDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 606c4dd7-4567-42e4-b7b0-60473a012a0e
          stepCounter: c4409e0a-f729-4a23-aef5-d3ec08cb6955
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: BUDGETSALESAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 123279e9-c194-42ac-bd5c-fadf3927dc2a
          stepCounter: c4409e0a-f729-4a23-aef5-d3ec08cb6955
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: BUDGETREVENUEAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 87087fca-7745-432f-8361-cff08ff054a9
          stepCounter: c4409e0a-f729-4a23-aef5-d3ec08cb6955
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: BUDGETTYPE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            --------------------------------------------------------------------------------------------------------------------------
             --Get Amounts to use by 2019 Budget Date
             --------------------------------------------------------------------------------------------------------------------------
             WITH cteReportsSalesAndRevenue AS (
                    SELECT ISNULL([sar].[TerritoryDivisionId], CASE--This CASE statement is used to assign correct Division Name when Territory Assignment is NULL due to data or hierarchy issues
              WHEN [sar].[OrganizationId] IN(1, 5, 6) THEN 1--Public
              WHEN [sar].[OrganizationId] IN(2, 3, 4, 7) THEN 2--Private
              ELSE 1 END) AS [TerritoryDivisionId],
                           [sar].[ReceiptDate],
                           [sar].[Sales],
                           [sar].[Revenue],
                           [sar].[ReceiptDateKey],
                           [sar].[ContractId]
                      FROM [Reports].[SalesAndRevenue] AS [sar]
                     WHERE [sar].[ReceiptDateKey] BETWEEN 20190101 AND 20191231 -- Actuals for Q1-Q4 2019

                   ),
                   cteTotalSalesRevenue --Get Actuals for months closed in 2019
              AS (
                    SELECT [sar].[ContractId],
                           [sar].[ReceiptDate],
                           CASE YEAR([sar].[ReceiptDate])
                                WHEN 2018                 THEN DATEADD([yy], 1, [sar].[ReceiptDate])
                                ELSE [sar].[ReceiptDate]
                                 END AS [BudgetDate],
                           SUM([sar].[Sales]) AS [TotalSales],
                           SUM([sar].[Revenue]) AS [TotalRevenue]
                      FROM [cteReportsSalesAndRevenue] AS [sar]
                     WHERE [sar].[TerritoryDivisionId] IN (1, 2)
                     GROUP BY [sar].[ContractId],
                              [sar].[ReceiptDate]
                   ) --SELECT budgetdate, sum([TotalRevenue]) FROM cteTotalSalesRevenue AS [ctbr] GROUP BY budgetdate ORDER BY [ctbr].[BudgetDate]
              ,
                   [cteTotalBudgetRevenue] --Get Budget values for 2019
              AS (
                    SELECT [bd].[ContractId],
                           [b].[BudgetDate],
                           SUM([b].[BudgetSalesAmount] * [tbg].[Adjustment]) AS [BudgetSalesAmount],
                           SUM([b].[BudgetRevenueAmount] * [tbg].[Adjustment]) AS [BudgetRevenueAmount]
                      FROM [Fact].[Budget] AS [b]
                      LEFT OUTER JOIN [Dim].[BudgetDetail] AS [bd]
                        ON [b].[BudgetDetailKey] = [bd].[BudgetDetailKey]
                      LEFT OUTER JOIN [Dim].[SalesTerritory_2019] AS [st]
                        ON [b].[SalesTerritoryKey] = [st].[SalesTerritory_2019Key]
                      LEFT OUTER JOIN [Dim].[TerritoryBudgetGrowth] AS [tbg]
                        ON [b].[BudgetDate] = [tbg].[BudgetDate]
                       AND [st].[TerritoryDivisionId] = [tbg].[TerritoryDivisionId]
                     WHERE [b].[BudgetDateKey] BETWEEN 20191001 AND 20191231 --AND [st].[TerritoryDivisionId] IN (1, 2)

                     GROUP BY [bd].[ContractId],
                              [b].[BudgetDate]
                   ) --SELECT budgetdate, sum([BudgetRevenueAmount]) FROM [cteTotalBudgetRevenue] AS [ctbr] GROUP BY budgetdate ORDER BY [ctbr].[BudgetDate]
              ,
                   cteMasterBudgetByBudgetDate AS (
                    SELECT ISNULL([ctbr].[ContractId], [ctsr].[ContractId]) AS [ContractId],
                           ISNULL([ctbr].[BudgetDate], [ctsr].[BudgetDate]) AS [BudgetDate],
                           [ctsr].[TotalSales] AS [BudgetSalesAmount],
                           [ctsr].[TotalRevenue] AS [BudgetRevenueAmount]
                      FROM [cteTotalBudgetRevenue] AS [ctbr]
                      FULL OUTER JOIN [cteTotalSalesRevenue] AS [ctsr]
                        ON [ctbr].[BudgetDate] = [ctsr].[BudgetDate]
                       AND [ctbr].[ContractId] = [ctsr].[ContractId] --ORDER BY [ctbr].[BudgetDate]

                   ) --SELECT budgetdate, sum([cmbbbd].[BudgetRevenueAmount]) FROM [cteMasterBudgetByBudgetDate] AS [cmbbbd] GROUP BY budgetdate ORDER BY [cmbbbd].[BudgetDate]--, [ContractId]
              , --------------------------------------------------------------------------------------------------------------------
              cteContractIdBudget_2019 AS (
                    SELECT --2019 Budget by ContractId
              [clb].[ContractId],
                           [clb].[BudgetDate],
                           [clb].[BudgetSalesAmount],
                           [clb].[BudgetRevenueAmount],
                           CASE WHEN [c].[SourceEntityName] = 'Insight GPO' THEN CAST('PD Budget - ISG' AS VARCHAR(20))
                                ELSE CAST('PD Budget' AS VARCHAR(20))
                                 END AS [BudgetType]
                      FROM [cteMasterBudgetByBudgetDate] AS [clb]
                      LEFT OUTER JOIN [Dim].[Contract] AS [c]
                        ON [clb].[ContractId] = [c].[ContractId]
                   ) --SELECT * FROM cteContractIdBudget_2019 WHERE contractid = '2014'
              --------------------------------------------------------------------------------------------------------------------
              ,
                   cteContractIdBudget_2020 AS (
                    SELECT --2020 Budget by ContractId
              [clb].[ContractId],
                           [clb].[BudgetDate],
                           [clb].[BudgetSalesAmount],
                           [clb].[BudgetRevenueAmount],
                           [clb].[BudgetType]
                      FROM [Fact].[RevenueBudget] AS [clb]
                     WHERE [clb].[BudgetDateKey] BETWEEN 20200101 AND 20201231
                       AND [clb].[BudgetType] LIKE 'PD Budget%'
                   ) --SELECT year([cfb].[BudgetDate]), [cfb].[BudgetType], SUM([cfb].[BudgetRevenueAmount]) FROM cteContractIdBudget_2020 AS [cfb] GROUP BY year([cfb].[BudgetDate]), [cfb].[BudgetType] ORDER BY year([cfb].[BudgetDate]), [cfb].[BudgetType]
              --SELECT year([cfb].[BudgetDate]), [cfb].[BudgetType], SUM([cfb].[BudgetRevenueAmount]) FROM [Reports].[vwBudgetContractID_ISG] AS [cfb] GROUP BY year([cfb].[BudgetDate]), [cfb].[BudgetType] ORDER BY year([cfb].[BudgetDate]), [cfb].[BudgetType]
              SELECT [clb].[ContractId],
                   [clb].[BudgetDate],
                   [clb].[BudgetSalesAmount],
                   [clb].[BudgetRevenueAmount],
                   [clb].[BudgetType]
              FROM [cteContractIdBudget_2019] AS [clb]
             UNION SELECT [clb].[ContractId],
                   [clb].[BudgetDate],
                   [clb].[BudgetSalesAmount],
                   [clb].[BudgetRevenueAmount],
                   [clb].[BudgetType]
              FROM [cteContractIdBudget_2020] AS [clb] --UNION
              --SELECT
              --	[clb].[ContractId],
              --	[clb].[BudgetDate],
              --	[clb].[BudgetSalesAmount],
              --	[clb].[BudgetRevenueAmount],
              --	[clb].[BudgetType]
              --FROM   [Reports].[vwBudgetContractID_ISG] AS [clb]
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: VWBUDGETCONTRACTID
        noLinkRefs: []
  name: VWBUDGETCONTRACTID
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
