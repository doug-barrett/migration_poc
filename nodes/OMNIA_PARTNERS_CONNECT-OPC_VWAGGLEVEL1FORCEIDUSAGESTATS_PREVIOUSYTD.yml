fileVersion: 1
id: eb49c785-24a5-4afd-8f41-e46731851c90
name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "YTD aggregate usage statistics for each Level1ForceId"
  isMultisource: false
  locationName: OMNIA_PARTNERS_CONNECT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c6a30383-943d-4d4d-86b4-ffc92bd8eaf9
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: Level1ForceId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17834672-715a-4a59-9f1c-aa301aed4e11
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55317684-8e9e-4e7f-8a6e-093f717415c9
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: SUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 66a7efe2-cc10-475e-b8e7-67c6f205015b
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e61d67ec-5900-463a-aaba-8a18b8c1f43b
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: DATE
        defaultValue: ""
        description: DSSMaxTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSMAXTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 419ee032-a332-4660-ab3e-41789ae83683
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: MAX(OPSalesAndRevenue.MaxReceiptDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: db36f901-aae7-4383-bc63-4e3cb29951d0
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: DATE
        defaultValue: ""
        description: PreviousYTD_MostRecentTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_MOSTRECENTTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: eedff006-26f5-4ee6-a114-8bca9e60393a
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: MAX(OPSalesAndRevenue.TransactionDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d8b7638a-a8ac-4c21-8565-553d9970a3cd
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_MonthsSinceLastTransaction
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_MONTHSSINCELASTTRANSACTION
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: eedff006-26f5-4ee6-a114-8bca9e60393a
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: DATEDIFF(MONTH,MAX(OPSalesAndRevenue.TransactionDate),MAX(OPSalesAndRevenue.MaxReceiptDate))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 161cbd54-c250-41d5-94d7-530e61b71fb0
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfSuppliersUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFSUPPLIERSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f545bfb6-c2b1-46c4-b179-59743d486207
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.FinancialReportingSupplierName) OVER (PARTITION BY OPSalesAndRevenue.Level1ForceId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 943deb9c-9485-4399-9617-84a1f0d0f807
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContractsUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTRACTSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ba802b9c-d505-48f1-8d0e-78850c4ebf67
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.InitialContractId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e6f15fa9-ed23-4e44-b03d-1a6ce1313054
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContractCategoriesUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTRACTCATEGORIESUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 37890ce8-113b-4cf9-88f6-ac0204f2b2e3
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.ContractCategory)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8ef8da2-8fb4-4eb3-9cb4-ccb1bc75af4c
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_SumOfSales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_SUMOFSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e8504e6-4204-4589-85e5-227bd76fa4e1
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: SUM(OPSalesAndRevenue.Sales)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce2633a4-bc5e-49b1-923b-da40923ddb80
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_SumOfRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_SUMOFREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e91e5021-0002-4847-b986-ba96d4e9850e
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: SUM(OPSalesAndRevenue.Revenue)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18b3b136-7306-4f09-b0e3-b26023ea07f3
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_RankbySales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_RANKBYSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e8504e6-4204-4589-85e5-227bd76fa4e1
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Sales) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d33bdcc-d6cf-4f86-b519-26547bdb6a1e
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_RankbyRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_RANKBYREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e91e5021-0002-4847-b986-ba96d4e9850e
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Revenue) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4cbf5ff3-2473-4b02-b124-e62565c479c7
          stepCounter: eb49c785-24a5-4afd-8f41-e46731851c90
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContacts
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTACTS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0c6c95a9-173a-41a1-8a25-a73143fcc576
                stepCounter: 5fa12080-8040-4cbf-96f4-8e9c84eee853
            transform: COUNT (DISTINCT Contact.DimContactKey)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW OPC.vwAggLevel1ForceIdUsageStats_CurrentYTD -- (Level1ForceId, Level1DisplayAccountName, NumOfSuppliersUsed, NumOfContractsUsed, NumOfContractCategoriesUsed, AsOfMaxReceiptDate, MonthsSinceLastTransaction, MostRecentReceiptDate, SumOfSales, SumOfRevenue, SumOfRevenue, RankbyRevenue, RankbySales, NumOfContacts, DSSCreateTime, DSSUpdateTime)
             AS SELECT SalesAndRevenue.Level1ForceId AS Level1ForceId ,
                   SalesAndRevenue.Level1DisplayAccountName AS Level1DisplayAccountName ,
                   SalesAndRevenue.SupplierId AS SupplierId ,
                   COUNT (DISTINCT FinancialReportingSupplierName) AS CurrentYTD_NumOfSuppliersUsed ,
                   COUNT (DISTINCT InitialContractId) AS CurrentYTD_NumOfContractsUsed ,
                   COUNT (DISTINCT ContractCategory) AS CurrentYTD_NumOfContractCategoriesUsed ,
                   MAX(MaxReceiptDate) AS DSSMaxTransactionDate ,
                   DATEDIFF(MONTH, MAX(TransactionDate), MAX(MaxReceiptDate)) AS CurrentYTD_MonthsSinceLastTransaction ,
                   MAX(TransactionDate) AS CurrentYTD_MostRecentTransactionDate ,
                   SUM(Sales) AS CurrentYTD_SumOfSales ,
                   SUM(Revenue) AS CurrentYTD_SumOfRevenue ,
                   RANK() OVER (ORDER BY SUM(REVENUE) DESC) AS CurrentYTD_RankbyRevenue ,
                   RANK() OVER (ORDER BY SUM(SALES) DESC) AS CurrentYTD_RankbySales ,
                   COUNT (DISTINCT DimContactKey) AS CurrentYTD_NumOfContacts ,
                   GETDATE() AS DSSCreateTime ,
                   GETDATE() AS DSSUpdateTime
              FROM OP.OPSalesAndRevenue AS SalesAndRevenue
              LEFT OUTER JOIN Dim.Contact AS Contact
                ON Contact.Level1ForceId = SalesAndRevenue.Level1ForceId -- AND IsCapitalContract = 0 --Exclude capital contracts

             WHERE DATEDIFF(YEAR,TransactionDate,MaxReceiptDate) = 0
             GROUP BY SalesAndRevenue.Level1ForceId,
                      Level1DisplayAccountName,
                      SupplierId;
        dependencies:
          - locationName: DIM
            nodeName: CONTACT
          - locationName: OP
            nodeName: OPSALESANDREVENUE
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DIM','CONTACT') }}
            {{ ref('OP','OPSALESANDREVENUE') }}
        name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
        noLinkRefs: []
  name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
