fileVersion: 1
id: e6220985-4917-46fb-8dda-4e48ebbc9123
name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "YTD aggregate usage statistics for each Level1ForceId"
  isMultisource: false
  locationName: OMNIA_PARTNERS_CONNECT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 447023e3-7c53-4eb7-aefb-e958e9a3cf3d
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: Level1ForceId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6ea0e49f-9d46-4faa-8ebd-256264fe362f
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9ee5597c-dce1-48cf-94b3-835794c69087
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: SUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e1e61397-1158-4c4a-8086-9eb391293a8b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3aa275ab-f435-42e9-a759-ed008f1ab739
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: DATE
        defaultValue: ""
        description: DSSMaxTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSMAXTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be651b66-97d5-463d-a1a2-c18b0692cd19
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: MAX(OPSalesAndRevenue.MaxReceiptDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 20b8f68f-5b69-4dc2-bb12-7cd8b50c88c1
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: DATE
        defaultValue: ""
        description: PreviousYTD_MostRecentTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_MOSTRECENTTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72d853b1-2c60-429c-9c50-67ef44ca32ff
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: MAX(OPSalesAndRevenue.TransactionDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d1238ec0-b599-4a10-938e-b13d8745cd98
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_MonthsSinceLastTransaction
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_MONTHSSINCELASTTRANSACTION
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72d853b1-2c60-429c-9c50-67ef44ca32ff
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: DATEDIFF(MONTH,MAX(OPSalesAndRevenue.TransactionDate),MAX(OPSalesAndRevenue.MaxReceiptDate))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5321d7e8-56e0-428e-80b1-4abf8d1acd1d
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfSuppliersUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFSUPPLIERSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9553a61f-3806-4cd2-8df2-80606567ed33
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.FinancialReportingSupplierName) OVER (PARTITION BY OPSalesAndRevenue.Level1ForceId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 50b4826f-b388-4879-b412-4bed0fed24cb
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContractsUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTRACTSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 35d9e7f2-d183-4db2-b711-1b7bfa20d946
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.InitialContractId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 598eeaf1-c5b4-4603-b215-7d9dbbb34775
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContractCategoriesUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTRACTCATEGORIESUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ea681605-d658-47db-bca4-bab58a6fe221
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.ContractCategory)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: daad684e-cc01-4c89-b8a6-d7892a90997e
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_SumOfSales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_SUMOFSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f0ef5b2-912b-4797-864c-c9eea3f6a42c
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: SUM(OPSalesAndRevenue.Sales)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 92922631-a05d-4764-b92b-b97757710d36
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_SumOfRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_SUMOFREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be11fa76-dfa3-408b-9073-f4d08cba469b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: SUM(OPSalesAndRevenue.Revenue)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7049997d-054d-4ada-8f3d-13e0384ce741
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_RankbySales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_RANKBYSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f0ef5b2-912b-4797-864c-c9eea3f6a42c
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Sales) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e143650-89fb-4eb1-94b6-da0467933858
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_RankbyRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_RANKBYREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be11fa76-dfa3-408b-9073-f4d08cba469b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Revenue) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a98797bc-6996-41d8-9443-fbc9c711e8a2
          stepCounter: e6220985-4917-46fb-8dda-4e48ebbc9123
        config: {}
        dataType: INT
        defaultValue: ""
        description: PreviousYTD_NumOfContacts
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: PREVIOUSYTD_NUMOFCONTACTS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a73af37f-395a-43e2-ad1e-46c2fedc925a
                stepCounter: e165c76e-6a45-4567-817a-c8ecf377ecd2
            transform: COUNT (DISTINCT Contact.DimContactKey)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW OPC.vwAggLevel1ForceIdUsageStats_CurrentYTD -- (Level1ForceId, Level1DisplayAccountName, NumOfSuppliersUsed, NumOfContractsUsed, NumOfContractCategoriesUsed, AsOfMaxReceiptDate, MonthsSinceLastTransaction, MostRecentReceiptDate, SumOfSales, SumOfRevenue, SumOfRevenue, RankbyRevenue, RankbySales, NumOfContacts, DSSCreateTime, DSSUpdateTime)
             AS SELECT SalesAndRevenue.Level1ForceId AS Level1ForceId ,
                   SalesAndRevenue.Level1DisplayAccountName AS Level1DisplayAccountName ,
                   SalesAndRevenue.SupplierId AS SupplierId ,
                   COUNT (DISTINCT FinancialReportingSupplierName) AS CurrentYTD_NumOfSuppliersUsed ,
                   COUNT (DISTINCT InitialContractId) AS CurrentYTD_NumOfContractsUsed ,
                   COUNT (DISTINCT ContractCategory) AS CurrentYTD_NumOfContractCategoriesUsed ,
                   MAX(MaxReceiptDate) AS DSSMaxTransactionDate ,
                   DATEDIFF(MONTH, MAX(TransactionDate), MAX(MaxReceiptDate)) AS CurrentYTD_MonthsSinceLastTransaction ,
                   MAX(TransactionDate) AS CurrentYTD_MostRecentTransactionDate ,
                   SUM(Sales) AS CurrentYTD_SumOfSales ,
                   SUM(Revenue) AS CurrentYTD_SumOfRevenue ,
                   RANK() OVER (ORDER BY SUM(REVENUE) DESC) AS CurrentYTD_RankbyRevenue ,
                   RANK() OVER (ORDER BY SUM(SALES) DESC) AS CurrentYTD_RankbySales ,
                   COUNT (DISTINCT DimContactKey) AS CurrentYTD_NumOfContacts ,
                   GETDATE() AS DSSCreateTime ,
                   GETDATE() AS DSSUpdateTime
              FROM OP.OPSalesAndRevenue AS SalesAndRevenue
              LEFT OUTER JOIN Dim.Contact AS Contact
                ON Contact.Level1ForceId = SalesAndRevenue.Level1ForceId -- AND IsCapitalContract = 0 --Exclude capital contracts

             WHERE DATEDIFF(YEAR,TransactionDate,MaxReceiptDate) = 0
             GROUP BY SalesAndRevenue.Level1ForceId,
                      Level1DisplayAccountName,
                      SupplierId;
        dependencies:
          - locationName: DIM
            nodeName: CONTACT
          - locationName: OP
            nodeName: OPSALESANDREVENUE
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DIM','CONTACT') }}
            {{ ref('OP','OPSALESANDREVENUE') }}
        name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
        noLinkRefs: []
  name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_PREVIOUSYTD
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
