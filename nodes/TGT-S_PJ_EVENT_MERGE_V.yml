fileVersion: 1
id: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
name: S_PJ_EVENT_MERGE_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "Merge together events from ED, IP, OP and Theatre."
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc38958e-73b6-48e9-b62f-340eaba1d01e
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Source for this event e.g. ED, Inpatient.
        name: EVENT_SOURCE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e0d95524-d78d-40cf-b1a3-ce0401097eb3
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 76b038bd-7e26-45bd-be4c-886c217906d4
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5cadfd7-d00b-4faf-a2ee-850db1c188fd
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: encounter unique identifier
        name: ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 44bca1a6-e316-4993-8d82-b41e82e756e7
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 22154928-dbbe-44f2-ac51-e762a8317014
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP encounter unique identifier
        name: IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 44bca1a6-e316-4993-8d82-b41e82e756e7
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a630203d-e215-4cf4-b5f4-f2b3ae3bf23e
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ED Encounter unique identifier
        name: ED_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 04157529-10b2-479e-8d0d-a5e38b443ca2
                stepCounter: 1f888c0c-c0bc-4225-aebf-0a0cae18c7f0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 610f4b1d-94a2-486b-9343-16506c445670
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ED_HOSPITAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d3931b8e-cbc8-4775-b3f5-96b2d67e960b
                stepCounter: 1f888c0c-c0bc-4225-aebf-0a0cae18c7f0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aaef0339-0421-41ee-b6ed-461ecf391868
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Theatre Encounter unique identifier
        name: THEATRE_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a2675b06-b610-45b5-82f3-4c2aa5ba5dd5
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: theatre_acute_flag
        name: THEATRE_ACUTE_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 55445f60-08f5-4314-970a-d7c9a9556c77
                stepCounter: 5e652275-92c8-4da6-85d0-b9f43a68cf7a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 394e99c1-3f5e-4496-90c9-a4aa4a96756e
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: ""
        name: THEATRE_CANCELLED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2c593c8a-7bfd-41fd-b0f9-65d9458280b0
                stepCounter: 5e652275-92c8-4da6-85d0-b9f43a68cf7a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8c1aab16-a9f3-4fbe-8994-679410513891
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: OP encounter unique identifier
        name: OP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e6e1ff32-ad09-4726-ac8f-a05ab6aacd43
                stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: db80635a-2411-44db-9737-7a21ba78a6cb
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RADIOLOGY_ACCESSION_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5c9c3a92-4618-4a7c-9860-e370c1014caa
                stepCounter: 599dda53-de86-414a-a6a2-52dff404c37f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 638b4af1-130a-4fa0-85e8-8fd7c6c037bc
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(22)
        defaultValue: ""
        description: eOrder_id
        name: RADIOLOGY_EORDER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 961336e8-834d-48e4-80b9-63cce9732b4c
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Event start date and time e.g. admit time.
        name: EVENT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ac81f4d-5011-424b-9139-4f6c7d36d034
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b03d05a5-ea1a-41af-830f-67907a9ec91d
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the event ended e.g. discharge time.
        name: EVENT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 22b1ef25-f90e-4eaf-9897-edb2588d8daf
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b5717959-4c07-473f-b0bd-0e4209d6eb0a
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: 'ip event_length_of_stay '
        name: IP_EVENT_LENGTH_OF_STAY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 25b572c8-2a09-4cbb-9414-fd42ecc17ab3
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 26483bec-a854-4218-a983-84a09693461c
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Service_Point_Code
        name: IP_ADMIT_WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a59994e-d549-4da4-8a58-b5885d51ace4
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 761d4bfd-033b-47ce-a9b1-980b6ce551e7
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Service_Point_Code
        name: IP_DISCHARGE_WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d062d85-8cbe-4058-af07-3c5785a2f39b
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d4bbec17-b2d3-4ced-8a3a-8f39d8fb7709
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Specialty Code
        name: IP_ADMIT_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72e3a973-31b6-4160-b09b-947c7f1434a0
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9f388c36-6906-4532-8ba6-b81bef09b3e3
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Specialty Code
        name: IP_DISCHARGE_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17b7adce-f817-40b9-949c-6a7802729941
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a3993f44-a5bc-473a-9d20-7c51983a847c
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: VARCHAR(5)
        defaultValue: ""
        description: ""
        name: DRG_FAMILY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cc92df44-2b60-4e68-b9e4-770e56964766
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e56a015d-19bb-43a0-838c-cb4d5f554569
          stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the event has been clinically coded to a DRG.
        name: CODED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: de19bfb9-130a-4cbc-a980-1e95c68aa939
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'IP' event_source,
                   patient_NHI,
                   ip_encounter_id encounter_id,
                   ip_encounter_id,
                   CONVERT(varchar(20), NULL) ed_encounter_id,
                   CONVERT(varchar(20), NULL) ed_hospital_code,
                   CONVERT(varchar(20), NULL) theatre_encounter_id,
                   CONVERT(tinyint, NULL) theatre_acute_flag,
                   CONVERT(tinyint, NULL) theatre_cancelled_flag,
                   CONVERT(varchar(20), NULL) op_encounter_id,
                   CONVERT(varchar(20), NULL) radiology_accession_number,
                   CONVERT(varchar(22), NULL) radiology_eOrder_id,
                   ip_admit_date event_start_date,
                   ip_discharge_date event_end_date,
                   ip_event_length_of_stay,
                   ip_admit_ward_code,
                   ip_discharge_ward_code,
                   ip_admit_specialty_code,
                   ip_discharge_specialty_code,
                   DRG_Family_Code,
                   coded_flag
              FROM s_PJ_ip_event
            UNION ALL SELECT 'ED',
                   patient_NHI,
                   ed_encounter_id encounter_id,
                   ip_encounter_id,
                   ed_encounter_id,
                   ed_hospital_code,
                   NULL theatre_encounter_id,
                   NULL theatre_acute_flag,
                   NULL theatre_cancelled_flag,
                   NULL op_encounter_id,
                   NULL radiology_accession_number,
                   NULL radiology_eOrder_id,
                   ed_presentation_date,
                   ed_discharge_date,
                   NULL ip_event_length_of_stay,
                   NULL ip_admit_ward_code,
                   NULL ip_discharge_ward_code,
                   NULL ip_admit_specialty_code,
                   NULL ip_discharge_specialty_code,
                   NULL DRG_Family_Code,
                   NULL coded_flag
              FROM s_PJ_ed_event
            UNION ALL SELECT 'Theatre',
                   patient_NHI,
                   theatre_encounter_id encounter_id,
                   ip_encounter_id,
                   NULL ed_encounter_id,
                   NULL ed_hospital_code,
                   theatre_encounter_id,
                   acute_flag,
                   theatre_cancelled_flag,
                   NULL op_encounter_id,
                   NULL radiology_accession_number,
                   NULL radiology_eOrder_id,
                   COALESCE(into_theatre_date, session_start_date),
                   COALESCE(out_of_theatre_date, session_end_date),
                   NULL ip_event_length_of_stay,
                   NULL ip_admit_ward_code,
                   NULL ip_discharge_ward_code,
                   NULL ip_admit_specialty_code,
                   NULL ip_discharge_specialty_code,
                   NULL DRG_Family_Code,
                   NULL coded_flag
              FROM s_PJ_theatre_event
             WHERE row_num = 1
            UNION ALL SELECT 'OP' event_source,
                   patient_NHI,
                   op_encounter_id encounter_id,
                   ip_encounter_id,
                   NULL ed_encounter_id,
                   NULL ed_hospital_code,
                   NULL theatre_encounter_id,
                   NULL theatre_acute_flag,
                   NULL theatre_cancelled_flag,
                   op_encounter_id,
                   NULL radiology_accession_number,
                   NULL radiology_eOrder_id,
                   appointment_start_date event_start_date,
                   appointment_end_date event_end_date,
                   NULL ip_event_length_of_stay,
                   NULL ip_admit_ward_code,
                   NULL ip_discharge_ward_code,
                   NULL ip_admit_specialty_code,
                   NULL ip_discharge_specialty_code,
                   NULL DRG_Family_Code,
                   NULL coded_flag
              FROM s_PJ_op_event
             WHERE FSA_flag = 1
                OR FUP_row_num = 1
            UNION ALL SELECT 'Radiology' event_source,
                   patient_NHI,
                   accession_number encounter_id,
                   ip_encounter_id,
                   ed_encounter_id,
                   NULL ed_hospital_code,
                   NULL theatre_encounter_id,
                   NULL theatre_acute_flag,
                   NULL theatre_cancelled_flag,
                   op_encounter_id,
                   accession_number radiology_accession_number,
                   radiology_eOrder_id radiology_eOrder_id,
                   exam_date event_start_date,
                   exam_date event_end_date,
                   NULL ip_event_length_of_stay,
                   NULL ip_admit_ward_code,
                   NULL ip_discharge_ward_code,
                   NULL ip_admit_specialty_code,
                   NULL ip_discharge_specialty_code,
                   NULL DRG_Family_Code,
                   NULL coded_flag
              FROM s_PJ_radiology_event
        dependencies: []
        join:
          joinCondition: None
        name: S_PJ_EVENT_MERGE_V
        noLinkRefs: []
  name: S_PJ_EVENT_MERGE_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
