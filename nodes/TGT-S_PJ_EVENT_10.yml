fileVersion: 1
id: 0d25165c-0f95-4d39-a64a-78bd48349b98
name: S_PJ_EVENT_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Materialise s_PJ_event_merge_v and calculate event sequence numbers and counts for each patient."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 06eacd13-77c1-4e2e-88f8-085d8a225957
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be046f23-fc02-4263-9928-cd92ab754a26
                stepCounter: 5befc2fa-b6e2-4073-9918-ee3b328fc2ed
            transform: COALESCE(l_WDHB_datastore_Merges.NewNumber, s_PJ_event_merge_v.patient_NHI)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4b47df43-c86d-424b-bd3e-d8816fd6ab43
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: The old NHI which has been replaced by a new one.
        name: OLD_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: daf6485f-bd4e-4ea0-9eba-833323f76c52
                stepCounter: 5befc2fa-b6e2-4073-9918-ee3b328fc2ed
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55675504-0696-4ca4-8793-f706553372c3
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers events for each patient in event_start_date order.
        name: EVENT_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ROW_NUMBER() OVER(PARTITION BY COALESCE(l_WDHB_datastore_Merges.NewNumber, s_PJ_event_merge_v.patient_NHI) ORDER BY event_start_date, encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9cead6cd-7b36-4145-abad-46a300d0e9bb
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers IP events (i.e. not OP) for each patient in event_start_date order.
        name: IP_EVENT_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN event_source IN ('OP','Radiology') THEN NULL
                          ELSE ROW_NUMBER() OVER(PARTITION BY COALESCE(l_WDHB_datastore_Merges.NewNumber, s_PJ_event_merge_v.patient_NHI), CASE WHEN event_source IN ('OP','Radiology') THEN 1 ELSE 0 END ORDER BY event_start_date, encounter_id)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47e06585-f850-45f6-be1b-54a8675e23c2
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers IP events (i.e. not OP) exclude IP events like theatre within an ip event.
        name: ACT_IP_EVENT_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN event_source NOT IN ('IP') THEN NULL
                          ELSE ROW_NUMBER() OVER(PARTITION BY COALESCE(l_WDHB_datastore_Merges.NewNumber, s_PJ_event_merge_v.patient_NHI), CASE WHEN event_source NOT IN ('IP') THEN 1 ELSE 0 END ORDER BY event_start_date, encounter_id)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d475105-9ab9-486c-9682-c0fda15d87ad
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Total number of events for each patient.
        name: EVENT_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: COUNT(1) OVER(PARTITION BY COALESCE(l_WDHB_datastore_Merges.NewNumber, s_PJ_event_merge_v.patient_NHI))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1c7867af-c163-4671-b306-1622d184fbe7
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Source for this event e.g. ED, Inpatient.
        name: EVENT_SOURCE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bc38958e-73b6-48e9-b62f-340eaba1d01e
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 72cea01c-d77f-4607-90cc-94f635b56913
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: encounter unique identifier
        name: ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a5cadfd7-d00b-4faf-a2ee-850db1c188fd
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4163ce58-b600-4d58-9dfb-aef70a433792
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP encounter unique identifier
        name: IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 22154928-dbbe-44f2-ac51-e762a8317014
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2c0a9d96-d713-4749-8038-36ae77c1f720
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ED Encounter unique identifier
        name: ED_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a630203d-e215-4cf4-b5f4-f2b3ae3bf23e
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9d6454b7-10f5-4d78-b7be-ad4d87e89981
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ED_HOSPITAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 610f4b1d-94a2-486b-9343-16506c445670
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c1f7d776-51c3-4b81-99bf-8cf6cf8bd538
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Theatre Encounter unique identifier
        name: THEATRE_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: aaef0339-0421-41ee-b6ed-461ecf391868
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0c6dea33-0687-442c-a0aa-f6517f17b1d4
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: theatre_acute_flag
        name: THEATRE_ACUTE_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a2675b06-b610-45b5-82f3-4c2aa5ba5dd5
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4052c6eb-89d1-4927-8859-fb34941931fe
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: ""
        name: THEATRE_CANCELLED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 394e99c1-3f5e-4496-90c9-a4aa4a96756e
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d1d5ac6-4e9f-4901-9371-a1a48da535c2
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RADIOLOGY_ACCESSION_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: db80635a-2411-44db-9737-7a21ba78a6cb
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a81e34d5-bae7-4586-9cf9-7c13e1a9526f
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(22)
        defaultValue: ""
        description: eOrder_id
        name: RADIOLOGY_EORDER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 638b4af1-130a-4fa0-85e8-8fd7c6c037bc
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ca41f150-d384-4ffd-81b3-4ff0890f8bf8
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: OP encounter unique identifier
        name: OP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8c1aab16-a9f3-4fbe-8994-679410513891
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 94e24acb-f959-4976-ba32-ac9bec8adea9
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Event start date and time e.g. admit time.
        name: EVENT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 961336e8-834d-48e4-80b9-63cce9732b4c
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3577e9d1-814e-465d-970a-a2d132b4ab97
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the event ended e.g. discharge time.
        name: EVENT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b03d05a5-ea1a-41af-830f-67907a9ec91d
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 72220672-6f3f-4ede-9ace-2a3179186d61
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: 'ip event_length_of_stay '
        name: IP_EVENT_LENGTH_OF_STAY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5717959-4c07-473f-b0bd-0e4209d6eb0a
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 99b6e5d1-81be-4358-ac74-a00cf1857be0
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Service_Point_Code
        name: IP_ADMIT_WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 26483bec-a854-4218-a983-84a09693461c
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c791422-428c-4ba6-86e6-78a596182c9c
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Service_Point_Code
        name: IP_DISCHARGE_WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 761d4bfd-033b-47ce-a9b1-980b6ce551e7
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 45b3c55f-398b-4bb8-b4c4-aa9bb51827b5
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Specialty Code
        name: IP_ADMIT_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d4bbec17-b2d3-4ced-8a3a-8f39d8fb7709
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 16e88621-f6d7-4453-84ed-390186e51e1c
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Specialty Code. Required for working out the index event for a journey.
        name: IP_DISCHARGE_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9f388c36-6906-4532-8ba6-b81bef09b3e3
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6037d479-97ec-4cc3-bfab-d555d5c6a318
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: VARCHAR(5)
        defaultValue: ""
        description: ""
        name: DRG_FAMILY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a3993f44-a5bc-473a-9d20-7c51983a847c
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 179b2008-671c-4467-ae55-6ee32ff2ded8
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the event has been clinically coded to a DRG.
        name: CODED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e56a015d-19bb-43a0-838c-cb4d5f554569
                stepCounter: 98f88617-89a9-41a3-b57d-c47a6ec32fe2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: db8203eb-e2c7-4465-b02e-25bdecc166dd
          stepCounter: 0d25165c-0f95-4d39-a64a-78bd48349b98
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: L_WDHB_DATASTORE_MERGES
        join:
          joinCondition: |-
            FROM s_PJ_event_merge_v
              LEFT OUTER JOIN l_WDHB_datastore_Merges
                ON s_PJ_event_merge_v.patient_NHI = l_WDHB_datastore_Merges.OldNumber
        name: S_PJ_EVENT_10
        noLinkRefs: []
  name: S_PJ_EVENT_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
