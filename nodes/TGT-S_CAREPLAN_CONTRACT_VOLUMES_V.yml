fileVersion: 1
id: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
name: S_CAREPLAN_CONTRACT_VOLUMES_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 203426e6-90b1-4671-9b1f-3401de1f9512
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 33bd56ea-ae41-4931-9d1e-e450537221fd
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31a438f3-7385-44b4-8a4f-d4041e989e93
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: links back to encounter in fact careplan community
        name: SOURCE_ENCOUNTER_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8966cbe2-8bf9-4a48-b8d4-15768abbf4b1
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: based on the careplan identifier altered to reflect the contract grain
        name: ACTIVE_CAREPLAN_MONTH_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b32a38e9-9e35-468b-b6d8-939af9383a56
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e559bf8c-5bb3-4bca-b023-558a17fb2615
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_DOMICILE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a76c6ab-e4ec-45a5-a4c4-9b0ca5f71b4d
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: phase_start_date
        name: PHASE_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 356231b7-f19e-4fd3-a0e2-d71e654c107a
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: phase_end_date
        name: PHASE_END_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 725146a6-f830-48c6-9fab-993f0e6ae72e
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_CONTRACT_MONTH_DATE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 302f6b19-f97e-442e-9a7d-dcf640445638
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CONTRACT_MONTH_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7157d2a8-b0ab-464d-9dd9-d727dd43b337
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: purchase_unit_volume
        name: PURCHASE_UNIT_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: defc2433-9275-46ca-85a1-bb6f8072418a
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DIM_CAREPLAN_COMMUNITY_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b822f331-aeb1-4d6a-abab-058a6e89d7ff
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: YEAR_OFFSET
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c239543b-ad58-47f8-a3af-469559ae0598
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: presenting_issue_category_desc
        name: PRESENTING_ISSUE_CATEGORY_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b94c028-7535-49a3-8c53-6b17f08531d9
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 04ca0609-d8ee-4a36-b948-ac1315c0d99b
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: careplan_month
        name: CAREPLAN_MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c6561448-ed0b-4782-adc8-59540a3186bc
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: NNPAC_volume, is one volume for the first month in the year the careplan is open
        name: NNPAC_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 983535ff-6457-4943-bef9-a084d2bd5543
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: SEEN_BY_CLINICIAN_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 82e0ebd9-3677-40c1-b528-4f2b6d6b9f04
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2d077acf-2193-4e10-a3bb-7e7bdcd0db53
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PURCHASER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b6030c0e-2979-4e22-8827-828b8fd609ef
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7691df3e-81c1-4909-b045-1cc2f0ffc684
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 99640e93-62fe-456b-900c-97045cbd23b8
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 87e8b9d6-7bc9-4656-9ffa-3803ce007e32
          stepCounter: 4f9eee1c-eb4c-4ef6-a0a1-5c130b9a76a4
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15d7f47c-feb3-4f95-8990-e83e38e84930
                stepCounter: 3affb0b6-b82a-49e6-9618-2ac55d6794bd
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT task_request_id ,
                   contact_encounter_ID source_encounter_id ,
                   'K' + RIGHT('0000000000000'+CAST(task_request_id AS VARCHAR(13))+ + RIGHT(cast(dim_date.cal_month AS varchar(6)),4),13) active_careplan_month_id ,
                   patient_NHI ,
                   dim_domicile_key ,
                   phase_start_date ,
                   phase_end_date ,
                   dim_date_key dim_contract_month_date_key ,
                   calendar_date contract_month_date ,
                   1 contract_volume ,
                   dim_careplan_community.dim_careplan_community_key ,
                   dim_date.year_offset ,
                   dim_careplan_community.presenting_issue_category_desc ,
                   puc.purchase_Unit_code ,
                   dim_date.cal_month careplan_month -- , case when datename(month,calendar_date) = 'July' then 1
            --  when datediff(month,calendar_date,phase_start_date)=0 then 1
            --  else 0 end  NNPAC_Volume
            ,
                   1 NNPAC_Volume --   ,ro.role_code
            ,
                   s_careplan_community_20.seen_by_clinician_reference_no ,
                   s_careplan_community_20.purchaser ,
                   s_careplan_community_20.referral_encounter_id ,
                   s_careplan_community_20.IDF_class
              FROM s_careplan_community_20
             INNER JOIN dim.dim_careplan_community dim_careplan_community
                ON dim_careplan_community.dim_careplan_community_key = s_careplan_community_20.dim_careplan_community_key
             INNER JOIN dim.dim_date dim_date
                ON dim_date.calendar_date = cast(phase_start_date AS date)
             INNER JOIN dim.dim_role_community ro
                ON ro.dim_role_community_key = s_careplan_community_20.dim_role_community_key
             INNER JOIN dim.dim_purchase_unit puc
                ON calendar_date BETWEEN puc.validity_start_date AND IFNULL(puc.validity_end_date,getdate())
               AND puc.purchase_unit_code = CASE WHEN dim_careplan_community.presenting_issue_category_code = 'CAPD'  THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'CAPDT' THEN 'M60005'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'APD'   THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'Hom'   THEN 'M60006'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'HHT'   THEN 'M60007'
                         END
             WHERE dim_date.year_offset <6
               AND phase_start_date <> IFNULL(phase_end_date,phase_start_date +1)
               AND dim_careplan_community.presenting_issue_category_code IN('APD', 'CAPD', 'Hom','CAPDT','HHT')
               AND ro.role_code IN ('HDC','PDC')
            UNION ALL SELECT task_request_id ,
                   contact_encounter_ID source_encounter_id ,
                   'K' + RIGHT('0000000000000'+CAST(task_request_id AS VARCHAR(13))+ + RIGHT(cast(dim_date.cal_month AS varchar(6)),4),13) active_careplan_month_id ,
                   patient_NHI ,
                   dim_domicile_key ,
                   phase_start_date ,
                   phase_end_date ,
                   dim_date_key dim_contract_month_date_key ,
                   calendar_date contract_month_date ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 0
                        ELSE 1
                         END contract_volume ,
                   dim_careplan_community.dim_careplan_community_key ,
                   dim_date.year_offset ,
                   dim_careplan_community.presenting_issue_category_desc ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 'WDHB075'
                        ELSE puc.purchase_unit_code
                         END purchase_unit_code ,
                   dim_date.cal_month careplan_month -- , case when datename(month,calendar_date) = 'July' then 1
            --  when datediff(month,calendar_date,phase_start_date)=0 then 1
            --  else 0 end  NNPAC_Volume
            ,
                   CASE WHEN unit_of_measure = 'New Client' THEN 0
                        ELSE 1
                         END NNPAC_Volume ,
                   s_careplan_community_20.seen_by_clinician_reference_no ,
                   s_careplan_community_20.purchaser ,
                   s_careplan_community_20.referral_encounter_id ,
                   s_careplan_community_20.IDF_class
              FROM s_careplan_community_20
             INNER JOIN dim.dim_careplan_community dim_careplan_community
                ON dim_careplan_community.dim_careplan_community_key = s_careplan_community_20.dim_careplan_community_key
             INNER JOIN dim.dim_date dim_date
                ON dim_date.calendar_date BETWEEN phase_start_date AND IFNULL(phase_end_date,getdate())
               AND dim_date.cal_day_in_month = 1
             INNER JOIN dim.dim_role_community ro
                ON ro.dim_role_community_key = s_careplan_community_20.dim_role_community_key
             INNER JOIN dim.dim_purchase_unit puc
                ON calendar_date BETWEEN puc.validity_start_date AND IFNULL(puc.validity_end_date,getdate())
               AND puc.purchase_unit_code = CASE WHEN dim_careplan_community.presenting_issue_category_code = 'CAPD'  THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'CAPDT' THEN 'M60005'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'APD'   THEN 'M60004'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'Hom'   THEN 'M60006'
                        WHEN dim_careplan_community.presenting_issue_category_code = 'HHT'   THEN 'M60007'
                         END
             WHERE dim_date.year_offset <6
               AND phase_start_date <> IFNULL(phase_end_date,phase_start_date +1)
               AND dim_careplan_community.presenting_issue_category_code IN('APD', 'CAPD', 'Hom','CAPDT','HHT')
               AND ro.role_code IN ('HDC','PDC')
        dependencies:
          - locationName: TGT
            nodeName: S_CAREPLAN_COMMUNITY_20
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_CAREPLAN_COMMUNITY_20') }}
        name: S_CAREPLAN_CONTRACT_VOLUMES_V
        noLinkRefs: []
  name: S_CAREPLAN_CONTRACT_VOLUMES_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
