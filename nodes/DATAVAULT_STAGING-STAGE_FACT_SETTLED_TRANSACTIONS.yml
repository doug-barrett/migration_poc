fileVersion: 1
id: 2a9ec7df-b366-4808-bb84-789d3773eedb
name: STAGE_FACT_SETTLED_TRANSACTIONS
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: false
  description: ""
  isMultisource: false
  locationName: DATAVAULT_STAGING
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c24a31c7-5d7a-4535-aa8f-8692c6db99c9
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: DECIMAL(38,0)
        defaultValue: ""
        description: Identifies the Merchant who initially received the transaction.
        isBusinessKey: true
        name: TRANSACTION_MERCHANT_INTERNAL_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c28b77cc-f8d9-4bfa-9702-03350af48cbd
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: TRIM(s_settled_transactions_mroc.transaction_merchant_internal_number)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 115b6078-63bc-4dc0-b6dd-ef11894a6165
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_settlement_date=DIM_DATE.DATE_DESC_DATETIME
        name: DIM_DATE_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f583aa90-1525-4b60-897c-b626691934da
                stepCounter: 5205e907-f7fe-42c2-9d8b-5f54fad2bc2d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 852c8063-990f-405e-9f3c-75f0a7fcdd26
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_merchant_internal_number=DIM_MERCHANT.MERCHANT_NK
        name: DIM_MERCHANT_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fdc82a12-ac55-4e04-ad8d-29f1db24533b
                stepCounter: 84dffcd0-9390-473b-bb8a-2b250cfdf762
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d17f6155-bb09-4703-aedb-8dd5d3826578
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TERMINAL_ALLOCATION_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 237695c8-3e6e-4b59-b2a6-aafae2a60d13
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(19)
        defaultValue: ""
        description: ""
        name: TERMINAL_SERIAL_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 943638c0-0abc-40ad-95d0-1340aa104f8b
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.settlement_currency_code=DIM_CURRENCY.CURRENCY_NK
        name: DIM_CURRENCY_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ec9f4fa2-8d0c-4876-bd37-ce37361af5c7
                stepCounter: 5efe0ed4-ad29-4793-b1da-02949d10c2a1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1b171aef-93f2-458f-a21d-5e36ef263430
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: NUMBER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.card_type_code=DIM_CARD_BRAND.CARD_BRAND_NK
        name: DIM_CARD_BRAND_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d8bdf8b9-c745-4dd2-998c-bb79b6598215
                stepCounter: 9776b8fe-3a2f-4034-9f10-e86710b93884
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc92e9bd-066b-4768-a675-9c95d79a1533
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_type_code=DIM_TRANSACTION_TYPE.TRANSACTION_TYPE_NK
        name: DIM_TRANSACTION_TYPE_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 637ff723-556a-45d4-a0f7-ee93e8f7d206
                stepCounter: 597b63f6-611a-42c6-b8a7-ffa09a27d519
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 35638b21-8522-4386-9693-bb99e06acc27
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MONTH_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e7d90cf1-f3b3-4ec9-b089-72b8e88f635b
                stepCounter: 5205e907-f7fe-42c2-9d8b-5f54fad2bc2d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2531f7d7-fa9b-4dd6-9733-24da1c63b0c5
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc5dfacf-5620-40ba-b271-01f82798c5b8
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: DECIMAL(38,0)
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: RECID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e39ea5c3-f937-4020-822d-8ec5cc211b71
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 72e4e17e-e608-4be9-9e33-482045883378
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: DECIMAL(19,2)
        defaultValue: ""
        description: The total amount of the transaction expressed in the settlement currency (unsigned). This will be the amount that will be settled.
        name: SETTLEMENT_TRANSACTION_TOTAL_AMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 49c60479-c5ab-4c8c-b504-965e402772b8
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f0cec2ae-08a5-4d72-be3d-5eb9a0caeedd
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: DECIMAL(19,2)
        defaultValue: ""
        description: The total amount of the transaction expressed in the settlement currency (unsigned). This will be the amount that will be settled.
        name: SETTLEMENT_TRANSCATION_TOTAL_AMOUNT_CAD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 49c60479-c5ab-4c8c-b504-965e402772b8
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: |-
              CASE WHEN s_settled_transactions_mroc.settlement_currency_code = 840 THEN SETTLEMENT_TRANSACTION_TOTAL_AMOUNT * (s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr))
                          ELSE SETTLEMENT_TRANSACTION_TOTAL_AMOUNT
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: df34169d-8c55-4f2a-8add-0f6736e87aee
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(23)
        defaultValue: ""
        description: The unique Acquirer Reference Number of the transaction
        name: DCC_USED_INDICATOR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f36f3738-5b19-453b-8377-78aa5e00deae
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: |-
              CASE WHEN SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '400469' OR SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '523420' THEN 'D'
                          WHEN SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '415766' OR SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '518689' THEN 'M'
                          ELSE 'NONE'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3cc77bee-f83b-4b1b-8818-34858aa03642
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: NUMBER(19,0)
        defaultValue: ""
        description: ""
        name: CONVERSION_RATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a14a5c45-bcea-4155-93f3-e539841ed0d1
                stepCounter: e3324d81-d924-4e97-8101-a80f4661d934
            transform: s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aed29306-c505-4a93-b7b1-43d75cd6e83e
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: FEES_AMOUNT_CAD
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN s_settled_transactions_mroc.settlement_currency_code = 840 THEN (TRANSACTION_FEE_PERCENTAGE_AMOUNT + TRANSACTION_FEE_FLAT_AMOUNT) * (s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr))
                          ELSE (TRANSACTION_FEE_PERCENTAGE_AMOUNT + TRANSACTION_FEE_FLAT_AMOUNT)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ad6c1adf-4354-4cbb-a838-2b63d305d8e4
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: USER_AGENT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 68b4245e-5308-4e1a-a5f7-8a163d6e1d35
                stepCounter: c592eb3f-55b3-4732-b100-a07debae68cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c818e29-f906-4e11-a2dd-ba5aff45de87
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(256)
        defaultValue: ""
        description: ""
        name: REF_URL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3b614755-ddba-4181-952e-7671789556ac
                stepCounter: c592eb3f-55b3-4732-b100-a07debae68cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 988dc49a-c5c6-47c6-a5dd-d21285646355
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: Indicates the type of card that was used in the transaction
        name: CARD_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 271c10f1-88ba-46f1-ac4c-aaef7d1bb159
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: TRIM(s_settled_transactions_mroc.card_type_code)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 039b46db-2bf8-420e-b8c9-2f058399a9ac
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: Identifies the type of the transaction
        name: TRANSACTION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 95095684-989c-4482-aad7-d47f265567e1
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: TRIM(s_settled_transactions_mroc.transaction_type_code)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 304ad347-6620-4541-a3c9-737ef4b874e3
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: Identifies the currency in which the transaction will be settled in
        name: SETTLEMENT_CURRENCY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6714cf8e-527e-4e25-8ee6-da51bea545a4
                stepCounter: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 96c3a756-49b3-494b-ae76-2bf54f4ab1e6
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was created in the data warehouse.
        isSystemCreateDate: true
        name: DSS_CREATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 16ee9579-748e-4c4a-9c77-5deeebb508a3
          stepCounter: 2a9ec7df-b366-4808-bb84-789d3773eedb
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_SETTLED_TRANSACTIONS_MROC: 1e1a4d2c-8864-4916-9af1-0582a45ca41b
          S_LKP_CURRENCY_RATE_MROC_CURRENT: e3324d81-d924-4e97-8101-a80f4661d934
          S_TRANSACTION_EXT_INFO_MROC: c592eb3f-55b3-4732-b100-a07debae68cb
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_LKP_CURRENCY_RATE_MROC_CURRENT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_CARD_BRAND
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_CURRENCY
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_MERCHANT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_TRANSACTION_TYPE
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_SETTLED_TRANSACTIONS_MROC
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_TRANSACTION_EXT_INFO_MROC
          - locationName: UNKNOWN
            nodeName: VIEW_TERMINAL_JOIN_ASSISTANCE
        join:
          joinCondition: |-
            FROM {{ ref('DATAVAULT_RAW_VAULT','S_SETTLED_TRANSACTIONS_MROC') }} s_settled_transactions_mroc
              LEFT JOIN {{ ref('DATAVAULT_BUSINESS_VAULT','S_LKP_CURRENCY_RATE_MROC_CURRENT') }} s_lkp_currency_rate_mroc_current
                ON s_lkp_currency_rate_mroc_current.cry_cde = s_settled_transactions_mroc.settlement_currency_code
               AND s_lkp_currency_rate_mroc_current.rte_dte = date_trunc('day', s_settled_transactions_mroc.transaction_settlement_date)
              LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','S_TRANSACTION_EXT_INFO_MROC') }} s_transaction_ext_info_mroc
                ON s_settled_transactions_mroc.usr_dta_mrtime_unq_id = s_transaction_ext_info_mroc.host_id
              LEFT JOIN {{ ref('UNKNOWN','VIEW_TERMINAL_JOIN_ASSISTANCE') }} VIEW_TERMINAL_JOIN_ASSISTANCE
                ON SPLIT_PART(VIEW_TERMINAL_JOIN_ASSISTANCE.TERMINAL_ALLOCATION_NK, '_', 1) = s_settled_transactions_mroc.transaction_merchant_internal_number
               AND SPLIT_PART(VIEW_TERMINAL_JOIN_ASSISTANCE.TERMINAL_ALLOCATION_NK, '_', 3) = TRIM(s_settled_transactions_mroc.terminal_identification_text)
             WHERE s_settled_transactions_mroc.card_type_code <> '0000' --AND s_settled_transactions_mroc.transaction_settlement_date BETWEEN '2024-01-01' AND '2024-01-01'
        name: STAGE_FACT_SETTLED_TRANSACTIONS
        noLinkRefs: []
  name: STAGE_FACT_SETTLED_TRANSACTIONS
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
