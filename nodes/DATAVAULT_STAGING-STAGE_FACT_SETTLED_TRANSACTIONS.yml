fileVersion: 1
id: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
name: STAGE_FACT_SETTLED_TRANSACTIONS
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: false
  description: ""
  isMultisource: false
  locationName: DATAVAULT_STAGING
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eac861f0-5b27-46ee-b97d-d5b53886c527
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: DECIMAL(38,0)
        defaultValue: ""
        description: Identifies the Merchant who initially received the transaction.
        isBusinessKey: true
        name: TRANSACTION_MERCHANT_INTERNAL_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6080dfee-95b2-4843-9d41-d7a87c48b2c1
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: TRIM(s_settled_transactions_mroc.transaction_merchant_internal_number)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5d6d0f3-37f3-43f0-b27c-4f3696adece3
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_settlement_date=DIM_DATE.DATE_DESC_DATETIME
        name: DIM_DATE_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 40aa3c9e-9b85-4425-a47b-b0183cd58863
                stepCounter: 3f4b0133-f2a1-4a6f-8a9e-d1722827a6c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 330d7f64-4894-4160-8e4a-2e72fe132956
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_merchant_internal_number=DIM_MERCHANT.MERCHANT_NK
        name: DIM_MERCHANT_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 435ef0b7-fae2-42c6-a903-881ef34ca1a6
                stepCounter: 47efa677-7996-4551-9dec-b7b4d9cedb8d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 19cc7fc6-c14c-4b7a-8996-bc9a9d451b08
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TERMINAL_ALLOCATION_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7b11ce3b-27a2-44b9-8a9d-6f336456e241
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(19)
        defaultValue: ""
        description: ""
        name: TERMINAL_SERIAL_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6e38b15-cd19-4f73-bf9a-d11d68744ece
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.settlement_currency_code=DIM_CURRENCY.CURRENCY_NK
        name: DIM_CURRENCY_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17835b08-ab01-469e-859b-c21ffae78de7
                stepCounter: 0cdf2973-b12b-4032-a67a-2f8bdd06e24e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 48c4f695-8f2e-430f-af7d-7bba4e9384f7
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: NUMBER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.card_type_code=DIM_CARD_BRAND.CARD_BRAND_NK
        name: DIM_CARD_BRAND_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 42d86a98-7324-40a5-8376-44022e77db4a
                stepCounter: 076650ac-d366-4713-9a43-7ebe2bc2fd56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ee8f7040-6aab-45af-9138-6ce851e88deb
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: STAGE_FACT_SETTLED_TRANSACTIONS.s_settled_transactions_mroc.transaction_type_code=DIM_TRANSACTION_TYPE.TRANSACTION_TYPE_NK
        name: DIM_TRANSACTION_TYPE_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17f20dab-4881-437e-b0be-734dace0a9d1
                stepCounter: 8137ce3d-b2ac-4202-9832-e902b9566a8e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6cb956da-3936-4718-97c1-78a391eaa736
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MONTH_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 73f7c005-2e09-4f22-a070-61ecb57f14f0
                stepCounter: 3f4b0133-f2a1-4a6f-8a9e-d1722827a6c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9cf52e2a-4222-4397-bec9-f0a0c969c077
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PRODUCT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 851ebab6-1ca4-4ec7-a39e-ca070e9b0d0c
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: DECIMAL(38,0)
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: RECID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4818826b-51f8-42e7-a5d0-d67232dbeaaf
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9951c6b-feb5-43a5-af8c-c0a35cc71ab2
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: DECIMAL(19,2)
        defaultValue: ""
        description: The total amount of the transaction expressed in the settlement currency (unsigned). This will be the amount that will be settled.
        name: SETTLEMENT_TRANSACTION_TOTAL_AMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: aa291715-daaa-47f6-a3ee-8f9a6da5d368
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5e1909e-6b7b-4667-a435-dc6b560f88e6
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: DECIMAL(19,2)
        defaultValue: ""
        description: The total amount of the transaction expressed in the settlement currency (unsigned). This will be the amount that will be settled.
        name: SETTLEMENT_TRANSCATION_TOTAL_AMOUNT_CAD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: aa291715-daaa-47f6-a3ee-8f9a6da5d368
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: |-
              CASE WHEN s_settled_transactions_mroc.settlement_currency_code = 840 THEN SETTLEMENT_TRANSACTION_TOTAL_AMOUNT * (s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr))
                          ELSE SETTLEMENT_TRANSACTION_TOTAL_AMOUNT
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d977b8ca-979c-4bb3-b5cd-51b01dfb3f84
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(23)
        defaultValue: ""
        description: The unique Acquirer Reference Number of the transaction
        name: DCC_USED_INDICATOR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6636a33c-23a8-48cd-b40c-be78e2c75a58
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: |-
              CASE WHEN SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '400469' OR SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '523420' THEN 'D'
                          WHEN SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '415766' OR SUBSTRING(s_settled_transactions_mroc.acquirer_reference_number, 2, 6) = '518689' THEN 'M'
                          ELSE 'NONE'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 09597904-9a27-42a1-9448-ad47415d7cf8
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: NUMBER(19,0)
        defaultValue: ""
        description: ""
        name: CONVERSION_RATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 771a376d-e376-4af1-8adc-06fcecfc5faa
                stepCounter: e1b7eaeb-3242-42eb-9523-ec40900490be
            transform: s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d1442dce-8a5c-4f6c-b5c3-28adaa093890
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: FEES_AMOUNT_CAD
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN s_settled_transactions_mroc.settlement_currency_code = 840 THEN (TRANSACTION_FEE_PERCENTAGE_AMOUNT + TRANSACTION_FEE_FLAT_AMOUNT) * (s_lkp_currency_rate_mroc_current.cry_rte_nbr / POW(10, s_lkp_currency_rate_mroc_current.rte_ent_nbr))
                          ELSE (TRANSACTION_FEE_PERCENTAGE_AMOUNT + TRANSACTION_FEE_FLAT_AMOUNT)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6fb91b7-941f-4092-824d-a1c95eb926ad
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: USER_AGENT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d603f7ec-5f55-4bdd-a610-0755c9fbf7d8
                stepCounter: 579ee1c3-79a7-4221-a41b-38e69709c150
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dfa54f40-3ebb-4576-8152-d16278aac9b8
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(256)
        defaultValue: ""
        description: ""
        name: REF_URL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 67ab3bc2-9709-4ac8-b2dc-35dbb7bb3403
                stepCounter: 579ee1c3-79a7-4221-a41b-38e69709c150
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1accf8f7-5715-4a01-8176-97dad0323aab
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: Indicates the type of card that was used in the transaction
        name: CARD_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3bbcf635-dc7e-4d43-8311-b15858fa4e95
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: TRIM(s_settled_transactions_mroc.card_type_code)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f0bf18e-ddb1-4b43-abb3-313d7f5504fa
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: Identifies the type of the transaction
        name: TRANSACTION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5ea3c3b-7a0e-4f20-835c-00fd651a53e8
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: TRIM(s_settled_transactions_mroc.transaction_type_code)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eab36fd0-b529-4407-9ca3-071e3565e035
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: Identifies the currency in which the transaction will be settled in
        name: SETTLEMENT_CURRENCY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 634fa40c-fed6-4301-873d-3764e5343a1e
                stepCounter: c165ccdf-2dd1-40f5-941e-412964619919
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5895c785-0b5b-4b56-a564-bbfd0316ad05
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was created in the data warehouse.
        isSystemCreateDate: true
        name: DSS_CREATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 668401eb-df7b-4811-ab7c-6c0640461c7b
          stepCounter: 08459eff-3ef9-4bc3-9c65-a7cbd60ae3b8
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_SETTLED_TRANSACTIONS_MROC: c165ccdf-2dd1-40f5-941e-412964619919
          S_LKP_CURRENCY_RATE_MROC_CURRENT: e1b7eaeb-3242-42eb-9523-ec40900490be
          S_TRANSACTION_EXT_INFO_MROC: 579ee1c3-79a7-4221-a41b-38e69709c150
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_LKP_CURRENCY_RATE_MROC_CURRENT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_CARD_BRAND
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_CURRENCY
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_DATE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_MERCHANT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_TRANSACTION_TYPE
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_SETTLED_TRANSACTIONS_MROC
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_TRANSACTION_EXT_INFO_MROC
          - locationName: UNKNOWN
            nodeName: VIEW_TERMINAL_JOIN_ASSISTANCE
        join:
          joinCondition: |-
            FROM {{ ref('DATAVAULT_RAW_VAULT','S_SETTLED_TRANSACTIONS_MROC') }} s_settled_transactions_mroc
              LEFT JOIN {{ ref('DATAVAULT_BUSINESS_VAULT','S_LKP_CURRENCY_RATE_MROC_CURRENT') }} s_lkp_currency_rate_mroc_current
                ON s_lkp_currency_rate_mroc_current.cry_cde = s_settled_transactions_mroc.settlement_currency_code
               AND s_lkp_currency_rate_mroc_current.rte_dte = date_trunc('day', s_settled_transactions_mroc.transaction_settlement_date)
              LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','S_TRANSACTION_EXT_INFO_MROC') }} s_transaction_ext_info_mroc
                ON s_settled_transactions_mroc.usr_dta_mrtime_unq_id = s_transaction_ext_info_mroc.host_id
              LEFT JOIN {{ ref('UNKNOWN','VIEW_TERMINAL_JOIN_ASSISTANCE') }} VIEW_TERMINAL_JOIN_ASSISTANCE
                ON SPLIT_PART(VIEW_TERMINAL_JOIN_ASSISTANCE.TERMINAL_ALLOCATION_NK, '_', 1) = s_settled_transactions_mroc.transaction_merchant_internal_number
               AND SPLIT_PART(VIEW_TERMINAL_JOIN_ASSISTANCE.TERMINAL_ALLOCATION_NK, '_', 3) = TRIM(s_settled_transactions_mroc.terminal_identification_text)
             WHERE s_settled_transactions_mroc.card_type_code <> '0000' --AND s_settled_transactions_mroc.transaction_settlement_date BETWEEN '2024-01-01' AND '2024-01-01'
        name: STAGE_FACT_SETTLED_TRANSACTIONS
        noLinkRefs: []
  name: STAGE_FACT_SETTLED_TRANSACTIONS
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
