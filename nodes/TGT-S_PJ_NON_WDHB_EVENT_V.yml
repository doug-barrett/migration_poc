fileVersion: 1
id: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
name: S_PJ_NON_WDHB_EVENT_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "Get details of non WDHB events which occured either 1 day prior to the first journey event or 1 day after the last event. Details of non WDHB events taken from fact_MOH_inpatient_event."
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b9cd51c-2283-4e31-a730-b1d82bccf168
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique ID for a patient journey
        name: JOURNEY_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7f7dd4ca-4b72-4471-8e15-dd1ec0a54c3c
                stepCounter: 025cc51b-16d6-4445-83f7-5229e679b705
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2d6fecfa-c61e-4786-9f9a-e191429bb3ef
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP encounter unique identifier
        name: IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d37cafeb-c7c3-49fa-8631-76458e42124c
                stepCounter: 025cc51b-16d6-4445-83f7-5229e679b705
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b8b327eb-3619-4ed2-888d-c58f9073f369
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Event start date and time e.g. admit time.
        name: EVENT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2621ef5d-f448-424a-98e0-cef8cd8fba05
                stepCounter: 025cc51b-16d6-4445-83f7-5229e679b705
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d5d9dd05-5abc-48ea-a84a-921a31e3b0bb
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the event ended e.g. discharge time.
        name: EVENT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b4deb8dd-0a39-4fae-ab24-ca122be93cbf
                stepCounter: 025cc51b-16d6-4445-83f7-5229e679b705
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 89bc0378-37fc-4e1c-bea0-29ed95b11a89
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers rows for each IP_encounter_id containing a prior event ID.
        name: PRIOR_ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8e7a5d46-f366-42d8-a63a-6c780399eaa7
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8283d19c-5342-4c49-ab61-77e54919bfad
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers rows for each IP_encounter_id containing a subsequent event ID.
        name: SUBSEQUENT_ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8d2a4190-a356-4ab5-b0ba-9829698b62b3
                stepCounter: 04791d95-8803-45a7-84f5-7fe19c6545ae
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ccd83ebd-508f-4d90-bac1-3049982fd97d
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ID of non WDHB encounter if it ends within a day of the first journey event start.
        name: NON_WDHB_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 98310d0e-c0a8-4a0e-9184-3ec9ab9a0d7b
                stepCounter: 1e518f56-9d40-43a0-b84a-7e0ed27a74c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 741ac9e5-73f9-4240-94e3-b6f6081ae816
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MOH_EVENT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b8a6779d-776e-4f16-91c5-18c01d15c7c0
                stepCounter: 1e518f56-9d40-43a0-b84a-7e0ed27a74c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f5cad46-ec6c-4b45-9d70-d93660063da2
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MOH_EVENT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 257e2c53-ccdb-4936-8613-8d8a2a3a45d5
                stepCounter: 1e518f56-9d40-43a0-b84a-7e0ed27a74c7
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f472371-7794-4b05-8e61-152927446d8c
          stepCounter: 6ed04ee2-b619-41b0-978e-643c6d4f9dd0
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: FUNDING_AGENCY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6aebd8cb-0d76-4c08-982a-00dce2dfd505
                stepCounter: 46d041e9-5067-449a-82cf-baff7c97a211
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            --**************************************************************
            -- Non WDHB events ending 1 day prior to the first journey event
            --**************************************************************
            SELECT s.journey_id,
                   s.ip_encounter_id,
                   s.event_start_date,
                   s.event_end_date,
                   ROW_NUMBER() OVER(PARTITION BY s.ip_encounter_id ORDER BY f.event_end_date DESC) prior_row_num,
                   NULL subsequent_row_num,
                   f.event_encounter_id,
                   f.event_start_date,
                   f.event_end_date,
                   d.funding_agency_code
              FROM s_PJ_event s
              JOIN s_PJ_ip_event sip
                ON sip.ip_encounter_id = s.ip_encounter_id
              JOIN fact.fact_MOH_inpatient_event f
                ON s.patient_NHI = f.patient_NHI
              JOIN dim.dim_MOH_funding_agency d
                ON d.dim_MOH_funding_agency_key = f.dim_MOH_funding_agency_key
              JOIN dss_parameter
                ON dss_parameter_name = 'journey_WDHB_admission_codes'
             WHERE s.event_source = 'IP'
               AND s.journey_event_seq_num = 1
               AND CHARINDEX(',' + sip.admission_source_code + ',', ',' + dss_parameter_value + ',') = 0
               AND d.funding_agency_code <> '1021'
               AND DATEDIFF(DD, f.event_end_date, s.event_start_date) IN (0,1)
            UNION ALL --*************************************************************
            -- Non WDHB events starting 1 day after the final journey event
            --*************************************************************
            SELECT s.journey_id,
                   s.ip_encounter_id,
                   s.event_start_date,
                   s.event_end_date,
                   NULL prior_row_num,
                   ROW_NUMBER() OVER(PARTITION BY s.ip_encounter_id ORDER BY f.event_start_date, f.event_encounter_id) subsequent_row_num,
                   f.event_encounter_id,
                   f.event_start_date,
                   f.event_end_date,
                   d.funding_agency_code
              FROM s_PJ_event s
              JOIN s_PJ_ip_event sip
                ON sip.ip_encounter_id = s.ip_encounter_id
              JOIN fact.fact_MOH_inpatient_event f
                ON s.patient_NHI = f.patient_NHI
              JOIN dim.dim_MOH_funding_agency d
                ON d.dim_MOH_funding_agency_key = f.dim_MOH_funding_agency_key
             WHERE s.event_source = 'IP'
               AND s.journey_event_seq_num = journey_event_count
               AND sip.event_end_type_code IN ('EA','ET','DA','DP','DT','DW')
               AND d.funding_agency_code <> '1021'
               AND DATEDIFF(DD, s.event_end_date, f.event_start_date) IN (0,1)
        dependencies:
          - locationName: TGT
            nodeName: S_PJ_EVENT
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_PJ_EVENT') }}
        name: S_PJ_NON_WDHB_EVENT_V
        noLinkRefs: []
  name: S_PJ_NON_WDHB_EVENT_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
