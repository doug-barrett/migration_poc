fileVersion: 1
id: 95ed83bf-7e19-497e-8bae-40732da8defe
name: S_IN_PATIENT_CODED_WIES_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "View to calculate Average WIES for the current year.  11-Jan-2023  Changed to use s_in_patient_event_05. Old logic is in tab Notes."
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e6ebced4-aa71-49f3-bd49-7f29a57e893f
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: HOSPITAL_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c58a79f9-b36f-4d77-96b1-8522082fb8f7
                stepCounter: f0fafd40-0f27-49a1-9550-5ecbe8b1e50f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 256af058-3e97-4686-a55e-134ed321fb7f
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ADMISSION_METHOD_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cfd358e5-689e-4542-a972-0aba002b02cf
                stepCounter: 469bfd7a-0084-4352-8ef5-69fd15a77ed4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 912bf5a6-975f-4bd2-9879-488d8ecac952
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: HEALTH_SPECIALTY_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab525339-3f36-4625-ba0c-d207897f094b
                stepCounter: 4182a75e-d07b-4637-97fa-4c01e2878360
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01d7e0dd-1830-4a2d-843c-8ff886d1f13f
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: WIES_GROUPING
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6a86ce2f-a82f-48b7-8a1c-a73dcf4b02dc
                stepCounter: 14621552-1d60-4a3f-9189-d97042f50728
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2be09b10-3fc4-422f-aa54-4e0ade89d214
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: WIES_RATING_COUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 968383e9-e143-4960-a2c5-f678ab16313c
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: WIES_RATING_SUM
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 909a2e19-5d88-46d5-9981-2e0d8e6cc46e
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: WIES_RATING_AVG
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f1393d60-08fe-4973-96ca-a4ca75d1002c
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: WIES_RATING_MAX
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ac85c3ca-9846-4f17-954d-df0e70ac9d1b
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: ""
        name: WIES_RATING_MIN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d7821450-d23a-4370-b895-8deb87b6fcf1
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Minimum Length of Stay in the group
        name: MINIMUM_EVENT_LENGTH_OF_STAY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b11409f2-64a4-41a3-9598-6afbc6fcf585
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Maximum Length of Stay in the group
        name: MAXIMUM_EVENT_LENGTH_OF_STAY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f97ee3e-1d3a-4a7b-9359-dc9f31ff814f
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Average Length of Stay in the group
        name: AVERAGE_EVENT_LENGTH_OF_STAY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4db2d935-98be-4d90-8be5-af7c341e90a7
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Median Length of Stay in the group
        name: MEDIAN_EVENT_LENGTH_OF_STAY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0205f3fe-4002-413d-abf0-7bf89cd79fde
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: WIES_rating_median
        name: WIES_RATING_MEDIAN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c4fc559c-87ed-41c4-ac82-d3e1dd8df7ec
          stepCounter: 95ed83bf-7e19-497e-8bae-40732da8defe
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: Currently showing the value of the 65th percentile. Used as a possible mechanism to tweak estimated WIES
        name: WIES_RATING_VARY_PERCENTILE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6307af81-e215-4a12-9b1f-07fa0eea3ac3
                stepCounter: 01a05ba7-1d18-4301-93c3-8bfe55c3f782
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT DISTINCT IFNULL(e.hospital_id,'1021') hospital_id ,
                   e.admission_method_code ,
                   e.health_specialty_code ,
                   g.WIES_Grouping ,
                   COUNT(c.WIES_rating) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_count ,
                   SUM (c.WIES_rating) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_sum ,
                   AVG (c.WIES_rating) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_avg ,
                   MAX (c.WIES_rating) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_max ,
                   MIN (c.WIES_rating) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_min ,
                   min(e.event_length_of_stay) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) MinEventLOS ,
                   MAX(e.event_length_of_stay) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) MaxEventLOS ,
                   AVG(e.event_length_of_stay) over(PARTITION BY e.hospital_id, e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) ALOS ,
                   PERCENTILE_cont(0.5) WITHIN GROUP(ORDER BY event_length_of_stay) Over(PARTITION BY IFNULL(e.hospital_id, '1021'), e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) Median_LOS ,
                   PERCENTILE_cont(0.5) WITHIN GROUP(ORDER BY WIES_rating) Over(PARTITION BY IFNULL(e.hospital_id, '1021'), e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_median ,
                   PERCENTILE_cont(0.65) WITHIN GROUP(ORDER BY WIES_rating) Over(PARTITION BY IFNULL(e.hospital_id, '1021'), e.admission_method_code, e.health_specialty_code, g.WIES_Grouping) WIES_rating_vary_percentile
              FROM s_in_patient_event_05 e
              JOIN s_in_patient_coding_05 c
                ON e.event_encounter_id = c.event_encounter_id
              JOIN s_in_patient_event_prev_next n
                ON e.event_encounter_id = n.cur_event_encounter_id
              LEFT OUTER JOIN s_in_patient_leave_05 l
                ON e.event_encounter_id = l.event_encounter_id
               AND l.event_leave_seq_num = 1
              LEFT OUTER JOIN l_reference_LOS_Grouping g
                ON DATEDIFF(dd, e.admit_date, e.disch_date) - IFNULL(l.event_leave_total_duration, 0) = g.Day
             WHERE e.disch_date BETWEEN getdate()-395 AND getdate()-5
               AND e.DRG_code IS NOT NULL
        dependencies:
          - locationName: TGT
            nodeName: S_IN_PATIENT_EVENT_05
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_IN_PATIENT_EVENT_05') }}
        name: S_IN_PATIENT_CODED_WIES_V
        noLinkRefs: []
  name: S_IN_PATIENT_CODED_WIES_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
