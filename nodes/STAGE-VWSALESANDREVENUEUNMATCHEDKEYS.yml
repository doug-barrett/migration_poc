fileVersion: 1
id: 7379c71d-9353-4309-8cc4-b72c5814bc5a
name: VWSALESANDREVENUEUNMATCHEDKEYS
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: STAGE
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 400f2111-4c58-4920-afec-9fca45cc6f83
          stepCounter: 7379c71d-9353-4309-8cc4-b72c5814bc5a
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LOADDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 446f1894-d6d2-4345-af11-2852cc88a145
          stepCounter: 7379c71d-9353-4309-8cc4-b72c5814bc5a
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: KEYNAME
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 54a686a1-3d8d-4ba9-be8f-7452e38fe507
          stepCounter: 7379c71d-9353-4309-8cc4-b72c5814bc5a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: KEYCOUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VWSALESANDREVENUEUNMATCHEDKEYS: 7379c71d-9353-4309-8cc4-b72c5814bc5a
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('STAGE','VWSALESANDREVENUEUNMATCHEDKEYS') }}(LoadDate, KeyName, KeyCount) AS WITH cte AS (
                    SELECT SUM(CASE WHEN AccountGeographyKey = 0 THEN 1 ELSE 0 END) AS AccountGeographyKey,
                           SUM(CASE WHEN AccountHierarchyKey = 0 THEN 1 ELSE 0 END) AS AccountHierarchyKey,
                           SUM(CASE WHEN AccountKey = 0 THEN 1 ELSE 0 END) AS AccountKey,
                           SUM(CASE WHEN ContractKey = 0 THEN 1 ELSE 0 END) AS ContractKey,
                           SUM(CASE WHEN DirectSalesTerritoryKey = 0 THEN 1 ELSE 0 END) AS DirectSalesTerritoryKey,
                           SUM(CASE WHEN FinancialSalesTerritoryKey = 0 THEN 1 ELSE 0 END) AS FinancialSalesTerritoryKey,
                           SUM(CASE WHEN OrganizationKey = 0 THEN 1 ELSE 0 END) AS OrganizationKey,
                           SUM(CASE WHEN ReceiptDateKey = 0 THEN 1 ELSE 0 END) AS ReceiptDateKey,
                           SUM(CASE WHEN RevenueBudgetForceIdDetailKey = 0 THEN 1 ELSE 0 END) AS RevenueBudgetForceIdDetailKey,
                           SUM(CASE WHEN RevenueBudgetForceIdDirectDetailKey = 0 THEN 1 ELSE 0 END) AS RevenueBudgetForceIdDirectDetailKey,
                           SUM(CASE WHEN RevenueBudgetPDDetailKey = 0 THEN 1 ELSE 0 END) AS RevenueBudgetPDDetailKey,
                           SUM(CASE WHEN SalesTerritoryKey = 0 THEN 1 ELSE 0 END) AS SalesTerritoryKey,
                           SUM(CASE WHEN SupplierKey = 0 THEN 1 ELSE 0 END) AS SupplierKey,
                           SUM(CASE WHEN TransactionDateKey = 0 THEN 1 ELSE 0 END) AS TransactionDateKey,
                           MAX(dss_load_date) AS LoadDate
                      FROM Stage.StageSalesMerge_AddKeys AS smak
                     WHERE AccountGeographyKey = 0
                        OR AccountHierarchyKey = 0
                        OR AccountKey = 0
                        OR ContractKey = 0
                        OR DirectSalesTerritoryKey = 0
                        OR FinancialSalesTerritoryKey = 0
                        OR OrganizationKey = 0
                        OR ReceiptDateKey = 0
                        OR RevenueBudgetForceIdDetailKey = 0
                        OR RevenueBudgetForceIdDirectDetailKey = 0
                        OR RevenueBudgetPDDetailKey = 0
                        OR SalesTerritoryKey = 0
                        OR SupplierKey = 0
                        OR TransactionDateKey = 0
                   ) SELECT LoadDate,
                   KeyName,
                   KeyCount
              FROM cte UNPIVOT(KeyCount FOR KeyName IN(AccountGeographyKey , AccountHierarchyKey , AccountKey , ContractKey , DirectSalesTerritoryKey , FinancialSalesTerritoryKey, OrganizationKey , ReceiptDateKey , RevenueBudgetForceIdDetailKey, RevenueBudgetForceIdDirectDetailKey, RevenueBudgetPDDetailKey , SalesTerritoryKey , SupplierKey)) AS unpvt
             ORDER BY KeyName
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: VWSALESANDREVENUEUNMATCHEDKEYS
        noLinkRefs: []
  name: VWSALESANDREVENUEUNMATCHEDKEYS
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
