fileVersion: 1
id: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
name: VIEW_PWRANALYTICS_FBU_EDF
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5dc48f28-eb37-48d1-9ed6-2b26aa9a0a6a
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: ACCOUNT_NUMBER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d492c11d-ef40-4329-b45c-89e82a3d5fbf
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 286403d0-8a04-450f-beee-2d809efeaf2e
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: SERVICE_ADDRESS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f90dfcdc-c3b7-4809-ab68-593ce8c94088
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: TOTAL_CONSUMPTION_KWH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e1e217d-0994-41f4-9ff4-294a364e2f4e
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: ENERGY_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc9f9f4f-e93f-44c6-ba0a-49cbc69c3b52
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: REACTIVE_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17f56ef1-9f3e-4294-b4ff-2cf421391870
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: TRANSMISSION_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 188c05e0-72f6-433f-a5d9-07fe6f532579
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: METER_NUMBER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c4a2483-cde9-478b-b069-b8f9675428b8
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SITE_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2e4266a4-f2cb-485a-a62b-8af1770e8fa6
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SITE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 93227238-98e8-4e3d-94f1-67b22b71b081
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DEMAND_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c0c04fce-998b-470f-9902-43382f8c289a
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: GST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5e251495-da14-469a-9f58-4d2e30517cca
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: PST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7d700d53-8716-4c0a-bb57-5dff3f9be9d4
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: BASIC_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2fcecb21-aa01-4ec2-bb22-80c66ea91304
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: BILLED_DEMAND_KVA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 798aff45-4e0e-4d4e-bf9d-72578b0d06bd
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: REGISTERED_DEMAND_KVA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fcef5d57-b36f-4753-a7a7-0b01c946b33d
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: FOREMAN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8faa47a9-80c1-4b2c-9c26-173437726007
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CLUSTER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 571055fb-ae33-4752-8560-72ee028c36df
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(250)
        defaultValue: ""
        description: ""
        name: WELL_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2ec75f3f-e8dc-4734-907e-e143d02635a2
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6247badb-acc5-41e3-92f4-f6c937d20b07
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: UWI
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a95acfda-7cb7-45da-aa13-cd12b113d5e5
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9660c56f-49e7-4396-902a-5427ecfa36fe
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CC_NUM
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 564ab833-bef6-47b0-920b-4268ba7b1bfa
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f7119c09-089f-48a9-b0b5-b636823a9044
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(40)
        defaultValue: ""
        description: ""
        name: CC_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c0d5bc35-996e-40a4-9f5c-bebb5e06bf93
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 03e80bf2-be70-4a52-aaa5-02de3fa6ce2e
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: COUNTRY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7ce4cdfe-b6ce-4a85-bd41-7164620577f4
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8267b2ac-2e48-4b02-9c52-869643e369eb
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: PROVINCE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 884c301b-4558-489c-9ec2-a67f4ab5e6d5
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fef02b8a-afeb-401a-8420-38e746ae39e5
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: CORE_AREA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4e8e1552-1224-4696-8d09-076417219a05
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9484c55b-ef16-4845-8999-1a56b22e8c16
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: AREA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3de424a9-b541-487f-a3c5-83085cdd102b
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0fa56ab4-6664-459f-82c9-aff05a63465f
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: FACILITY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: eb9afe93-8206-4700-bd5b-431703cee29b
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3320a76f-c066-4b09-9d66-039cafc5e672
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: WATER_M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9a58cc07-15cc-44d6-92fe-596ebd0b5819
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b44c8fd3-41fd-4ea9-9673-3b8be03d8157
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36, 8)
        defaultValue: ""
        description: ""
        name: OIL_M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 20e891e8-5b54-4cc8-b338-55c51daeecb9
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dbf06ea5-014a-4062-b65e-32711ac5fdd1
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: OIL_BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4351dc14-beb6-4ce6-84fc-8224c710e007
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8963ffda-acb8-457c-8d6e-abcbde672b48
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: GAS_BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 970bde0c-3e30-4e20-9cd0-ee43dc0679e0
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eb32eb1b-6bba-478c-a995-65b4dd58447a
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: GAS_E3M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 85fde402-9a7b-4b08-8c35-c6bb66e3ab99
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fb5abad3-5449-44ca-86f2-1adb0820e0b3
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: DOWNTIME_HOURS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8324b765-c568-4a0b-89cb-0cd17adf620e
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eb2b881a-427f-42a5-af94-625f18ed838d
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: RUN_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a8309338-d65e-4085-a5f4-f3bfb7a502d6
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a420085-9f09-4acf-815d-7ef6e6beb51b
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fde885ff-67cc-4a11-a25b-f04808dd437a
                stepCounter: dbe73b17-10e8-4241-8f3d-bc696bcc4ac6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 34c72b59-3ad2-4b67-b7a4-35d7146e2686
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: CONSUMPTION_MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9ffebc00-1fe6-4ae4-98e0-c2784625505c
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: AMI_METER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bea627ed-4ae1-40f5-9e77-5f129fd4e1c5
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(2)
        defaultValue: ""
        description: ""
        name: AMI_METER_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 80407cd4-d977-408b-a775-724583f97131
          stepCounter: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: SOURCE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PWRANALYTICS_FBU_EDF: 8beb0121-d202-4eda-a0f0-4ba224ba3bd6
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PWRANALYTICS_FBU_EDF') }} AS WITH PRODVIEW_CTE AS (
                    SELECT WELL_NAME,
                           UWI,
                           CC_NUM,
                           CC_NAME,
                           COUNTRY,
                           PROVINCE,
                           CORE_AREA,
                           AREA,
                           FACILITY,
                           PROD_MONTH,
                           LAST_DAY(TO_DATE(CONCAT(pv.PROD_MONTH, ' 1 ', pv.PROD_YEAR), 'MON DD YYYY')) AS CONSUMPTION_MONTH,
                           WATER_M3,
                           OIL_M3,
                           OIL_BOE,
                           GAS_BOE,
                           GAS_E3M3,
                           DOWNTIME_HOURS,
                           RUN_NAME,
                           BOE
                      FROM WS_EDW.VIEW_FDC_PWRANALYTICS pv
                     WHERE COUNTRY = 'FRANCE'
                   ),
                   POWERBILL_CTE AS (
                    SELECT num_facture AS Invoice_Number ,
                           ref_acheminement AS Delivery_point ,
                           cast(date_de_debut_de_consommation AS DATETIME) AS Consumption_start_of_period ,
                           CASE WHEN cast(concat(DATE_PART(YEAR, cast(date_de_fin_de_consommation AS date)), right(concat('00', DATE_PART(MONTH, cast(date_de_fin_de_consommation AS date))), 2)) AS int) > cast(concat(DATE_PART(YEAR, cast(date_de_debut_de_consommation AS date)), right(concat('00', DATE_PART(MONTH, cast(date_de_debut_de_consommation AS DATETIME))), 2)) AS int) THEN DATEADD(SECOND, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', cast(date_de_debut_de_consommation AS date)) + 1, '1900-01-01'))
                                ELSE CAST(date_de_fin_de_consommation AS DATE)
                                 END AS Consumption_end_of_period ,
                           DATEDIFF(MONTH, cast(date_de_debut_de_consommation AS date), cast(date_de_fin_de_consommation AS date)) AS MonthDiff ,
                           CAST(date_de_debut_de_consommation AS DATE) AS period_start ,
                           CAST(date_de_fin_de_consommation AS DATE) AS period_end ,
                           date_facture AS Invoice_date ,
                           nom_site AS Site_name ,
                           id_site AS Site_code ,
                           adresse_site AS Address ,
                           type_index AS Invoice_type ,
                           try_cast(NULL AS float) AS Subscription_excl_VAT ,
                           conso_elec_facturee_kwh AS Consumption_kWh ,
                           try_cast(total_htva_euros AS float) AS Energy_Cost ,
                           try_cast(energie_reactive_euros AS float) AS Reactive_Cost ,
                           try_cast(montant_ht_reseau_distrib_euros AS float) AS Transmission_Cost
                      FROM DS_POWER.FBU_EDF
                     WHERE cast(date_de_debut_de_consommation AS date) > '1900-12-31'
                 UNION ALL SELECT cte.Invoice_Number ,
                           cte.Delivery_point ,
                           CASE WHEN cte.MonthDiff > 0 THEN DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)), '1900-01-01')
                                ELSE CAST(cte.Consumption_start_of_period AS DATETIME)
                                 END AS start_of_period ,
                           CASE WHEN cte.MonthDiff > 0 AND DATEADD(DAY, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)) + 1, '1900-01-01')) < CAST(t.date_de_fin_de_consommation AS DATE) THEN DATEADD(DAY, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)) + 1, '1900-01-01'))
                                ELSE CAST(t.date_de_fin_de_consommation AS DATE)
                                 END AS end_of_period ,
                           (cte.MonthDiff - 1) AS MonthDiff ,
                           CAST(t.date_de_debut_de_consommation AS DATE) AS period_start ,
                           CAST(t.date_de_fin_de_consommation AS DATE) AS period_end ,
                           cte.Invoice_date ,
                           cte.Site_name ,
                           cte.Site_code ,
                           cte.Address ,
                           cte.Invoice_type ,
                           cte.Subscription_excl_VAT ,
                           cte.Consumption_kWh ,
                           cte.Energy_Cost ,
                           cte.Reactive_Cost ,
                           cte.Transmission_Cost
                      FROM POWERBILL_CTE cte
                     INNER JOIN DS_POWER.FBU_EDF t
                        ON cte.Invoice_Number = t.num_facture
                       AND cte.Delivery_point = t.ref_acheminement
                       AND cte.Site_code = t.id_site
                     WHERE cte.MonthDiff > 0
                   ),
                   FBU_CTE AS (
                    SELECT Account_Number ,
                           Consumption_Month ,
                           Service_Address ,
                           Current_Read_Type ,
                           Total_Consumption_kWh * coalesce(pct, 1) AS Total_Consumption_kWh ,
                           Energy_Cost * coalesce(pct, 1) AS Energy_Cost ,
                           Reactive_Cost * coalesce(pct, 1) AS Reactive_Cost ,
                           Transmission_Cost * coalesce(pct, 1) AS Transmission_Cost ,
                           Meter_Number ,
                           site_name ,
                           site ,
                           pct ,
                           Demand_Cost ,
                           GST ,
                           PST ,
                           Basic_Cost ,
                           Billed_Demand_kVA ,
                           Registered_Demand_kVA ,
                           AMI_Meter ,
                           Bill_Days ,
                           Foreman ,
                           CLUSTER
                      FROM (
                            SELECT cast(NULL AS varchar(50)) AS Account_Number ,
                                   LAST_DAY(cast(Consumption_end_of_period AS date)) AS Consumption_Month ,
                                   cast(Address AS varchar(100)) AS Service_Address ,
                                   cast(Invoice_type AS varchar(50)) AS Current_Read_Type ,
                                   cast(Consumption_kWh AS float) / total_days * days AS Total_Consumption_kWh ,
                                   Energy_Cost / total_days * days AS Energy_Cost ,
                                   Reactive_Cost / total_days * days AS Reactive_Cost ,
                                   Transmission_Cost / total_days * days AS Transmission_Cost ,
                                   Delivery_point AS Meter_Number ,
                                   cast(Site_name AS varchar(50)) AS site_name ,
                                   cast(Site AS varchar(50)) AS site ,
                                   cast(NULL AS float) AS Demand_Cost ,
                                   cast(NULL AS float) AS GST ,
                                   cast(NULL AS float) AS PST ,
                                   cast(NULL AS float) AS Basic_Cost ,
                                   cast(NULL AS float) AS Billed_Demand_kVA ,
                                   cast(NULL AS float) AS Registered_Demand_kVA ,
                                   cast(NULL AS varchar(5)) AS AMI_Meter ,
                                   datediff(DAY, Consumption_start_of_period, Consumption_end_of_period) AS Bill_Days ,
                                   try_cast(replace(ALLOC_PCT, '%', '') AS float) / 100 AS pct ,
                                   FOREMAN ,
                                   CLUSTER
                              FROM (
                                    SELECT pb.Delivery_point ,
                                           pb.Consumption_start_of_period ,
                                           pb.Consumption_end_of_period ,
                                           pb.period_start ,
                                           pb.period_end ,
                                           pb.Site_name ,
                                           pb.Site_code ,
                                           pb.Address ,
                                           pb.Invoice_type ,
                                           pb.Subscription_excl_VAT ,
                                           pb.Consumption_kWh ,
                                           pb.Energy_Cost ,
                                           pb.Reactive_Cost ,
                                           pb.Transmission_Cost ,
                                           sm.Foreman AS FOREMAN ,
                                           sm.PRODVIEW_SITE AS Site ,
                                           sm.PERCENTAGE AS ALLOC_PCT ,
                                           sm.CLUSTER AS CLUSTER ,
                                           DATEDIFF(DAY, Consumption_start_of_period, Consumption_end_of_period) + 1 AS days ,
                                           DATEDIFF(DAY, period_start, period_end) + 1 AS total_days
                                      FROM POWERBILL_CTE pb
                                      LEFT JOIN DS_POWER.FBU_SITE_MAPPING sm
                                        ON pb.Delivery_point = COALESCE(cast(sm.DELIVERY_POINT AS FLOAT), -1)
                                   ) fbp
                           ) fbp2
                   ),
                   FBU2_CTE AS (
                    SELECT NULL AS Account_Number ,
                           Consumption_Month AS
                     MONTH ,
                           MAX(Service_Address) AS Service_Address ,
                           SUM(Total_Consumption_kWh) AS Total_Consumption_kWh ,
                           SUM(Energy_Cost) AS Energy_Cost ,
                           SUM(Reactive_Cost) AS Reactive_Cost ,
                           SUM(Transmission_Cost) AS Transmission_Cost ,
                           Meter_Number ,
                           MAX(site_name) AS site_name ,
                           site ,
                           SUM(Demand_Cost) AS Demand_Cost ,
                           SUM(GST) AS GST ,
                           SUM(PST) AS PST ,
                           SUM(Basic_Cost) AS Basic_Cost ,
                           SUM(Billed_Demand_kVA) AS Billed_Demand_kVA ,
                           SUM(Registered_Demand_kVA) AS Registered_Demand_kVA ,
                           Foreman ,
                           CLUSTER
                      FROM FBU_CTE
                     GROUP BY Consumption_Month ,
                              Meter_Number ,
                              site ,
                              Foreman ,
                              CLUSTER
                   ) SELECT FBU.*,
                   WELL_NAME,
                   UWI,
                   CC_NUM,
                   CC_NAME,
                   COUNTRY,
                   PROVINCE,
                   CORE_AREA,
                   AREA,
                   FACILITY,
                   WATER_M3,
                   OIL_M3,
                   OIL_BOE,
                   GAS_BOE,
                   GAS_E3M3,
                   DOWNTIME_HOURS,
                   RUN_NAME,
                   BOE,
                   COALESCE(prod.CONSUMPTION_MONTH, fbu.Month) AS Consumption_Month,
                   NULL AS AMI_Meter,
                   'No' AS AMI_Meter_Flag,
                   NULL AS SOURCE
              FROM PRODVIEW_CTE prod
              FULL JOIN FBU2_CTE fbu
                ON prod.WELL_NAME = fbu.site
               AND prod.CONSUMPTION_MONTH = fbu.Month
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PWRANALYTICS_FBU_EDF
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PWRANALYTICS_FBU_EDF') }}
        name: VIEW_PWRANALYTICS_FBU_EDF
        noLinkRefs: []
  name: VIEW_PWRANALYTICS_FBU_EDF
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
