fileVersion: 1
id: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
name: VIEW_PWRANALYTICS_FBU_EDF
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b498c92-5fda-4716-94dc-d6c4a052d5af
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: ACCOUNT_NUMBER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 62b95795-f74c-41a6-906c-cf6e80e405fa
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ab3cefd7-7894-4731-b38a-463d27df55dd
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: SERVICE_ADDRESS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c20ba1e-e3c3-4ad5-891f-523269d9cb92
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: TOTAL_CONSUMPTION_KWH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f85e43e9-f8dd-4df8-81bd-ffbbc3df7e29
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: ENERGY_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4ca027ad-0ecf-4e8c-ac75-f7d808bf2c4c
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: REACTIVE_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 83eaf4fd-616f-4888-848a-f6d2ed461505
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: TRANSMISSION_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8b69ccac-7b34-45c6-946a-6c43251549a7
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: METER_NUMBER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2e88627d-1d71-4e6e-9026-8eb280b79782
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SITE_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8154237-5e35-4c19-b4b2-50f0d1063ea9
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SITE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4b4bdc1a-886c-4191-a717-3cc6bd2e90a7
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: DEMAND_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01f3027b-c018-48dd-9a0b-bea94201f6c6
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: GST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7804b54c-f39e-4d8f-b4b8-dc5a76dcfe21
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: PST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8637381e-4a8e-4cbd-ac9d-e4b4c7292f8a
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: BASIC_COST
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 555c006c-0f3d-4227-986c-b4b18354f312
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: BILLED_DEMAND_KVA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5d83aa1a-90bd-43e9-83d6-56dfea6358ef
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: REGISTERED_DEMAND_KVA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4f9edb68-3893-4bfc-ae09-8ff675dd4128
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: FOREMAN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 432f8afd-93ac-4489-9292-8ffdca3ab358
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CLUSTER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cd722963-f0a0-48cd-b222-992796d42a5c
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(250)
        defaultValue: ""
        description: ""
        name: WELL_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e9274b40-1353-4dce-a583-c4062ed087ee
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 459b34ee-f534-4f77-86dd-8e33d2e951b1
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: UWI
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b970b538-ad87-4f15-9eb9-4571974433ca
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c056c0ef-e9da-44bb-b48b-344c93bfc4cb
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CC_NUM
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ef42c06-3534-4c4b-ad75-114cf05935f4
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b46291b3-bfa0-4139-8cfd-44612f2bb7df
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(40)
        defaultValue: ""
        description: ""
        name: CC_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7b82cd0c-afd0-4c3e-b1db-2819cc0393c1
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d18aa013-6a54-424e-b753-a40fc5263bf8
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: COUNTRY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b69166eb-4c3f-451f-ab8e-10b6f03531f7
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 959f90ca-69d9-4b5c-a160-f04349262903
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: PROVINCE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 58129151-4dcb-436a-a113-3468f78460f4
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 692e9a5f-9e71-4af4-b53a-6d7a69a14b7c
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: CORE_AREA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4319240d-ccab-415c-aaab-5f7e49cc2a0a
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5c6ddc84-8e23-4ff2-8ab1-19eccacb94f1
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(240)
        defaultValue: ""
        description: ""
        name: AREA
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ee18cda9-694e-4439-a649-f80d0b473156
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d241d152-b54c-48ab-bf16-31aa6d9b8418
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: FACILITY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c1f9c96f-f5a4-4231-9fd2-aff86896e3bc
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 696ec3d7-ce0f-497c-8878-7143fa3a7e4b
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: WATER_M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bc2677ac-5d37-4f79-b89d-5938f3bd4ca8
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d12c25e8-23a5-49e0-8819-49e9b2f85b23
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36, 8)
        defaultValue: ""
        description: ""
        name: OIL_M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b22a67b6-0f37-4b7d-94ec-e7d4b3553b21
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 993ecda6-3304-4ca6-9a0d-af7cb777fe79
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: OIL_BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: abed9871-37ba-4751-a47c-1303b56b9556
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0aec7a86-d75e-43fb-9e87-c210c6aeac77
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: GAS_BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 35f67bde-347a-40bb-9f89-0410c1a4f4d2
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d77337f2-96e3-4095-9816-2d696c3ea436
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: GAS_E3M3
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 565f5974-f17c-4b89-839b-32e8e6dce7ef
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 57499610-9c71-4bfb-8bfd-86e08b53f952
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: DOWNTIME_HOURS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ccaeb446-a23b-4f9c-8110-aa52d880d1b8
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b45d18cb-fc5e-49b7-bd9e-c68b3569d2c7
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(100)
        defaultValue: ""
        description: ""
        name: RUN_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 867d6e6b-089c-4b4f-9a46-cba3f805752d
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2847a73c-7ad1-4188-8027-f28def00ee15
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: NUMERIC(36,8)
        defaultValue: ""
        description: ""
        name: BOE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3202f8bc-13ed-42d3-bdbe-ac20d24f1c85
                stepCounter: 0253f085-53df-4007-a1e3-5aa11e6ab290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 56cdf732-164c-4944-963e-886de96cf78a
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: CONSUMPTION_MONTH
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59b63d0e-547e-4a71-bc91-130d087ee9b0
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: AMI_METER
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: be10c53e-76cc-4de4-9bf4-569a7913fc5f
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(2)
        defaultValue: ""
        description: ""
        name: AMI_METER_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59bd05a3-b836-4b8b-be23-7a36c9ef99c8
          stepCounter: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        config: {}
        dataType: VARCHAR(255)
        defaultValue: ""
        description: ""
        name: SOURCE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PWRANALYTICS_FBU_EDF: ba8a6ef3-b5a9-4725-bde1-094793c3bdfc
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PWRANALYTICS_FBU_EDF') }} AS WITH PRODVIEW_CTE AS (
                    SELECT WELL_NAME,
                           UWI,
                           CC_NUM,
                           CC_NAME,
                           COUNTRY,
                           PROVINCE,
                           CORE_AREA,
                           AREA,
                           FACILITY,
                           PROD_MONTH,
                           LAST_DAY(TO_DATE(CONCAT(pv.PROD_MONTH, ' 1 ', pv.PROD_YEAR), 'MON DD YYYY')) AS CONSUMPTION_MONTH,
                           WATER_M3,
                           OIL_M3,
                           OIL_BOE,
                           GAS_BOE,
                           GAS_E3M3,
                           DOWNTIME_HOURS,
                           RUN_NAME,
                           BOE
                      FROM WS_EDW.VIEW_FDC_PWRANALYTICS pv
                     WHERE COUNTRY = 'FRANCE'
                   ),
                   POWERBILL_CTE AS (
                    SELECT num_facture AS Invoice_Number ,
                           ref_acheminement AS Delivery_point ,
                           cast(date_de_debut_de_consommation AS DATETIME) AS Consumption_start_of_period ,
                           CASE WHEN cast(concat(DATE_PART(YEAR, cast(date_de_fin_de_consommation AS date)), right(concat('00', DATE_PART(MONTH, cast(date_de_fin_de_consommation AS date))), 2)) AS int) > cast(concat(DATE_PART(YEAR, cast(date_de_debut_de_consommation AS date)), right(concat('00', DATE_PART(MONTH, cast(date_de_debut_de_consommation AS DATETIME))), 2)) AS int) THEN DATEADD(SECOND, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', cast(date_de_debut_de_consommation AS date)) + 1, '1900-01-01'))
                                ELSE CAST(date_de_fin_de_consommation AS DATE)
                                 END AS Consumption_end_of_period ,
                           DATEDIFF(MONTH, cast(date_de_debut_de_consommation AS date), cast(date_de_fin_de_consommation AS date)) AS MonthDiff ,
                           CAST(date_de_debut_de_consommation AS DATE) AS period_start ,
                           CAST(date_de_fin_de_consommation AS DATE) AS period_end ,
                           date_facture AS Invoice_date ,
                           nom_site AS Site_name ,
                           id_site AS Site_code ,
                           adresse_site AS Address ,
                           type_index AS Invoice_type ,
                           try_cast(NULL AS float) AS Subscription_excl_VAT ,
                           conso_elec_facturee_kwh AS Consumption_kWh ,
                           try_cast(total_htva_euros AS float) AS Energy_Cost ,
                           try_cast(energie_reactive_euros AS float) AS Reactive_Cost ,
                           try_cast(montant_ht_reseau_distrib_euros AS float) AS Transmission_Cost
                      FROM DS_POWER.FBU_EDF
                     WHERE cast(date_de_debut_de_consommation AS date) > '1900-12-31'
                 UNION ALL SELECT cte.Invoice_Number ,
                           cte.Delivery_point ,
                           CASE WHEN cte.MonthDiff > 0 THEN DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)), '1900-01-01')
                                ELSE CAST(cte.Consumption_start_of_period AS DATETIME)
                                 END AS start_of_period ,
                           CASE WHEN cte.MonthDiff > 0 AND DATEADD(DAY, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)) + 1, '1900-01-01')) < CAST(t.date_de_fin_de_consommation AS DATE) THEN DATEADD(DAY, -1, DATEADD(MONTH, DATEDIFF(MONTH, '1900-01-01', DATEADD(MONTH, 1, cte.Consumption_start_of_period)) + 1, '1900-01-01'))
                                ELSE CAST(t.date_de_fin_de_consommation AS DATE)
                                 END AS end_of_period ,
                           (cte.MonthDiff - 1) AS MonthDiff ,
                           CAST(t.date_de_debut_de_consommation AS DATE) AS period_start ,
                           CAST(t.date_de_fin_de_consommation AS DATE) AS period_end ,
                           cte.Invoice_date ,
                           cte.Site_name ,
                           cte.Site_code ,
                           cte.Address ,
                           cte.Invoice_type ,
                           cte.Subscription_excl_VAT ,
                           cte.Consumption_kWh ,
                           cte.Energy_Cost ,
                           cte.Reactive_Cost ,
                           cte.Transmission_Cost
                      FROM POWERBILL_CTE cte
                     INNER JOIN DS_POWER.FBU_EDF t
                        ON cte.Invoice_Number = t.num_facture
                       AND cte.Delivery_point = t.ref_acheminement
                       AND cte.Site_code = t.id_site
                     WHERE cte.MonthDiff > 0
                   ),
                   FBU_CTE AS (
                    SELECT Account_Number ,
                           Consumption_Month ,
                           Service_Address ,
                           Current_Read_Type ,
                           Total_Consumption_kWh * coalesce(pct, 1) AS Total_Consumption_kWh ,
                           Energy_Cost * coalesce(pct, 1) AS Energy_Cost ,
                           Reactive_Cost * coalesce(pct, 1) AS Reactive_Cost ,
                           Transmission_Cost * coalesce(pct, 1) AS Transmission_Cost ,
                           Meter_Number ,
                           site_name ,
                           site ,
                           pct ,
                           Demand_Cost ,
                           GST ,
                           PST ,
                           Basic_Cost ,
                           Billed_Demand_kVA ,
                           Registered_Demand_kVA ,
                           AMI_Meter ,
                           Bill_Days ,
                           Foreman ,
                           CLUSTER
                      FROM (
                            SELECT cast(NULL AS varchar(50)) AS Account_Number ,
                                   LAST_DAY(cast(Consumption_end_of_period AS date)) AS Consumption_Month ,
                                   cast(Address AS varchar(100)) AS Service_Address ,
                                   cast(Invoice_type AS varchar(50)) AS Current_Read_Type ,
                                   cast(Consumption_kWh AS float) / total_days * days AS Total_Consumption_kWh ,
                                   Energy_Cost / total_days * days AS Energy_Cost ,
                                   Reactive_Cost / total_days * days AS Reactive_Cost ,
                                   Transmission_Cost / total_days * days AS Transmission_Cost ,
                                   Delivery_point AS Meter_Number ,
                                   cast(Site_name AS varchar(50)) AS site_name ,
                                   cast(Site AS varchar(50)) AS site ,
                                   cast(NULL AS float) AS Demand_Cost ,
                                   cast(NULL AS float) AS GST ,
                                   cast(NULL AS float) AS PST ,
                                   cast(NULL AS float) AS Basic_Cost ,
                                   cast(NULL AS float) AS Billed_Demand_kVA ,
                                   cast(NULL AS float) AS Registered_Demand_kVA ,
                                   cast(NULL AS varchar(5)) AS AMI_Meter ,
                                   datediff(DAY, Consumption_start_of_period, Consumption_end_of_period) AS Bill_Days ,
                                   try_cast(replace(ALLOC_PCT, '%', '') AS float) / 100 AS pct ,
                                   FOREMAN ,
                                   CLUSTER
                              FROM (
                                    SELECT pb.Delivery_point ,
                                           pb.Consumption_start_of_period ,
                                           pb.Consumption_end_of_period ,
                                           pb.period_start ,
                                           pb.period_end ,
                                           pb.Site_name ,
                                           pb.Site_code ,
                                           pb.Address ,
                                           pb.Invoice_type ,
                                           pb.Subscription_excl_VAT ,
                                           pb.Consumption_kWh ,
                                           pb.Energy_Cost ,
                                           pb.Reactive_Cost ,
                                           pb.Transmission_Cost ,
                                           sm.Foreman AS FOREMAN ,
                                           sm.PRODVIEW_SITE AS Site ,
                                           sm.PERCENTAGE AS ALLOC_PCT ,
                                           sm.CLUSTER AS CLUSTER ,
                                           DATEDIFF(DAY, Consumption_start_of_period, Consumption_end_of_period) + 1 AS days ,
                                           DATEDIFF(DAY, period_start, period_end) + 1 AS total_days
                                      FROM POWERBILL_CTE pb
                                      LEFT JOIN DS_POWER.FBU_SITE_MAPPING sm
                                        ON pb.Delivery_point = COALESCE(cast(sm.DELIVERY_POINT AS FLOAT), -1)
                                   ) fbp
                           ) fbp2
                   ),
                   FBU2_CTE AS (
                    SELECT NULL AS Account_Number ,
                           Consumption_Month AS
                     MONTH ,
                           MAX(Service_Address) AS Service_Address ,
                           SUM(Total_Consumption_kWh) AS Total_Consumption_kWh ,
                           SUM(Energy_Cost) AS Energy_Cost ,
                           SUM(Reactive_Cost) AS Reactive_Cost ,
                           SUM(Transmission_Cost) AS Transmission_Cost ,
                           Meter_Number ,
                           MAX(site_name) AS site_name ,
                           site ,
                           SUM(Demand_Cost) AS Demand_Cost ,
                           SUM(GST) AS GST ,
                           SUM(PST) AS PST ,
                           SUM(Basic_Cost) AS Basic_Cost ,
                           SUM(Billed_Demand_kVA) AS Billed_Demand_kVA ,
                           SUM(Registered_Demand_kVA) AS Registered_Demand_kVA ,
                           Foreman ,
                           CLUSTER
                      FROM FBU_CTE
                     GROUP BY Consumption_Month ,
                              Meter_Number ,
                              site ,
                              Foreman ,
                              CLUSTER
                   ) SELECT FBU.*,
                   WELL_NAME,
                   UWI,
                   CC_NUM,
                   CC_NAME,
                   COUNTRY,
                   PROVINCE,
                   CORE_AREA,
                   AREA,
                   FACILITY,
                   WATER_M3,
                   OIL_M3,
                   OIL_BOE,
                   GAS_BOE,
                   GAS_E3M3,
                   DOWNTIME_HOURS,
                   RUN_NAME,
                   BOE,
                   COALESCE(prod.CONSUMPTION_MONTH, fbu.Month) AS Consumption_Month,
                   NULL AS AMI_Meter,
                   'No' AS AMI_Meter_Flag,
                   NULL AS SOURCE
              FROM PRODVIEW_CTE prod
              FULL JOIN FBU2_CTE fbu
                ON prod.WELL_NAME = fbu.site
               AND prod.CONSUMPTION_MONTH = fbu.Month
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PWRANALYTICS_FBU_EDF
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PWRANALYTICS_FBU_EDF') }}
        name: VIEW_PWRANALYTICS_FBU_EDF
        noLinkRefs: []
  name: VIEW_PWRANALYTICS_FBU_EDF
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
