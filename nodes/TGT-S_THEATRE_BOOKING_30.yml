fileVersion: 1
id: b1b58f8a-2821-4902-ac42-276cb6e02d39
name: S_THEATRE_BOOKING_30
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Join to s_consolidate_theatre to get details of the next actual theatre visit for the same specialty. If no such visit exists the first one within the next 10 days is selected."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 34de5366-ab6c-47f6-be0a-7a9cfdfc7f9b
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1eda1e16-cacd-47f2-863f-25a78267b9eb
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e7b3a510-9450-42a7-b709-a3760e37b610
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: afbdf457-abfa-430c-9936-9cec06d42993
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4241ab58-4d1b-4287-b88b-9b88c801200f
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: BOOKING_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e34a6c5f-fac3-4dd0-bbab-8a22c6116a8f
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f4f11d08-d948-4ed6-b017-9ff80121cbb9
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: BOOKING_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c95f2e2b-4320-4f26-a06c-fa9b8ddf3aa4
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f15f804d-e246-466c-9980-1604e2282c2d
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: BOOKING_SENT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 57fea6b7-f878-4df3-92ad-957557db3a63
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0cad6b24-6a26-42b3-a15d-9b9401b29e74
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e829177f-95cf-4f5f-9989-524aebdbeb16
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8e9aeb88-f076-49c7-bfcf-462a72d09c07
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers rows for each booking encounter ID in theatre visit order.
        name: ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e34a6c5f-fac3-4dd0-bbab-8a22c6116a8f
                stepCounter: 9d3cd9c4-6e6d-45a3-a066-4105d90bbaca
            transform: ROW_NUMBER() OVER(PARTITION BY s_theatre_booking_10.booking_id ORDER BY CASE WHEN dim_theatre_specialty.theatre_specialty_code = s_theatre_booking_10.specialty_code THEN 0 ELSE 1 END, ds_consolidate_theatre.visit_start_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d539c98-ecb0-441c-8dc3-8260ee647d56
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: VARCHAR(12)
        defaultValue: ""
        description: 'The next acute theatre visit for the patient - either for the same specialty or occurring in the next 10 days if no such visit exists.  '
        name: THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 38f22026-55f1-4f12-ba29-e7b05502b811
                stepCounter: 559bcb0e-7f2c-42ea-a758-d73dead63a4f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4cf1428b-d9de-448d-9ff9-7e1542386b93
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Set to into_theatre_date or, if that is null, the date portion of visit_start_date.
        name: BOOKING_CHECK_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cd834443-63fb-4ee9-9888-39e3a0971fee
                stepCounter: 559bcb0e-7f2c-42ea-a758-d73dead63a4f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51c96289-5164-44bd-ac54-149ca43171ac
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: ""
        name: BOOK_VISIT_DAYS_DIFF
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: efdd61ec-a0b0-4582-8000-687e440c5860
                stepCounter: 559bcb0e-7f2c-42ea-a758-d73dead63a4f
            transform: DATEDIFF(DD, s_theatre_booking_10.booking_sent_date, ds_consolidate_theatre.booking_check_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8d718a41-7481-4d9b-b22f-97821b78b984
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Specialty Code
        name: THEATRE_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e943587d-2b9a-4a3e-ac17-dc2324c12370
                stepCounter: 2df2f1e3-81fa-48e7-8567-e35a38c06290
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1dcb0215-1a7c-4ecf-9b29-c6abd3163a65
          stepCounter: b1b58f8a-2821-4902-ac42-276cb6e02d39
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_THEATRE_BOOKING_10
        join:
          joinCondition: |-
            FROM s_theatre_booking_10
              JOIN ds_consolidate_theatre
                ON ds_consolidate_theatre.patient_nhi = s_theatre_booking_10.patient_nhi
               AND ds_consolidate_theatre.booking_check_date >= s_theatre_booking_10.booking_sent_date
               AND ds_consolidate_theatre.acute_flag = 'Y'
              JOIN dim.dim_theatre_specialty
                ON ds_consolidate_theatre.dim_theatre_specialty_key = dim_theatre_specialty.dim_theatre_specialty_key
             WHERE s_theatre_booking_10.specialty_code = dim_theatre_specialty.theatre_specialty_code
                OR (IFNULL(s_theatre_booking_10.specialty_code, '') <> dim_theatre_specialty.theatre_specialty_code AND DATEDIFF(DD, s_theatre_booking_10.booking_sent_date, ds_consolidate_theatre.booking_check_date) <= 10)
        name: S_THEATRE_BOOKING_30
        noLinkRefs: []
  name: S_THEATRE_BOOKING_30
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
