fileVersion: 1
id: 6ff56648-4d24-4138-8ddf-ca8d7198021e
name: AGGCONTRACTUSAGEBYRECEIPTDATE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0c936a92-46a0-4e92-a710-0b027f495941
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: INT
        defaultValue: ""
        description: Unique identifier for an account. Commonly called the "Force Id"
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        isBusinessKey: true
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0960d547-e310-44ae-ad82-ccd1ee7d442a
                stepCounter: a594f58e-2240-453f-a570-12719830e3d0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a63ce77b-6811-47c7-812c-d3191aff8415
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        isBusinessKey: true
        name: PPACONTRACTNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bab96930-aec3-49c4-a9c1-9be83fc0e144
                stepCounter: c745f44c-5c71-4400-897b-ff90a502a9cb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0388284f-723a-4d47-a1a3-a87b48ccfa52
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: The receipt date calendar quarter representation. Format YYYYQQ. Example 200204.
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        isBusinessKey: true
        name: RECEIPTDATECALQUARTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ce5388f4-a6c1-4f68-b172-ee92e500fb8d
                stepCounter: 5b2d5c58-31de-4b87-b6c8-d601fc33ff03
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 109216a8-bdf5-4992-a269-3ac8f8a806aa
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: SALES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f4a71e14-54d2-4ee3-88da-c8c95b56c2c7
                stepCounter: 79e76231-b280-4362-a8fa-68215a84f788
            transform: SUM(SalesAndRevenue.Sales)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 576601a0-b97f-40aa-a021-7fe111839419
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2098b7a3-a5c3-4180-b722-2fa84cd3e787
                stepCounter: 79e76231-b280-4362-a8fa-68215a84f788
            transform: SUM(SalesAndRevenue.Revenue)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bff8794f-495e-403b-a9ca-5e4645fa2156
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: BOOLEAN
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: ISFIRSTTIMEUSINGCONTRACT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9f0957af-16aa-40fe-a225-3f515a7496a8
                stepCounter: 79e76231-b280-4362-a8fa-68215a84f788
            transform: |-
              -- Is this the very 1st time using this contract?
               IFF(LAG(ReceiptDateCalQuarter, 1) OVER(PARTITION BY ForceId, Contract.PPAContractNumber ORDER BY ForceId, Contract.PPAContractNumber,ReceiptDateCalQuarter) IS NULL, 1, 0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15ea265b-eb62-4ece-a1c9-4f8ae9983c24
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: ISCONTRACTUSENEWORRECURRINGINTRAILING12MONTHS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9f0957af-16aa-40fe-a225-3f515a7496a8
                stepCounter: 79e76231-b280-4362-a8fa-68215a84f788
            transform: |-
              --New or Recurring in a Rolling 4 Quarter Timeline
                IFF(DATEDIFF(QUARTER, LAG(TO_DATE(CONCAT(CAST(LEFT(DimReceiptDate.ReceiptDateCalQuarter, 4) AS VARCHAR(10)), CASE RIGHT(CAST(DimReceiptDate.ReceiptDateCalQuarter AS VARCHAR(10)), 2) WHEN '01' THEN '03' WHEN '02' THEN '06' WHEN '03' THEN '09' ELSE '12' END, '01')), 1) OVER(PARTITION BY ForceId, Contract.PPAContractNumber ORDER BY ForceId, Contract.PPAContractNumber, DimReceiptDate.ReceiptDateCalQuarter), TO_DATE(CONCAT(CAST(LEFT(DimReceiptDate.ReceiptDateCalQuarter, 4) AS VARCHAR(10)), CASE RIGHT(CAST(DimReceiptDate.ReceiptDateCalQuarter AS VARCHAR(10)), 2) WHEN '01' THEN '03' WHEN '02' THEN '06' WHEN '03' THEN '09' ELSE '12' END, '01'))) <= 4, 'Recurring', 'New')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d597bbaf-471f-4899-a3d5-96eb03290c81
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: QUARTERSSINCECONTRACTUSE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9f0957af-16aa-40fe-a225-3f515a7496a8
                stepCounter: 79e76231-b280-4362-a8fa-68215a84f788
            transform: |-
              --Quarters Since Last Use
                DATEDIFF(QUARTER, LAG(TO_DATE(CONCAT(CAST(LEFT(DimReceiptDate.ReceiptDateCalQuarter, 4) AS VARCHAR(10)), CASE RIGHT(CAST(DimReceiptDate.ReceiptDateCalQuarter AS VARCHAR(10)), 2) WHEN '01' THEN '03' WHEN '02' THEN '06' WHEN '03' THEN '09' ELSE '12' END, '01')), 1) OVER(PARTITION BY ForceId, Contract.PPAContractNumber ORDER BY ForceId, Contract.PPAContractNumber,DimReceiptDate.ReceiptDateCalQuarter), TO_DATE(CONCAT(CAST(LEFT(DimReceiptDate.ReceiptDateCalQuarter, 4) AS VARCHAR(10)), CASE RIGHT(CAST(DimReceiptDate.ReceiptDateCalQuarter AS VARCHAR(10)), 2) WHEN '01' THEN '03' WHEN '02' THEN '06' WHEN '03' THEN '09' ELSE '12' END, '01')))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 931f6563-d569-4a95-b962-a5b470ef18bd
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was created in the data warehouse.
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSCREATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 66d0be89-01e3-467c-82c8-b0ce1828b08f
          stepCounter: 6ff56648-4d24-4138-8ddf-ca8d7198021e
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSUPDATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          SALESANDREVENUE: 79e76231-b280-4362-a8fa-68215a84f788
          ACCOUNT: a594f58e-2240-453f-a570-12719830e3d0
          CONTRACT: c745f44c-5c71-4400-897b-ff90a502a9cb
          DIMRECEIPTDATE: 5b2d5c58-31de-4b87-b6c8-d601fc33ff03
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DIM
            nodeName: ACCOUNT
          - locationName: DIM
            nodeName: CONTRACT
          - locationName: DIM
            nodeName: DIMRECEIPTDATE
          - locationName: FACT
            nodeName: SALESANDREVENUE
        join:
          joinCondition: |-
            FROM {{ ref('FACT','SALESANDREVENUE') }} SalesAndRevenue
              LEFT JOIN {{ ref('DIM','ACCOUNT') }} ACCOUNT
                ON SalesAndRevenue.AccountKey = Account.AccountKey
              LEFT JOIN {{ ref('DIM','CONTRACT') }} Contract
                ON SalesAndRevenue.ContractKey = Contract.ContractKey
              LEFT JOIN {{ ref('DIM','DIMRECEIPTDATE') }} DimReceiptDate
                ON SalesAndRevenue.ReceiptDateKey = DimReceiptDate.ReceiptDateKey
             GROUP BY Account.ForceId,
                      Contract.PPAContractNumber,
                      DimReceiptDate.ReceiptDateCalQuarter
             ORDER BY Account.ForceId,
                      Contract.PPAContractNumber,
                      DimReceiptDate.ReceiptDateCalQuarter
        name: AGGCONTRACTUSAGEBYRECEIPTDATE
        noLinkRefs: []
  name: AGGCONTRACTUSAGEBYRECEIPTDATE
  overrideSQL: false
  schema: ""
  sqlType: Fact
  type: sql
  version: 1
type: Node
