fileVersion: 1
id: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
name: AGGCONTRACTUSAGEBYRECEIPTDATE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3ebedca3-09e4-45ff-a907-1166bba4d389
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: INT
        defaultValue: ""
        description: UNIQUE IDENTIFIER FOR AN ACCOUNT. COMMONLY CALLED THE "FORCE ID"
        isBusinessKey: true
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e5618162-63a1-4114-905f-185fd2a82e5e
                stepCounter: d5234d5a-eb19-45e2-9c42-47221579f347
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2a796e15-44ff-4785-81a5-56614e3b02e3
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: PPACONTRACTNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 347ea14e-1c55-4d79-b912-f7f0672d79e7
                stepCounter: ab16115a-f5c7-4d24-bca6-41c596634f50
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e2618d0-b325-427f-8369-3bc5857359b4
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: THE RECEIPT DATE CALENDAR QUARTER REPRESENTATION. FORMAT YYYYQQ. EXAMPLE 200204.
        isBusinessKey: true
        name: RECEIPTDATECALQUARTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 220ef05e-3d00-467d-a227-0a478b9b3a94
                stepCounter: 2208854c-f7ba-4014-a250-d2598d1217cd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15edc9be-080a-46ce-bc32-171727e70ee3
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: SALES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4a2458c7-c0c6-4612-8ab1-2a23e7ee2bd8
                stepCounter: 35498798-8753-42e9-bc58-c54bc0c65138
            transform: SUM(SALESANDREVENUE.SALES)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 12c7146d-a746-4ec0-8b17-a535b250d7d9
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d80644e6-6eac-4b2a-a4b4-8ae1175d334b
                stepCounter: 35498798-8753-42e9-bc58-c54bc0c65138
            transform: SUM(SALESANDREVENUE.REVENUE)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5cb3ad8d-53fc-489a-97c6-86ee652cb534
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: BOOLEAN
        defaultValue: ""
        description: ""
        name: ISFIRSTTIMEUSINGCONTRACT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0a0fb266-a188-45d6-a47b-484f2ad556bd
                stepCounter: 35498798-8753-42e9-bc58-c54bc0c65138
            transform: |-
              -- IS THIS THE VERY 1ST TIME USING THIS CONTRACT?
              \NIFF(LAG(RECEIPTDATECALQUARTER, 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,RECEIPTDATECALQUARTER) IS NULL, 1, 0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ecedec1b-aef7-499b-8afd-657cf4981f44
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: ISCONTRACTUSENEWORRECURRINGINTRAILING12MONTHS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0a0fb266-a188-45d6-a47b-484f2ad556bd
                stepCounter: 35498798-8753-42e9-bc58-c54bc0c65138
            transform: |-
              --NEW OR RECURRING IN A ROLLING 4 QUARTER TIMELINE
              \N IFF(\N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER, DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01'))) <= 4, 'RECURRING', 'NEW')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e46acce5-77ff-4ef0-98f6-19c12dda9788
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: QUARTERSSINCECONTRACTUSE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0a0fb266-a188-45d6-a47b-484f2ad556bd
                stepCounter: 35498798-8753-42e9-bc58-c54bc0c65138
            transform: |-
              --QUARTERS SINCE LAST USE
              \N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 411b10f0-8185-4932-aa15-fff2d48ade55
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS CREATED IN THE DATA WAREHOUSE.
        name: DSSCREATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 292c253b-07a8-4c29-a29b-a4d03cbd3576
          stepCounter: 7afd2c0c-c85c-4105-af4d-37f11ec56e66
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS UPDATED IN THE DATA WAREHOUSE.
        name: DSSUPDATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          SALESANDREVENUE: 35498798-8753-42e9-bc58-c54bc0c65138
          ACCOUNT: d5234d5a-eb19-45e2-9c42-47221579f347
          CONTRACT: ab16115a-f5c7-4d24-bca6-41c596634f50
          DIMRECEIPTDATE: 2208854c-f7ba-4014-a250-d2598d1217cd
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DIM
            nodeName: ACCOUNT
          - locationName: DIM
            nodeName: CONTRACT
          - locationName: DIM
            nodeName: DIMRECEIPTDATE
          - locationName: FACT
            nodeName: SALESANDREVENUE
        join:
          joinCondition: |-
            FROM {{ ref('FACT','SALESANDREVENUE') }} SALESANDREVENUE
              LEFT JOIN {{ ref('DIM','ACCOUNT') }} ACCOUNT
                ON SALESANDREVENUE.ACCOUNTKEY = ACCOUNT.ACCOUNTKEY
              LEFT JOIN {{ ref('DIM','CONTRACT') }} CONTRACT
                ON SALESANDREVENUE.CONTRACTKEY = CONTRACT.CONTRACTKEY
              LEFT JOIN {{ ref('DIM','DIMRECEIPTDATE') }} DIMRECEIPTDATE
                ON SALESANDREVENUE.RECEIPTDATEKEY = DIMRECEIPTDATE.RECEIPTDATEKEY
             GROUP BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
             ORDER BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
        name: AGGCONTRACTUSAGEBYRECEIPTDATE
        noLinkRefs: []
  name: AGGCONTRACTUSAGEBYRECEIPTDATE
  overrideSQL: false
  schema: ""
  sqlType: Agreggate
  type: sql
  version: 1
type: Node
