fileVersion: 1
id: 8510e238-84b4-4851-9cff-50c92425531d
name: AGGCONTRACTUSAGEBYRECEIPTDATE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 20b871cd-de95-4548-be18-73402aca44d4
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: INT
        defaultValue: ""
        description: UNIQUE IDENTIFIER FOR AN ACCOUNT. COMMONLY CALLED THE "FORCE ID"
        isBusinessKey: true
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 349c7dc1-e387-4400-9038-4c5b022f35f8
                stepCounter: e6f00723-a598-4272-b25a-ed544e4c0a06
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 92828172-e2d6-4e47-9206-cce9cfb8dc86
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: PPACONTRACTNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0c342b18-106e-4eb9-8661-3d19f8f11981
                stepCounter: 59cadb79-2e03-4a1c-9c6e-7e6588e89674
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 28fb295d-9c32-49cb-a434-18593743af73
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: THE RECEIPT DATE CALENDAR QUARTER REPRESENTATION. FORMAT YYYYQQ. EXAMPLE 200204.
        isBusinessKey: true
        name: RECEIPTDATECALQUARTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6b1606bf-7e92-4edd-9950-40e161fe45cb
                stepCounter: 51cbcfa2-a7ad-4741-a911-b641fa22bffb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a559c5c5-8c1c-495d-a7c2-7bba03af3bb8
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: SALES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4e102484-a481-43c7-a074-4ea04cea341d
                stepCounter: b616ec63-e21c-400a-948a-218a9fc3f509
            transform: SUM(SALESANDREVENUE.SALES)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8adf478f-878f-4792-bf8b-50e9e3c966ba
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 78149a3a-b5c8-4438-bec1-c2c9155b2a27
                stepCounter: b616ec63-e21c-400a-948a-218a9fc3f509
            transform: SUM(SALESANDREVENUE.REVENUE)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01154597-fd6a-4b52-9bd4-a41f66910c25
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: BOOLEAN
        defaultValue: ""
        description: ""
        name: ISFIRSTTIMEUSINGCONTRACT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4bc74844-4302-4e53-a03f-a492b129a48e
                stepCounter: b616ec63-e21c-400a-948a-218a9fc3f509
            transform: |-
              -- IS THIS THE VERY 1ST TIME USING THIS CONTRACT?
              \NIFF(LAG(RECEIPTDATECALQUARTER, 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,RECEIPTDATECALQUARTER) IS NULL, 1, 0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a0d24c30-0820-4a7f-b15e-025915da8c14
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: ISCONTRACTUSENEWORRECURRINGINTRAILING12MONTHS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4bc74844-4302-4e53-a03f-a492b129a48e
                stepCounter: b616ec63-e21c-400a-948a-218a9fc3f509
            transform: |-
              --NEW OR RECURRING IN A ROLLING 4 QUARTER TIMELINE
              \N IFF(\N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER, DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01'))) <= 4, 'RECURRING', 'NEW')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 26e052ce-c49a-4758-b769-953e11ef5192
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: QUARTERSSINCECONTRACTUSE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4bc74844-4302-4e53-a03f-a492b129a48e
                stepCounter: b616ec63-e21c-400a-948a-218a9fc3f509
            transform: |-
              --QUARTERS SINCE LAST USE
              \N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1719ab9d-d2df-4977-9f36-0152cd1e5c1b
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS CREATED IN THE DATA WAREHOUSE.
        name: DSSCREATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9c5d7154-9ce2-4983-91d3-b96af1f54e64
          stepCounter: 8510e238-84b4-4851-9cff-50c92425531d
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS UPDATED IN THE DATA WAREHOUSE.
        name: DSSUPDATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          SALESANDREVENUE: b616ec63-e21c-400a-948a-218a9fc3f509
          ACCOUNT: e6f00723-a598-4272-b25a-ed544e4c0a06
          CONTRACT: 59cadb79-2e03-4a1c-9c6e-7e6588e89674
          DIMRECEIPTDATE: 51cbcfa2-a7ad-4741-a911-b641fa22bffb
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DIM
            nodeName: ACCOUNT
          - locationName: DIM
            nodeName: CONTRACT
          - locationName: DIM
            nodeName: DIMRECEIPTDATE
          - locationName: FACT
            nodeName: SALESANDREVENUE
        join:
          joinCondition: |-
            FROM {{ ref('FACT','SALESANDREVENUE') }} SALESANDREVENUE
              LEFT JOIN {{ ref('DIM','ACCOUNT') }} ACCOUNT
                ON SALESANDREVENUE.ACCOUNTKEY = ACCOUNT.ACCOUNTKEY
              LEFT JOIN {{ ref('DIM','CONTRACT') }} CONTRACT
                ON SALESANDREVENUE.CONTRACTKEY = CONTRACT.CONTRACTKEY
              LEFT JOIN {{ ref('DIM','DIMRECEIPTDATE') }} DIMRECEIPTDATE
                ON SALESANDREVENUE.RECEIPTDATEKEY = DIMRECEIPTDATE.RECEIPTDATEKEY
             GROUP BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
             ORDER BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
        name: AGGCONTRACTUSAGEBYRECEIPTDATE
        noLinkRefs: []
  name: AGGCONTRACTUSAGEBYRECEIPTDATE
  overrideSQL: false
  schema: ""
  sqlType: Fact
  type: sql
  version: 1
type: Node
