fileVersion: 1
id: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
name: AGGCONTRACTUSAGEBYRECEIPTDATE
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15531df5-c8e7-4e06-a0d4-72fc35fd9613
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: UNIQUE IDENTIFIER FOR AN ACCOUNT. COMMONLY CALLED THE "FORCE ID"
        isBusinessKey: true
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be2b5606-0fe8-444f-867f-5c3e46361714
                stepCounter: 96e8695b-6733-4729-8797-91b12c74cb7e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fe502994-b2a1-4e67-b71d-68e54e1bdd7b
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        isBusinessKey: true
        name: PPACONTRACTNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 66e5fe5f-289d-443d-9480-1f042cdf2f5d
                stepCounter: 930a330f-3276-4f21-bd05-9ed55fd63528
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7dd3664d-57e8-4053-865c-2bc339fbf5ad
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: THE RECEIPT DATE CALENDAR QUARTER REPRESENTATION. FORMAT YYYYQQ. EXAMPLE 200204.
        isBusinessKey: true
        name: RECEIPTDATECALQUARTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 486f0383-22fc-4ecb-9fa0-8dc462a50150
                stepCounter: d13b3440-8bde-40ca-9ad7-7d0a6431e115
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 705b1f59-e5bf-4ff7-a057-90b61b266a5c
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: SALES
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4129155a-6d88-4334-8076-297a018bdd12
                stepCounter: a45c4c17-99cc-493a-8410-a4e188c9c3a2
            transform: SUM(SALESANDREVENUE.SALES)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a1185114-f01b-4209-9c0e-cdc6a48a24d4
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: NUMERIC(18,4)
        defaultValue: ""
        description: ""
        name: REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ed76dbed-8dd4-4d3b-a417-bc4aec76a744
                stepCounter: a45c4c17-99cc-493a-8410-a4e188c9c3a2
            transform: SUM(SALESANDREVENUE.REVENUE)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0288ea60-609a-48aa-a5f4-f7d9f0796762
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: BOOLEAN
        defaultValue: ""
        description: ""
        name: ISFIRSTTIMEUSINGCONTRACT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef0485ac-161d-423a-83d5-8586f4472d41
                stepCounter: a45c4c17-99cc-493a-8410-a4e188c9c3a2
            transform: |-
              -- IS THIS THE VERY 1ST TIME USING THIS CONTRACT?
              \NIFF(LAG(RECEIPTDATECALQUARTER, 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,RECEIPTDATECALQUARTER) IS NULL, 1, 0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 834d0f3a-85c9-4b7a-8bb3-8a365233f435
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: ISCONTRACTUSENEWORRECURRINGINTRAILING12MONTHS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef0485ac-161d-423a-83d5-8586f4472d41
                stepCounter: a45c4c17-99cc-493a-8410-a4e188c9c3a2
            transform: |-
              --NEW OR RECURRING IN A ROLLING 4 QUARTER TIMELINE
              \N IFF(\N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER, DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01'))) <= 4, 'RECURRING', 'NEW')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 28905c64-323a-40f6-9b79-8f711bd6fecb
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: QUARTERSSINCECONTRACTUSE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef0485ac-161d-423a-83d5-8586f4472d41
                stepCounter: a45c4c17-99cc-493a-8410-a4e188c9c3a2
            transform: |-
              --QUARTERS SINCE LAST USE
              \N DATEDIFF(QUARTER, \N LAG(\N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')), 1) OVER(\N PARTITION BY FORCEID, CONTRACT.PPACONTRACTNUMBER \N ORDER BY FORCEID, CONTRACT.PPACONTRACTNUMBER,DIMRECEIPTDATE.RECEIPTDATECALQUARTER), \N TO_DATE(CONCAT(CAST(LEFT(DIMRECEIPTDATE.RECEIPTDATECALQUARTER, 4) AS VARCHAR(10)), \N CASE RIGHT(CAST(DIMRECEIPTDATE.RECEIPTDATECALQUARTER AS VARCHAR(10)), 2) \N WHEN '01' THEN '03' \N WHEN '02' THEN '06' \N WHEN '03' THEN '09' \N ELSE '12' \N END, '01')))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d349591b-728e-4420-9297-e143c3008594
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS CREATED IN THE DATA WAREHOUSE.
        name: DSSCREATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 52bcc0aa-8cd6-4ff5-8106-163543e635e5
          stepCounter: 994ebd02-ae9d-4a12-9c49-96bfe6d779a4
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: DATE AND TIME THE ROW WAS UPDATED IN THE DATA WAREHOUSE.
        name: DSSUPDATETIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          SALESANDREVENUE: a45c4c17-99cc-493a-8410-a4e188c9c3a2
          ACCOUNT: 96e8695b-6733-4729-8797-91b12c74cb7e
          CONTRACT: 930a330f-3276-4f21-bd05-9ed55fd63528
          DIMRECEIPTDATE: d13b3440-8bde-40ca-9ad7-7d0a6431e115
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DIM
            nodeName: ACCOUNT
          - locationName: DIM
            nodeName: CONTRACT
          - locationName: DIM
            nodeName: DIMRECEIPTDATE
          - locationName: FACT
            nodeName: SALESANDREVENUE
        join:
          joinCondition: |-
            FROM {{ ref('FACT','SALESANDREVENUE') }} SALESANDREVENUE
              LEFT JOIN {{ ref('DIM','ACCOUNT') }} ACCOUNT
                ON SALESANDREVENUE.ACCOUNTKEY = ACCOUNT.ACCOUNTKEY
              LEFT JOIN {{ ref('DIM','CONTRACT') }} CONTRACT
                ON SALESANDREVENUE.CONTRACTKEY = CONTRACT.CONTRACTKEY
              LEFT JOIN {{ ref('DIM','DIMRECEIPTDATE') }} DIMRECEIPTDATE
                ON SALESANDREVENUE.RECEIPTDATEKEY = DIMRECEIPTDATE.RECEIPTDATEKEY
             GROUP BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
             ORDER BY ACCOUNT.FORCEID,
                      CONTRACT.PPACONTRACTNUMBER,
                      DIMRECEIPTDATE.RECEIPTDATECALQUARTER
        name: AGGCONTRACTUSAGEBYRECEIPTDATE
        noLinkRefs: []
  name: AGGCONTRACTUSAGEBYRECEIPTDATE
  overrideSQL: false
  schema: ""
  sqlType: Fact
  type: sql
  version: 1
type: Node
