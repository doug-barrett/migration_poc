fileVersion: 1
id: 46f11841-9f37-4506-96bc-f77bdb3eef6a
name: S_NEXUS_DIAGNOSTIC_PROCEDURES_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 24591a72-cd5f-47f2-9188-774e988170e9
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: SCHEDULE_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 57c9c4f7-1da2-454b-b0cc-32a0c72d9198
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cfe9542f-5b65-428f-a349-67902477fa90
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 57c9c4f7-1da2-454b-b0cc-32a0c72d9198
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: "'NX'+convert(varchar(30),ds_nexus_OPS.opnumber,0)"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc694249-5d7a-486b-9697-6b82006b767f
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: VISIT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 931ef0a5-6a28-4d07-9324-d2ecbb30a708
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b892e72c-60e7-4470-beca-334f7956098c
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated key for the date dimension. Nominal format is YYYYMMDD, but DD equal to 0 and greater than 31 permited for special date handling.
        name: DIM_VISIT_START_DATE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 13234e71-2519-473a-af0d-7f73325182c3
                stepCounter: 484fdf1d-550f-43b0-8050-5734ec05d67b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ca362772-f0af-4d90-b1ac-564583bf0591
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: VISIT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 931ef0a5-6a28-4d07-9324-d2ecbb30a708
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 94822fbc-63ab-420b-8a71-efd45b6f011b
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated key for the date dimension. Nominal format is YYYYMMDD, but DD equal to 0 and greater than 31 permited for special date handling.
        name: DIM_VISIT_END_DATE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 08025052-688d-445e-bbd8-0354e67585c3
                stepCounter: 90bdc455-a671-42c7-840f-35c738a1f1f3
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 89c921ff-10c2-431e-8a23-074734bd33d9
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CODING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 931ef0a5-6a28-4d07-9324-d2ecbb30a708
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 94553827-78dd-4f51-819a-1ea1fec24594
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fd9087b0-e1c1-484b-8332-d6058069daf2
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1465450c-96ab-4e4b-9fc7-1486fdcf8c20
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: MEDICAL_PROBLEM_LEVEL_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: z.procnumber
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9c30e85b-7f72-4ea4-89dd-2efe05691702
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: MEDICAL_PROBLEM_LEVEL_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN z.procnumber = 1 THEN 'PRIME'
                          ELSE 'SECND'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 80429aa8-67af-4499-99db-8009cfc629b7
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(5)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_TYPE_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eb44f881-fca0-4bfc-a502-7dcbac763898
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_SUBTYPE_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8c429804-2db3-4001-90b8-8d963600cb6b
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: CLINICAL_CLASSIFICATION_XREF_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b7b57bad-d676-48e3-862b-b3899ae2f6e8
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CLINICAL_CLASSIFICATION_XREF_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 48e189ad-dc4a-418f-a588-5d6230ecbcb9
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DIAGNOSIS_PROCEDURE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN charindex('-',z.PROCCODE) = 0 THEN z.PROCCODE
                          ELSE SUBSTRING(z.PROCCODE,1,charindex('-',z.PROCCODE)-1)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b506453d-2bda-4692-851c-c6e5fb0325cd
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_THEATRE_PROCEDURE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d4f838b6-9e8c-408a-b036-3f02573753f6
                stepCounter: 840b1a44-55c1-4cbc-9199-4415e254bce4
            transform: IFNULL(dim_theatre_procedure.dim_theatre_procedure_key,0)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 75e86a4c-2284-43f4-8df3-3f1a344f293f
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PATIENT_DIAGNOSIS_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 48b48001-92af-402c-bbaf-659f20f0348e
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PATIENT_DIAGNOSIS_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ae3d72bf-f74a-4ba3-8de4-6d07ab017d60
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PATIENT_PROCEDURE_SEQ_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: z.procnumber
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ce2e8dd-7360-499d-8705-343f1f1bc545
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PATIENT_PROCEDURE_COUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: COUNT(1) OVER (PARTITION BY z.opnumber)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9a4fcfc0-cb53-459b-9f73-83f2fa0888ef
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CREATE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dab0ac6a-7cf8-47c6-a566-95405793439f
                stepCounter: da9b1eeb-57ac-43cf-abdd-8091b869da6f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8179c86e-9fb1-4c4f-93c9-8caa544938a2
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CREATE_USER_LOGIN_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 634af1ef-eaeb-472e-adbf-affa09104571
                stepCounter: da9b1eeb-57ac-43cf-abdd-8091b869da6f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 162a3175-70d7-49a2-844a-6c627c04905d
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: MODIFY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a9299356-d36b-413d-b45c-40d1bb381fc2
                stepCounter: 50d26640-0cb5-4660-9d6b-c83e70fae3d9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f30cf8e-6602-46e5-85f3-39dd2ac6a243
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: OUTPATIENT_COUNT
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c865367b-7e3d-41a1-b95f-f1f04446ab56
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: MODIFY_USER_LOGIN_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cb3df518-af9b-42ba-a660-edbbe6ca092d
                stepCounter: 50d26640-0cb5-4660-9d6b-c83e70fae3d9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31afd739-1321-4940-8c83-216bfbb7230b
          stepCounter: 46f11841-9f37-4506-96bc-f77bdb3eef6a
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          DIM_VISIT_START_DATE: 484fdf1d-550f-43b0-8050-5734ec05d67b
          DIM_VISIT_END_DATE: 90bdc455-a671-42c7-840f-35c738a1f1f3
          S_NEXUS_CREATE_V: da9b1eeb-57ac-43cf-abdd-8091b869da6f
          S_NEXUS_MODIF_V: 50d26640-0cb5-4660-9d6b-c83e70fae3d9
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: DS_NEXUS_OPS
          - locationName: TGT
            nodeName: DIM_VISIT_START_DATE
          - locationName: TGT
            nodeName: DIM_VISIT_END_DATE
          - locationName: TGT
            nodeName: S_NEXUS_CREATE_V
          - locationName: TGT
            nodeName: S_NEXUS_MODIF_V
        join:
          joinCondition: |-
            FROM ds_nexus_ops
              JOIN (
                    SELECT a.opnumber ,
                           IFNULL(a.proccode,b.proccode) proccode ,
                           IFNULL(a.procnumber,b.procnumber) procnumber
                      FROM (
                            SELECT *
                              FROM ds_nexus_opproc
                             WHERE proctype = 'A'
                           ) a
                      LEFT JOIN (
                            SELECT *
                              FROM ds_nexus_opproc
                             WHERE proctype <> 'A'
                           ) b
                        ON a.opnumber = b.opnumber
                       AND a.procnumber = b.procnumber
                   ) z
                ON ds_nexus_ops.opnumber = z.opnumber
              JOIN {{ ref('TGT','DIM_VISIT_START_DATE') }}
                ON cast(ds_nexus_OPS.opdate AS date) = dim_visit_start_date.visit_start_calendar_date
              JOIN {{ ref('TGT','DIM_VISIT_END_DATE') }}
                ON cast(ds_nexus_OPS.opdate AS date) = dim_visit_end_date.visit_end_calendar_date
              JOIN dim.[dim_patient]
                ON ds_nexus_ops.hospnumber = dim_patient.patient_NHI
               AND dim_patient.NHI_sequence = 1
              LEFT JOIN dim.dim_theatre_procedure
                ON CASE WHEN charindex('-',z.PROCCODE) = 0 THEN z.PROCCODE
                        ELSE SUBSTRING(z.PROCCODE,1,charindex('-',z.PROCCODE)-1)
                         END = dim_theatre_procedure.theatre_procedure_code
               AND dim_theatre_procedure.dss_current_flag = 'Y'
              JOIN {{ ref('TGT','S_NEXUS_CREATE_V') }}
                ON ds_nexus_OPS.opnumber = s_nexus_create_v.opnumber
              JOIN {{ ref('TGT','S_NEXUS_MODIF_V') }}
                ON ds_nexus_OPS.opnumber = s_nexus_modif_v.opnumber
        name: S_NEXUS_DIAGNOSTIC_PROCEDURES_10
        noLinkRefs: []
  name: S_NEXUS_DIAGNOSTIC_PROCEDURES_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
