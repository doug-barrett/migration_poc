fileVersion: 1
id: 94bd545f-efb2-49b0-ae84-d4fe3718383c
name: S_PJ_OP_EVENT
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Get all the outpatient information required from fact_outpatient_appointment."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05a68922-0cc7-4715-a14b-32411a449da3
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f66125c2-7f8b-47ed-879f-aaec6a8e937a
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 685650f3-0549-44c1-841c-b9d5c1402330
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: IP encounter unique identifier
        name: IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d9d094ba-d727-40fa-972a-8e4bb46999ee
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e6e1ff32-ad09-4726-ac8f-a05ab6aacd43
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: OP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 20eadec1-a258-4f9b-b277-a04a10f2e086
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6362e8c6-e941-4c15-928d-4d764d975433
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 257eea8c-1964-4516-b094-71a620a29983
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 09e09f73-fda8-4c93-90ca-5dd0567535de
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: WAITLIST_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3fea9cee-04ac-4ffa-a38b-62a1cf75b970
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: abdfdade-9b2a-4b74-81cd-baf853cd7f04
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: APPOINTMENT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4379c957-a7c4-4209-bfcf-1897aca41c6b
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a478d991-474f-44fd-8c7a-af0188243a3f
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: APPOINTMENT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 65109fb0-a894-493d-8749-612d7c72a89d
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 58f39896-a860-4d00-aac9-31f940c69f39
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: CHAR(1)
        defaultValue: ""
        description: appointment_status_type_code, "A=Actual", "P=Planned", "C=Cancelled"
        name: APPOINTMENT_STATUS_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5d726681-bcc2-41c1-ba98-0582e10b729d
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e34e801e-c7be-4ba1-949b-3bf5171cabe6
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ATTENDED_APPOINTMENT_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a97e4c01-731a-4c36-8021-c400ccdcf431
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e5bd0602-2f18-407b-9678-523dc1ff33c0
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: BIT
        defaultValue: ""
        description: Set to 1 if this is a follow up appointment (i.e. status type = P - Planned).
        name: FUP_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4379c957-a7c4-4209-bfcf-1897aca41c6b
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: |-
              CASE WHEN dim_purchase_unit.purchase_unit_code = 'S00002' THEN 0
                          ELSE 1
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6aa1d29-060e-42f1-a3df-f2843e2e8306
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers each FUP event for a journey by appointment start date.
        name: FUP_ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4379c957-a7c4-4209-bfcf-1897aca41c6b
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: |-
              CASE WHEN dim_purchase_unit.purchase_unit_code = 'S00002' THEN NULL
                          ELSE ROW_NUMBER() OVER(PARTITION BY ip_event_encounter_id, CASE WHEN dim_purchase_unit.purchase_unit_code = 'S00002' THEN 1 ELSE 0 END ORDER BY appointment_start_date)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: df7cb31f-a6b1-407a-894f-741a714cc753
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: NUMERIC(15,2)
        defaultValue: ""
        description: ""
        name: OP_ACTUAL_COST
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 606b6f29-3e0b-45fb-b81f-44745336da9a
                stepCounter: a8ac2a94-2c41-48b4-8b58-3f9f4a973334
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce86cc9d-db45-4e31-a4e7-4cfd68a68db2
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: MONEY
        defaultValue: ""
        description: Planned price x purchase unit volume
        name: OP_REVENUE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1e6d82e8-597d-4e09-bd26-905c599c9800
                stepCounter: 6bba0578-7ad6-41df-94c4-5d25f4782845
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1b2503df-e246-4098-91cc-e0a1f72280d0
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab7a8ee2-7413-4635-a87d-bfe9ceaa8498
                stepCounter: d198650d-0f77-489d-92ec-0c0257cd5a43
            transform: NULLIF(dim_purchase_unit.purchase_unit_code, 'Unknown')
      - appliedColumnTests: {}
        columnReference:
          columnCounter: da129fda-c03e-437b-8a6a-34e2019e0451
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: BIT
        defaultValue: ""
        description: Set to 1 if this is an FSA event
        name: FSA_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab7a8ee2-7413-4635-a87d-bfe9ceaa8498
                stepCounter: d198650d-0f77-489d-92ec-0c0257cd5a43
            transform: |-
              CASE WHEN dim_purchase_unit.purchase_unit_code = 'S00002' THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 580a240b-1725-4648-82fc-b4902de5f14c
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Unique business identifier for inpatient event.
        name: EVENT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 296d9698-586e-402a-b834-80fa2e5751bd
                stepCounter: ec00abea-1825-4ce7-9891-cf8f5b2f9379
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 434a0bde-01a5-4682-ab46-2f0c3fc29c92
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ADMISSION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 61d295bc-8396-46a6-b1ff-31d8290f3c25
                stepCounter: ec00abea-1825-4ce7-9891-cf8f5b2f9379
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 587273f7-ae10-43e6-88cd-d820cfed55b5
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: DISCHARGE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7026bcd6-e15b-4041-b7da-ab187db6c55f
                stepCounter: ec00abea-1825-4ce7-9891-cf8f5b2f9379
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6fe45100-8b3a-4377-9421-77a84461c305
          stepCounter: 94bd545f-efb2-49b0-ae84-d4fe3718383c
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: FACT_OUTPATIENT_APPOINTMENT
        join:
          joinCondition: |-
            FROM fact.fact_outpatient_appointment
              JOIN dim.dim_purchase_unit
                ON fact_outpatient_appointment.dim_purchase_unit_key = dim_purchase_unit.dim_purchase_unit_key
              JOIN fact.fact_inpatient_event
                ON fact_outpatient_appointment.ip_event_encounter_id = fact_inpatient_event.event_encounter_id
               AND fact_outpatient_appointment.appointment_start_date BETWEEN fact_inpatient_event.admission_date AND fact_inpatient_event.discharge_date
              LEFT OUTER JOIN s_PJ_revenue
                ON fact_outpatient_appointment.outpatient_appointment_encounter_id = s_PJ_revenue.source_encounter
             WHERE fact_outpatient_appointment.ip_event_encounter_id IS NOT NULL
               AND ((fact_outpatient_appointment.attended_appointment_count = 1 -- FUP attended  OR    fact_outpatient_appointment.appointment_status_type_code = 'P') -- FUP Planned  OR    dim_purchase_unit.purchase_unit_code = 'S00002') -- FSA
        name: S_PJ_OP_EVENT
        noLinkRefs: []
  name: S_PJ_OP_EVENT
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
