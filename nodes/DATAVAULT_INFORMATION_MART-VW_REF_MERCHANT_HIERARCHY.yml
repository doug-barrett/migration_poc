fileVersion: 1
id: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
name: VW_REF_MERCHANT_HIERARCHY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_INFORMATION_MART
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ddf950a4-4cec-4190-aff9-3cfaf12532fa
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ddf950a4-4cec-4190-aff9-3cfaf12532fa
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: adc0f43c-1af9-41e4-bcb6-fe3c2d0ec322
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: adc0f43c-1af9-41e4-bcb6-fe3c2d0ec322
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 35009523-165a-493e-bcc4-63b5df72a28d
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 35009523-165a-493e-bcc4-63b5df72a28d
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ab20748-6749-47e7-bab2-bab8bf73c991
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2ab20748-6749-47e7-bab2-bab8bf73c991
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b352b6b5-cf65-4868-89b7-5694c1b5dcae
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: CHAIN_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b352b6b5-cf65-4868-89b7-5694c1b5dcae
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5736e8da-e88f-42a6-a9a2-6b7d2a1794fc
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: CHAIN_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5736e8da-e88f-42a6-a9a2-6b7d2a1794fc
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 54008c3d-812d-4d56-9e21-c55a50d2cdc3
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: CHAIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 54008c3d-812d-4d56-9e21-c55a50d2cdc3
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 805e1d29-d848-4907-9e3a-9144395dea01
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: CHAIN_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 805e1d29-d848-4907-9e3a-9144395dea01
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 685df7cc-4f96-4cb3-8234-ca5402f3845e
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 685df7cc-4f96-4cb3-8234-ca5402f3845e
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 25ec99b6-5784-4870-acc8-3a6c8dba7aa6
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: MERCHANT_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 25ec99b6-5784-4870-acc8-3a6c8dba7aa6
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 23013ed5-9182-4070-8e7d-984e15a19d46
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: MERCHANT_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 23013ed5-9182-4070-8e7d-984e15a19d46
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 71b085f5-9958-4127-8c51-dcf817c285ac
          stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: MERCHANT_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 71b085f5-9958-4127-8c51-dcf817c285ac
                stepCounter: 913f0215-9c4c-4b3a-a843-9fb6f9c2c259
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_MERCHANT_MROC_CURRENT: f5496293-8162-40a6-9c8a-4b67605c4671
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(SUPERCHAIN_NK, SUPERCHAIN_TYPE_CODE, SUPERCHAIN_NAME, SUPERCHAIN_ACQUISITION_DATE, CHAIN_NK, CHAIN_TYPE_CODE, CHAIN_NAME, CHAIN_ACQUISITION_DATE, MERCHANT_NK, MERCHANT_TYPE_CODE, MERCHANT_NAME, MERCHANT_ACQUISITION_DATE) AS WITH merchant_all AS (
                    SELECT smr.MERCHANT_ID,
                           smr.MERCHANT_TYPE_CODE,
                           smr.MERCHANT_NAME,
                           MIN(TO_DATE(smsr.SAE_INL_DTE)) AS SAE_INL_DTE
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','S_MERCHANT_MROC_CURRENT') }} smr
                      LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','S_MERCHANT_STATE_MROC') }} smsr
                        ON smr.merchant_id = smsr.merchant_id
                     GROUP BY ALL
                   ) ,
                   S_CHAIN_HIERARCHY_MROC AS (
                    SELECT *
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','S_CHAIN_HIERARCHY_MROC_LATEST_RECORD') }}
                   ) ,
                   merchant_structure AS (
                    SELECT l1.merchant_id id_l1 ,
                           l1.MERCHANT_TYPE_CODE type_l1 ,
                           l1.MERCHANT_NAME name_l1 ,
                           l1.SAE_INL_DTE acquisition_l1 ,
                           l2.merchant_id id_l2 ,
                           l2.MERCHANT_TYPE_CODE type_l2 ,
                           l2.merchant_name name_l2 ,
                           l2.SAE_INL_DTE acquisition_l2 ,
                           l3.merchant_id id_l3 ,
                           l3.MERCHANT_TYPE_CODE type_l3 ,
                           l3.merchant_name name_l3 ,
                           l3.SAE_INL_DTE acquisition_l3
                      FROM S_CHAIN_HIERARCHY_MROC a
                      LEFT JOIN merchant_all l1
                        ON a.PARENT_LEVEL_NUMBER_1 = l1.merchant_id
                      LEFT JOIN merchant_all l2
                        ON a.PARENT_LEVEL_NUMBER_2 = l2.merchant_id
                      LEFT JOIN merchant_all l3
                        ON a.PARENT_LEVEL_NUMBER_3 = l3.merchant_id
                     GROUP BY ALL
                   ) SELECT CASE WHEN type_l1 like 'SC__' THEN id_l1
                        ELSE NULL
                         END AS superchain_NK,
                   CASE WHEN type_l1 like 'SC__' THEN type_l1
                        ELSE NULL
                         END AS superchain_type_code,
                   CASE WHEN type_l1 like 'SC__' THEN name_l1
                        ELSE NULL
                         END AS superchain_name,
                   CASE WHEN type_l1 like 'SC__' THEN acquisition_l1
                        ELSE NULL
                         END AS superchain_acquisition_date,
                   CASE WHEN type_l2 like 'CH__' THEN id_l2
                        WHEN type_l1 like 'CH__' THEN id_l1
                        ELSE NULL
                         END AS chain_NK,
                   CASE WHEN type_l2 like 'CH__' THEN type_l2
                        WHEN type_l1 like 'CH__' THEN type_l1
                        ELSE NULL
                         END AS chain_type_code,
                   CASE WHEN type_l2 like 'CH__' THEN name_l2
                        WHEN type_l1 like 'CH__' THEN name_l1
                        ELSE NULL
                         END AS chain_name,
                   CASE WHEN type_l2 like 'CH__' THEN acquisition_l2
                        WHEN type_l1 like 'CH__' THEN acquisition_l1
                        ELSE NULL
                         END AS chain_acquisition_date,
                   CASE WHEN type_l3 like 'MRCH' THEN id_l3
                        WHEN type_l2 like 'MRCH' THEN id_l2
                        ELSE NULL
                         END AS merchant_NK,
                   CASE WHEN type_l3 like 'MRCH' THEN type_l3
                        WHEN type_l2 like 'MRCH' THEN type_l2
                        ELSE NULL
                         END AS merchant_type_code,
                   CASE WHEN type_l3 like 'MRCH' THEN name_l3
                        WHEN type_l2 like 'MRCH' THEN name_l2
                        ELSE NULL
                         END AS merchant_name,
                   CASE WHEN type_l3 like 'MRCH' THEN acquisition_l3
                        WHEN type_l2 like 'MRCH' THEN acquisition_l2
                        ELSE NULL
                         END AS merchant_acquisition_date
              FROM merchant_structure
             WHERE merchant_nk IS NOT NULL
        dependencies:
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_CHAIN_HIERARCHY_MROC_LATEST_RECORD
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_MERCHANT_MROC_CURRENT
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_MERCHANT_STATE_MROC
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DATAVAULT_BUSINESS_VAULT','S_MERCHANT_MROC_CURRENT') }}
            {{ ref('DATAVAULT_RAW_VAULT','S_MERCHANT_STATE_MROC') }}
            {{ ref('DATAVAULT_BUSINESS_VAULT','S_CHAIN_HIERARCHY_MROC_LATEST_RECORD') }}
        name: VW_REF_MERCHANT_HIERARCHY
        noLinkRefs: []
  name: VW_REF_MERCHANT_HIERARCHY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
