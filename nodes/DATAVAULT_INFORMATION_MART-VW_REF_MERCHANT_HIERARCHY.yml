fileVersion: 1
id: c5193a17-bf94-4032-aff2-100a440b441f
name: VW_REF_MERCHANT_HIERARCHY
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_INFORMATION_MART
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67f51684-d436-412b-ac2f-9ee792ffdd37
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 67f51684-d436-412b-ac2f-9ee792ffdd37
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d4deaf81-3cf7-4fa5-ba16-1786567cf927
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d4deaf81-3cf7-4fa5-ba16-1786567cf927
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 063a2fc8-6cdb-429c-a0ad-7411f9afffd0
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 063a2fc8-6cdb-429c-a0ad-7411f9afffd0
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1ad657d9-72cf-42e7-bc89-5a07eda3c863
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: SUPERCHAIN_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ad657d9-72cf-42e7-bc89-5a07eda3c863
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b7ff07ca-adcf-408b-bc31-ac2158b7afb8
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: CHAIN_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b7ff07ca-adcf-408b-bc31-ac2158b7afb8
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 70db2cad-ee4c-4ba6-9e4f-00af52e293dd
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: CHAIN_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 70db2cad-ee4c-4ba6-9e4f-00af52e293dd
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3af9f5f8-2b83-4d58-95b1-0c23eae673a6
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: CHAIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3af9f5f8-2b83-4d58-95b1-0c23eae673a6
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d1aef15c-a46b-4b0d-8727-13ea5667913d
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: CHAIN_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d1aef15c-a46b-4b0d-8727-13ea5667913d
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 34de4fd3-d044-4cf3-8487-7a048a95d33c
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: NUMBER(38)
        defaultValue: ""
        description: ""
        name: MERCHANT_NK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 34de4fd3-d044-4cf3-8487-7a048a95d33c
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 044b87d0-bcf8-4909-b0c5-fa8ba6752059
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: MERCHANT_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 044b87d0-bcf8-4909-b0c5-fa8ba6752059
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fb0cf40a-622d-4f5a-bf6f-eba90be9312b
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: MERCHANT_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fb0cf40a-622d-4f5a-bf6f-eba90be9312b
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2e3516b3-2d53-4281-8a8a-748e36b19adb
          stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: MERCHANT_ACQUISITION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e3516b3-2d53-4281-8a8a-748e36b19adb
                stepCounter: c5193a17-bf94-4032-aff2-100a440b441f
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_MERCHANT_MROC_CURRENT: 69d815ad-59f8-422a-8238-0364d4f078b7
          S_MERCHANT_STATE_MROC: d765bf06-b0af-4079-a088-01792fbeb79f
          S_CHAIN_HIERARCHY_MROC_LATEST_RECORD: b3e19e2e-bb1d-4ef4-9ac1-1b7b6b666860
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(SUPERCHAIN_NK, SUPERCHAIN_TYPE_CODE, SUPERCHAIN_NAME, SUPERCHAIN_ACQUISITION_DATE, CHAIN_NK, CHAIN_TYPE_CODE, CHAIN_NAME, CHAIN_ACQUISITION_DATE, MERCHANT_NK, MERCHANT_TYPE_CODE, MERCHANT_NAME, MERCHANT_ACQUISITION_DATE) AS WITH merchant_all AS (
                    SELECT smr.MERCHANT_ID,
                           smr.MERCHANT_TYPE_CODE,
                           smr.MERCHANT_NAME,
                           MIN(TO_DATE(smsr.SAE_INL_DTE)) AS SAE_INL_DTE
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','S_MERCHANT_MROC_CURRENT') }} smr
                      LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','S_MERCHANT_STATE_MROC') }} smsr
                        ON smr.merchant_id = smsr.merchant_id
                     GROUP BY ALL
                   ) ,
                   S_CHAIN_HIERARCHY_MROC AS (
                    SELECT *
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','S_CHAIN_HIERARCHY_MROC_LATEST_RECORD') }}
                   ) ,
                   merchant_structure AS (
                    SELECT l1.merchant_id id_l1 ,
                           l1.MERCHANT_TYPE_CODE type_l1 ,
                           l1.MERCHANT_NAME name_l1 ,
                           l1.SAE_INL_DTE acquisition_l1 ,
                           l2.merchant_id id_l2 ,
                           l2.MERCHANT_TYPE_CODE type_l2 ,
                           l2.merchant_name name_l2 ,
                           l2.SAE_INL_DTE acquisition_l2 ,
                           l3.merchant_id id_l3 ,
                           l3.MERCHANT_TYPE_CODE type_l3 ,
                           l3.merchant_name name_l3 ,
                           l3.SAE_INL_DTE acquisition_l3
                      FROM S_CHAIN_HIERARCHY_MROC a
                      LEFT JOIN merchant_all l1
                        ON a.PARENT_LEVEL_NUMBER_1 = l1.merchant_id
                      LEFT JOIN merchant_all l2
                        ON a.PARENT_LEVEL_NUMBER_2 = l2.merchant_id
                      LEFT JOIN merchant_all l3
                        ON a.PARENT_LEVEL_NUMBER_3 = l3.merchant_id
                     GROUP BY ALL
                   ) SELECT CASE WHEN type_l1 like 'SC__' THEN id_l1
                        ELSE NULL
                         END AS superchain_NK,
                   CASE WHEN type_l1 like 'SC__' THEN type_l1
                        ELSE NULL
                         END AS superchain_type_code,
                   CASE WHEN type_l1 like 'SC__' THEN name_l1
                        ELSE NULL
                         END AS superchain_name,
                   CASE WHEN type_l1 like 'SC__' THEN acquisition_l1
                        ELSE NULL
                         END AS superchain_acquisition_date,
                   CASE WHEN type_l2 like 'CH__' THEN id_l2
                        WHEN type_l1 like 'CH__' THEN id_l1
                        ELSE NULL
                         END AS chain_NK,
                   CASE WHEN type_l2 like 'CH__' THEN type_l2
                        WHEN type_l1 like 'CH__' THEN type_l1
                        ELSE NULL
                         END AS chain_type_code,
                   CASE WHEN type_l2 like 'CH__' THEN name_l2
                        WHEN type_l1 like 'CH__' THEN name_l1
                        ELSE NULL
                         END AS chain_name,
                   CASE WHEN type_l2 like 'CH__' THEN acquisition_l2
                        WHEN type_l1 like 'CH__' THEN acquisition_l1
                        ELSE NULL
                         END AS chain_acquisition_date,
                   CASE WHEN type_l3 like 'MRCH' THEN id_l3
                        WHEN type_l2 like 'MRCH' THEN id_l2
                        ELSE NULL
                         END AS merchant_NK,
                   CASE WHEN type_l3 like 'MRCH' THEN type_l3
                        WHEN type_l2 like 'MRCH' THEN type_l2
                        ELSE NULL
                         END AS merchant_type_code,
                   CASE WHEN type_l3 like 'MRCH' THEN name_l3
                        WHEN type_l2 like 'MRCH' THEN name_l2
                        ELSE NULL
                         END AS merchant_name,
                   CASE WHEN type_l3 like 'MRCH' THEN acquisition_l3
                        WHEN type_l2 like 'MRCH' THEN acquisition_l2
                        ELSE NULL
                         END AS merchant_acquisition_date
              FROM merchant_structure
             WHERE merchant_nk IS NOT NULL
        dependencies:
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: VW_REF_MERCHANT_HIERARCHY
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_MERCHANT_MROC_CURRENT
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_MERCHANT_STATE_MROC
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_CHAIN_HIERARCHY_MROC_LATEST_RECORD
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DATAVAULT_INFORMATION_MART','VW_REF_MERCHANT_HIERARCHY') }}
            {{ ref('DATAVAULT_BUSINESS_VAULT','S_MERCHANT_MROC_CURRENT') }}
            {{ ref('DATAVAULT_RAW_VAULT','S_MERCHANT_STATE_MROC') }}
            {{ ref('DATAVAULT_BUSINESS_VAULT','S_CHAIN_HIERARCHY_MROC_LATEST_RECORD') }}
        name: VW_REF_MERCHANT_HIERARCHY
        noLinkRefs: []
  name: VW_REF_MERCHANT_HIERARCHY
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
