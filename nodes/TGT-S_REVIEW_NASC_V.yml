fileVersion: 1
id: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
name: S_REVIEW_NASC_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1442a1e0-e301-4e09-b78a-dfb020b1aa7d
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CONTACT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f4640f58-9188-46b6-96f2-0d58edd6e6bf
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ad789b0-1af1-49e5-b06b-e698b88f786b
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 58c1599f-1468-4e15-b032-9f18c890bb63
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9bc6297d-00ed-48bb-952b-24c3544e139e
                stepCounter: 289da868-88f5-4e61-a975-de3b30517956
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c88eceb-4f7b-4285-8503-63af94b4d871
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: patient_programme_id
        name: PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1dc01ac2-a10c-49ca-90eb-ed32df22cd74
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d4ec40ec-4c1b-4aeb-af2a-f0af9bb7ad45
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: patient_programme_status
        name: PROGRAMME_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 68ae7343-6636-410f-8f54-d96cc55f2e09
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a9f407e8-395e-4d29-b151-ba59b89c78c3
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TASK_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e5353c2d-4a44-4e11-bc07-37f02a977a35
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: abda0ae9-a86f-4dfb-88c4-f15681d11596
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: HEALTH_ORG_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c12f6696-6dfb-413d-a9e0-108fd7fdb031
                stepCounter: 05ed0e9e-67ad-49bf-b299-f8f341d6b3c4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47865d7a-5e29-457a-8a61-d350856055e0
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: SEEN_BY_CLINICIAN_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2b8f3a79-f117-4171-adef-1c933c0a05b5
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d2beea79-7da8-416b-b728-3ecb1657f1e9
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9668f55c-c7a5-4a58-a248-a09453e77eaa
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 544b5fe1-41b0-42de-be0f-4dde43a490b1
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: HOSPITAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 980489a9-a2f2-4899-b808-e20222682081
                stepCounter: 0790fdf4-e815-4587-a9cd-954ea13f53c6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: efe9dec8-6de9-422d-8c38-ef9b04c03194
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PROVIDER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b64f71a4-6818-4fe2-8f71-79ea2097bd8d
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 86f2c479-422d-444c-9800-4f6df94a6d35
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PROVIDER_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e54c5b96-c200-4dd7-85cc-9dc969de2264
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2c58d398-4221-44d9-923f-2cd69828d6e9
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PROGRAMME_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c8c2984d-cd99-4fba-a43e-3c04e85bc21d
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: DEPARTMENT_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a1934670-ab32-4f87-8596-72e67f41da50
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SERVICE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1236585e-4250-4ea9-a856-a97b8e4ac3d9
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5de1023-9916-4569-ad46-d203d6bd8b59
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 06b02da6-ac3d-4ef1-931e-d941aec37d85
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EPISODE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a61b1e4e-250d-4353-8a0b-699237cac645
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c3980855-c180-41f7-898b-db019ce86ede
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REVIEW_OUTCOME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c145ad2c-6c01-405d-a9d6-dfdb88937dab
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REVIEW_REASON
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b49fa610-fce3-4f71-8dcd-59fd329fb8c2
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: NEXT_REVIEW_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 053738bf-0cb6-4160-8325-6f7b2bcbab7d
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: NEXT_REVIEW_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0b63cd5e-058a-4693-ab31-3a8dad87cc3b
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PREVIOUS_REVIEW_COMMENT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b1526cb0-6121-4b8b-9a5a-18a32a2c542d
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: EXIT_REASON
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b3cd56cc-db46-46b0-8b73-c0b254681012
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EXIT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31734fb1-8c9f-4637-b820-68031b11b427
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: TRANSFER_OUT_RESIDENTIAL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d569f69-45e0-44d2-8b98-5daac90a9ce8
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: TRANSFER_OUT_DHB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 28dd0e5e-c591-4a4a-a8e4-1a573e6931ba
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_DUE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 00375d4d-ac65-428c-a6ed-107ee136ee44
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a76b589f-f76a-47ea-885c-6501911a046e
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e062b704-8bee-4ebf-9f39-44e0732669e2
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 609ccb4a-4deb-40c6-9ec7-96a131ee7891
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0f2e33ef-8ae5-4e28-9dbc-6e3089022f15
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d99e8260-6e85-4a87-8604-47354120d947
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CREATE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e11a0bad-b228-417a-b977-da23dcd925b4
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8d1d7de3-05d5-4f52-8216-0ccd422bd62f
          stepCounter: b9d7bd59-91f1-456a-bf25-bbf6f9eefb11
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CREATE_USER_LOGIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 005077ef-2f46-49d9-8c15-62f319935a6e
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'NA'+SUBSTRING(CONVERT(varchar,10000000000+tr.taskrequest_id),2,10) contact_encounter_id,
                   tr.taskrequest_id task_request_id,
                   pt.NHI_number,
                   pp.patient_programme_id programme_id,
                   MAX(pp.patient_programme_status) programme_status,
                   LEFT(MAX(tt.display_name),30) task_desc,
                   MAX(cl.external_clinic_id) health_org_id,
                   MAX(ob.provider_nzmc) seen_by_clinician_id,
                   MAX(CASE WHEN LEFT (tr.stream_id,1) = '1' THEN 'R' + tr.stream_id ELSE tr.stream_id END) referral_encounter_id,
                   MAX(CASE WHEN og.health_org_desc LIKE '%West%' THEN '3216' ELSE '3215' END) hospital_id,
                   MAX(pr.provider_id) provider_id,
                   MAX(pr.provider_role_code) provider_role_code,
                   LEFT(MAX(rl.name),50) programme_role_code,
                   LEFT(MAX(dp.name),50) department_desc,
                   LEFT(MAX(sv.name),50) service_desc,
                   MAX(tr.request_date) task_request_date,
                   MAX(pp.episode_start_date) episode_start_date,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 4455515314692 THEN ov.value ELSE NULL END),50) review_outcome,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 4497268370100 THEN ov.value ELSE NULL END),50) review_reason,
                   MAX(CASE WHEN ov.datatype_id = 4462680096716 THEN ov.value ELSE NULL END) next_review_date,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 4568844972108 THEN ov.value ELSE NULL END),50) next_review_type,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 4698393948064 THEN ov.value ELSE NULL END),50) previous_review_comment,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 4497265089308 THEN ov.value ELSE NULL END),50) exit_reason,
                   MAX(CASE WHEN ov.datatype_id = 4692589947576 THEN try_CONVERT(datetime,ov.value,103) ELSE NULL END) exit_date,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 5028509917560 THEN ov.value ELSE NULL END),50) transfer_out_residential,
                   LEFT(MAX(CASE WHEN ov.datatype_id = 5028510230360 THEN ov.value ELSE NULL END),50) transfer_out_DHB,
                   MAX(IFNULL(ob.due_date,tr.due_date)) observation_report_due_date,
                   MAX(ob.date_completed) observation_report_completion_date,
                   MAX(CASE WHEN ob.observation_report_status ='A' THEN 'Finalised' WHEN ob.observation_report_status ='F' THEN 'Completed' WHEN ob.observation_report_status ='S' THEN 'In Progress' WHEN ob.observation_report_status ='X' THEN 'Declined' ELSE 'Current' END) observation_report_status,
                   MAX(ob.created_date) create_date,
                   REPLACE(MAX(ob.created_by),' null','') create_user_login_name
              FROM ds_cdsswe_task_request tr
             INNER JOIN l_cdsswe_Task_Type tt
                ON tr.tasktype_id = tt.tasktype_id
               AND tt.name = 'Review'
             INNER JOIN ds_cdsswe_patient_programme pp
                ON tr.patient_programme_id = pp.patient_programme_id
             INNER JOIN l_cdsswe_programme rl
                ON rl.programme_id = pp.programme_id --AND rl.programme_id = 4452666405396  --'Needs Assessors in NASC'

             INNER JOIN l_cdsswe_patient pt
                ON pp.patient_id = pt.patient_id
             INNER JOIN ds_cdsswe_observation_report ob
                ON tr.taskrequest_id = ob.taskrequest_id
               AND ob.record_status = 'A'
               AND ob.observation_report_status IN ('A','F','X','S')
              LEFT OUTER JOIN ds_cdsswe_atomic_observation ov
                ON ov.observation_report_id = ob.observation_report_id
              LEFT OUTER JOIN l_cdsswe_Patient_Programme_Provider pr
                ON pr.patient_programme_id = pp.patient_programme_id
               AND pr.record_status = 'A'
               AND pr.sequence_num = '1'
              LEFT OUTER JOIN l_cdsswe_clinic cl
                ON pr.clinic_id = cl.clinic_id
               AND cl.record_status = 'A'
               AND cl.clinic_type = 'CASETEAM'
              LEFT OUTER JOIN dim.dim_health_organisation og
                ON cl.external_clinic_id = og.health_org_reference_no
              LEFT OUTER JOIN l_cdsswe_programme dp
                ON dp.programme_id = rl.parent_programme_id
              LEFT OUTER JOIN l_cdsswe_programme sv
                ON sv.programme_id = dp.parent_programme_id
             GROUP BY tr.taskrequest_id,
                      pt.NHI_number,
                      pp.patient_programme_id
        dependencies:
          - locationName: TGT
            nodeName: DS_CDSSWE_TASK_REQUEST
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','DS_CDSSWE_TASK_REQUEST') }}
        name: S_REVIEW_NASC_V
        noLinkRefs: []
  name: S_REVIEW_NASC_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
