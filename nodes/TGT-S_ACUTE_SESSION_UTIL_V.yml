fileVersion: 1
id: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
name: S_ACUTE_SESSION_UTIL_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2cfe82c9-e21a-49b6-8394-b7c19f7eb65d
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: THEATRE_SESSION_REFERENCE_NO
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: db6380ec-1104-41e3-86ee-97b6c107bae2
                stepCounter: 7e9faaf5-2f15-45fb-a3ff-4802dd381bdd
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 812d0122-06b8-424f-b221-c890a4ee6acb
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_InHours
        name: UTILISATION_ACUTE_INHOURS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a99aec16-293f-4c16-be18-ae1f97cfeed9
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_LateSession
        name: UTILISATION_ACUTE_LATESESSION
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8f8098db-520a-46de-bac0-112fc990dab7
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_AfterHours
        name: UTILISATION_ACUTE_AFTERHOURS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 84ebecc7-cd71-4cba-bc93-0e996f51bd66
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteInHoursOps
        name: ACUTEINHOURSOPS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 02e37048-b100-41e2-b600-5181d3593c63
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteLateSessionOps
        name: ACUTELATESESSIONOPS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 251e3012-0e37-4fc4-9010-75602e4ead6f
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteAfterHoursOps
        name: ACUTEAFTERHOURSOPS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e9d8793-a104-47a0-8b21-f48b9a0930eb
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteSessions_InHrs
        name: ACUTESESSIONS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0351b6d8-1de6-493b-9f03-e706541510b9
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteSessions_LateSession
        name: ACUTESESSIONS_LATESESSION
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a1217e4-4e0a-4e5b-9d7e-030f855a0672
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: AcuteSessions_AfterHours
        name: ACUTESESSIONS_AFTERHOURS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: df5e3aac-ed8e-4f3a-b468-7fce46e22c65
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Total_TurnAroundMins_InHrs
        name: TOTAL_TURNAROUNDMINS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a106891d-c9f8-49c2-9103-aae905c98d09
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: TurnAroundOver30Mins_InHrs
        name: TURNAROUNDOVER30MINS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67d7a2ba-1454-4de7-93be-024d89aa137b
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: TurnAroundOver60Mins_InHrs
        name: TURNAROUNDOVER60MINS_INHRS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d345c140-033e-4fb4-9d7e-eb314a2a90e2
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_InHours_numerator
        name: UTILISATION_ACUTE_INHOURS_NUMERATOR
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 81fb3ead-1a3f-4bb6-afdf-b02f74f48a02
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_InHours_denominator
        name: UTILISATION_ACUTE_INHOURS_DENOMINATOR
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 86afac90-e371-4db4-bfe3-7cc098e37368
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_InHours_numerator_IncWeekends
        name: UTILISATION_ACUTE_INHOURS_NUMERATOR_INCWEEKENDS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a70822ff-e58f-48cd-804b-bc33e99c3f97
          stepCounter: 8dce8a15-428b-4b82-8db0-1e21a7d24cbe
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Utilisation_Acute_InHours_denominator_IncWeekends
        name: UTILISATION_ACUTE_INHOURS_DENOMINATOR_INCWEEKENDS
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(theatre_session_reference_no, Utilisation_Acute_InHours, Utilisation_Acute_LateSession, Utilisation_Acute_AfterHours, AcuteInHoursOps, AcuteLateSessionOps, AcuteAfterHoursOps, AcuteSessions_InHrs, AcuteSessions_LateSession, AcuteSessions_AfterHours, Total_TurnAroundMins_InHrs, TurnAroundOver30Mins_InHrs, TurnAroundOver60Mins_InHrs, Utilisation_Acute_InHours_numerator, Utilisation_Acute_InHours_denominator, Utilisation_Acute_InHours_numerator_IncWeekends, Utilisation_Acute_InHours_denominator_IncWeekends) AS SELECT b.theatre_session_reference_no,
                   CASE WHEN datediff(MINUTE,MIN(CASE WHEN d.InHoursFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursFlag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN b.session_duration <540 THEN Session_duration ELSE 540 END) > 100 THEN 100
                        ELSE datediff(MINUTE,MIN(CASE WHEN d.InHoursFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursFlag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN b.session_duration <540 THEN Session_duration ELSE 540 END)
                         END AS Utilisation_Acute_InHours,
                   CASE WHEN datediff(MINUTE,MIN(CASE WHEN d.LateSessionflag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.LateSessionflag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(300) > 100 THEN 100
                        ELSE datediff(MINUTE,MIN(CASE WHEN d.LateSessionflag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.LateSessionflag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(300)
                         END AS Utilisation_Acute_LateSession,
                   CASE WHEN datediff(MINUTE,MIN(CASE WHEN d.Afterhoursflag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.Afterhoursflag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN DATEPART(weekday,a.into_theatre_date) IN (1,7) THEN 1440.00 ELSE 600.00 END) > 100 THEN 100
                        ELSE datediff(MINUTE,MIN(CASE WHEN d.Afterhoursflag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.Afterhoursflag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN DATEPART(weekday,a.into_theatre_date) IN (1,7) THEN 1440.00 ELSE 600.00 END)
                         END AS Utilisation_Acute_AfterHours,
                   sum(CASE WHEN d.inhoursflag = 'Y' THEN 1 ELSE 0 END) AcuteInHoursOps,
                   sum(CASE WHEN d.LateSessionflag = 'Y' THEN 1 ELSE 0 END) AcuteLateSessionOps,
                   sum(CASE WHEN d.Afterhoursflag = 'Y' THEN 1 ELSE 0 END) AcuteAfterHoursOps,
                   CASE WHEN sum(CASE WHEN d.inhoursflag = 'Y' THEN 1 ELSE 0 END) > 0 THEN 1
                        ELSE 0
                         END AcuteSessions_InHrs,
                   CASE WHEN sum(CASE WHEN d.LateSessionflag = 'Y' THEN 1 ELSE 0 END) > 0 THEN 1
                        ELSE 0
                         END AcuteSessions_LateSession,
                   CASE WHEN sum(CASE WHEN d.Afterhoursflag = 'Y' THEN 1 ELSE 0 END) > 0 THEN 1
                        ELSE 0
                         END AcuteSessions_AfterHours,
                   SUM(CASE WHEN NOT(c.Into_Theatre_Date IS NULL) AND DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date)<0 THEN 0 ELSE CASE WHEN d.InHoursFlag = 'Y' AND e.InHoursFlag = 'Y' THEN DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date) ELSE 0 END END) Total_TurnAroundMins_InHrs,
                   SUM(CASE WHEN NOT(c.Into_Theatre_Date IS NULL) AND DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date)<0 THEN 0 ELSE CASE WHEN d.InHoursFlag = 'Y' AND e.InHoursFlag = 'Y' THEN CASE WHEN DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date)>30 THEN 1 ELSE 0 END ELSE 0 END END) TurnAroundOver30Mins_InHrs,
                   SUM(CASE WHEN NOT(c.Into_Theatre_Date IS NULL) AND DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date)<0 THEN 0 ELSE CASE WHEN d.InHoursFlag = 'Y' AND e.InHoursFlag = 'Y' THEN CASE WHEN DATEDIFF(MINUTE, a.out_of_theatre_date,c.Into_Theatre_Date)>60 THEN 1 ELSE 0 END ELSE 0 END END) TurnAroundOver60Mins_InHrs,
                   CASE WHEN datediff(MINUTE,MIN(CASE WHEN d.InHoursFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursFlag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN b.session_duration <540 THEN Session_duration ELSE 540 END) > 100 THEN avg(CASE WHEN b.session_duration <540 THEN Session_duration ELSE 540 END)
                        ELSE datediff(MINUTE,MIN(CASE WHEN d.InHoursFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursFlag = 'Y' THEN a.out_of_theatre_date END))
                         END Utilisation_Acute_InHours_numerator,
                   avg(CASE WHEN b.session_duration <540 THEN Session_duration ELSE 540 END) Utilisation_Acute_InHours_denominator,
                   CASE WHEN datediff(MINUTE,MIN(CASE WHEN d.InHoursWDFlag = 'Y' OR d.InHoursWEFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursWDFlag = 'Y' OR d.InHoursWEFlag = 'Y' THEN a.out_of_theatre_date END))*100/ avg(CASE WHEN session_duration <540 THEN Session_duration ELSE 540 END) > 100 THEN avg(CASE WHEN session_duration <540 THEN Session_duration ELSE 540 END)
                        ELSE datediff(MINUTE,MIN(CASE WHEN d.InHoursWDFlag = 'Y' OR d.InHoursWEFlag = 'Y' THEN a.ready_date END), MAX(CASE WHEN d.InHoursWDFlag = 'Y' OR d.InHoursWEFlag = 'Y' THEN a.out_of_theatre_date END))
                         END AS Utilisation_Acute_InHours_numerator_IncWeekends,
                   avg(CASE WHEN session_duration <540 THEN Session_duration ELSE 540 END) Utilisation_Acute_InHours_denominator_IncWeekends
              FROM ds_consolidate_theatre a
              JOIN fact.fact_theatre_session b
                ON a.theatre_session_reference_no = b.theatre_session_reference_no
              LEFT JOIN ds_consolidate_theatre c
                ON a.session_next_theatre_visit_encounter_ID = c.theatre_visit_encounter_id
              LEFT JOIN s_acute_theatre_flags_v d
                ON a.theatre_visit_encounter_id = d.theatre_visit_encounter_id
              LEFT JOIN s_acute_theatre_flags_v e
                ON c.theatre_visit_encounter_id = e.theatre_visit_encounter_id
             WHERE a.schedule_status_code = 'A'
               AND b.session_status_code = 'A'
               AND b.session_acute_flag = 'Y'
               AND b.actual_operations_num > 0
             GROUP BY b.theatre_session_reference_no
        dependencies:
          - locationName: TGT
            nodeName: S_CONSOLIDATE_TH_SESSION
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_CONSOLIDATE_TH_SESSION') }}
        name: S_ACUTE_SESSION_UTIL_V
        noLinkRefs: []
  name: S_ACUTE_SESSION_UTIL_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
