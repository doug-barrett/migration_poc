fileVersion: 1
id: 4edb69a1-0666-49d3-98df-b3a33e906231
name: S_ED_STAY_PREV_NEXT_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "View of s_ed_stay_10 providing details of previous and next stays for s_ed_stay_20  /***********************************************  This view is using parameters and should not be materialised  ************************************************/"
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: def34779-f8b1-4c9f-b0bc-04b96ea0fff1
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8e08a28e-93fc-4605-85e2-0b787c491aed
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ddf93e1b-732f-4912-a4f2-97d26c9af669
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: STAY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 06ce1a48-1e70-4022-91dc-a5498f1fd73e
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 80781b01-0b6c-4ea2-9f31-653db2cbe745
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 74154559-ef81-4ff2-a709-d39e560b1f6d
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c7721f11-dc9c-496f-9636-7ce59845acbc
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47920dbb-7ae6-4261-b2ca-90e226ac1192
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ORIG_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bdc3e44d-d192-4ed6-9795-72da2b00992d
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ORIG_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2512096b-8628-4cb9-976c-9aa629342d72
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: arrived_date
        name: ARRIVED_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 02eb4fe2-4949-45a6-86c1-4de3140e4edb
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c09dadb9-9c15-4330-af4b-65858023f970
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: DEPARTED_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 51367620-44f1-4bf8-a7fc-6c0899ca03c5
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8201799f-4498-4aaf-83b3-bb667ca0d039
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: LOCATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ca8d71f4-865e-45f6-9768-f9c48ae9e76f
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d24849b-e23e-4588-8d81-4972ef099394
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CLINICIAN
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a3925589-33a6-4b42-82d0-7f3098aab469
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 925d2372-43de-44d0-bd4d-8ea75cd65948
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SPECIALTY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 99b3ffe5-93d9-4d27-8c6e-2e1248abbee1
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55e67974-3af5-4f8e-b262-fa1aa00648f7
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ROW_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6aa02f9b-4d1a-465d-9e60-d34435da3b62
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bf0a2ad1-7d79-4486-9634-e392af4f1c5f
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2d3c2bf5-eebb-4404-b1b2-2f99214f2824
                stepCounter: 19f97281-8cc4-4660-83be-6049689bc9c9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67275da0-0062-4634-9fa9-5aeced6a1584
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: NUMERIC(10)
        defaultValue: ""
        description: ""
        name: PREV_STAY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 022eb1f0-185f-4bf6-ba69-a9271cd30ad0
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: PREV_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c8d493eb-9867-46cd-b320-0bb394e40451
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: PREV_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0d2c718f-d53b-4732-836e-8d8af1cb0756
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: PREV_SPECT_XFER_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5f53da6a-c0c4-4d6a-8df0-59cf9337cfbe
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PREV_SERVICE_POINT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 36b5276c-bccc-416c-93c2-4d4f6f6524c9
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PREV_SERVICE_POINT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e1ecb5cc-ed85-4eb8-854e-860ccb1a2b5d
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PREV_HEALTHCARE_PROFESSIONAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01d70af6-b76e-474a-a9af-b91769e671db
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PREV_HEALTHCARE_PROFESSIONAL_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c9520bc-3cec-4360-8b4c-7506e3defc2b
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PREV_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa96c672-a599-418f-a5ff-7ad376ea49d9
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PREV_SPECIALTY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01bca069-ca40-418b-9cb6-cbf8e9ac4172
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: NEXT_STAY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4ca64a70-b3f0-4440-86f9-7c296c2f2e7d
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: NEXT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a903e4cd-e0c6-4536-8ed9-c558e0b8caf4
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: NEXT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 382b1056-8152-4c7a-9a58-dbbdd2a60e86
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: NEXT_SPECT_XFER_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f42740a-6cfd-405a-96dc-24f5c0acd77c
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: NEXT_SERVICE_POINT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47fb606b-9163-41c2-8001-6a9d390dfc25
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: NEXT_SERVICE_POINT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 63fb4262-c614-4f35-919d-fe7cdcd5c2bc
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: NEXT_HEALTHCARE_PROFESSIONAL_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3b2acbfd-98a0-48cd-b69f-f69871dda91e
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: NEXT_HEALTHCARE_PROFESSIONAL_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: af9f8ab6-130a-4b82-af64-d65d1132a455
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: NEXT_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e8b744f9-91c6-419f-88a1-6d272a9aa315
          stepCounter: 4edb69a1-0666-49d3-98df-b3a33e906231
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: NEXT_SPECIALTY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT s.encounter,
                   s.aesty_refno stay_reference_no,
                   COALESCE(prev_stay.end_date, s.arrived_date) start_date,
                   CASE WHEN p.row_num = s.row_count THEN CASE WHEN s.departed_date < prev_stay.end_date THEN prev_stay.end_date ELSE s.departed_date END
                        ELSE CASE WHEN s.end_date > s.departed_date THEN s.departed_date WHEN s.location <> next_stay.location THEN COALESCE(s.end_date, prev_stay.end_date) WHEN COALESCE(prev_stay.end_date, s.arrived_date) < s.end_date THEN COALESCE(s.end_date, prev_stay.end_date) WHEN next_stay.spect_xfer_date IS NOT NULL AND next_stay.spect_xfer_date < s.departed_date THEN next_stay.spect_xfer_date ELSE prev_stay.end_date END
                         END end_date,
                   s.start_date orig_start_date,
                   s.end_date orig_end_date,
                   s.arrived_date,
                   s.departed_date,
                   s.location,
                   s.clinician,
                   s.specialty,
                   s.row_count,
                   s.row_num,
                   prev_stay.aesty_refno prev_stay_reference_no,
                   CASE WHEN p.row_num = 1 THEN NULL
                        ELSE COALESCE(prev_stay.start_date, prev_stay.arrived_date)
                         END prev_start_date,
                   CASE WHEN p.row_num = 1 THEN NULL
                        ELSE CASE WHEN prev_stay.end_date > s.start_date THEN prev_stay.end_date ELSE s.start_date END
                         END prev_end_date,
                   prev_stay.spect_xfer_date prev_spect_xfer_date,
                   prev_stay.location prev_service_point_code,
                   prev_stay.service_point_reference_no prev_service_point_reference_no,
                   prev_stay.clinician prev_healthcare_professional_code,
                   prev_stay.healthcare_professional_reference_no prev_healthcare_professional_reference_no,
                   prev_stay.specialty prev_specialty_code,
                   prev_stay.specialty_reference_no prev_specialty_reference_no,
                   next_stay.aesty_refno next_stay_reference_no,
                   CASE WHEN p.row_num = s.row_count THEN NULL
                        ELSE CASE WHEN next_stay.start_date > s.end_date THEN next_stay.start_date ELSE s.end_date END
                         END next_start_date,
                   CASE WHEN p.row_num = s.row_count THEN NULL
                        ELSE CASE WHEN next_stay.end_date > s.departed_date THEN s.departed_date ELSE next_stay.end_date END
                         END next_end_date,
                   next_stay.spect_xfer_date next_spect_xfer_date,
                   next_stay.location next_service_point_code,
                   next_stay.service_point_reference_no next_service_point_reference_no,
                   next_stay.clinician next_healthcare_professional_code,
                   next_stay.healthcare_professional_reference_no next_healthcare_professional_reference_no,
                   next_stay.specialty next_specialty_code,
                   next_stay.specialty_reference_no next_specialty_reference_no
              FROM s_ed_stay_10 s
             CROSS JOIN (
                    SELECT CONVERT(tinyint, dss_parameter_value) row_num
                      FROM dss_parameter
                     WHERE dss_parameter_name = 'location_stay_row_num'
                   ) p
              LEFT OUTER JOIN s_ed_stay_20 prev_stay
                ON prev_stay.encounter = s.encounter
               AND prev_stay.row_num = p.row_num - 1
              LEFT OUTER JOIN s_ed_stay_10 next_stay
                ON next_stay.encounter = s.encounter
               AND next_stay.row_num = p.row_num + 1
             WHERE s.sort_ref IS NULL -- i.e. encounter not yet successfully processed

               AND s.row_num = p.row_num
        dependencies:
          - locationName: TGT
            nodeName: S_ED_STAY_10
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_ED_STAY_10') }}
        name: S_ED_STAY_PREV_NEXT_V
        noLinkRefs: []
  name: S_ED_STAY_PREV_NEXT_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
