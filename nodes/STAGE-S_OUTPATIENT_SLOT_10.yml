fileVersion: 1
id: 78162b60-7087-4372-abbd-d6cb06ade5b1
name: S_OUTPATIENT_SLOT_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: false
  description: "Get the number of bookings allowed for each visit code in each time slot. There will be one row for each time slot, visit code combination."
  isMultisource: false
  locationName: STAGE
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ec902f67-1d57-4eb6-a7b0-a2611833aeb3
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier for the outpatient session.
        name: OUTPATIENT_SESSION_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59680a34-7369-40f7-967e-820ea5e0b8c3
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier of the outpatient clinic.
        name: OUTPATIENT_CLINIC_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51047391-f6d5-4467-b2d4-819240a08a28
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier for the slot within an outpatient session.
        isBusinessKey: true
        name: OUTPATIENT_SLOT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ccacd003-a411-4f29-b036-5ac14c38c06c
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Start date and time of the session slot.
        name: SLOT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5cdab7f9-ea8d-41be-82cc-8c1177092e6d
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: End date and time of the session slot.
        name: SLOT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 802125ca-657c-4c93-983c-68a759051e22
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Duration of a session slot in minutes.
        name: SLOT_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ec0e52f6-c154-481a-852c-e5008f803b41
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: ""
        name: SLOT_CANCELLED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN ds_pims_service_point_time_slots.cancel_dttm IS NULL THEN 0
                          ELSE 1
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f9c6ab4-6a09-4562-b9d6-4d9c83d91828
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Number of appointments available in the slot.
        name: SLOT_AVAILABLE_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b7603b98-a30f-42a5-b839-ed5d1a9bf7e8
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Number of appointments booked in the slot.
        name: SLOT_BOOKING_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a3a96b50-13cc-4c91-859a-5a2ba7896167
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TSTAT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa7ca481-efba-488c-8686-6c762a7ce70c
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: Possible values include AVAIL (Available), NOLAV (No longer available), BUKED (Booked), RESRV (Reserved).
        name: SLOT_STATUS_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ref1.main_code
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a1d84fee-f727-4f6e-a980-4d61c85245d0
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: 'Set to 1 if the slot is booked and so no longer available.  '
        name: SLOT_BOOKED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN ref1.main_code = 'BUKED' THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55ac7456-252c-4602-a7bf-c2245b6fc371
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the slot has a forced booking i.e. slot not normally available but has been booked anyway. Such bookings have no visit type.
        name: FORCED_BOOKING_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN ref2.rfval_refno IS NULL THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e1ef4691-cfd4-4146-af59-5569728ac49a
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: SORCE_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 64481ce8-54e4-46c1-8afe-a3839fc8d630
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: RULES_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9667ebda-2eae-4638-8a03-4ba39e73f6d9
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: VISIT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ref2.rfval_refno
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 20de0c6a-5043-413a-b8d3-5d74516fd5d7
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: VISIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ref2.main_code
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f277a9c-0f2e-47b3-8d2e-1502216023c5
          stepCounter: 78162b60-7087-4372-abbd-d6cb06ade5b1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: UNKNOWN
            nodeName: DS_PIMS_SERVICE_POINT_SESSIONS
        join:
          joinCondition: |-
            FROM ds_pims_service_point_sessions
              JOIN ds_pims_service_point_time_slots
                ON ds_pims_service_point_time_slots.spssn_refno = ds_pims_service_point_sessions.spssn_refno
              JOIN ds_pims_reference_values ref1
                ON ref1.rfval_refno = ds_pims_service_point_time_slots.tstat_refno
               AND ref1.rfvdm_code = 'TSTAT'
              LEFT OUTER JOIN ds_pims_dependant_rules
                ON ds_pims_dependant_rules.sorce_refno = ds_pims_service_point_time_slots.spslt_refno
               AND ds_pims_dependant_rules.sorce_code = 'SPSLT'
              LEFT OUTER JOIN l_pims_rules
                ON l_pims_rules.rules_refno = ds_pims_dependant_rules.rules_refno
               AND l_pims_rules.code = 'Visit'
              LEFT OUTER JOIN ds_pims_reference_values ref2
                ON ref2.rfval_refno = ds_pims_dependant_rules.value
               AND ref2.rfvdm_code = 'VISIT'
             WHERE -- Slots that have been linked to a valid visit type   ((ds_pims_dependant_rules.sorce_code = 'SPSLT' AND ref2.rfval_refno IS NOT NULL)    -- Slots that have forced bookings i.e. no valid visit type but booked anyway  OR (ds_pims_service_point_time_slots.noof_bookings > 0 AND ds_pims_dependant_rules.sorce_code IS NULL))
        name: S_OUTPATIENT_SLOT_10
        noLinkRefs: []
  name: S_OUTPATIENT_SLOT_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
