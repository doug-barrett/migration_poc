fileVersion: 1
id: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
name: S_CONTRACT_ACTIVITY_REFERRAL_DOM_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 35827f92-5e3c-4fcf-bf02-792fcbc2dccd
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: PROVIDER_FUNDER_SPLIT
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6c248af4-c261-4c95-ba0d-b769e4817fa5
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 885c378b-9509-4c0f-84ca-a156c80b3a2b
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fd30ca37-d8c7-4800-a9c2-885af4e2b55f
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 56165405-67f5-40ca-852a-36769e5ca374
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d13c1551-88b3-4ce0-94fb-394ea248f360
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17f70d32-f3c6-4af9-9764-59d72a1b3a89
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: health_specialty_code
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39bb1510-6881-4542-9fe4-3c3f3c1a7902
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01d5e6b1-a3b4-4cef-8030-d6cc9cf002a6
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: facility_code
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a8456a89-5262-4db0-b2a8-03338de5dd26
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8f116d24-c910-4f80-adfc-2aab017b3367
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 835beb19-5269-44dc-a759-21dd12bd018a
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f041efa8-81c8-47fc-9a4f-9846d05ab442
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 143d2b16-da56-438c-b960-377ea3abfe3d
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0f0c1087-f147-457d-8c44-bd04cff4cecb
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 51ae3cdf-ca42-4099-8476-f2030fc948e9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e20c178c-baad-4c99-b20c-2b415524003f
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 65f38813-292e-454f-9516-fd505e1e5e3e
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18fb5231-1062-4a3b-a7f6-d7e1eefc943f
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a55a3755-72b0-4015-9072-e2de542a1e5a
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2768377e-560a-47e6-94a4-c2005db88cce
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_referral_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9186ecf-8354-43fe-87c7-8c09f1ad5eca
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5531704-5883-4375-b339-8210f378db1e
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ed20cff-db5e-42d4-ac25-36de1bb8cdc9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 364ee902-d5af-4e1b-884d-3f7dd2e20eeb
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0b9f39ed-5374-4778-a674-bcb6c8becc90
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 088d3f2c-97a2-4590-b46c-5999afb413f1
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 40dace33-9736-4e6e-8581-8e73ae0c9b6a
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f532d42e-dfc0-4123-aa53-39df0cb36934
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4a3f7bd8-2b20-46fd-b892-b827c716d570
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eb7e383f-64ac-44c1-bbc9-57cc4fe88106
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: da1df2ed-bb77-4602-974b-c243064464c7
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 652cdd6f-293e-4785-9868-b7eb16dfca01
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 54fd819b-302e-4369-9752-03826e8ddf13
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 56c0a78b-f575-4f07-a0eb-5f437407967e
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5caa5b97-416f-467e-8d96-cee2400732f3
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d27ae7ed-d2f0-4c10-b3c9-a0cb73847b5e
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 05b9d66c-b8bc-4516-9a19-97e146bd1416
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5d8645d2-6637-40a5-afb7-047fe1aca28a
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d993df2-a3c1-4fa8-8d96-537133cbccb9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3508b8c4-099d-4712-a44b-704cdfcca08f
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dcf2fcba-d3f2-4fcd-b185-63e0e3f71be3
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e640d26b-517f-4b5b-976c-669e8e226518
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 92650ae1-819b-40f0-9224-f6b8e9dfa5d3
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc8019c6-de6b-473e-b3b9-0a3bbf4920f3
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: contact clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e3dc6016-76ed-42e7-b48c-cad747269ffc
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2d7ecf84-ea4b-4141-8fdd-5d82226f2709
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39bf259b-bdad-4997-a932-a6bf6f65c1a2
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b6fe7217-2ff6-4367-8e6b-d43c7b0fcc93
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a87775d4-c343-4446-a652-cff68f38f502
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5d1014ef-f894-4213-bce2-6f8e12384017
          stepCounter: 137aaf7c-9495-46d1-bd3a-f1215a4546a9
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 470c29b7-275e-4e81-b4f2-c342b880b56e
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE VIEW {{ this }}(provider_funder_split, PUC_map_id, responsibility_centre_code, health_specialty_code, facility_code, reporting_date, source_encounter, funded_event_encounter, event_encounter_type_code, NHI, dim_patient_key, admin_category_reference_no, contract_admit_type, admission_type_code, IDF_class, domicile_code, purchase_unit_code, purchase_unit_volume, estimated_purchase_unit_volume, dim_age_group_key, dim_planned_care_key, DRG_Code, clinician_reference_no, source_system, referral_encounter_id, referral_reference_no) AS SELECT 'provider' provider_funder_split ,
                   NULL puc_map_id ,
                   CASE WHEN reporting_date.reporting_date >= '2023-07-01' THEN '1421464'
                        ELSE '142-1460'
                         END responsibility_centre_code ,
                   'D01' health_specialty_code ,
                   '1021' facility_code ,
                   reporting_date.reporting_date ,
                   'R' + CAST(REFRL.refrl_refno AS VARCHAR) + 'F' + RIGHT(fin_year_display, 2) source_encounter ,
                   'R' + CAST(REFRL.refrl_refno AS VARCHAR) + 'F' + RIGHT(fin_year_display, 2) funded_event_encounter ,
                   'R' AS [event_encounter_type_code] ,
                   PATNT.pasid AS [NHI] ,
                   dim_patient.[dim_patient_key] AS dim_patient_key ,
                   1000008180 AS [admin_category_reference_no] ,
                   'OTHER' AS [contract_admit_type] ,
                   NULL admission_type_code ,
                   s_patient_address.IDF_Class AS [IDF_class] ,
                   s_patient_address.domicile_code AS [domicile_code] ,
                   CASE WHEN PatientProgramme.programme_id = '4424640152548'                                                                                                                                                                                                                                                                                           THEN 'DOM103'
                        WHEN ((Programme.name = 'DN' /* District Nurse */ AND ((CareType = 'Urology' AND NOT IFNULL([CareSubType], '') IN ('TROC')/*in ('ISD/ISC','Urology other')*/) OR (CareType2 = 'Urology' AND NOT IFNULL([CareSubType], '') IN ('TROC')/*[CareSubType2] in ('ISD/ISC','Urology other')*/))) OR Programme.name IN ('CO')/* Continence, Ostomy */) THEN 'DOM104'
                         END purchase_unit_code ,
                   1 AS [purchase_unit_volume] ,
                   0 AS [estimated_purchase_unit_volume] ,
                   [dim_age_group].[dim_age_group_key] AS [dim_age_group_key] ,
                   0 AS [dim_planned_care_key] ,
                   NULL DRG_Code ,
                   REFRL.refto_proca_refno clinician_reference_no ,
                   'iPM REF_DOM' AS [source_system] ,
                   'R' + CAST(REFRL.refrl_refno AS VARCHAR) referral_encounter_id ,
                   REFRL.refrl_refno referral_reference_no
              FROM dbo.ds_pims_referrals AS REFRL
             INNER JOIN (
                    SELECT DISTINCT fin_year_display ,
                           fin_year_first_date ,
                           fin_year_last_date
                      FROM dim.dim_date
                   ) AS fin_year
                ON (REFRL.recvd_dttm <= fin_year_last_date AND IFNULL(REFRL.closr_date, GETDATE()) >= fin_year_first_date) CROSS APPLY (
                    SELECT IIF(REFRL.recvd_dttm > fin_year.fin_year_first_date, REFRL.recvd_dttm, fin_year.fin_year_first_date) AS reporting_date
                   ) AS reporting_date
             INNER JOIN ds_pims_patients AS PATNT
                ON PATNT.PATNT_REFNO = REFRL.patnt_refno
             INNER JOIN dim.dim_patient
                ON REFRl.patnt_refno = dim_patient.patient_reference_no
             INNER JOIN dim.dim_age_group
                ON FLOOR(DATEDIFF(DAY, dim_patient.patient_date_of_birth, reporting_date.reporting_date) / 365.25) = dim_age_group.age_years
             INNER JOIN ds_cdsswe_patient_programme AS PatientProgramme
             INNER JOIN l_cdsswe_programme AS Programme
                ON Programme.programme_id = PatientProgramme.programme_id
                ON CAST(REFRL.refrl_refno AS VARCHAR(MAX)) = PatientProgramme.stream_id
               AND PatientProgramme.programme_id IN ('4424640119860' /* District Nurse HOME HEALTH */ , '4424640152548' /* Ostomy, Home Health */ , '4424640186236' /* Continence, Home Health */)
              LEFT OUTER JOIN (
                    /* as UrologyCarePlan */ SELECT CarePlan.patient_programme_id ,
                           [5638810358328] AS CareType ,
                           [6252665878112] AS CareType2 ,
                           [6301334046160] AS CareSubType ,
                           [6303409310760] AS CareSubType2
                      FROM (
                            /* as CarePlanValue */ SELECT AtomicValue.Value ,
                                   AtomicValue.datatype_id ,
                                   AtomicValue.patient_programme_id
                              FROM (
                                    /* as AtomicValue */ SELECT TaskRequest.taskrequest_id ,
                                           TaskRequest.patient_programme_id ,
                                           AtomicObservation.datatype_id ,
                                           CAST(AtomicObservation.value AS VARCHAR(MAX)) AS [Value] ,
                                           ROW_NUMBER() OVER (PARTITION BY TaskRequest.patient_programme_id, AtomicObservation.datatype_id ORDER BY ObservationReport.date_completed DESC, ObservationReport.created_date DESC) AS seq_number
                                      FROM ds_cdsswe_task_request AS TaskRequest
                                     INNER JOIN ds_cdsswe_observation_report AS ObservationReport
                                        ON ObservationReport.taskrequest_id = TaskRequest.taskrequest_id
                                       AND ObservationReport.observation_report_status IN ('A', 'F', 'S')
                                       AND ObservationReport.record_status = 'A'
                                     INNER JOIN ds_cdsswe_atomic_observation AS AtomicObservation
                                        ON AtomicObservation.observation_report_id = ObservationReport.observation_report_id
                                     WHERE tasktype_id = '5069664993244' /* DN Care Plan */
                                       AND AtomicObservation.datatype_id IN ('5638810358328' /* Care Type */ , '6252665878112' /* Care Type2 */ , '6301334046160' /* CareSubType */ , '6303409310760' /* CareSubType2 */)
                                   ) AS AtomicValue
                             WHERE AtomicValue.seq_number = 1
                           ) AS CarePlanValue PIVOT (MAX(CarePlanValue.Value) FOR CarePlanValue.datatype_id IN ([5638810358328] /* Care Type */ , [6252665878112] /* Care Type2 */ , [6301334046160] /* CareSubType */ , [6303409310760] /* CareSubType2 */)) AS CarePlan
                   ) AS UrologyCarePlan
                ON UrologyCarePlan.patient_programme_id = PatientProgramme.patient_programme_id
              LEFT JOIN s_patient_address
                ON PATNT.patnt_refno = s_patient_address.patient_reference_no
               AND reporting_date >= address_validity_start_date
               AND reporting_date < IFNULL(address_validity_end_date, GETDATE() + 1000)
               AND address_role_code = 'HOME'
             WHERE 1 = 1
               AND (name IN ('OY','CO') OR (name = 'DN' AND (CareType = 'Urology' OR CareType2 = 'Urology')))
        dependencies:
          - locationName: TGT
            nodeName: S_CONTRACT_ACTIVITY_REFERRAL_V
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_CONTRACT_ACTIVITY_REFERRAL_V') }}
        name: S_CONTRACT_ACTIVITY_REFERRAL_DOM_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_REFERRAL_DOM_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
