fileVersion: 1
id: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
name: S_PJ_JOURNEY_60
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Match journeys to referrals involving community or EDARS contacts."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6cf9d749-a3d2-4c82-bcab-2ea5b90cf699
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique ID for a patient journey
        name: JOURNEY_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15dbefba-904b-4b84-a2a2-ed523a968a08
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 930950f6-55ce-4099-8361-3219d103764d
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 70753ad4-7f17-4546-b6bd-6a75dc7dd862
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dab3a250-d416-4287-852d-0286ca1ede77
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: First IP Encounter unique identifier
        name: FIRST_IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f6b90f61-81e4-451e-b774-c85369327df0
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4f24d5d5-739b-4f22-a895-3c533b200c19
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Final IP Encounter unique identifier
        name: FINAL_IP_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a26dc51-08d9-4a70-91e2-d6ea70e4e386
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f906bfb1-b95a-44f5-b939-561f4974c692
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Admit date and time of the first IP event for the journey.
        name: FIRST_IP_ADMIT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8a41a400-c5e3-4a6e-81a2-2fbb391430ec
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2482c7d8-37b7-4e21-b56e-8dd15c293b04
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Discharge date and time of the final IP event for the journey.
        name: FINAL_IP_DISCHARGE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ba2de1e-0880-458c-9e57-63e3588f230f
                stepCounter: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 686fdf61-65a5-4e0f-84af-cc7b6663c494
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: CONTACT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 321d4c27-228e-4503-86aa-8aed7e74b191
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: faae3bb1-3bbe-4b47-905a-1b5667c3d80f
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: add1b730-7960-4d9f-8770-5b2f7c057260
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: COMMUNITY_REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f455d641-442f-4d4f-b2a6-c155a262069d
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5e844982-3acf-42ed-8fc5-cdcde30a341c
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: Healthcare_Professional_Type_Code
        name: REFERRED_TO_CLINICIAN_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f3bfd6bd-2ce8-46b4-82b5-96274c872742
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 600cde81-1915-475d-bfa0-1c67d5e2551c
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: Set to 1 if the referral involves the EDARS team.
        name: EDARS_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ba36fdda-d368-43ca-ad61-2c0192210b40
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5f245c42-08ff-4de4-8838-db49e2dbd9fc
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Parent referral ID if this is an EDARS referral.
        name: PARENT_REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b0135322-7217-44c5-8c79-1da69fbd5dc7
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d24f02d0-35e7-405d-8b59-991dcbf378d8
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: Start date of the parent EDARS referral.
        name: PARENT_REFERRAL_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3fc816b3-e032-403a-a4cb-6b80cca2676e
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: ParentRef.referral_start_date
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f8785f9-c62d-4383-b1ca-db4bcc23b32a
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers rows for each journey by contact_start_date.
        name: JOURNEY_ROW_NUM
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ROW_NUMBER() OVER(PARTITION BY s_PJ_journey_10.journey_id ORDER BY s_PJ_community.contact_start_date, s_PJ_community.referral_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 45e0db41-1243-4f94-bbce-d7abbc00bce1
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers rows for each journey, referral type (i.e. DN, DT, OT etc) by contact_start_date.
        name: REF_TYPE_ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code IN ('DN','DIET','OCC','PHYSIO','SPTH','SOCWK') THEN ROW_NUMBER() OVER(PARTITION BY s_PJ_journey_10.journey_id, s_PJ_community.referred_to_clinician_type_code ORDER BY s_PJ_community.contact_start_date, s_PJ_community.referral_encounter_id)
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3b3ca793-73e0-4ef6-9e4f-1fb739d0551b
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_DT_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'DIET' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05bbc125-07af-4622-9045-19d5fb9989d2
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_OT_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'OCC' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15c83895-a848-4caf-8b62-12fae9eeca06
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_PT_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'PHYSIO' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f1a5f7b-9a48-49b4-9784-cdd3d23479a7
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_SLT_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'SPTH' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 57e849cf-4464-4265-ba0b-c734f86439fc
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_SW_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'SOCWK' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 85c7d8e6-28aa-4411-8b66-c37ad9b410c7
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: COMMUNITY_DN_FIRST_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ef1b8f48-e389-467e-bec7-a96a640c7a0f
                stepCounter: b49e7248-b606-453c-a5b7-a20a67000f2b
            transform: |-
              CASE WHEN s_PJ_community.referred_to_clinician_type_code = 'DN' THEN s_PJ_community.observation_report_completion_date
                          ELSE NULL
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3730fba4-6ba9-4bc0-be4e-c328273076d1
          stepCounter: 07e4bc33-3c0d-41f8-9061-d0cdf91ccfc8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_PJ_JOURNEY_10: 8190dcc6-8301-47ab-9fd9-68b29ee91fde
          S_PJ_COMMUNITY: b49e7248-b606-453c-a5b7-a20a67000f2b
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_PJ_JOURNEY_10
          - locationName: TGT
            nodeName: S_PJ_COMMUNITY
        join:
          joinCondition: |-
            FROM {{ ref('TGT','S_PJ_JOURNEY_10') }} s_PJ_journey_10
              JOIN {{ ref('TGT','S_PJ_COMMUNITY') }} s_PJ_community
                ON s_PJ_community.patient_NHI = s_PJ_journey_10.patient_NHI
              LEFT OUTER JOIN {{ ref('TGT','S_PJ_COMMUNITY') }} ParentRef -- Parent referral for EDARS referrals  ON  s_PJ_community.parent_referral_encounter_id = ParentRef.referral_encounter_id  AND s_PJ_community.edars_flag = 1    WHERE s_PJ_community.referred_to_clinician_type_code IN ('DIET', 'DN', 'OCC', 'PHYSIO', 'SOCWK', 'SPTH')  -- Dietitian, District Nurse, Occupational Therapist, Physiotherapist, Social Worker, Speech Language Therapist  AND s_PJ_community.FTF_contact = 'Y'  AND ((s_PJ_community.edars_flag = 0  AND   s_PJ_community.referral_start_date >= s_PJ_journey_10.first_ip_admit_date  AND   s_PJ_community.referral_start_date <= s_PJ_journey_10.final_ip_discharge_date + 7)  OR   (s_PJ_community.edars_flag = 1  AND   ParentRef.referral_start_date >= s_PJ_journey_10.first_ip_admit_date  AND   ParentRef.referral_start_date <= s_PJ_journey_10.final_ip_discharge_date + 7))
        name: S_PJ_JOURNEY_60
        noLinkRefs: []
  name: S_PJ_JOURNEY_60
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
