fileVersion: 1
id: 5eeec6df-cf13-4bb4-9744-4bac25ded256
name: S_CONTRACT_ACTIVITY_REFERRAL_DIABETES_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 140a1dd1-2849-4d32-96f3-5c86528dbc89
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d5106aa7-3b7c-40fe-b071-c931b890f2bb
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Generated column used to join to correct Price Volume Schdule Line
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c12b16dc-cbba-4984-aeb9-d5da6c8c7e7c
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 634db8b5-f6b4-4139-b9aa-117231b2d8ee
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: 'health_specialty_code '
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 109af693-2cb6-4a42-9855-32e9b241c1f2
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 62b112e0-2022-4e38-963c-5251c1e43196
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Has twelve months added. Mental Health data was 24 months old so 12 months added int his step and the s_contract_activity_10
        name: REPORTING_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a5a89b9-c9fa-49a3-bca0-6712c9478667
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3bb9a021-8bf3-44d2-a9c3-77aabffd0fa9
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 68f26e91-cdda-4d71-80dc-c12a92422c59
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9d229567-5aa1-44ba-87c3-729100b45cc8
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 70bcd68c-0573-4399-ae58-cb44c5431403
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_in_patient_event_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5f804bff-c65a-477e-b378-a12e467454a6
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 01d381ce-61f0-4e41-be89-84692ecdc3ac
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fd150ed1-4a5f-41f9-8410-843486a98b9d
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b1c0b8bc-b771-4887-8765-e34625d3f26e
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa0beacb-f6c5-4783-9b70-c4295f62dd2d
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 09cebc7e-5261-4c2c-b969-40fc77304696
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0756feb-8130-4666-a5b3-e0b7f500f2d1
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6a6646bd-2420-4e58-b7f7-ba83960d0a43
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: Purchase unit volume derived from forecasting
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 207a9038-0f73-4ee1-92a7-81acf6abde7b
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8d4bb2af-3024-44fd-b830-ce4e46d9bc12
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: '0'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d9d9ff0e-e97a-41e1-b163-907ca8623f17
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67a94aff-3c02-4579-89df-81e658cda97d
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: discharging clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6d43e079-dc3a-4c25-80b0-7003ad586153
          stepCounter: 5eeec6df-cf13-4bb4-9744-4bac25ded256
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT provider_funder_split ,
                   PUC_map_id ,
                   responsibility_centre_code ,
                   health_specialty_code ,
                   facility_code ,
                   reporting_date ,
                   source_encounter ,
                   funded_event_encounter ,
                   event_encounter_type_code ,
                   NHI ,
                   dim_patient_key ,
                   admin_category_reference_no ,
                   contract_admit_type ,
                   admission_type_code ,
                   IDF_class ,
                   domicile_code ,
                   purchase_unit_code ,
                   purchase_unit_volume ,
                   estimated_purchase_unit_volume ,
                   dim_age_group_key ,
                   dim_planned_care_key ,
                   NULL DRG_code ,
                   clinician_reference_no ,
                   source_system
              FROM (
                    SELECT 'provider' AS [provider_funder_split] ,
                           NULL AS PUC_map_id ,
                           '115-1113' AS [responsibility_centre_code] ,
                           referred_to_health_specialty_code AS [health_specialty_code] ,
                           '1021' AS [facility_code] ,
                           CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END AS reporting_date ,
                           s_referral_30.referral_encounter_id + 'F' + RIGHT(fin_year_display,2) AS [source_encounter] ,
                           s_referral_30.referral_encounter_id + 'F' + RIGHT(fin_year_display,2) AS [funded_event_encounter] ,
                           'R' AS [event_encounter_type_code] ,
                           s_referral_30.patient_NHI AS [NHI] ,
                           s_referral_30.[dim_patient_key] AS dim_patient_key ,
                           1000008180 AS [admin_category_reference_no] ,
                           'OTHER' AS [contract_admit_type] ,
                           NULL admission_type_code ,
                           s_patient_address.IDF_Class AS [IDF_class] ,
                           s_patient_address.domicile_code AS [domicile_code] ,
                           'M20006' AS [purchase_unit_code] ,
                           CASE WHEN sum_of_appointments > 0 THEN 1
                                ELSE 0
                                 END AS [purchase_unit_volume] ,
                           0 AS [estimated_purchase_unit_volume] ,
                           [dim_age_group].[dim_age_group_key] AS [dim_age_group_key] ,
                           0 AS [dim_planned_care_key] ,
                           dim_referred_to_clinician.referred_to_clinician_reference_no clinician_reference_no ,
                           'iPM REF_ANNL' AS [source_system] ,
                           NULL AS something ,
                           NULL AS something_else ,
                           s_Referral_30.referral_encounter_id ,
                           ROW_NUMBER() OVER (PARTITION BY s_referral_30.referral_encounter_id + 'F' + RIGHT(fin_year_display,2) ORDER BY s_patient_address.idf_class DESC, address_row_num) AS filter_address ,
                           op.sum_of_appointments AS [Had Op Appt] ,
                           s_Referral_30.referral_start_date ,
                           s_Referral_30.referral_completion_date ,
                           first_fin_date.fin_year_first_date ,
                           first_fin_date.fin_year_last_date ,
                           ROW_NUMBER() OVER (PARTITION BY s_Referral_30.patient_NHI, first_fin_date.fin_year ORDER BY (CASE WHEN referral_start_date >= calendar_date THEN referral_start_date ELSE calendar_date END) DESC,s_referral_30.referral_encounter_id) AS [filter_referrals]
                      FROM fact.fact_referral s_Referral_30
                     INNER JOIN dim.dim_referred_to_specialty
                        ON s_Referral_30.dim_referred_to_specialty_key = dim_referred_to_specialty.dim_referred_to_specialty_key
                     INNER JOIN (
                            SELECT DISTINCT calendar_date ,
                                   fin_year_display ,
                                   fin_year_first_date ,
                                   fin_year_last_date ,
                                   fin_year ,
                                   current_fin_year
                              FROM dim.dim_date
                             WHERE fin_day_in_year = 0
                           ) first_fin_date
                        ON calendar_date BETWEEN CONCAT('01-jul-', CASE WHEN MONTH(referral_start_date) >6 THEN YEAR(referral_start_date) ELSE YEAR(referral_start_date) -1 END) AND IFNULL(s_Referral_30.referral_completion_date,getdate()+100)
                     INNER JOIN dim.dim_referral_status
                        ON s_Referral_30.dim_referral_status_key = dim_referral_status.dim_referral_status_key
                     INNER JOIN dim.dim_referred_to_clinician
                        ON s_Referral_30.dim_referred_to_clinician_key = dim_referred_to_clinician.dim_referred_to_clinician_key
                     INNER JOIN dim.dim_referral_start_date
                        ON s_Referral_30.dim_referral_start_date_key = dim_referral_start_date.dim_referral_start_date_key
                     INNER JOIN dim.dim_patient
                        ON s_Referral_30.dim_patient_key = dim_patient.dim_patient_key
                     INNER JOIN dim.dim_age_group
                        ON floor(datediff(DAY, dim_patient.patient_date_of_birth, CASE WHEN referral_start_date >= calendar_date THEN referral_start_date ELSE calendar_date END)/365.25)= dim_age_group.age_years
                      LEFT JOIN (
                            SELECT fin_year ,
                                   fin_year_first_date ,
                                   fin_year_last_date ,
                                   sum(attended_appointment_count) sum_of_appointments ,
                                   patient_NHI
                              FROM [fact].[fact_outpatient_appointment] a
                             INNER JOIN [dim].[dim_outpatient_specialty] sp
                                ON sp.dim_outpatient_specialty_key = a.dim_outpatient_specialty_key
                             INNER JOIN dim.dim_Date dt
                                ON a.dim_appointment_start_date_key= dt.dim_date_key
                             WHERE 1=1
                               AND sp.outpatient_health_specialty_code LIKE 'M96'
                               AND a.attended_appointment_count = 1
                             GROUP BY fin_year ,
                                      fin_year_first_date ,
                                      fin_year_last_date ,
                                      patient_NHI
                           ) op
                        ON op.patient_NHI = s_Referral_30.patient_NHI
                       AND (op.fin_year = first_fin_date.fin_year OR op.fin_year-1 = first_fin_date.fin_year)
                     INNER JOIN s_patient_address
                        ON dim_patient.patient_reference_no = s_patient_address.patient_reference_no
                       AND (CASE WHEN referral_start_date >= calendar_date THEN referral_start_date ELSE calendar_date END) >= address_validity_start_date
                       AND (CASE WHEN referral_start_date >= calendar_date THEN referral_start_date ELSE calendar_date END) <IFNULL(address_validity_end_date,getdate()+1000)
                       AND address_role_code = 'HOME'
                     WHERE 1=1
                       AND dim_referral_status.referral_status_reference_no <> 50024
                       AND referred_to_health_specialty_code = 'M96'
                       AND CASE WHEN referral_start_date >= calendar_date THEN referral_start_date
                                ELSE calendar_date
                                 END <= getdate()
                   ) t
             INNER JOIN dim.dim_contract_reporting_date
                ON calendar_date = reporting_date
             WHERE 1=1
               AND filter_referrals = 1
               AND [Had Op Appt] IS NOT NULL
        dependencies: []
        join:
          joinCondition: None
        name: S_CONTRACT_ACTIVITY_REFERRAL_DIABETES_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_REFERRAL_DIABETES_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
