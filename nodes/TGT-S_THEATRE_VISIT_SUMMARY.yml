fileVersion: 1
id: ce792b90-a4cb-4fb6-acfb-747390b833a1
name: S_THEATRE_VISIT_SUMMARY
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d402d82-4639-4015-a3f7-1550e7629dd3
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: THEATRE_SESSION_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9a42ad0f-095e-41fe-8657-78cd62dcd1ea
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ea843bd5-c3cd-4f01-b7c9-14684b5ff92a
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: CHAR(1)
        defaultValue: ""
        description: ""
        name: AM_LONG_DELAY_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN RIGHT(CONVERT(VARCHAR,CONVERT(TIME,MAX(session_start_date)),0),2) = 'AM' AND RIGHT(CONVERT(VARCHAR,CONVERT(TIME,MAX(session_end_date)),0),2) = 'AM' AND CONVERT(TIME,MAX(CASE WHEN s_theatre_visit_20.schedule_status_code <> 'C' THEN ready_date ELSE NULL END),120) > CONVERT(TIME,'09:30:00') THEN 'Y'
                          ELSE 'N'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b40b2028-d961-4596-90d6-19a704187c9d
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FIRST_THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d1904aac-a64c-4ce6-ac97-c7ebc85f8854
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MIN(s_theatre_visit_20.session_first_theatre_visit_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ad277d11-de51-40d6-a14c-0533f780835a
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_BOOKED_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc5d9580-e6cb-40ff-82b6-236ffc8cd94b
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MIN(s_theatre_visit_20.visit_start_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5aa13515-0817-4caa-aec1-468c654d1a7b
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_PATIENT_READY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 49dc24cf-c1a8-45f3-b3f9-91c0cc271f5a
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MIN(IFNULL(s_theatre_visit_20.ready_date,s_theatre_visit_20.into_theatre_date))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dbae432e-c855-454e-8002-813707b6883c
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_PATIENT_INTO_THEATRE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7a7053b9-0c24-4149-8bb2-7a8a4497be60
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MIN(s_theatre_visit_20.into_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d7fa73e-5b42-41ee-bdf0-0a5491cf48cb
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: LAST_THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 692267e0-36a9-4911-b142-9abec8ecd843
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MAX(s_theatre_visit_20.session_last_theatre_visit_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fc6617f9-0d67-4048-8b15-ea147aea25c3
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_PATIENT_OUT_OF_THEATRE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5fd7c4d6-6970-40b4-a1c2-e421e73acd23
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MAX(s_theatre_visit_20.out_of_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: acfcc646-3873-4ab8-9786-96b38f666ef3
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_PATIENT_INTO_POSTOP_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: defd4280-2cc2-44c7-9e03-363eacf8f825
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MAX(s_theatre_visit_20.into_postop_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dafa6861-d056-48b6-97f3-099715bb74c2
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_BOOKED_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dad8c60b-0d60-457f-9a6a-5d690b7b7964
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: MAX(s_theatre_visit_20.visit_end_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8cccb4e8-1052-4299-a4b6-bd79e880c6b7
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: CANCELLED_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 916857c0-5c0e-457c-85c0-c84e3a33183a
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.schedule_status_code = 'C' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 29005f52-096c-4a1c-bedb-eca22dbe7e46
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ACTUAL_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 916857c0-5c0e-457c-85c0-c84e3a33183a
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.schedule_status_code = 'A' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 87e7b0aa-14d1-4f6f-bd70-4add7f966cf3
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PLANNED_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 916857c0-5c0e-457c-85c0-c84e3a33183a
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: COUNT(CASE WHEN s_theatre_visit_20.schedule_status_code = 'P' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8cfc4a8-cd17-45ef-b147-5860e6ff082c
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: LISTS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc5d9580-e6cb-40ff-82b6-236ffc8cd94b
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: |-
              CASE WHEN SUM(CASE WHEN s_theatre_visit_20.schedule_status_code <> 'C' THEN DATEDIFF(mi,visit_start_date,visit_end_date) ELSE 0 END) < 300 THEN 1
                          ELSE 2
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 42777e6d-4592-4ce0-8e3f-2c172a00fa94
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: VISIT_TOTAL_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc5d9580-e6cb-40ff-82b6-236ffc8cd94b
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.theatre_visit_duration BETWEEN 0 AND 999999 AND s_theatre_visit_20.schedule_status_code <> 'C' THEN s_theatre_visit_20.theatre_visit_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d364ef0b-57d3-4fa0-b73e-10223ee9e9a2
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ANAESTHETIC_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72581363-cafc-402b-b332-cb86bc601536
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.schedule_status_code <> 'C' THEN s_theatre_visit_20.anaesthetic_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c30cc372-beee-4de1-8a9d-a95a4d62b5b2
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: KNIFE_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1a844b94-9d05-462d-aea0-93fc959f7657
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.schedule_status_code <> 'C' THEN s_theatre_visit_20.knife_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a81a49df-6f57-4571-95d7-34908ed1719d
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: IN_THEATRE_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7a7053b9-0c24-4149-8bb2-7a8a4497be60
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: SUM(CASE WHEN s_theatre_visit_20.schedule_status_code <> 'C' THEN s_theatre_visit_20.in_theatre_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 630bbbff-0723-426f-89f9-eab62e8ac89f
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: AVERAGE_TURNAROUND_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7a7053b9-0c24-4149-8bb2-7a8a4497be60
                stepCounter: 570cd0a2-90c6-40c6-8e22-7dadde0451b1
            transform: AVG(CASE WHEN schedule_status_code <> 'C' AND session_into_theatre_seq_num > 1 THEN CASE WHEN DATEDIFF(mi,IFNULL(session_previous_out_of_theatre_date,into_theatre_date),into_theatre_date) < 0 THEN 0 ELSE DATEDIFF(mi,IFNULL(session_previous_out_of_theatre_date,into_theatre_date),into_theatre_date) END ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 14c9d681-409e-4ce5-8371-7d4a7adae69e
          stepCounter: ce792b90-a4cb-4fb6-acfb-747390b833a1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: surgeon_duration
        name: SURGEON_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(s_theatre_visit_20.surgeon_duration)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_THEATRE_VISIT_20
        join:
          joinCondition: FROM s_theatre_visit_20 --WHERE s_theatre_visit_20.schedule_status_code <> 'C'       GROUP BY s_theatre_visit_20.theatre_session_reference_no
        name: S_THEATRE_VISIT_SUMMARY
        noLinkRefs: []
  name: S_THEATRE_VISIT_SUMMARY
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
