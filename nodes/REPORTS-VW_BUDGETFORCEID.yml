fileVersion: 1
id: 2f981bab-561c-4e96-b4fa-754a55b06978
name: VW_BUDGETFORCEID
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9ca7d2c-8f95-4f63-9589-c1f71d6bcc30
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: TERRITORYID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7dcb5968-2ec3-4902-bc92-23f0d05638a3
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: BUDGETDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7a03111b-b8af-4cc8-abb3-fc2e10ac1b77
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 54d9b6e1-50a8-4ea9-b943-e30a601701ca
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2411f537-c866-4815-bada-1703c3254190
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: NUMERIC(18,18)
        defaultValue: ""
        description: ""
        name: FORCEIDDISTRIBUTION
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e7aa391-dbac-44ff-b9b2-5913b6a9251e
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETFORCEIDSALESAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2ab8dfa2-7483-41f0-a8b5-3d3a35c97a17
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETFORCEIDREVENUEAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6b44ed2f-6297-4110-bef3-958b9daf7c3d
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: TERRITORYID_PY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 56426282-40fd-4abe-91c0-f9e8d96329f1
          stepCounter: 2f981bab-561c-4e96-b4fa-754a55b06978
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: BUDGETTYPE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            --------------------------------------------------------------------------------------------------------------------------
            \N--GET AMOUNTS TO USE BY 2019 BUDGET DATE
            \N--------------------------------------------------------------------------------------------------------------------------
            \N \NWITH CTEREPORTSSALESANDREVENUE \N AS (
                    SELECT \N ISNULL([SAR].[TERRITORYDIVISIONID], CASE--THIS CASE STATEMENT IS USED TO ASSIGN CORRECT DIVISION NAME WHEN TERRITORY ASSIGNMENT IS NULL DUE TO DATA OR HIERARCHY ISSUES
            \N WHEN [SAR].[ORGANIZATIONID] IN(1, 5, 6) THEN 1--PUBLIC
            \N WHEN [SAR].[ORGANIZATIONID] IN(2, 3, 4, 7) THEN 2--PRIVATE
            \N ELSE 1 \N END) AS [TERRITORYDIVISIONID], \N [SAR].[RECEIPTDATE], \N [SAR].[SALES], \N [SAR].[REVENUE], \N [SAR].[RECEIPTDATEKEY], \N [SAR].[FORCEID] \N
                      FROM [REPORTS].[SALESANDREVENUE] AS [SAR] \N
                     WHERE [SAR].[RECEIPTDATEKEY] BETWEEN 20190101 AND 20191231
                   ) \N--SELECT * FROM [CTEREPORTSSALESANDREVENUE]
            \N, \N CTEFORCEIDSALESREVENUE --GET ACTUALS BY FORCEID
            \N AS (
                    SELECT \N ISNULL([SAR].[TERRITORYDIVISIONID], 1) AS [TERRITORYDIVISIONID], \N [SAR].[RECEIPTDATE] AS [BUDGETDATE], \N ISNULL([SAR].[FORCEID], 0) AS [FORCEID], \N SUM([SAR].[SALES]) AS [BUDGETFORCEIDSALESAMOUNT], \N SUM([SAR].[REVENUE]) AS [BUDGETFORCEIDREVENUEAMOUNT] \N
                      FROM [CTEREPORTSSALESANDREVENUE] AS [SAR] \N
                     WHERE ISNULL([SAR].[TERRITORYDIVISIONID], 1) IN (1, 2) \N
                       AND NOT([SAR].[REVENUE] = 0) --[SAR].[FORCEID] IS NOT NULL --THERE ARE BUDGETS WHERE SALES HAS NOT HAPPENED
            \N
                     GROUP BY \N ISNULL([SAR].[TERRITORYDIVISIONID], 1), \N [SAR].[RECEIPTDATE], \N ISNULL([SAR].[FORCEID], 0)
                   ) \N --SELECT TOP 10 * FROM [CTEFORCEIDSALESREVENUE] AS [CFISR] WHERE FORCEIDREVENUE = 0
            \N --SELECT * FROM [CTEFORCEIDSALESREVENUE] AS CFISR GROUP BY BUDGETDATE
            \N --SELECT CFISR.BUDGETDATE,SUM(CFISR.[FORCEIDSALES]) , SUM([CFISR].[FORCEIDREVENUE]) FROM [CTEFORCEIDSALESREVENUE] AS CFISR GROUP BY CFISR.BUDGETDATE ORDER BY [CFISR].[BUDGETDATE]
            \N , \N --------------------------------------------------------------------------------------------------------------------
            \N CTEFORCEIDBUDGET_2019 \N AS (
                    SELECT --2019 BUDGET BY FORCEID
            \N ISNULL([CLB].[TERRITORYDIVISIONID], 1) AS [TERRITORYDIVISIONID], \N CASE \N
                                WHEN [DA].[TERRITORYID] IS NULL THEN CASE \N WHEN [CLB].[TERRITORYDIVISIONID] = 1 THEN 52 --PUBLIC\PUBLIC\HOUSE
            \N WHEN [CLB].[TERRITORYDIVISIONID] = 2 THEN 11 --PRIVATE\PRIVATE\HOUSE
            \N ELSE [DA].[TERRITORYID] \N END \N
                                ELSE [DA].[TERRITORYID] \N
                                 END AS [TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [DA].[LEVEL1FORCEID], \N [DA].[FORCEID], \N NULL AS [FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N NULL AS [GROWTH], \N [A].[TERRITORYID_PY] AS [TERRITORYID_PY], --2019 TERRITORYID
            \N CASE \N
                                WHEN [DA].[ORGANIZATIONID] = 7 THEN 'TERRITORY BUDGET - ISG' \N
                                ELSE 'TERRITORY BUDGET' \N
                                 END AS [BUDGETTYPE] \N
                      FROM [CTEFORCEIDSALESREVENUE] AS [CLB] \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT_NEXTYEAR] AS [A]
                        ON [CLB].[FORCEID] = [A].[FORCEID] --GET 2019 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT] AS [DA]
                        ON [CLB].[FORCEID] = [DA].[FORCEID] --GET 2020 TERRITORY FOR FORCEID
            \N
                   ) \N --SELECT [CSABBFI].[TERRITORYDIVISIONID], SUM(CSABBFI.[BUDGETFORCEIDREVENUEAMOUNT]) FROM [CTEFORCEIDBUDGET_2019] AS CSABBFI GROUP BY [CSABBFI].[TERRITORYDIVISIONID]
            \N --SELECT BUDGETDATE,[TERRITORYDIVISIONID], SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   CTEFORCEIDBUDGET_MASTER AS CFB  GROUP BY BUDGETDATE,[TERRITORYDIVISIONID] ORDER BY [CFB].[BUDGETDATE], [TERRITORYDIVISIONID]
            \N --SELECT BUDGETDATE, SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2019] AS CFB  GROUP BY BUDGETDATE ORDER BY [CFB].[BUDGETDATE]
            \N --SELECT BUDGETDATE,[TERRITORYDIVISIONID], SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2019] AS CFB  GROUP BY BUDGETDATE,[TERRITORYDIVISIONID] ORDER BY [CFB].[BUDGETDATE], [TERRITORYDIVISIONID]
            \N --------------------------------------------------------------------------------------------------------------------
            \N , \N CTEFORCEIDBUDGET_2020 \N AS (
                    SELECT --2020 BUDGET BY FORCEID
            \N [STNY].[TERRITORYDIVISIONID], \N [DA].[TERRITORYID] AS [TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE] AS [BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N NULL AS [FORCEIDDISTRIBUTION], \N [CLB].[BUDGETSALESAMOUNT] AS [BUDGETFORCEIDSALESAMOUNT], --[BUDGETFORCEIDSALESAMOUNT_2020]
            \N [CLB].[BUDGETREVENUEAMOUNT] AS [BUDGETFORCEIDREVENUEAMOUNT], --[BUDGETFORCEIDREVENUEAMOUNT_2020]
            \N NULL AS [GROWTH], \N [A].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] AS [BUDGETTYPE] \N
                      FROM [FACT].[REVENUEBUDGET] AS [CLB] \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT_NEXTYEAR] AS [A]
                        ON [CLB].[FORCEID] = [A].[FORCEID] --GET 2019 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [OMNIAPARTNERSODS].[ODS].[DSACCOUNT] AS [DA]
                        ON [CLB].[FORCEID] = [DA].[FORCEID] --GET 2020 TERRITORY FOR FORCEID
            \N
                      LEFT OUTER JOIN [DIM].[SALESTERRITORY_NEXTYEAR] AS [STNY]
                        ON [STNY].[TERRITORYID] = [DA].[TERRITORYID] \N --LEFT OUTER JOIN [DIM].[TERRITORYBUDGETGROWTH] AS [TBG] ON [TBG].[TERRITORYDIVISIONID] = ISNULL([STNY].[TERRITORYDIVISIONID], 1) AND [TBG].[BUDGETDATE] = [CLB].[BUDGETDATE]
            \N
                     WHERE [CLB].[BUDGETTYPE] LIKE 'TERRITORY BUDGET%' \N
                       AND [CLB].[BUDGETDATEKEY] BETWEEN 20200101 AND 20201231
                   ) \N --SELECT BUDGETDATE, SUM([CFB].[BUDGETFORCEIDREVENUEAMOUNT]) FROM   [CTEFORCEIDBUDGET_2020] AS CFB  GROUP BY BUDGETDATE ORDER BY [CFB].[BUDGETDATE]
            \N SELECT \N [CLB].[TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N [CLB].[FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N [CLB].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] \N
              FROM [CTEFORCEIDBUDGET_2019] AS [CLB] \N
             UNION \N SELECT \N [CLB].[TERRITORYID], --2020 TERRITORYID
            \N [CLB].[BUDGETDATE], \N [CLB].[LEVEL1FORCEID], \N [CLB].[FORCEID], \N [CLB].[FORCEIDDISTRIBUTION], \N [CLB].[BUDGETFORCEIDSALESAMOUNT], \N [CLB].[BUDGETFORCEIDREVENUEAMOUNT], \N [CLB].[TERRITORYID_PY], --2019 TERRITORYID
            \N [CLB].[BUDGETTYPE] \N
              FROM [CTEFORCEIDBUDGET_2020] AS [CLB]
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: VWBUDGETFORCEID
        noLinkRefs: []
  name: VW_BUDGETFORCEID
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
