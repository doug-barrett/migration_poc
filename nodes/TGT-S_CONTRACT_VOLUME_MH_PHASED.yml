fileVersion: 1
id: b9264eae-b318-4ace-9d1e-91b0604916d4
name: S_CONTRACT_VOLUME_MH_PHASED
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3317c990-d32e-4abf-8e36-a351bfaadf1e
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0c12fee0-1447-40b2-b6ae-78fc2f809b1e
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 52cb89e7-4461-4ce0-bbad-a0c72d3f7ec1
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 821eb6e5-03f5-45fb-acaf-9c0da497b541
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a36c0270-8034-4da5-a041-24d4f968fbf5
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8726e63e-e680-4606-a9f3-8d2447e7e442
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1fe70792-97aa-41ba-9c39-dac2fae2eb90
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15063407-2e8c-4e50-8d8d-ee4321de40b3
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: |-
              CASE WHEN LEN (left(s_contract_volume_MH_FTE_10.fiscal_year,4)+'M'+substring(s_contract_volume_MH_FTE_10.purchase_unit_code,3,20) + replace(s_contract_volume_MH_FTE_10.responsibility_centre_code,'-','')) > 16 THEN left(s_contract_volume_MH_FTE_10.fiscal_year,4) +'M'+substring(s_contract_volume_MH_FTE_10.purchase_unit_code,4,20) + replace(s_contract_volume_MH_FTE_10.responsibility_centre_code,'-','')
                          ELSE left(s_contract_volume_MH_FTE_10.fiscal_year,4) +'M'+substring(s_contract_volume_MH_FTE_10.purchase_unit_code,3,20) + replace(s_contract_volume_MH_FTE_10.responsibility_centre_code,'-','')
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2a00047e-55cd-42ce-8df5-4cfc516137f6
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bc587560-3cce-42f5-b882-6ea19bd1b5b3
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51381f93-29b5-4bff-9ef7-0dbe09734ee0
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: Based on average FTE
        name: ACTUAL_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d1961e1f-29d5-40a1-a2ae-4edf0a4ccf27
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: s_contract_volume_MH_FTE_10.actual_volume * l_tMap_Contract_Phasing.Phasing
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ea83b1b5-8603-4b64-a777-84cd270c5113
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: dummy field for MH contract admit type. This should always have the value "OTHER"
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39d2a3e5-82df-46b0-afaf-6e036543f715
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 12bc6f41-4580-4213-a936-5a09a77e78da
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: 'Phasing is applied to the volume so that that a monthly result can be presented. FTE based purchase units aggregate as averages rather than totals making them an exceptiion to the standard method of phasing. '
        name: PHASING_METHOD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c5c8e633-2d5c-4615-b355-259e55bcd9bc
                stepCounter: b94aecaf-264b-4301-923b-de0f2827d46a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 85b3d85b-eb55-4cf3-9205-b1269d5b7d30
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: dummy IDF Class for Mental Volume
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: "'Non-IDF'"
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 344a7bb7-0b60-47c2-a573-55da9b334175
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: FLOAT
        defaultValue: ""
        description: ""
        name: FISCALPERIOD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7ef31f99-6d67-4caa-bb98-945dccee30a8
                stepCounter: 4ce1b5d5-0bfd-4280-9bbb-8fa265b2dceb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 25a47b9e-df36-4052-acaa-6c3282875a21
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: NUMERIC(38,20)
        defaultValue: ""
        description: ""
        name: PHASING
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5789b02a-2ee0-4018-aee1-c20d7a6b9671
                stepCounter: 4ce1b5d5-0bfd-4280-9bbb-8fa265b2dceb
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5ab37125-73dd-49e4-81a8-9c155d00e4db
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: The calendar date for this row.
        name: CONTRACT_REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7e83f34e-49ec-49f4-b97f-87feffe0d00d
                stepCounter: 4f22f895-47c0-4e2a-9a51-f3051174cf24
            transform: DATEADD(MONTH, -12, dim_contract_reporting_date.calendar_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7d7a3d91-d665-4711-8f3b-77bc490860b2
          stepCounter: b9264eae-b318-4ace-9d1e-91b0604916d4
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          L_TMAP_CONTRACT_PHASING: 4ce1b5d5-0bfd-4280-9bbb-8fa265b2dceb
          DIM_CONTRACT_REPORTING_DATE: 4f22f895-47c0-4e2a-9a51-f3051174cf24
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_CONTRACT_VOLUME_MH_FTE_10
          - locationName: TGT
            nodeName: L_TMAP_CONTRACT_PHASING
          - locationName: TGT
            nodeName: DIM_CONTRACT_REPORTING_DATE
        join:
          joinCondition: |-
            FROM s_contract_volume_MH_FTE_10
              JOIN {{ ref('TGT','L_TMAP_CONTRACT_PHASING') }}
                ON s_contract_volume_MH_FTE_10.fiscal_year = l_tMap_Contract_Phasing.FiscalYear
               AND s_contract_volume_MH_FTE_10.phasing_method = l_tMap_Contract_Phasing.Method
               AND l_tMap_Contract_Phasing.EndDate IS NULL
              JOIN {{ ref('TGT','DIM_CONTRACT_REPORTING_DATE') }}
                ON l_tMap_Contract_Phasing.FiscalPeriod = dim_contract_reporting_date.contract_reporting_fin_month_no
               AND l_tMap_Contract_Phasing.FiscalYear = dim_contract_reporting_date.contract_reporting_fin_year
               AND dim_contract_reporting_date.contract_reporting_cal_day_in_month = 1
        name: S_CONTRACT_VOLUME_MH_PHASED
        noLinkRefs: []
  name: S_CONTRACT_VOLUME_MH_PHASED
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
