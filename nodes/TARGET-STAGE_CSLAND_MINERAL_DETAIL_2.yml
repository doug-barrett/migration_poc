fileVersion: 1
id: 39b434df-8b1c-4d26-b99c-aefd36f143b3
name: STAGE_CSLAND_MINERAL_DETAIL_2
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e1285b59-b9fd-4d38-847e-1b6833df0901
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: LAND_DESCRIPTION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a7482c7b-d952-44b3-9294-331965a35b5e
                stepCounter: a06a88ac-a5dc-4140-bcf2-bcfbeca9c510
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e22d2041-760d-4f9b-bcd9-19f5966fde8a
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: RIGHTS_HELD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 128dfe0f-4a0b-472e-9990-2c3d2e019921
                stepCounter: 2e299bef-3185-4de6-bbb4-56ac97076a3b
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bcccea41-fa7f-4b2d-98ec-50dd14858777
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: CURR_DOI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8f841507-16ce-4612-80ff-8261367e7396
                stepCounter: 5d401374-6e3b-4e5f-b27a-ab979c40cb21
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 733b6094-6242-40f7-bda6-e13242d34b9e
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: REF_DOI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8f841507-16ce-4612-80ff-8261367e7396
                stepCounter: 5d401374-6e3b-4e5f-b27a-ab979c40cb21
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e84f48e1-1287-4fdf-8bdc-84add61a8dfa
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: RENT_DOI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8f841507-16ce-4612-80ff-8261367e7396
                stepCounter: 5d401374-6e3b-4e5f-b27a-ab979c40cb21
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6449035f-b0ca-4ebd-8b64-85d5f76d2886
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: REMARKS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f70b27fb-2416-4d28-91c8-8300bf9ad613
                stepCounter: fd2fdce6-834b-4479-bb8b-be7e7eb0b4d6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 82227183-4e8f-4b46-81a2-2bf35139eb01
          stepCounter: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        config: {}
        dataType: VARCHAR(12)
        defaultValue: ""
        description: ""
        name: MINERAL_FILE_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          STAGE_CSLAND_MINERAL_DETAIL_2: 39b434df-8b1c-4d26-b99c-aefd36f143b3
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','STAGE_CSLAND_MINERAL_DETAIL_2') }} AS SELECT REPLACE(LL.LAND_DESCRIPTION,CHR(13)||CHR(10),CHR(10)) "LAND_DESCRIPTION",
                   REPLACE(LR.RIGHTS_HELD,CHR(13)||CHR(10),CHR(10)) "RIGHTS_HELD",
                   CURR_D.DOI_DETAILS "CURR_DOI",
                   REF_D.DOI_DETAILS "REF_DOI",
                   RENT_D.DOI_DETAILS "RENT_DOI",
                   MR.REMARKS,
                   TRIM(LS.FILE_NUMBER)||TRIM(LS.FILE_SUB) "MINERAL_FILE_KEY"
              FROM DS_CSLAND.L_SUB LS,
                   DS_CSLAND.L_LEGAL LL,
                   DS_CSLAND.L_RIGHTS LR,
                   (
                    SELECT FILE_NUMBER,
                           FILE_SUB,
                           REPLACE(LISTAGG(TO_CHAR(REMARKS_DATE,'YYYY-MM-DD')||': ['||TRIM(REMARKS_TYPE)||'] - '||REMARKS, '~'),'~',chr(10)) "REMARKS"
                      FROM (
                            SELECT *
                              FROM DS_CSLAND.L_REMARK
                             ORDER BY FILE_NUMBER,
                                      FILE_SUB,
                                      REMARKS_DATE,
                                      OCCURRENCE
                           )
                     GROUP BY FILE_NUMBER,
                              FILE_SUB
                   ) MR,
                   (
                    SELECT FILE_NUMBER,
                           FILE_SUB,
                           LISTAGG(DOI_TYPE || ' (' || DOI_ID || ') ' || CHR(10) || DOI_DETAIL || CHR(10), '~') "DOI_DETAILS"
                      FROM (
                            SELECT DX.FILE_NUMBER,
                                   DX.FILE_SUB,
                                   TD.DESCRIPTION "DOI_TYPE",
                                   DD.DOI_ID,
                                   REPLACE(LISTAGG('     ' || RPAD(BA.NAME||'  ('||TRIM(DD.PARTNER)||')', 50, ' ') || LPAD(TO_CHAR(NVL(DD.PARTNER_PERCENT,0),'990.0000000'),12,' ') || ' ' || DECODE(DD.SILENT_PARTNER,'*','S',' ') || ' ' || DECODE(NVL(DD.PENALTY,'N'),'Y','P',' '), '~'),'~',chr(10)) "DOI_DETAIL"
                              FROM DS_CSLAND.D_XREF DX,
                                   DS_CSLAND.D_DETAIL DD,
                                   DS_CSLAND.BA_TABLE BA,
                                   DS_CSLAND.T_OWNERS TOW,
                                   DS_CSLAND.T_DOI TD
                             WHERE DX.DOI_ID = DD.DOI_ID
                               AND DX.SUBSYSTEM = 'M'
                               AND DX.EFFECTIVE_DATE <= CURRENT_TIMESTAMP
                               AND DX.EXPIRY_DATE > CURRENT_TIMESTAMP
                               AND DD.PARTNER = BA.PRIMARY_KEY
                               AND DD.PARTNER = TOW.OWNER(+)
                               AND ACCOUNT_GROUP = 'CURR%'
                               AND DX.DOI_TYPE = TD.CODE
                             GROUP BY DX.FILE_NUMBER,
                                      DX.FILE_SUB,
                                      TD.DESCRIPTION,
                                      DD.DOI_ID
                           )
                     GROUP BY FILE_NUMBER,
                              FILE_SUB
                   ) CURR_D,
                   (
                    SELECT FILE_NUMBER,
                           FILE_SUB,
                           LISTAGG(DOI_TYPE || ' (' || DOI_ID || ') ' || CHR(10) || DOI_DETAIL || CHR(10), '~') "DOI_DETAILS"
                      FROM (
                            SELECT DX.FILE_NUMBER,
                                   DX.FILE_SUB,
                                   TD.DESCRIPTION "DOI_TYPE",
                                   DD.DOI_ID,
                                   REPLACE(LISTAGG('     ' || RPAD(BA.NAME||'  ('||TRIM(DD.PARTNER)||')', 50, ' ') || LPAD(TO_CHAR(NVL(DD.PARTNER_PERCENT,0),'990.0000000'),12,' ') || ' ' || DECODE(DD.SILENT_PARTNER,'*','S',' ') || ' ' || DECODE(NVL(DD.PENALTY,'N'),'Y','P',' '), '~'),'~',chr(10)) "DOI_DETAIL"
                              FROM DS_CSLAND.D_XREF DX,
                                   DS_CSLAND.D_DETAIL DD,
                                   DS_CSLAND.BA_TABLE BA,
                                   DS_CSLAND.T_OWNERS TOW,
                                   DS_CSLAND.T_DOI TD
                             WHERE DX.DOI_ID = DD.DOI_ID
                               AND DX.SUBSYSTEM = 'M'
                               AND DX.EFFECTIVE_DATE <= CURRENT_TIMESTAMP
                               AND DX.EXPIRY_DATE > CURRENT_TIMESTAMP
                               AND DD.PARTNER = BA.PRIMARY_KEY
                               AND DD.PARTNER = TOW.OWNER(+)
                               AND ACCOUNT_GROUP = 'REF%'
                               AND DX.DOI_TYPE = TD.CODE
                             GROUP BY DX.FILE_NUMBER,
                                      DX.FILE_SUB,
                                      TD.DESCRIPTION,
                                      DD.DOI_ID
                           )
                     GROUP BY FILE_NUMBER,
                              FILE_SUB
                   ) REF_D,
                   (
                    SELECT FILE_NUMBER,
                           FILE_SUB,
                           LISTAGG(DOI_TYPE || ' (' || DOI_ID || ') ' || CHR(10) || DOI_DETAIL || CHR(10), '~') "DOI_DETAILS"
                      FROM (
                            SELECT DX.FILE_NUMBER,
                                   DX.FILE_SUB,
                                   TD.DESCRIPTION "DOI_TYPE",
                                   DD.DOI_ID,
                                   REPLACE(LISTAGG('     ' || RPAD(BA.NAME||'  ('||TRIM(DD.PARTNER)||')', 50, ' ') || LPAD(TO_CHAR(NVL(DD.PARTNER_PERCENT,0),'990.0000000'),12,' ') || ' ' || DECODE(DD.SILENT_PARTNER,'*','S',' ') || ' ' || DECODE(NVL(DD.PENALTY,'N'),'Y','P',' '), '~'),'~',chr(10)) "DOI_DETAIL"
                              FROM DS_CSLAND.D_XREF DX,
                                   DS_CSLAND.D_DETAIL DD,
                                   DS_CSLAND.BA_TABLE BA,
                                   DS_CSLAND.T_OWNERS TOW,
                                   DS_CSLAND.T_DOI TD
                             WHERE DX.DOI_ID = DD.DOI_ID
                               AND DX.SUBSYSTEM = 'M'
                               AND DX.EFFECTIVE_DATE <= CURRENT_TIMESTAMP
                               AND DX.EXPIRY_DATE > CURRENT_TIMESTAMP
                               AND DD.PARTNER = BA.PRIMARY_KEY
                               AND DD.PARTNER = TOW.OWNER(+)
                               AND ACCOUNT_GROUP = 'RENT%'
                               AND DX.DOI_TYPE = TD.CODE
                             GROUP BY DX.FILE_NUMBER,
                                      DX.FILE_SUB,
                                      TD.DESCRIPTION,
                                      DD.DOI_ID
                           )
                     GROUP BY FILE_NUMBER,
                              FILE_SUB
                   ) RENT_D
             WHERE LS.FILE_NUMBER = LL.FILE_NUMBER(+)
               AND LS.FILE_SUB = LL.FILE_SUB(+)
               AND LS.FILE_NUMBER = LR.FILE_NUMBER(+)
               AND LS.FILE_SUB = LR.FILE_SUB(+)
               AND LS.FILE_NUMBER = CURR_D.FILE_NUMBER(+)
               AND LS.FILE_SUB = CURR_D.FILE_SUB(+)
               AND LS.FILE_NUMBER = REF_D.FILE_NUMBER(+)
               AND LS.FILE_SUB = REF_D.FILE_SUB(+)
               AND LS.FILE_NUMBER = RENT_D.FILE_NUMBER(+)
               AND LS.FILE_SUB = RENT_D.FILE_SUB(+)
               AND LS.FILE_NUMBER = MR.FILE_NUMBER(+)
               AND LS.FILE_SUB = MR.FILE_SUB(+)
        dependencies:
          - locationName: TARGET
            nodeName: ODS_CSLAND_L_LEGAL
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_CSLAND_L_LEGAL') }}
        name: STAGE_CSLAND_MINERAL_DETAIL_2
        noLinkRefs: []
  name: STAGE_CSLAND_MINERAL_DETAIL_2
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
