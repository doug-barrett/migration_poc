fileVersion: 1
id: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
name: S_CONTRACT_ACTIVITY_REFERRAL
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "builds a table at the grain of referral by fiscal year. Uses concept of active referral meaning that there is outpatient/community contact activity on the referral. Also finds duplicate referrals open in the year to the same specialty"
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c6ede895-fb8a-4f8f-ac6f-f8eca699c1bf
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 702dfc9d-df5e-42d8-86f8-9e68f29c462c
                stepCounter: d52dd438-7899-4242-9e38-539d2a1447df
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: abdc79f5-e6f6-402b-a547-9a3e5c83d8ee
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6c248af4-c261-4c95-ba0d-b769e4817fa5
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cbb20f28-1251-415e-ba04-1056dcfc2ff2
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d13c1551-88b3-4ce0-94fb-394ea248f360
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6075a61d-b08c-4ae3-a796-6de4c7449e4a
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: health_specialty_code
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39bb1510-6881-4542-9fe4-3c3f3c1a7902
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4c1f4494-f596-4880-809c-3f34f9211b04
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: facility_code
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a8456a89-5262-4db0-b2a8-03338de5dd26
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 16d017c1-81b2-450b-bd96-b0785f71df12
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: REPORTING_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 835beb19-5269-44dc-a759-21dd12bd018a
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 637811fb-692a-4254-99c8-6440e8d1e034
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 143d2b16-da56-438c-b960-377ea3abfe3d
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 106aabfb-e883-4a5b-8844-cc57b071a59f
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 51ae3cdf-ca42-4099-8476-f2030fc948e9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1a3a8195-d22a-41cc-a215-10a1fa998c4e
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 65f38813-292e-454f-9516-fd505e1e5e3e
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 415b879f-2d85-46c4-97e0-7273ad908825
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a55a3755-72b0-4015-9072-e2de542a1e5a
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5c99a425-1126-40a1-b00f-8c3d315f718a
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_contract_activity_referral.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9186ecf-8354-43fe-87c7-8c09f1ad5eca
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aaeab6be-9789-4727-a982-91758857e6a2
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ed20cff-db5e-42d4-ac25-36de1bb8cdc9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e97e72b2-f8e9-4fe1-843d-2179d8e126d4
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(8)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0b9f39ed-5374-4778-a674-bcb6c8becc90
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59c38662-fa71-4e13-a5f5-6fe75f743313
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4a3f7bd8-2b20-46fd-b892-b827c716d570
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: baff42e0-c9f5-4e77-8b14-ed12552912e9
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: da1df2ed-bb77-4602-974b-c243064464c7
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 90d199df-d88b-4377-ae30-26ef52adba09
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 54fd819b-302e-4369-9752-03826e8ddf13
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e1722844-1593-40f2-847c-2f6a70eae3b5
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5caa5b97-416f-467e-8d96-cee2400732f3
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8df9c460-e619-4970-a525-8d5abced1add
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 05b9d66c-b8bc-4516-9a19-97e146bd1416
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 33507bcf-120a-4c72-9849-0aded13506de
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6d993df2-a3c1-4fa8-8d96-537133cbccb9
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7ef995f4-3df8-4a56-977d-478cf1e4f2fe
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: contact clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e3dc6016-76ed-42e7-b48c-cad747269ffc
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 98aa4ce4-d580-4779-a589-1d2d0198812d
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39bf259b-bdad-4997-a932-a6bf6f65c1a2
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 386cf7f6-1960-4a67-acce-8c1a3068eff0
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ACTIVE_REFERRAL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8a0d9a1d-0692-406a-b1d2-1bd4a0ae8e6d
                stepCounter: ba88d388-2a8d-436d-9224-973b9723a83e
            transform: |-
              CASE WHEN IFNULL(s_contract_activity_active_referrals.encounter_count,0) >0 THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 37b6f0aa-3905-4b7b-bd8c-55182a3decd1
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: OPEN_REFERRAL_SEQUENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7f08f5a6-b967-465c-b181-2675960b0100
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1c60597c-f9ec-4081-871f-2380717a49cb
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a87775d4-c343-4446-a652-cff68f38f502
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa863b72-cea2-4f95-89bb-b3e314dc6bcc
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REFERRAL_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 470c29b7-275e-4e81-b4f2-c342b880b56e
                stepCounter: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 184de024-c3c8-4fd3-b43c-a9ae23dbf7a2
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: FIN_YEAR_OFFSET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b3944da5-87b6-493e-841d-7f496d18c809
                stepCounter: bc3fcb77-c0c4-477a-92d8-4db14f153b73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f42cb754-bc94-43ea-aaab-a32362e177c9
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: INT
        defaultValue: ""
        description: Financial year. Format YYYY.
        name: FIN_YEAR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2ae52b1-4578-42d3-9e26-e153637ebee6
                stepCounter: bc3fcb77-c0c4-477a-92d8-4db14f153b73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b272ae90-656e-4514-8954-9f73cc8a1a94
          stepCounter: c8c8768f-4806-46ba-87e8-0cfa0d9cb0ac
        config: {}
        dataType: VARCHAR(6)
        defaultValue: ""
        description: Financial year. Format FYyyyy.
        name: FIN_YEAR_DISPLAY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 65de49b1-1323-4fe1-92f3-110f19795122
                stepCounter: bc3fcb77-c0c4-477a-92d8-4db14f153b73
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_CONTRACT_ACTIVITY_REFERRAL_V: a2da9a3b-8e27-4489-83a4-c1a7a6fc934e
          DIM_DATE: bc3fcb77-c0c4-477a-92d8-4db14f153b73
          DIM_PATIENT: d52dd438-7899-4242-9e38-539d2a1447df
          S_CONTRACT_ACTIVITY_ACTIVE_REFERRALS: ba88d388-2a8d-436d-9224-973b9723a83e
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: DIM_PATIENT
          - locationName: TGT
            nodeName: S_CONTRACT_ACTIVITY_REFERRAL_V
          - locationName: TGT
            nodeName: DIM_DATE
          - locationName: TGT
            nodeName: S_CONTRACT_ACTIVITY_ACTIVE_REFERRALS
        join:
          joinCondition: |-
            FROM {{ ref('TGT','S_CONTRACT_ACTIVITY_REFERRAL_V') }}
              JOIN {{ ref('TGT','DIM_DATE') }}
                ON s_contract_activity_referral_v.reporting_date = dim_date.calendar_date
              JOIN {{ ref('TGT','DIM_PATIENT') }}
                ON dim_patient.dim_patient_key = s_contract_activity_referral_v.dim_patient_key
              LEFT OUTER JOIN {{ ref('TGT','S_CONTRACT_ACTIVITY_ACTIVE_REFERRALS') }}
                ON s_contract_activity_referral_v.referral_encounter_id = s_contract_activity_active_referrals.referral_id
        name: S_CONTRACT_ACTIVITY_REFERRAL
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_REFERRAL
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
