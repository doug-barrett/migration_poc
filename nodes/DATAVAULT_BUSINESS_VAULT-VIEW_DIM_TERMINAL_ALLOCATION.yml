fileVersion: 1
id: cd8fed57-cc21-4016-8697-32cc75c23b66
name: VIEW_DIM_TERMINAL_ALLOCATION
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: DATAVAULT_BUSINESS_VAULT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4a2ad251-e9ca-49d3-8e74-3533cbe9d5d0
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: ""
        name: SOURCE_SYSTEM
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 96603962-b34a-4f43-9195-ffd98453082e
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: TERMINAL_ALLOCATION_NK
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 67b2d075-ded2-4afb-9397-ebaf705a7179
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: NUMBER
        defaultValue: ""
        description: ""
        name: DIM_MERCHANT_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 167edf70-57b6-4c41-a5fc-4d714628546a
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: NUMBER
        defaultValue: ""
        description: ""
        name: DIM_LOCALE_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e706d675-8f89-4253-a4f5-49ad4505a164
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: NUMBER(38,0)
        defaultValue: ""
        description: ""
        name: MERCHANT_NK
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a3743e54-d203-45e1-85b6-003a2cac8dae
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(19)
        defaultValue: ""
        description: ""
        name: TERMINAL_SERIAL_NUMBER
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b4950741-e9af-41a6-9c88-73cd4bd154f0
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: LOCALE_NK
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 617cb06c-b247-46f9-b5ee-f4a0859470a6
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: TERMINAL_DEALLOCATION_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b2e102c9-6500-4d5c-819e-aed2d5db3e4a
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(2)
        defaultValue: ""
        description: ""
        name: PRODUCT_PREFIX_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3f103e95-52f2-4c32-8b32-bcb71745a62b
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: TERMINAL_ALLOCATION_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2f6d8350-4407-4d0b-8bdc-81580f11d796
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: LOCALE_DSS_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f17f636d-1f4f-4610-8c69-482a06e30c2c
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: LOCALE_DSS_END_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 99b12f4d-61c9-491f-9bff-5c8dae7733b9
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: ""
        name: LOCALE_DSS_CURRENT_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e31a0500-3e34-4244-a593-5df15520ff04
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MERCHANT_DSS_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 25773a72-f75d-4571-a8c7-c595bdb0483b
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: MERCHANT_DSS_END_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: be3716c8-dd52-4813-bfd8-99421eefb53a
          stepCounter: cd8fed57-cc21-4016-8697-32cc75c23b66
        config: {}
        dataType: VARCHAR(1)
        defaultValue: ""
        description: ""
        name: MERCHANT_DSS_CURRENT_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_TMS_TERMINAL_CURRENT_ALLOCATION_MROC: 4fa14942-de1e-4dc7-90e1-1ad193c15850
          S_POS_TYPE_MROC_CURRENT: c88cf564-7534-49b2-a674-caf422bbe56c
          S_DMS_TERMINAL_CURRENT_ALLOCATION_MROC: 37fab517-607f-43cd-8e83-95984efddd91
          DMS_TERMINAL_ALLOCATION: ab7e25b3-bd52-47b0-ba68-560a653c3a4a
          S_TMS_TERMINAL_ALLOCATION_LOG_MROC: 3eed6b74-5c7b-478d-a009-17ed4489cf7a
          H_MERCHANT: 340d6188-0752-42c1-adb3-4d3566304a22
          DIM_LOCALE: b6546d83-edf2-4f40-be5b-a9ccf1408d50
          DIM_MERCHANT: 84dffcd0-9390-473b-bb8a-2b250cfdf762
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ this }} (SOURCE_SYSTEM, TERMINAL_ALLOCATION_NK, DIM_MERCHANT_ID, DIM_LOCALE_ID, TERMINAL_SERIAL_NUMBER, MERCHANT_NK, LOCALE_NK, TERMINAL_ALLOCATION_DATE, TERMINAL_DEALLOCATION_DATE, PRODUCT_PREFIX_CODE, LOCALE_DSS_START_DATE, LOCALE_DSS_END_DATE, LOCALE_DSS_CURRENT_FLAG, MERCHANT_DSS_START_DATE, MERCHANT_DSS_END_DATE, MERCHANT_DSS_CURRENT_FLAG) AS WITH TMS AS (
                    SELECT TMS.TERMINAL_ID AS TERMINAL_SERIAL_NUMBER ,
                           LEFT(TMS.TERMINAL_ID, 2) AS TERMINAL_PREFIX_CODE ,
                           PT.POS_TYPE_CODE ,
                           'TMS' AS SOURCE ,
                           TMS.* -- CG: change from BDV current view to RDV table

                      FROM {{ ref('DATAVAULT_RAW_VAULT','S_TMS_TERMINAL_CURRENT_ALLOCATION_MROC') }} TMS
                      JOIN {{ ref('DATAVAULT_BUSINESS_VAULT','S_POS_TYPE_MROC_CURRENT') }} PT
                        ON PT.POS_TYPE_CODE = LEFT(TMS.TERMINAL_ID, 2)
                     WHERE 1=1
                   ),
                   DMS AS (
                    SELECT DMS.TERMINAL_SERIAL_NUMBER AS "TERMINAL_SERIAL_NUMBERA" ,
                           LEFT(DMS.TERMINAL_SERIAL_NUMBER, 2) AS TERMINAL_PREFIX_CODE ,
                           'DMS' AS SOURCE ,
                           DMS.*
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','S_POS_TYPE_MROC_CURRENT') }} PT -- CG: change from BDV current view to RDV table

                      JOIN {{ ref('DATAVAULT_RAW_VAULT','S_DMS_TERMINAL_CURRENT_ALLOCATION_MROC') }} DMS
                        ON TRIM(PT.POS_TYPE_CODE) = TRIM(LEFT(DMS.TERMINAL_SERIAL_NUMBER, 2))
                     WHERE 1=1
                   ),
                   DMS_TERMINAL_ALLOCATION_minmax AS (
                    SELECT 'DMS_' || MERCHANT_NUMBER_ACI || '_' || LOCALE_NUMBER AS NK ,
                           TERMINAL_CHANGED ,
                           MIN(CASE WHEN SRC = 'ALLOCATED' THEN REC_DATETIME ELSE NULL END) AS ALLOCATION_DATE --,MAX(CASE WHEN SRC = 'DEALLOCATED' THEN REC_DATETIME ELSE null END) as DEALLOCATION_DATE
              -- CG: additional logic to compare allocated and deallocated datetime
              ,
                           CASE WHEN MAX(CASE WHEN SRC = 'ALLOCATED' THEN REC_DATETIME ELSE NULL END) IS NULL OR MAX(CASE WHEN SRC = 'ALLOCATED' THEN REC_DATETIME ELSE NULL END) < MAX(CASE WHEN SRC = 'DEALLOCATED' THEN REC_DATETIME ELSE NULL END) THEN MAX(CASE WHEN SRC = 'DEALLOCATED' THEN REC_DATETIME ELSE NULL END)
                                ELSE NULL
                                 END AS DEALLOCATION_DATE
                      FROM {{ ref('DATAVAULT_BUSINESS_VAULT','DMS_TERMINAL_ALLOCATION') }}
                     GROUP BY 1,
                              2
                   ),
                   DMS_TERMINAL_ALLOCATION_STATUS AS (
                    SELECT NK,
                           TERMINAL_CHANGED,
                           ALLOCATION_DATE,
                           DEALLOCATION_DATE ,
                           CASE WHEN DEALLOCATION_DATE < ALLOCATION_DATE                       THEN 'ALLOCATED'
                                WHEN DEALLOCATION_DATE >= ALLOCATION_DATE                      THEN 'DEALLOCATED'
                                WHEN ALLOCATION_DATE IS NOT NULL AND DEALLOCATION_DATE IS NULL THEN 'ALLOCATED'
                                WHEN ALLOCATION_DATE IS NULL AND DEALLOCATION_DATE IS NOT NULL THEN 'DEALLOCATED'
                                WHEN ALLOCATION_DATE IS NULL AND DEALLOCATION_DATE IS NULL     THEN 'ALLOCATED'
                                ELSE 'ERROR'
                                 END AS STATUS
                      FROM DMS_TERMINAL_ALLOCATION_minmax
                   ),
                   TMS_TERMINAL_ALLOCATION_minmax AS (
                    SELECT 'TMS_' || MERCHANT_NUMBER_ACI || '_' || LOCALE_ID AS NK ,
                           DEVICE_ID ,
                           MIN(CASE WHEN ACTION = 'ALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE NULL END) AS ALLOCATION_DATE --,MAX(CASE WHEN ACTION = 'DEALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE null END) as DEALLOCATION_DATE
              -- CG: additional logic to compare allocated and deallocated datetime
              ,
                           CASE WHEN MAX(CASE WHEN ACTION = 'ALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE NULL END) IS NULL OR MAX(CASE WHEN ACTION = 'ALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE NULL END) < MAX(CASE WHEN ACTION = 'DEALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE NULL END) THEN MAX(CASE WHEN ACTION = 'DEALLOCATE' THEN TO_TIMESTAMP(CREATION_TS) ELSE NULL END)
                                ELSE NULL
                                 END AS DEALLOCATION_DATE
                      FROM {{ ref('DATAVAULT_RAW_VAULT','S_TMS_TERMINAL_ALLOCATION_LOG_MROC') }}
                     WHERE DEVICE_SLOT = 0
                     GROUP BY 1,
                              2
                   ),
                   TMS_TERMINAL_ALLOCATION_STATUS AS (
                    SELECT NK,
                           DEVICE_ID,
                           ALLOCATION_DATE,
                           DEALLOCATION_DATE ,
                           CASE WHEN DEALLOCATION_DATE < ALLOCATION_DATE                       THEN 'ALLOCATED'
                                WHEN DEALLOCATION_DATE >= ALLOCATION_DATE                      THEN 'DEALLOCATED'
                                WHEN ALLOCATION_DATE IS NOT NULL AND DEALLOCATION_DATE IS NULL THEN 'ALLOCATED'
                                WHEN ALLOCATION_DATE IS NULL AND DEALLOCATION_DATE IS NOT NULL THEN 'DEALLOCATED'
                                WHEN ALLOCATION_DATE IS NULL AND DEALLOCATION_DATE IS NULL     THEN 'ALLOCATED'
                                ELSE 'ERROR'
                                 END AS STATUS
                      FROM TMS_TERMINAL_ALLOCATION_minmax
                   ),
                   OUTPUT AS (
                    SELECT DISTINCT 'TMS' AS SOURCE_SYSTEM -- (dm.DIM_MERCHANT_ID || '_' ||  L.DIM_LOCALE_ID || '_' || TMS.TERMINAL_SERIAL_NUMBER)::VARCHAR(30)           AS TERMINAL_ALLOCATION_NK
              -- CG: change NK with NKs, remove SKs in NK
              ,
                           L.LOCALE_NK || '_' || TMS.TERMINAL_SERIAL_NUMBER AS TERMINAL_ALLOCATION_NK ,
                           dm.DIM_MERCHANT_ID ,
                           L.DIM_LOCALE_ID ,
                           TMS.TERMINAL_SERIAL_NUMBER AS TERMINAL_SERIAL_NUMBER ,
                           DM.MERCHANT_NK ,
                           L.LOCALE_NK ,
                           NVL(TA.ALLOCATION_DATE,NULL)::DATE AS TERMINAL_ALLOCATION_DATE ,
                           NVL(TA.DEALLOCATION_DATE,NULL)::DATE AS TERMINAL_DEALLOCATION_DATE ,
                           TMS.TERMINAL_PREFIX_CODE AS PRODUCT_PREFIX_CODE ,
                           L.DSS_START_DATE ,
                           L.DSS_END_DATE ,
                           L.DSS_CURRENT_FLAG ,
                           DM.DSS_START_DATE ,
                           DM.DSS_END_DATE ,
                           DM.DSS_CURRENT_FLAG
                      FROM TMS
                      LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','H_MERCHANT') }} m
                        ON TMS.MERCHANT_NUMBER_ACI = m.merchant_id
                      LEFT JOIN TMS_TERMINAL_ALLOCATION_STATUS ta
                        ON 'TMS_' || TMS.MERCHANT_NUMBER_ACI || '_' || TMS.LOCALE_ID = ta.NK
                       AND TMS.TERMINAL_SERIAL_NUMBER::VARCHAR(19) = ta.DEVICE_ID
                      LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_LOCALE') }} L
                        ON L.LOCALE_NK = ('TMS_' || TMS.MERCHANT_NUMBER_ACI || '_' || TMS.LOCALE_ID)::VARCHAR(30)
                      LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }} dm -- on TMS.MERCHANT_NUMBER_ACI = dm.merchant_identification_number
              -- CG: join dim_merchant with dim_locale on SK to avoid merchant SCD dups.

                        ON l.dim_merchant_id=dm.dim_merchant_id -- CG: only get current record

                     WHERE L.dss_current_flag='Y' --and dm.dss_current_flag='Y'

                 UNION ALL SELECT DISTINCT 'DMS' AS SOURCE_SYSTEM ,
                           L.LOCALE_NK || '_' || DMS.TERMINAL_SERIAL_NUMBERA AS TERMINAL_ALLOCATION_NK ,
                           dm.DIM_MERCHANT_ID ,
                           L.DIM_LOCALE_ID ,
                           DMS.TERMINAL_SERIAL_NUMBERA AS TERMINAL_SERIAL_NUMBER ,
                           DM.MERCHANT_NK ,
                           L.LOCALE_NK ,
                           NVL(TA.ALLOCATION_DATE,NULL)::DATE AS TERMINAL_ALLOCATION_DATE ,
                           NVL(TA.DEALLOCATION_DATE,NULL) ::DATE AS TERMINAL_DEALLOCATION_DATE ,
                           DMS.TERMINAL_PREFIX_CODE AS PRODUCT_PREFIX_CODE ,
                           L.DSS_START_DATE ,
                           L.DSS_END_DATE ,
                           L.DSS_CURRENT_FLAG ,
                           DM.DSS_START_DATE ,
                           DM.DSS_END_DATE ,
                           DM.DSS_CURRENT_FLAG
                      FROM DMS
                      LEFT JOIN {{ ref('DATAVAULT_RAW_VAULT','H_MERCHANT') }} m
                        ON DMS.MERCHANT_NUMBER_ACI = m.merchant_id
                      LEFT JOIN DMS_TERMINAL_ALLOCATION_STATUS ta
                        ON 'DMS_' || DMS.MERCHANT_NUMBER_ACI || '_' || DMS.LOCALE_NUMBER = ta.NK
                       AND DMS.TERMINAL_SERIAL_NUMBERA::VARCHAR(19) = ta.TERMINAL_CHANGED
                      LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_LOCALE') }} L
                        ON L.LOCALE_NK = ('DMS_' || DMS.MERCHANT_NUMBER_ACI || '_' || DMS.LOCALE_NUMBER)::VARCHAR(30)
                      LEFT JOIN {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }} dm -- on DMS.MERCHANT_NUMBER_ACI = dm.merchant_identification_number
              -- CG: join dim_merchant with dim_locale on SK to avoid merchant SCD dups.

                        ON l.dim_merchant_id=dm.dim_merchant_id -- CG: only get current record

                     WHERE L.dss_current_flag='Y' --and dm.dss_current_flag='Y'

                   ) SELECT *
              FROM OUTPUT
             WHERE TERMINAL_ALLOCATION_NK IS NOT NULL --STOPGAP fix for missing merchants in 534 table.

               AND merchant_nk IS NOT NULL -- CG: STOPGAP fix for missing merchants in 534 table.
             ;
        dependencies:
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_TMS_TERMINAL_CURRENT_ALLOCATION_MROC
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: S_POS_TYPE_MROC_CURRENT
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_DMS_TERMINAL_CURRENT_ALLOCATION_MROC
          - locationName: DATAVAULT_BUSINESS_VAULT
            nodeName: DMS_TERMINAL_ALLOCATION
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: S_TMS_TERMINAL_ALLOCATION_LOG_MROC
          - locationName: DATAVAULT_RAW_VAULT
            nodeName: H_MERCHANT
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_LOCALE
          - locationName: DATAVAULT_INFORMATION_MART
            nodeName: DIM_MERCHANT
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DATAVAULT_RAW_VAULT','S_TMS_TERMINAL_CURRENT_ALLOCATION_MROC') }}
            {{ ref('DATAVAULT_BUSINESS_VAULT','S_POS_TYPE_MROC_CURRENT') }}
            {{ ref('DATAVAULT_RAW_VAULT','S_DMS_TERMINAL_CURRENT_ALLOCATION_MROC') }}
            {{ ref('DATAVAULT_BUSINESS_VAULT','DMS_TERMINAL_ALLOCATION') }}
            {{ ref('DATAVAULT_RAW_VAULT','S_TMS_TERMINAL_ALLOCATION_LOG_MROC') }}
            {{ ref('DATAVAULT_RAW_VAULT','H_MERCHANT') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_LOCALE') }}
            {{ ref('DATAVAULT_INFORMATION_MART','DIM_MERCHANT') }}
        name: VIEW_DIM_TERMINAL_ALLOCATION
        noLinkRefs: []
  name: VIEW_DIM_TERMINAL_ALLOCATION
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
