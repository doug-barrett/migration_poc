fileVersion: 1
id: b231466b-71df-43d5-b921-cc59b10a4568
name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "#NAME?"
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a6d6b262-a1f1-43b0-893f-4d35c3149c8e
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 85d6f749-a3a9-40f6-8bc0-862e4297d5ee
                stepCounter: a23239e4-617a-4ab9-a42c-1fd9220b7fb3
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d15bf4a-a21b-4a92-8316-12cd7549fd1a
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2950d899-db6e-4ed7-a2c0-f318a5834611
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5e1653cf-6c6d-4cc0-89d1-3c88ae6de329
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: OIL_IN_STORAGE_STKL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fadad108-9dd1-4c43-96cf-098b3afc541e
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1bc36198-dd03-465e-bc1b-7e6da9252916
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8bf7a934-847c-4ba4-945d-5cd239e960ec
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 05c82356-05d3-40e2-87f0-a1e6c0e3e098
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PERCENT_FULL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d6353614-327b-4988-99ab-b4b7ab739ae9
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: VOL_REMAINING
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bf54ff91-1896-4b87-b429-f40a75f5093d
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: LAST_DAILY_PROD_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b780a29d-25ac-4fd2-8077-5dcec6182aa5
                stepCounter: 1fc1f5e3-789a-4d7c-8f90-82afba0e441a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0ec7aac5-18dc-4051-b5c7-8a274b212277
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: LAST_DATE_PROD_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4db47ae5-8d01-4211-8123-f444134ff1c5
                stepCounter: 1fc1f5e3-789a-4d7c-8f90-82afba0e441a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f6adb25-7fdd-432e-b25b-7e4932bcdf10
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: NUM_DAYS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1aeeb265-07fb-4d4e-8277-69a3730c4f59
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE_TANK_TOPS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f0bf1e51-2ef3-4ff3-bac3-5a09a52fd602
          stepCounter: b231466b-71df-43d5-b921-cc59b10a4568
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW: b231466b-71df-43d5-b921-cc59b10a4568
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW') }} AS WITH daily_oil AS (
                    SELECT n.idflownet,
                           e.dttm,
                           round (sum(e.volhcliqcalc), 2) AS daily_produced_oil
                      FROM DS_PRODVIEW.PVT_pvflownetheader n
                     INNER JOIN DS_PRODVIEW.PVT_pvunit u
                        ON u.idflownet = n.idflownet
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND u.name like 'Wandoo Platform'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                        ON l.idrec = e.idrecparent
                     GROUP BY n.idflownet,
                              e.dttm
                   ),
                   storage_tank AS (
                    SELECT t.idflownet,
                           sum(t.volcapacity) capacity,
                           e.dttm,
                           round(sum(e.volhcliqcalc), 2) AS oil_in_storage_stkl,
                           CASE WHEN sum(t.volcapacity) = 0 THEN 0
                                ELSE round(sum(e.volhcliqcalc) / sum(t.volcapacity) * 100, 2)
                                 END AS percent_full,
                           round(sum(t.volcapacity) - SUM (e.volhcliqcalc), 2) AS vol_remaining
                      FROM DS_PRODVIEW.PVT_pvflownetheader n
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON n.idflownet = t.idflownet
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry e
                        ON t.idrec = e.idrecparent
                       AND t.name like 'SC%'
                     GROUP BY t.idflownet,
                              e.dttm
                   ) SELECT d.idflownet,
                   CAST(s.dttm AS date) AS date,
                   s.oil_in_storage_stkl,
                   s.capacity,
                   s.percent_full,
                   s.vol_remaining,
                   d.daily_produced_oil last_daily_prod_oil,
                   CAST(d.dttm AS date) AS last_date_prod_oil,
                   CASE WHEN d.daily_produced_oil = 0 THEN 0
                        ELSE FLOOR (s.vol_remaining / d.daily_produced_oil)
                         END AS num_days,
                   CAST(dateadd(d, CASE WHEN d.daily_produced_oil = 0 THEN 0 ELSE FLOOR (s.vol_remaining / d.daily_produced_oil) END, s.dttm) AS date) AS date_tank_tops,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM storage_tank s,
                   daily_oil d,
                   DS_PRODVIEW.PVT_pvflownetheader h
             WHERE d.dttm = (
                    SELECT max(dttm)
                      FROM daily_oil x
                     WHERE x.daily_produced_oil != 0
                       AND x.dttm <= s.dttm
                   )
               AND d.idflownet = s.idflownet
               AND h.idflownet = s.idflownet
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVFLOWNETHEADER
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVFLOWNETHEADER') }}
        name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
