fileVersion: 1
id: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "#NAME?"
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5745f116-9436-4785-9d4a-699911969fe8
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8f00e8fc-6c61-4ba7-8bae-f81179d23da4
                stepCounter: bd388a52-3d72-4c70-833d-7de7c6a8abd1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c6a4b69-9224-4429-9934-69167189e6d9
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5131aff1-ed1b-4a7b-9369-0c3088b7d384
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18784109-ce76-4c33-a0f5-bcb554e52802
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: OIL_IN_STORAGE_STKL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 49f384a3-2385-408c-aed2-c346d725bacc
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6618541c-6b90-46ae-b43b-1e0bf27405f2
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4840f1ec-1d30-41ce-9a45-5799dfbc546a
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 73eb289c-31ab-4fc9-9004-fb21cb69a082
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PERCENT_FULL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8e84a137-e062-4ed7-bb28-08d927794ed0
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: VOL_REMAINING
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a6972788-d8ff-4506-b960-2eb5898d6c7e
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: LAST_DAILY_PROD_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 875a6748-4391-4d32-8877-e15aaf480536
                stepCounter: a42bf1d3-9077-4deb-a421-72cf454785c2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 558d7d7b-24b6-4eb1-8371-de8332519eaa
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: LAST_DATE_PROD_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e45f2ea-a00d-4d23-b03d-225852c23145
                stepCounter: a42bf1d3-9077-4deb-a421-72cf454785c2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 03dcacff-c633-451d-810e-eb93340a9048
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: NUM_DAYS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9403ada4-52b2-4b7e-a00d-c1ecac79542a
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE_TANK_TOPS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 32672d97-82f4-4f3b-a9cf-b9176085bf98
          stepCounter: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW: 54b380e5-7ebf-4a4b-b2f3-761328e0d788
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW') }} AS WITH daily_oil AS (
                    SELECT n.idflownet,
                           e.dttm,
                           round (sum(e.volhcliqcalc), 2) AS daily_produced_oil
                      FROM DS_PRODVIEW.PVT_pvflownetheader n
                     INNER JOIN DS_PRODVIEW.PVT_pvunit u
                        ON u.idflownet = n.idflownet
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND u.name like 'Wandoo Platform'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                        ON l.idrec = e.idrecparent
                     GROUP BY n.idflownet,
                              e.dttm
                   ),
                   storage_tank AS (
                    SELECT t.idflownet,
                           sum(t.volcapacity) capacity,
                           e.dttm,
                           round(sum(e.volhcliqcalc), 2) AS oil_in_storage_stkl,
                           CASE WHEN sum(t.volcapacity) = 0 THEN 0
                                ELSE round(sum(e.volhcliqcalc) / sum(t.volcapacity) * 100, 2)
                                 END AS percent_full,
                           round(sum(t.volcapacity) - SUM (e.volhcliqcalc), 2) AS vol_remaining
                      FROM DS_PRODVIEW.PVT_pvflownetheader n
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON n.idflownet = t.idflownet
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry e
                        ON t.idrec = e.idrecparent
                       AND t.name like 'SC%'
                     GROUP BY t.idflownet,
                              e.dttm
                   ) SELECT d.idflownet,
                   CAST(s.dttm AS date) AS date,
                   s.oil_in_storage_stkl,
                   s.capacity,
                   s.percent_full,
                   s.vol_remaining,
                   d.daily_produced_oil last_daily_prod_oil,
                   CAST(d.dttm AS date) AS last_date_prod_oil,
                   CASE WHEN d.daily_produced_oil = 0 THEN 0
                        ELSE FLOOR (s.vol_remaining / d.daily_produced_oil)
                         END AS num_days,
                   CAST(dateadd(d, CASE WHEN d.daily_produced_oil = 0 THEN 0 ELSE FLOOR (s.vol_remaining / d.daily_produced_oil) END, s.dttm) AS date) AS date_tank_tops,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM storage_tank s,
                   daily_oil d,
                   DS_PRODVIEW.PVT_pvflownetheader h
             WHERE d.dttm = (
                    SELECT max(dttm)
                      FROM daily_oil x
                     WHERE x.daily_produced_oil != 0
                       AND x.dttm <= s.dttm
                   )
               AND d.idflownet = s.idflownet
               AND h.idflownet = s.idflownet
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVFLOWNETHEADER
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVFLOWNETHEADER') }}
        name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_STORAGE_CELL_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
