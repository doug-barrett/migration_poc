fileVersion: 1
id: 92b30948-bb67-4681-ae24-e3229839f1f9
name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "YTD aggregate usage statistics for each Level1ForceId"
  isMultisource: false
  locationName: OMNIA_PARTNERS_CONNECT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 62b258ab-4702-4a02-9a3c-f793ee15e536
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: Level1ForceId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17834672-715a-4a59-9f1c-aa301aed4e11
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce44b57a-6eb9-4132-bc60-5189f51b797c
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: SUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 66a7efe2-cc10-475e-b8e7-67c6f205015b
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 58e9a3b1-9ebf-436b-ae84-95d931e3d5a9
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: DATE
        defaultValue: ""
        description: DSSMaxTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSMAXTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 419ee032-a332-4660-ab3e-41789ae83683
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: MAX(OPSalesAndRevenue.MaxReceiptDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 414ca665-c2cf-4eea-8253-54da27f8d886
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: DATE
        defaultValue: ""
        description: CurrentYTD_MostRecentTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_MOSTRECENTTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: eedff006-26f5-4ee6-a114-8bca9e60393a
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: MAX(OPSalesAndRevenue.TransactionDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a452eb5-bb1d-4e67-9aa9-0c3eb06c0366
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_MonthsSinceLastTransaction
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_MONTHSSINCELASTTRANSACTION
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: eedff006-26f5-4ee6-a114-8bca9e60393a
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: DATEDIFF(MONTH,MAX(OPSalesAndRevenue.TransactionDate),MAX(OPSalesAndRevenue.MaxReceiptDate))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c7e640da-1717-4762-9731-46c5df9f6a59
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfSuppliersUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFSUPPLIERSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f545bfb6-c2b1-46c4-b179-59743d486207
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.FinancialReportingSupplierName) OVER (PARTITION BY OPSalesAndRevenue.Level1ForceId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2b9796c3-88b8-47b0-bfc1-b4f814471abb
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContractsUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTRACTSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ba802b9c-d505-48f1-8d0e-78850c4ebf67
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.InitialContractId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2bd258cc-dab2-4332-be0c-390935b9dff0
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContractCategoriesUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTRACTCATEGORIESUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 37890ce8-113b-4cf9-88f6-ac0204f2b2e3
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: COUNT(DISTINCT OPSalesAndRevenue.ContractCategory)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: baa68193-d14a-456f-88dd-fcffd62a71a7
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_SumOfSales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_SUMOFSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e8504e6-4204-4589-85e5-227bd76fa4e1
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: SUM(OPSalesAndRevenue.Sales)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c1ded11-73e6-45b7-83ed-e0fde2d976c6
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_SumOfRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_SUMOFREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e91e5021-0002-4847-b986-ba96d4e9850e
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: SUM(OPSalesAndRevenue.Revenue)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f3cfd593-3276-4cae-9ffc-ee935e21570f
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_RankbySales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_RANKBYSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2e8504e6-4204-4589-85e5-227bd76fa4e1
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Sales) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8628f797-7978-4e98-b22c-59863b382744
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_RankbyRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_RANKBYREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e91e5021-0002-4847-b986-ba96d4e9850e
                stepCounter: 5e945f0f-53c6-4f3f-9a98-66603d8a9fde
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Revenue) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b22ab2eb-4351-4cce-9846-7905734f2bb7
          stepCounter: 92b30948-bb67-4681-ae24-e3229839f1f9
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContacts
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTACTS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0c6c95a9-173a-41a1-8a25-a73143fcc576
                stepCounter: 5fa12080-8040-4cbf-96f4-8e9c84eee853
            transform: COUNT (DISTINCT Contact.DimContactKey)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW OPC.vwAggLevel1ForceIdUsageStats_CurrentYTD -- (Level1ForceId, Level1DisplayAccountName, NumOfSuppliersUsed, NumOfContractsUsed, NumOfContractCategoriesUsed, AsOfMaxReceiptDate, MonthsSinceLastTransaction, MostRecentReceiptDate, SumOfSales, SumOfRevenue, SumOfRevenue, RankbyRevenue, RankbySales, NumOfContacts, DSSCreateTime, DSSUpdateTime)
             AS SELECT SalesAndRevenue.Level1ForceId AS Level1ForceId ,
                   SalesAndRevenue.Level1DisplayAccountName AS Level1DisplayAccountName ,
                   SalesAndRevenue.SupplierId AS SupplierId ,
                   COUNT (DISTINCT FinancialReportingSupplierName) AS CurrentYTD_NumOfSuppliersUsed ,
                   COUNT (DISTINCT InitialContractId) AS CurrentYTD_NumOfContractsUsed ,
                   COUNT (DISTINCT ContractCategory) AS CurrentYTD_NumOfContractCategoriesUsed ,
                   MAX(MaxReceiptDate) AS DSSMaxTransactionDate ,
                   DATEDIFF(MONTH, MAX(TransactionDate), MAX(MaxReceiptDate)) AS CurrentYTD_MonthsSinceLastTransaction ,
                   MAX(TransactionDate) AS CurrentYTD_MostRecentTransactionDate ,
                   SUM(Sales) AS CurrentYTD_SumOfSales ,
                   SUM(Revenue) AS CurrentYTD_SumOfRevenue ,
                   RANK() OVER (ORDER BY SUM(REVENUE) DESC) AS CurrentYTD_RankbyRevenue ,
                   RANK() OVER (ORDER BY SUM(SALES) DESC) AS CurrentYTD_RankbySales ,
                   COUNT (DISTINCT DimContactKey) AS CurrentYTD_NumOfContacts ,
                   GETDATE() AS DSSCreateTime ,
                   GETDATE() AS DSSUpdateTime
              FROM OP.OPSalesAndRevenue AS SalesAndRevenue
              LEFT OUTER JOIN Dim.Contact AS Contact
                ON Contact.Level1ForceId = SalesAndRevenue.Level1ForceId -- AND IsCapitalContract = 0 --Exclude capital contracts

             WHERE DATEDIFF(YEAR,TransactionDate,MaxReceiptDate) = 0
             GROUP BY SalesAndRevenue.Level1ForceId,
                      Level1DisplayAccountName,
                      SupplierId;
        dependencies:
          - locationName: DIM
            nodeName: CONTACT
          - locationName: OP
            nodeName: OPSALESANDREVENUE
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DIM','CONTACT') }}
            {{ ref('OP','OPSALESANDREVENUE') }}
        name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
        noLinkRefs: []
  name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
