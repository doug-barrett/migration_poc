fileVersion: 1
id: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: "YTD aggregate usage statistics for each Level1ForceId"
  isMultisource: false
  locationName: OMNIA_PARTNERS_CONNECT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c28735b2-872c-4418-8bcf-980ff1ccd1b2
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: Level1ForceId
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: LEVEL1FORCEID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6ea0e49f-9d46-4faa-8ebd-256264fe362f
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3114c533-7937-4bfc-8705-135b9341ca51
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: SUPPLIERID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e1e61397-1158-4c4a-8086-9eb391293a8b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 56b3deb2-8dda-4d3a-88b1-719bb89c5d63
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: DATE
        defaultValue: ""
        description: DSSMaxTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: DSSMAXTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be651b66-97d5-463d-a1a2-c18b0692cd19
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: MAX(OPSalesAndRevenue.MaxReceiptDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 58efdffb-f2c2-4e9e-9c12-7f2d24269fa4
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: DATE
        defaultValue: ""
        description: CurrentYTD_MostRecentTransactionDate
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_MOSTRECENTTRANSACTIONDATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72d853b1-2c60-429c-9c50-67ef44ca32ff
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: MAX(OPSalesAndRevenue.TransactionDate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9165b0ba-8886-43ca-9743-ea06ee8ecb5b
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_MonthsSinceLastTransaction
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_MONTHSSINCELASTTRANSACTION
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 72d853b1-2c60-429c-9c50-67ef44ca32ff
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: DATEDIFF(MONTH,MAX(OPSalesAndRevenue.TransactionDate),MAX(OPSalesAndRevenue.MaxReceiptDate))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 38cdb957-64b9-4db1-915d-40ec81d6ae5e
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfSuppliersUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFSUPPLIERSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9553a61f-3806-4cd2-8df2-80606567ed33
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.FinancialReportingSupplierName) OVER (PARTITION BY OPSalesAndRevenue.Level1ForceId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b873eb5f-8996-4f9e-8740-93d7c92685a3
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContractsUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTRACTSUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 35d9e7f2-d183-4db2-b711-1b7bfa20d946
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.InitialContractId)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9615f080-d31b-4cf0-b1f9-ce3c962ae7d7
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContractCategoriesUsed
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTRACTCATEGORIESUSED
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ea681605-d658-47db-bca4-bab58a6fe221
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: COUNT(DISTINCT OPSalesAndRevenue.ContractCategory)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 035e7b3d-253b-4418-8259-d92bfc11d631
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_SumOfSales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_SUMOFSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f0ef5b2-912b-4797-864c-c9eea3f6a42c
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: SUM(OPSalesAndRevenue.Sales)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b480c39f-b6c4-4b88-8c45-67e7d4248f19
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_SumOfRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_SUMOFREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be11fa76-dfa3-408b-9073-f4d08cba469b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: SUM(OPSalesAndRevenue.Revenue)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 76b4c396-958c-4507-b1e7-c97edc72594b
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_RankbySales
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_RANKBYSALES
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6f0ef5b2-912b-4797-864c-c9eea3f6a42c
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Sales) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: edc886ba-ac41-45ca-bb2d-3f5b6e65cfa2
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_RankbyRevenue
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_RANKBYREVENUE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: be11fa76-dfa3-408b-9073-f4d08cba469b
                stepCounter: e52965f0-6139-4012-959f-3a038d4752da
            transform: RANK() OVER (ORDER BY SUM(OPSalesAndRevenue.Revenue) DESC)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b3dc613d-f190-4470-9519-6e80584e779b
          stepCounter: 625b2d8d-ca2f-49d3-8a99-118ef5eec5ec
        config: {}
        dataType: INT
        defaultValue: ""
        description: CurrentYTD_NumOfContacts
        hashDetails:
          hashAlgorithm: MD5
        hashedColumns:
          - column: "NULL"
        name: CURRENTYTD_NUMOFCONTACTS
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a73af37f-395a-43e2-ad1e-46c2fedc925a
                stepCounter: e165c76e-6a45-4567-817a-c8ecf377ecd2
            transform: COUNT (DISTINCT Contact.DimContactKey)
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW OPC.vwAggLevel1ForceIdUsageStats_CurrentYTD -- (Level1ForceId, Level1DisplayAccountName, NumOfSuppliersUsed, NumOfContractsUsed, NumOfContractCategoriesUsed, AsOfMaxReceiptDate, MonthsSinceLastTransaction, MostRecentReceiptDate, SumOfSales, SumOfRevenue, SumOfRevenue, RankbyRevenue, RankbySales, NumOfContacts, DSSCreateTime, DSSUpdateTime)
             AS SELECT SalesAndRevenue.Level1ForceId AS Level1ForceId ,
                   SalesAndRevenue.Level1DisplayAccountName AS Level1DisplayAccountName ,
                   SalesAndRevenue.SupplierId AS SupplierId ,
                   COUNT (DISTINCT FinancialReportingSupplierName) AS CurrentYTD_NumOfSuppliersUsed ,
                   COUNT (DISTINCT InitialContractId) AS CurrentYTD_NumOfContractsUsed ,
                   COUNT (DISTINCT ContractCategory) AS CurrentYTD_NumOfContractCategoriesUsed ,
                   MAX(MaxReceiptDate) AS DSSMaxTransactionDate ,
                   DATEDIFF(MONTH, MAX(TransactionDate), MAX(MaxReceiptDate)) AS CurrentYTD_MonthsSinceLastTransaction ,
                   MAX(TransactionDate) AS CurrentYTD_MostRecentTransactionDate ,
                   SUM(Sales) AS CurrentYTD_SumOfSales ,
                   SUM(Revenue) AS CurrentYTD_SumOfRevenue ,
                   RANK() OVER (ORDER BY SUM(REVENUE) DESC) AS CurrentYTD_RankbyRevenue ,
                   RANK() OVER (ORDER BY SUM(SALES) DESC) AS CurrentYTD_RankbySales ,
                   COUNT (DISTINCT DimContactKey) AS CurrentYTD_NumOfContacts ,
                   GETDATE() AS DSSCreateTime ,
                   GETDATE() AS DSSUpdateTime
              FROM OP.OPSalesAndRevenue AS SalesAndRevenue
              LEFT OUTER JOIN Dim.Contact AS Contact
                ON Contact.Level1ForceId = SalesAndRevenue.Level1ForceId -- AND IsCapitalContract = 0 --Exclude capital contracts

             WHERE DATEDIFF(YEAR,TransactionDate,MaxReceiptDate) = 0
             GROUP BY SalesAndRevenue.Level1ForceId,
                      Level1DisplayAccountName,
                      SupplierId;
        dependencies:
          - locationName: DIM
            nodeName: CONTACT
          - locationName: OP
            nodeName: OPSALESANDREVENUE
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('DIM','CONTACT') }}
            {{ ref('OP','OPSALESANDREVENUE') }}
        name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
        noLinkRefs: []
  name: OPC_VWAGGLEVEL1FORCEIDUSAGESTATS_CURRENTYTD
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
