fileVersion: 1
id: ab9815f4-cd54-416c-9b1b-efae418ca980
name: S_NEXUS_VISIT_05
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 21fdd8a3-74d7-44a4-8117-34c976253c45
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: OPNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 57c9c4f7-1da2-454b-b0cc-32a0c72d9198
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 819e8a05-8f7e-46fd-88b7-d4a14a5ed1be
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: IFNULL(opproca.proccode,opprocb.proccode)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 387b294b-1bbb-4a22-b39e-ef832b57cc4c
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OPDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 931ef0a5-6a28-4d07-9324-d2ecbb30a708
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f0c5e6e-9433-4b21-8548-c2dc9d1fe1d4
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: THEATRE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c8fb342a-29f8-4de8-81a0-b3c8d405c979
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 61f69a67-7df9-405f-8aac-dbecf55e40e9
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: HOSPNUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fd9087b0-e1c1-484b-8332-d6058069daf2
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 13f83cab-ae3a-4d48-96c6-3305b0d24e90
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: NHSNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 69df211a-fa12-4c98-83ca-7b7bc70d4c88
                stepCounter: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7c3c65d6-b52b-4e8f-abc3-08423aade94f
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: THEATRE_START_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: IFNULL(s_nexus_eventcode_sfor.eventdate,ds_nexus_OPS.opdate)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ef79afbb-3204-43a0-8953-c25ff91095b9
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: SPECIALTYCODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 926ce874-e078-4c47-a95e-e3712f97ed9e
                stepCounter: e909397e-fafc-435f-8cd2-cff7689648c4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a85f4fcf-2008-4bb3-9bb1-a59b5ac3351b
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: CONSCODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7b1d5272-802f-45c6-8f33-b004d5d8f79e
                stepCounter: 0e5d1910-611d-4f26-a64a-4189199510be
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d31d481-5ccc-4b80-b27a-c8574d773d19
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PATNT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5c1d681d-fba6-4c9e-bfdf-cc4bbe97e046
                stepCounter: 34c6fd4e-f463-4453-bad1-3a1d762d3caa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 66e1a9bb-f500-4717-b03c-99c5ac55e3b3
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: SPECT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 819c41d7-96ae-4a82-8767-97972861b562
                stepCounter: ac3ba691-d98e-4eaf-90fd-8ead76242a08
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: edc99b61-841e-4c65-9a3b-7570a8915f3d
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DECIMAL(10)
        defaultValue: ""
        description: ""
        name: PROCA_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17ee3590-ed47-4b73-b22e-a6494f78e113
                stepCounter: d42ee6db-29e1-4d7b-88a3-e45c058528e1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f39a662c-8fac-468c-8231-30a8f88f1dc4
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: NUMERIC(10)
        defaultValue: ""
        description: ""
        name: WLIST_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 806a4e9f-5dd4-486a-af2b-1432704fc0e6
                stepCounter: 16cd8790-0223-46de-ba69-e33922cacb61
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 18f625f2-97e8-4655-951e-22768daa8fea
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EVENTDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bda3774e-fa8a-44b2-bcc8-7b454d5ce13d
                stepCounter: 02d92502-7f3b-4aea-b7d7-37d184f86c76
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7349756b-de68-487e-8b06-19c2f376cf7e
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: INTO_THEATRE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: facd06ed-09ef-4daf-8e54-8c4143969228
                stepCounter: 73bc9602-c726-4c30-b456-132b6cefe2e0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 07c03963-b3e2-4c35-8485-0d82d93725e1
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: SESSION_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b80f7694-b170-4808-a9bf-e5d64d58ef9c
                stepCounter: 4b43ba77-04db-48ba-a6bc-cb68f677d59a
            transform: ds_nexus_FLEXSESS.sessdate+ds_nexus_FLEXSESS.endtime
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 02897f50-5125-4add-86c2-c50983d1a693
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ARRIVED_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e16c4c9b-d27f-495f-9002-fafb24344212
                stepCounter: 6f9c78f4-cbbc-4f74-9f05-751179faddda
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 97ce8d51-3402-4230-a6db-8d8625dbbfdf
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: ANAESTHETIC_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 93ab0ce7-ede6-44e8-bc4e-146a0d35b26e
                stepCounter: cffe2cda-0840-4171-8e3f-e78c5445e145
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0eb3c6b3-4b7a-46b2-a682-0a77c0e5d13e
          stepCounter: ab9815f4-cd54-416c-9b1b-efae418ca980
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          DS_NEXUS_OPS: 86ac4af0-de3e-4f22-9a31-c3e62b75355a
          DS_NEXUS_FLEXCONS: 0e5d1910-611d-4f26-a64a-4189199510be
          S_NEXUS_EVENTCODE_SFOR: 02d92502-7f3b-4aea-b7d7-37d184f86c76
          S_NEXUS_EVENTCODE_STAN: cffe2cda-0840-4171-8e3f-e78c5445e145
          DS_NEXUS_DBO_SPECIALTY: e909397e-fafc-435f-8cd2-cff7689648c4
          DS_PIMS_PATIENTS: 34c6fd4e-f463-4453-bad1-3a1d762d3caa
          DS_PIMS_SPECIALTIES: ac3ba691-d98e-4eaf-90fd-8ead76242a08
          DS_PIMS_PROF_CARERS: d42ee6db-29e1-4d7b-88a3-e45c058528e1
          S_PIMS_WLIST_NEXUS: 16cd8790-0223-46de-ba69-e33922cacb61
          S_NEXUS_EVENTCODE_INTH: 73bc9602-c726-4c30-b456-132b6cefe2e0
          S_NEXUS_EVENTCODE_ARRV: 6f9c78f4-cbbc-4f74-9f05-751179faddda
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: DS_NEXUS_OPS
          - locationName: TGT
            nodeName: DS_NEXUS_FLEXCONS
          - locationName: TGT
            nodeName: S_NEXUS_EVENTCODE_SFOR
          - locationName: TGT
            nodeName: S_NEXUS_EVENTCODE_STAN
          - locationName: TGT
            nodeName: DS_NEXUS_DBO_SPECIALTY
          - locationName: TGT
            nodeName: DS_PIMS_PATIENTS
          - locationName: TGT
            nodeName: DS_PIMS_SPECIALTIES
          - locationName: TGT
            nodeName: DS_PIMS_PROF_CARERS
          - locationName: TGT
            nodeName: S_PIMS_WLIST_NEXUS
          - locationName: TGT
            nodeName: S_NEXUS_EVENTCODE_INTH
          - locationName: TGT
            nodeName: S_NEXUS_EVENTCODE_ARRV
        join:
          joinCondition: |-
            FROM {{ ref('TGT','DS_NEXUS_OPS') }}
              LEFT OUTER JOIN ds_nexus_FLEXSESS
                ON ds_nexus_OPS.theatre = ds_nexus_FLEXSESS.theatre
               AND ds_nexus_OPS.opsession = ds_nexus_FLEXSESS.flexsess_session
               AND ds_nexus_OPS.opdate = ds_nexus_FLEXSESS.sessdate
              LEFT OUTER JOIN {{ ref('TGT','DS_NEXUS_FLEXCONS') }}
                ON ds_nexus_FLEXSESS.flexsess_session = ds_nexus_FLEXCONS.flexcons_session
               AND ds_nexus_FLEXSESS.theatre = ds_nexus_FLEXCONS.theatre
               AND ds_nexus_FLEXSESS.sessdate = ds_nexus_FLEXCONS.sessdate
              LEFT OUTER JOIN {{ ref('TGT','S_NEXUS_EVENTCODE_SFOR') }}
                ON ds_nexus_OPS.opnumber = s_nexus_eventcode_sfor.opnumber
               AND s_nexus_eventcode_sfor.rnsforevent = 1
              LEFT OUTER JOIN {{ ref('TGT','S_NEXUS_EVENTCODE_STAN') }}
                ON ds_nexus_OPS.opnumber = s_nexus_eventcode_stan.opnumber
               AND s_nexus_eventcode_stan.rnsforevent = 1
              LEFT OUTER JOIN {{ ref('TGT','DS_NEXUS_DBO_SPECIALTY') }}
                ON ds_nexus_FLEXSESS.specialty = ds_nexus_dbo_SPECIALTY.theatrespecialtycode
              JOIN {{ ref('TGT','DS_PIMS_PATIENTS') }}
                ON ds_nexus_OPS.hospnumber = ds_pims_patients.pasid
              LEFT OUTER JOIN {{ ref('TGT','DS_PIMS_SPECIALTIES') }}
                ON CASE WHEN ds_nexus_dbo_SPECIALTY.specialtycode = 'S60' THEN 'PLASU'
                        ELSE ds_nexus_dbo_SPECIALTY.specialtycode
                         END = ds_pims_specialties.main_ident
              LEFT OUTER JOIN {{ ref('TGT','DS_PIMS_PROF_CARERS') }}
                ON ds_nexus_FLEXCONS.conscode = ds_pims_prof_carers.main_ident
               AND IFNULL(ds_nexus_OPS.opdate,s_nexus_eventcode_sfor.eventdate) BETWEEN ds_pims_prof_carers.start_Dttm AND IFNULL(ds_pims_prof_carers.end_dttm,getdate())
              LEFT OUTER JOIN {{ ref('TGT','S_PIMS_WLIST_NEXUS') }}
                ON ds_nexus_OPS.nhsno = 'H'+cast(s_pims_wlist_nexus.prvsp_refno AS varchar)
              LEFT OUTER JOIN (
                    SELECT OPNUMBER,
                           CASE WHEN charindex('-',PROCCODE) = 0 THEN PROCCODE
                                ELSE SUBSTRING(PROCCODE,1,charindex('-',PROCCODE)-1)
                                 END proccode
                      FROM ds_nexus_OPPROC
                     WHERE PROCNUMBER = 1
                       AND proctype = 'A'
                   ) opproca
                ON ds_nexus_ops.opnumber = opproca.opnumber
              LEFT OUTER JOIN (
                    SELECT OPNUMBER,
                           CASE WHEN charindex('-',PROCCODE) = 0 THEN PROCCODE
                                ELSE SUBSTRING(PROCCODE,1,charindex('-',PROCCODE)-1)
                                 END proccode
                      FROM ds_nexus_OPPROC
                     WHERE PROCNUMBER = 1
                       AND proctype <> 'A'
                   ) opprocb
                ON ds_nexus_ops.opnumber = opprocb.opnumber
              LEFT OUTER JOIN {{ ref('TGT','S_NEXUS_EVENTCODE_INTH') }}
                ON ds_nexus_OPS.opnumber = s_nexus_eventcode_inth.opnumber
               AND s_nexus_eventcode_inth.rnsforevent = 1
              LEFT OUTER JOIN {{ ref('TGT','S_NEXUS_EVENTCODE_ARRV') }}
                ON ds_nexus_OPS.opnumber = s_nexus_eventcode_arrv.opnumber
               AND s_nexus_eventcode_arrv.rnsforevent = 1
        name: S_NEXUS_VISIT_05
        noLinkRefs: []
  name: S_NEXUS_VISIT_05
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
