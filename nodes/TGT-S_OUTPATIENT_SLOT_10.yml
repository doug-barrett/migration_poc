fileVersion: 1
id: c84a73e7-c410-440a-bbc7-9b0e810afff8
name: S_OUTPATIENT_SLOT_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Get the number of bookings allowed for each visit code in each time slot. There will be one row for each time slot, visit code combination."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9f005bf4-03b4-40f0-8da3-79a4ea67b58d
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier for the outpatient session.
        name: OUTPATIENT_SESSION_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7d9f8af9-6c05-4b3b-a680-e4b82ec34933
                stepCounter: 99dfb622-7f1c-4589-b7c3-b8e927d40a26
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 21b3d59a-3501-488b-9b8a-3eb64e6b7be3
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier of the outpatient clinic.
        name: OUTPATIENT_CLINIC_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dff48b7b-61cb-4ecb-8cc6-f8cb3e7a0ef4
                stepCounter: 99dfb622-7f1c-4589-b7c3-b8e927d40a26
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 64b794a7-1c1c-4054-ae0c-c779fdea256b
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Unique identifier for the slot within an outpatient session.
        isBusinessKey: true
        name: OUTPATIENT_SLOT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d9b442cc-1b1e-4e64-9364-431cd5f64efe
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 138d3536-6a32-484e-9a26-74ea5cb64730
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Start date and time of the session slot.
        name: SLOT_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 17d0893f-f1ce-4db1-b1d5-677c6f702863
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55143fda-ad6d-4f5c-aada-ca254ec07c7d
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: End date and time of the session slot.
        name: SLOT_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 27d914e9-95d6-4af3-93dc-a90a70c6e97e
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 62d09497-8564-4e26-9157-db4306b4e8f0
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Duration of a session slot in minutes.
        name: SLOT_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 88f60dbb-a2e3-4140-987d-aa6035dfefa0
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 54b8c0c6-218f-49ca-9751-8425cd0badeb
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: ""
        name: SLOT_CANCELLED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d96b7eb4-0863-4b34-84e0-3e921dc30d57
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: |-
              CASE WHEN ds_pims_service_point_time_slots.cancel_dttm IS NULL THEN 0
                          ELSE 1
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 70acc71e-221d-4726-a65c-e0331cd221e1
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Number of appointments available in the slot.
        name: SLOT_AVAILABLE_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b279d8a7-52f1-4700-b968-9f3c22c23e55
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aede122f-5b31-407a-ad47-a45293a28d5d
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Number of appointments booked in the slot.
        name: SLOT_BOOKING_COUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cc7af7a7-9f7f-426f-bf00-a90bd7f21614
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 540d0c66-b113-4bff-bc77-9596b149dad3
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TSTAT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6ab45e0b-c5d9-41fd-9c8e-70f409b90709
                stepCounter: a6d2459c-3a81-4cc6-a8ef-69bc595a759f
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 811adacb-6e68-43b0-b62a-35a93df288c5
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: Possible values include AVAIL (Available), NOLAV (No longer available), BUKED (Booked), RESRV (Reserved).
        name: SLOT_STATUS_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fbb01e3b-4612-47c8-9a4a-5d6abddc60ef
                stepCounter: 06fa4241-360c-43d0-8e4a-8b860f92fc09
            transform: ref1.main_code
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 59e23920-c7d2-4c78-ae12-2d562d98704c
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: 'Set to 1 if the slot is booked and so no longer available.  '
        name: SLOT_BOOKED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fbb01e3b-4612-47c8-9a4a-5d6abddc60ef
                stepCounter: 06fa4241-360c-43d0-8e4a-8b860f92fc09
            transform: |-
              CASE WHEN ref1.main_code = 'BUKED' THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0dc2199b-a54d-4ae0-9797-1362b801a0c6
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the slot has a forced booking i.e. slot not normally available but has been booked anyway. Such bookings have no visit type.
        name: FORCED_BOOKING_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fbb01e3b-4612-47c8-9a4a-5d6abddc60ef
                stepCounter: 06fa4241-360c-43d0-8e4a-8b860f92fc09
            transform: |-
              CASE WHEN ref2.rfval_refno IS NULL THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 43449e45-189a-432e-8d32-a28661d2ab0e
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: SORCE_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d53588ac-942f-4734-9a07-cc82ff1d24f0
                stepCounter: dbce8ba5-082f-4aca-8a70-45c0df72387c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d154e802-88b2-4b36-8dda-9c098e055bcc
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: RULES_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3a45e642-1a5e-42c5-9992-4a408dc8b3cb
                stepCounter: 953599df-803e-40fc-a10e-e0638789a041
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4f8270db-4c87-4434-9b3b-20ac2d733d0a
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: VISIT_REFNO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 97aebd53-8994-45f0-9fea-1b3150a90054
                stepCounter: 06fa4241-360c-43d0-8e4a-8b860f92fc09
            transform: ref2.rfval_refno
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8751f6a4-baf7-48b1-b0c3-70abc15b433c
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: VISIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fbb01e3b-4612-47c8-9a4a-5d6abddc60ef
                stepCounter: 06fa4241-360c-43d0-8e4a-8b860f92fc09
            transform: ref2.main_code
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aafdac63-7d94-452b-8168-1345eef892e0
          stepCounter: c84a73e7-c410-440a-bbc7-9b0e810afff8
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: DS_PIMS_SERVICE_POINT_SESSIONS
        join:
          joinCondition: |-
            FROM ds_pims_service_point_sessions
              JOIN ds_pims_service_point_time_slots
                ON ds_pims_service_point_time_slots.spssn_refno = ds_pims_service_point_sessions.spssn_refno
              JOIN ds_pims_reference_values ref1
                ON ref1.rfval_refno = ds_pims_service_point_time_slots.tstat_refno
               AND ref1.rfvdm_code = 'TSTAT'
              LEFT OUTER JOIN ds_pims_dependant_rules
                ON ds_pims_dependant_rules.sorce_refno = ds_pims_service_point_time_slots.spslt_refno
               AND ds_pims_dependant_rules.sorce_code = 'SPSLT'
              LEFT OUTER JOIN l_pims_rules
                ON l_pims_rules.rules_refno = ds_pims_dependant_rules.rules_refno
               AND l_pims_rules.code = 'Visit'
              LEFT OUTER JOIN ds_pims_reference_values ref2
                ON ref2.rfval_refno = ds_pims_dependant_rules.value
               AND ref2.rfvdm_code = 'VISIT'
             WHERE -- Slots that have been linked to a valid visit type   ((ds_pims_dependant_rules.sorce_code = 'SPSLT' AND ref2.rfval_refno IS NOT NULL)    -- Slots that have forced bookings i.e. no valid visit type but booked anyway  OR (ds_pims_service_point_time_slots.noof_bookings > 0 AND ds_pims_dependant_rules.sorce_code IS NULL))
        name: S_OUTPATIENT_SLOT_10
        noLinkRefs: []
  name: S_OUTPATIENT_SLOT_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
