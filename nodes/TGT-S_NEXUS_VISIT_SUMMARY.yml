fileVersion: 1
id: 839e185e-0d30-4073-b55f-88b80bf051f1
name: S_NEXUS_VISIT_SUMMARY
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e57a3f8b-38f0-467d-b0d5-8e7b31bd8d00
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_PATIENT_OUT_OF_THEATRE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: MAX(s_nexus_visit_30.outof_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e56cd422-0d40-4973-af08-8e9e83cc4f46
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: THEATRE_SESSION_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 18f1881f-1e49-45e6-ac05-3bf18b4a1770
                stepCounter: 09b971a8-88db-4267-bb87-de63ccb4416c
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3dd4a3d5-211a-4717-baba-89c0bf6fd860
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: CHAR(1)
        defaultValue: ""
        description: ""
        name: AM_LONG_DELAY_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN RIGHT(CONVERT(VARCHAR,CONVERT(TIME,MAX(s_nexus_visit_30.sent_for_date)),0),2) = 'AM' AND RIGHT(CONVERT(VARCHAR,CONVERT(TIME,MAX(s_nexus_visit_30.session_end_date)),0),2) = 'AM' AND CONVERT(TIME,MAX(s_nexus_visit_30.patient_ready_date),120) > CONVERT(TIME,'09:30:00') THEN 'Y'
                          ELSE 'N'
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 90ba4335-f9ef-4c11-95dc-abc1956852e2
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: VARCHAR(12)
        defaultValue: ""
        description: ""
        name: FIRST_THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: MIN(s_nexus_visit_30.first_theatre_visit_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3199541e-2591-48fd-bdfc-297cb6cf328a
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_BOOKED_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: min(s_nexus_visit_30.booked_start)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0574515f-ddf9-4487-aee5-48762ebb97eb
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_PATIENT_INTO_POSTOP_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: max(s_nexus_visit_30.into_postop_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 50270067-768c-4b53-b00f-626e9509cf09
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: LAST_BOOKED_END_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: max(s_nexus_visit_30.booked_end)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d0144564-69ca-4fe8-83ba-bb1da6823574
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_PATIENT_READY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: MIN(IFNULL(s_nexus_visit_30.patient_ready_date,s_nexus_visit_30.into_theatre_date))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f15bd786-290e-4fd5-a731-3a13291d2457
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: FIRST_PATIENT_INTO_THEATRE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: MIN(s_nexus_visit_30.into_theatre_date)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a0b6a7bf-5db9-4bba-a22c-b044148b16bb
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: CANCELLED_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.status = 'CANC' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9dc2b60b-223b-4c5f-84ff-388ffdb35d17
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ACTUAL_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.status = 'FINI' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f49586fc-07aa-432c-9f03-3ecbea90af2c
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: VARCHAR(12)
        defaultValue: ""
        description: ""
        name: LAST_THEATRE_VISIT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: MAX(s_nexus_visit_30.last_theatre_visit_encounter_id)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cccbdcc6-f54c-4580-b22e-40e66af5b003
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PLANNED_OPERATIONS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: Sum(CASE WHEN s_nexus_visit_30.status = 'PEND' THEN 1 ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c77cfa6-af3b-4683-a409-21f031962f77
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: LISTS_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: |-
              CASE WHEN SUM(CASE WHEN s_nexus_visit_30.status <> 'CANC' THEN DATEDIFF(mi,s_nexus_visit_30.visitdate,s_nexus_visit_30.outof_recovery_date) ELSE 0 END) < 300 THEN 1
                          ELSE 2
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c953c22b-a0ba-4a70-8f46-24bf9d3ebb74
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: VISIT_TOTAL_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.theatre_visit_duration BETWEEN 0 AND 999999 AND s_nexus_visit_30.status <> 'CANC' THEN s_nexus_visit_30.theatre_visit_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8209517d-1798-450d-8626-c8ba9a2f2edb
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: KNIFE_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.status <> 'CANC' THEN s_nexus_visit_30.knife_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e686239-95ae-4bdd-ab08-eb168cf58329
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: IN_THEATRE_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.status <> 'CANC' THEN s_nexus_visit_30.in_theatre_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 663ef75f-f42c-4bae-bf0f-2c04e6096980
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: AVERAGE_TURNAROUND_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: AVG(CASE WHEN s_nexus_visit_30.status <> 'CANC' AND s_nexus_visit_30.session_theatre_visit_seq_num > 1 THEN CASE WHEN DATEDIFF(mi,IFNULL(s_nexus_visit_30.previous_outof_theatre_date,s_nexus_visit_30.into_theatre_date),s_nexus_visit_30.into_theatre_date) < 0 THEN 0 ELSE DATEDIFF(mi,IFNULL(s_nexus_visit_30.previous_outof_theatre_date,s_nexus_visit_30.into_theatre_date),s_nexus_visit_30.into_theatre_date) END ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9d4f85b2-b34e-4da8-b12f-4db94cba4998
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: anaesthetic_duration
        name: ANAESTHETIC_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: SUM(CASE WHEN s_nexus_visit_30.status <> 'CANC' THEN s_nexus_visit_30.anaesthetic_duration ELSE 0 END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8c1efedd-f65d-4de4-8162-5083dbd1de35
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: surgeon_duration
        name: SURGEON_DURATION
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: sum(s_nexus_visit_30.surgeon_duration)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1b762346-17e9-4efb-82cd-ff4cb174e3dd
          stepCounter: 839e185e-0d30-4073-b55f-88b80bf051f1
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          S_NEXUS_VISIT_30: 09b971a8-88db-4267-bb87-de63ccb4416c
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_NEXUS_VISIT_30
        join:
          joinCondition: |-
            FROM {{ ref('TGT','S_NEXUS_VISIT_30') }}
             GROUP BY s_nexus_visit_30.theatre_session_reference_no
        name: S_NEXUS_VISIT_SUMMARY
        noLinkRefs: []
  name: S_NEXUS_VISIT_SUMMARY
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
