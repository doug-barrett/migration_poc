fileVersion: 1
id: e5d02d7d-f72b-45b5-9660-f8a248b65317
name: S_FUNDED_SERVICE_NASC_10
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Join the data item details in NASC_10 to other SWE load tables and data stores providing info about patient programmes, tasks etc."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ed85bf71-55e7-4e9c-aec2-d90d1855302d
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: NUMERIC(18)
        defaultValue: ""
        description: ""
        name: FORM_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b40a7ac1-587e-432c-bab5-f5d2f766a7fa
                stepCounter: 386fb5c2-4fa8-4e07-85e4-2490ff707b77
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fc9254ef-dd22-4e8f-ab8f-e6ba7fae0341
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: NUMERIC(18)
        defaultValue: ""
        description: ""
        name: PATIENT_PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1dc01ac2-a10c-49ca-90eb-ed32df22cd74
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0fd87695-bb18-4a09-9d5e-f58d37012799
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: PATIENT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5a18089a-9eba-4f50-8eb8-76bbb9e68a12
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ebe86be2-e175-4ff1-8260-2b143d6a3ba8
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: NUMERIC(18)
        defaultValue: ""
        description: ""
        name: PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7b91ef87-beb6-45b7-8ae3-d8d41ee24fae
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 235ee677-71c8-4fbc-b9fe-6160c5d6013d
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: STREAM_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 16991d8f-e34e-4125-9391-9a476bbca229
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1cc764ca-0893-4a6e-b25f-db15b868e5c7
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: patient_programme_status
        name: PROGRAMME_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 68ae7343-6636-410f-8f54-d96cc55f2e09
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7eee5676-2a26-4199-b0b5-f681d2e6ac78
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9bc6297d-00ed-48bb-952b-24c3544e139e
                stepCounter: 289da868-88f5-4e61-a975-de3b30517956
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 85aae632-8618-496c-a11b-6e615e5052af
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ad789b0-1af1-49e5-b06b-e698b88f786b
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d7d250aa-4221-40d7-bcf1-2f694d81f6e3
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: NUMERIC(18)
        defaultValue: ""
        description: ""
        name: TASK_TYPE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b815db37-bca6-45b6-b987-92372b9c1d7f
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e06f81f8-4d12-401c-a14a-5e16aa447b27
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TASK_TYPE_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ddd4dc20-39dc-42a8-8777-b95d24e4e093
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 662868fb-61d4-4f2a-b719-1e29d54a93eb
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: BIT
        defaultValue: ""
        description: ""
        name: SUPPORT_PLAN_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ddd4dc20-39dc-42a8-8777-b95d24e4e093
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: |-
              CASE WHEN l_cdsswe_task_type.name = 'Support Plan' THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a81b63e4-1e82-407b-ac40-5aaf4e7dce59
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: SMALLINT
        defaultValue: ""
        description: Numbers non Support Plan tasks for each Stream ID in descending task_request_id order.
        name: TASK_ROW_NUM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ddd4dc20-39dc-42a8-8777-b95d24e4e093
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: |-
              CASE WHEN l_cdsswe_task_type.name = 'Support Plan' THEN NULL
                          ELSE ROW_NUMBER() OVER(PARTITION BY ds_cdsswe_patient_programme.stream_id, CASE WHEN l_cdsswe_task_type.name = 'Support Plan' THEN 1 ELSE 0 END ORDER BY ds_cdsswe_task_request.taskrequest_id DESC)
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9b0ad346-bc85-4389-8c23-57f482639ce2
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2873ec7c-2c60-4c9b-8393-65dd1f9c1075
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 546042f4-b9e6-4590-9067-f3c3a735e3c2
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0f2e33ef-8ae5-4e28-9dbc-6e3089022f15
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fa70920b-24b1-47a0-bd8e-bc43a62df707
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: SERVICES_OBSERVATION_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 039fc9c6-3aea-4530-9639-ddb396f8bbf0
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Services' THEN ds_cdsswe_atomic_observation.atomic_observation_id ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 957a2d42-7d43-435c-9d8f-e5d2a6ea1d3f
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: PLACEMENT_SOURCE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Placement Source' THEN ds_cdsswe_atomic_observation.value ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 633431b3-47de-48fa-ab17-54674c942080
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: PLACEMENT_SOURCE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc4bf488-c591-41c9-9059-35501c1024c1
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Placement Source' THEN ds_cdsswe_atomic_observation.description ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e94e594-20c1-4270-9a35-60d80309e7c3
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: PLACEMENT_TYPE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fc4bf488-c591-41c9-9059-35501c1024c1
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Placement Type' THEN ds_cdsswe_atomic_observation.description ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5e920ccd-fcd6-4066-a0df-5a7cd289a9ca
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IS_RESIDENT_PLACEMENT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Is Residential Placement' THEN ds_cdsswe_atomic_observation.value ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3b4eb2c2-3f0c-4a63-ae01-456ad625996e
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: EXIT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Exit Date' THEN ds_cdsswe_atomic_observation.value ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 845a5595-6818-4bae-ad95-8246ae597f78
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: EXIT_REASON
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: MAX(CASE WHEN l_cdsswe_datatype.name = 'Exit Reason' THEN ds_cdsswe_atomic_observation.value ELSE NULL END)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 791f26c0-f9b3-4c41-af76-dda76f2b5210
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: NUMERIC(18)
        defaultValue: ""
        description: Dummy column added so that join to l_cdsswe_datatype is visible in Red meta data.
        name: DATATYPE_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6b5250f5-e851-4884-8fb9-664204190e69
                stepCounter: dab02aa8-85dd-4a28-9b0b-c79c6ada8efa
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0d61fb3e-229c-48cc-8fc7-bede90a3e431
          stepCounter: e5d02d7d-f72b-45b5-9660-f8a248b65317
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: L_CDSSWE_FORM
        join:
          joinCondition: |-
            FROM l_cdsswe_form
              JOIN ds_cdsswe_observation_report
                ON ds_cdsswe_observation_report.form_id = l_cdsswe_form.form_id
              JOIN ds_cdsswe_task_request
                ON ds_cdsswe_observation_report.taskrequest_id = ds_cdsswe_task_request.taskrequest_id
              JOIN l_cdsswe_task_type
                ON ds_cdsswe_task_request.tasktype_id = l_cdsswe_task_type.tasktype_id
              JOIN ds_cdsswe_patient_programme
                ON ds_cdsswe_task_request.patient_programme_id = ds_cdsswe_patient_programme.patient_programme_id
              JOIN l_cdsswe_patient
                ON ds_cdsswe_patient_programme.patient_id = l_cdsswe_patient.patient_id
              JOIN ds_cdsswe_atomic_observation
                ON ds_cdsswe_observation_report.observation_report_id = ds_cdsswe_atomic_observation.observation_report_id
              JOIN l_cdsswe_datatype
                ON ds_cdsswe_atomic_observation.datatype_id = l_cdsswe_datatype.datatype_id
             WHERE 1=1
               AND l_cdsswe_task_type.name IN ('Support Plan','Allocation Assessment','Needs Assessment','Review')
               AND l_cdsswe_datatype.name IN ('Services', 'Placement Type', 'Placement Source', 'Is Residential Placement', 'Exit Date', 'Exit Reason')
               AND ds_cdsswe_observation_report.record_status = 'A'
               AND (l_cdsswe_task_type.name = 'Support Plan' AND ds_cdsswe_observation_report.observation_report_status IN ('A','F','S') OR (l_cdsswe_task_type.name <> 'Support Plan' AND ds_cdsswe_observation_report.observation_report_status = 'A'))
             GROUP BY l_cdsswe_form.form_id,
                      ds_cdsswe_patient_programme.patient_programme_id,
                      ds_cdsswe_patient_programme.patient_id,
                      ds_cdsswe_patient_programme.programme_id,
                      ds_cdsswe_patient_programme.stream_id,
                      ds_cdsswe_patient_programme.patient_programme_status,
                      l_cdsswe_patient.nhi_number,
                      ds_cdsswe_task_request.taskrequest_id,
                      ds_cdsswe_task_request.tasktype_id,
                      l_cdsswe_task_type.name,
                      ds_cdsswe_observation_report.observation_report_id,
                      ds_cdsswe_observation_report.observation_report_status
        name: S_FUNDED_SERVICE_NASC_10
        noLinkRefs: []
  name: S_FUNDED_SERVICE_NASC_10
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
