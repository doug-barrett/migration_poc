fileVersion: 1
id: bcd9380f-4811-4da4-8381-e81b1e7f4930
name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b339d3a1-2598-4134-b9d3-11d54c924526
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 89f8c0fe-e7ef-4146-8b4f-290320e4050a
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8b033bd-77bf-4aab-8e15-a2f3d89fbb21
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2950d899-db6e-4ed7-a2c0-f318a5834611
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f58d5d8b-2e29-4e1f-9288-d17838247563
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8ff765dc-8758-4751-af41-c2f0ef5797f2
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c94baf26-8b60-4187-b528-2c782304cc7e
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: YESTERDAY_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fadad108-9dd1-4c43-96cf-098b3afc541e
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc291251-3368-4f75-8c42-511890811c6d
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PRODUCED_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 534b9768-bbb0-412b-895d-4dc5558290db
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: EXPORT_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6e0f9fe0-ee1e-42db-8233-39e56e4b271b
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: TRANSFER_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 83f3a417-9900-4cbf-9519-df9bcf1da6a9
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: ADJDOWN_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e60d79c3-af50-4160-acef-f0a454aa29e5
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: ADJUP_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a479a787-df87-4b6b-b023-97a17961fac3
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CLOSE_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cd9b8a2b-79ca-4cbd-815e-b8717a3f3912
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8bf7a934-847c-4ba4-945d-5cd239e960ec
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 118156d7-a8a5-4145-9646-ecebb4b0e366
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PERCENT_FULL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 318c5ea4-c399-463c-b830-430c586e1d53
          stepCounter: bcd9380f-4811-4da4-8381-e81b1e7f4930
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e2461b3f-8900-4460-9da7-dc1b4d0593bc
                stepCounter: a23239e4-617a-4ab9-a42c-1fd9220b7fb3
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW: bcd9380f-4811-4da4-8381-e81b1e7f4930
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW') }} AS WITH sc_tanks AS (
                    SELECT t.idflownet,
                           t.name,
                           t.volcapacity,
                           CAST(e.dttm AS date) AS date,
                           e.volhcliqcalc AS oil_stkl,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE round(e.volhcliqcalc / t.volcapacity, 2)
                                 END AS percent_full
                      FROM DS_PRODVIEW.PVT_pvunittank t
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry e
                        ON t.idrec = e.idrecparent
                     WHERE t.name like 'SC%'
                   ),
                   oil_move AS (
                    SELECT idflownet,
                           cell_name,
                           sum(Produced_Oil) AS Produced_Oil,
                           sum(Adjdown_oil) AS Adjdown_oil,
                           sum(adjup_oil) AS adjup_oil,
                           sum(Transfer_oil) AS Transfer_oil,
                           sum(Export_oil) AS Export_oil, date
                      FROM (
                            SELECT u.idflownet,
                                   CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                        ELSE 'SC2'
                                         END cell_name,
                                   (CASE WHEN l.name like 'Prod%' THEN ifnull(e.volhcliqcalc, 0) ELSE 0 END) AS Produced_Oil,
                                   (CASE WHEN l.name like '%Adj -%' THEN e.volhcliqcalc ELSE 0 END) AS Adjdown_oil,
                                   (CASE WHEN l.name like '%Adj +%' THEN e.volhcliqcalc ELSE 0 END) AS Adjup_oil,
                                   (CASE WHEN l.name like '%Transfer%' THEN e.volhcliqcalc ELSE 0 END) AS Transfer_oil,
                                   (CASE WHEN l.name like '%Export%' THEN e.volhcliqcalc ELSE 0 END) AS Export_oil,
                                   CAST(e.dttm AS date) AS date
                              FROM DS_PRODVIEW.PVT_pvunit u
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                                ON u.idrec = l.idrecparent
                               AND (u.name like 'Storage Cell%' OR u.name like 'Wandoo Platform')
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                                ON l.idrec = e.idrecparent
                             UNION SELECT u.idflownet,
                                   CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC2'
                                        ELSE 'SC1'
                                         END cell_name,
                                   0 AS Produced_Oil,
                                   0 AS Adjdown_oil,
                                   0 AS Adjup_oil,
                                   (CASE WHEN l.name like '%Transfer%' THEN 0 - e.volhcliqcalc ELSE 0 END) AS Transfer_oil,
                                   0 AS Export_oil,
                                   CAST(e.dttm AS date) AS date
                              FROM DS_PRODVIEW.PVT_pvunit u
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                                ON u.idrec = l.idrecparent
                               AND (u.name like 'Storage Cell%' OR u.name like 'Wandoo Platform')
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                                ON l.idrec = e.idrecparent
                               AND l.name like '%Transfer%'
                           ) x
                     GROUP BY idflownet,
                              cell_name, DATE
                   ),
                   oil_export AS (
                    SELECT u.idflownet,
                           CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                ELSE 'SC2'
                                 END cell_name,
                           sum(CASE WHEN l.name like '%Export' THEN ifnull(e.volhcliqcalc, 0) ELSE 0 END) AS Export_Oil,
                           CAST(e.dttm AS date) AS date
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND u.name like 'Storage Cell%'
                       AND l.name IN ('SC1 Oil Export', 'SC2 Oil Export')
                      LEFT JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                        ON l.idrec = e.idrecparent
                     GROUP BY u.idflownet,
                              CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                   ELSE 'SC2'
                                    END,
                              e.dttm
                   ) SELECT t.idflownet,
                   t.date,
                   t.name,
                   sum(ifnull(o.oil_stkl, 0)) yesterday_oil,
                   sum(ifnull(m.Produced_Oil, 0)) Produced_oil,
                   sum(ifnull(e.Export_oil, 0)) AS Export_oil,
                   sum(ifnull(m.Transfer_oil, 0)) AS transfer_oil,
                   sum(ifnull(m.Adjdown_oil, 0)) AS adjdown_oil,
                   sum(ifnull(m.Adjup_oil, 0)) AS adjup_oil,
                   sum(ifnull(t.oil_stkl, 0)) AS close_oil,
                   avg(t.volcapacity) capacity,
                   avg(t.percent_full) AS percent_full,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM sc_tanks t
              LEFT JOIN oil_move m
                ON t.name = m.cell_name
               AND t.date = m.date
               AND t.idflownet = m.idflownet
              LEFT JOIN oil_export e
                ON t.name = e.cell_name
               AND t.date = e.date
               AND t.idflownet = e.idflownet
              LEFT JOIN sc_tanks o
                ON t.name = o.name
               AND o.date = dateadd(d, -1, t.date)
               AND t.idflownet = o.idflownet
             INNER JOIN DS_PRODVIEW.PVT_pvflownetheader h
                ON h.idflownet = t.idflownet
             GROUP BY t.idflownet,
                      t.date,
                      t.name,
                      h.SYSSECURITYTYP
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVUNITTANK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVUNITTANK') }}
        name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
