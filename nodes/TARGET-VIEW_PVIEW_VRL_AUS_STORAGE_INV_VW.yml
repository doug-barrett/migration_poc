fileVersion: 1
id: 36a2830c-8593-4679-bc90-efff58caa820
name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b4f6b99f-575d-49f7-b31e-ff2fdb59822d
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b31c6a8d-f373-4463-9042-06fca11d3401
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6f6a646c-6289-420b-ae17-dc787440a675
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5131aff1-ed1b-4a7b-9369-0c3088b7d384
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 51966388-e462-4702-8f91-3a4a2e08981e
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7e9b76d6-b30f-4798-a21b-8105dbb9e951
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ea699203-46ed-4750-8c63-5f75b4debcbf
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: YESTERDAY_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 49f384a3-2385-408c-aed2-c346d725bacc
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c811600a-a83f-48f2-adbc-c2ad5d2f7141
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PRODUCED_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 13b93654-5a20-43f2-ba12-bc2dbd83eea7
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: EXPORT_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9e24b29-07a7-40cf-97c6-d4c9acdae11c
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: TRANSFER_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 863fa25d-2da0-4cf5-a88d-b5f5317954b9
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: ADJDOWN_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5434adb3-e01d-49bc-9eb8-2cf622f38d82
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: ADJUP_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bc9e6f75-f3a3-42a9-a709-16afbef0b9e5
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CLOSE_OIL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c8ed7510-652d-4fdf-9601-0d0ab4098e2c
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4840f1ec-1d30-41ce-9a45-5799dfbc546a
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fc6cb108-b8e1-4935-ae96-8552beacc559
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: PERCENT_FULL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3f5fe14c-83ff-4437-8fef-07ca0fb8c2a8
          stepCounter: 36a2830c-8593-4679-bc90-efff58caa820
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 748cdf05-5750-44bd-bb7a-77b0769f897d
                stepCounter: bd388a52-3d72-4c70-833d-7de7c6a8abd1
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW: 36a2830c-8593-4679-bc90-efff58caa820
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW') }} AS WITH sc_tanks AS (
                    SELECT t.idflownet,
                           t.name,
                           t.volcapacity,
                           CAST(e.dttm AS date) AS date,
                           e.volhcliqcalc AS oil_stkl,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE round(e.volhcliqcalc / t.volcapacity, 2)
                                 END AS percent_full
                      FROM DS_PRODVIEW.PVT_pvunittank t
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry e
                        ON t.idrec = e.idrecparent
                     WHERE t.name like 'SC%'
                   ),
                   oil_move AS (
                    SELECT idflownet,
                           cell_name,
                           sum(Produced_Oil) AS Produced_Oil,
                           sum(Adjdown_oil) AS Adjdown_oil,
                           sum(adjup_oil) AS adjup_oil,
                           sum(Transfer_oil) AS Transfer_oil,
                           sum(Export_oil) AS Export_oil, date
                      FROM (
                            SELECT u.idflownet,
                                   CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                        ELSE 'SC2'
                                         END cell_name,
                                   (CASE WHEN l.name like 'Prod%' THEN ifnull(e.volhcliqcalc, 0) ELSE 0 END) AS Produced_Oil,
                                   (CASE WHEN l.name like '%Adj -%' THEN e.volhcliqcalc ELSE 0 END) AS Adjdown_oil,
                                   (CASE WHEN l.name like '%Adj +%' THEN e.volhcliqcalc ELSE 0 END) AS Adjup_oil,
                                   (CASE WHEN l.name like '%Transfer%' THEN e.volhcliqcalc ELSE 0 END) AS Transfer_oil,
                                   (CASE WHEN l.name like '%Export%' THEN e.volhcliqcalc ELSE 0 END) AS Export_oil,
                                   CAST(e.dttm AS date) AS date
                              FROM DS_PRODVIEW.PVT_pvunit u
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                                ON u.idrec = l.idrecparent
                               AND (u.name like 'Storage Cell%' OR u.name like 'Wandoo Platform')
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                                ON l.idrec = e.idrecparent
                             UNION SELECT u.idflownet,
                                   CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC2'
                                        ELSE 'SC1'
                                         END cell_name,
                                   0 AS Produced_Oil,
                                   0 AS Adjdown_oil,
                                   0 AS Adjup_oil,
                                   (CASE WHEN l.name like '%Transfer%' THEN 0 - e.volhcliqcalc ELSE 0 END) AS Transfer_oil,
                                   0 AS Export_oil,
                                   CAST(e.dttm AS date) AS date
                              FROM DS_PRODVIEW.PVT_pvunit u
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                                ON u.idrec = l.idrecparent
                               AND (u.name like 'Storage Cell%' OR u.name like 'Wandoo Platform')
                             INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                                ON l.idrec = e.idrecparent
                               AND l.name like '%Transfer%'
                           ) x
                     GROUP BY idflownet,
                              cell_name, DATE
                   ),
                   oil_export AS (
                    SELECT u.idflownet,
                           CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                ELSE 'SC2'
                                 END cell_name,
                           sum(CASE WHEN l.name like '%Export' THEN ifnull(e.volhcliqcalc, 0) ELSE 0 END) AS Export_Oil,
                           CAST(e.dttm AS date) AS date
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND u.name like 'Storage Cell%'
                       AND l.name IN ('SC1 Oil Export', 'SC2 Oil Export')
                      LEFT JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry e
                        ON l.idrec = e.idrecparent
                     GROUP BY u.idflownet,
                              CASE WHEN charindex('SC1', l.name) > 0 THEN 'SC1'
                                   ELSE 'SC2'
                                    END,
                              e.dttm
                   ) SELECT t.idflownet,
                   t.date,
                   t.name,
                   sum(ifnull(o.oil_stkl, 0)) yesterday_oil,
                   sum(ifnull(m.Produced_Oil, 0)) Produced_oil,
                   sum(ifnull(e.Export_oil, 0)) AS Export_oil,
                   sum(ifnull(m.Transfer_oil, 0)) AS transfer_oil,
                   sum(ifnull(m.Adjdown_oil, 0)) AS adjdown_oil,
                   sum(ifnull(m.Adjup_oil, 0)) AS adjup_oil,
                   sum(ifnull(t.oil_stkl, 0)) AS close_oil,
                   avg(t.volcapacity) capacity,
                   avg(t.percent_full) AS percent_full,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM sc_tanks t
              LEFT JOIN oil_move m
                ON t.name = m.cell_name
               AND t.date = m.date
               AND t.idflownet = m.idflownet
              LEFT JOIN oil_export e
                ON t.name = e.cell_name
               AND t.date = e.date
               AND t.idflownet = e.idflownet
              LEFT JOIN sc_tanks o
                ON t.name = o.name
               AND o.date = dateadd(d, -1, t.date)
               AND t.idflownet = o.idflownet
             INNER JOIN DS_PRODVIEW.PVT_pvflownetheader h
                ON h.idflownet = t.idflownet
             GROUP BY t.idflownet,
                      t.date,
                      t.name,
                      h.SYSSECURITYTYP
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVUNITTANK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVUNITTANK') }}
        name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_STORAGE_INV_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
