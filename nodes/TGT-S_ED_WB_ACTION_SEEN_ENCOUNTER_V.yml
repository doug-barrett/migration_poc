fileVersion: 1
id: 5b9011ca-ce7b-479e-a396-a373777b78d7
name: S_ED_WB_ACTION_SEEN_ENCOUNTER_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 09bf6dec-9423-42d3-ad36-392179c696d6
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: iPM encounter number
        name: ATTENDANCE_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c2d5accf-5847-4762-97b8-7ad9e3d441a8
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1f47bff9-d914-4d2c-88f6-241551f9665c
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: EM_FIRST_SEEN_BY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bd8a450f-849d-4bb4-b318-1719fa1afa56
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: EM_LAST_SEEN_BY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1e24bbf9-df88-462a-adf2-bf2299ffbe1b
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: NON_EM_FIRST_SEEN_BY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f526370e-0a56-4ff5-a84b-fc525f6c922c
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: NON_EM_LAST_SEEN_BY_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31e448b6-e468-4c84-90b5-7501f1eba901
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: FIRST_SB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7a0d5e8a-9e37-4229-a3f9-d7d29aa5f48f
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: SECOND_SB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4dfb4349-29e2-4f9b-b8bf-f921bbe0c315
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: THIRD_SB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: acb37c48-c217-414e-89de-4d2538e75b8b
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: FOURTH_SB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d799f667-65f8-4373-9065-476ba5b39c26
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: FIFTH_SB
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: eb58e73a-e183-4478-9478-c5730ede154f
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_consolidate_whiteboard_action.WB_action_seenby_doctor=dim_ED_WB_action_seenby_clinician.WB_action_seenby_clinician_user_code
        name: DIM_FIRST_SEENBY_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9eb4757-83dd-43e9-83e6-a9ace615f6df
                stepCounter: a21d1ead-f234-445a-9637-b66949901878
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b939c844-3f0b-48df-bd77-b0718256272d
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_consolidate_whiteboard_action.WB_action_seenby_doctor=dim_ED_WB_action_seenby_clinician.WB_action_seenby_clinician_user_code
        name: DIM_SECOND_SEENBY_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9eb4757-83dd-43e9-83e6-a9ace615f6df
                stepCounter: a21d1ead-f234-445a-9637-b66949901878
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d6e9bdec-e80d-4605-8071-5be2a370b437
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_consolidate_whiteboard_action.WB_action_seenby_doctor=dim_ED_WB_action_seenby_clinician.WB_action_seenby_clinician_user_code
        name: DIM_THIRD_SEENBY_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9eb4757-83dd-43e9-83e6-a9ace615f6df
                stepCounter: a21d1ead-f234-445a-9637-b66949901878
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9c432140-e875-47de-aa8a-125221ddface
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_consolidate_whiteboard_action.WB_action_seenby_doctor=dim_ED_WB_action_seenby_clinician.WB_action_seenby_clinician_user_code
        name: DIM_FOURTH_SEENBY_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9eb4757-83dd-43e9-83e6-a9ace615f6df
                stepCounter: a21d1ead-f234-445a-9637-b66949901878
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3f5317fa-69bb-4ed8-a26c-dd79a639b8e0
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_consolidate_whiteboard_action.WB_action_seenby_doctor=dim_ED_WB_action_seenby_clinician.WB_action_seenby_clinician_user_code
        name: DIM_FIFTH_SEENBY_CLINICIAN_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c9eb4757-83dd-43e9-83e6-a9ace615f6df
                stepCounter: a21d1ead-f234-445a-9637-b66949901878
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 74ed4132-fc14-484c-98c9-096beb48f6f8
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the first specilaty transfer was performed
        name: SPECIALTY_TRANSFER_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b702bc30-0b52-459e-b13d-8537b2fee830
          stepCounter: 5b9011ca-ce7b-479e-a396-a373777b78d7
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: datetime at which the action was performed
        name: EM_FIRST_SEEN_BY_DATE_ONLYDOCTOR
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f7bb1637-e73e-437c-b43e-2d23c20b2024
                stepCounter: 72ef2eec-eaf1-4bc9-b7c7-363a6be4db73
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT attendance_encounter_id,
                   max(EM_first_seen_by_date) EM_first_seen_by_date,
                   max(EM_last_seen_by_date)EM_last_seen_by_date,
                   max(Oth_first_seen_by_date) Oth_first_seen_by_date,
                   max(Oth_last_seen_by_date)Oth_last_seen_by_date ,
                   CASE WHEN max(EM_first_seen_by_date) IS NOT NULL THEN max(EM_first_seen_by_date)
                        ELSE max(Oth_first_seen_by_date)
                         END first_sb ,
                   max(second_sb)second_sb ,
                   max(third_sb)third_sb ,
                   max(forth_sb)forth_sb ,
                   max(fifth_sb)fifth_sb ,
                   CASE WHEN max(EM_first_seen_by_date) IS NOT NULL THEN max(EMSB)
                        ELSE max(OthFSB)
                         END first_sb_clinician ,
                   max(Sec_sb)second_sb_clinician ,
                   max(thirdsb)third_sb_clinician ,
                   max(forthsb)fourth_sb_clinician ,
                   max(fifthsb)fifth_sb_clinician ,
                   max(SpecTfr)SpecTfr ,
                   max(EM_first_seen_by_date_new) EM_first_seen_by_date_onlydoctor
              FROM (
                    SELECT 'Q1' query,
                           em1.attendance_encounter_id,
                           WB_Action_date EM_first_seen_by_date,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb,
                           dim_ED_WB_action_seenby_clinician_key EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE EM1.specialty_code_group = 'EMMED'
                       AND specialty_group_sequence = 1
                 UNION ALL SELECT 'Q2' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           WB_Action_date EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE EM1.specialty_code_group = 'EMMED'
                       AND specialty_group_sequence_rev = 1
                 UNION ALL SELECT 'Q3' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           WB_Action_date Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           dim_ED_WB_action_seenby_clinician_key OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE EM1.specialty_code_group = 'Other'
                       AND specialty_group_sequence = 1
                 UNION ALL SELECT 'Q4' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           WB_Action_date Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE EM1.specialty_code_group = 'Other'
                       AND specialty_group_sequence_rev = 1
                 UNION ALL SELECT 'Q5' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           WB_Action_date second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           dim_ED_WB_action_seenby_clinician_key Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE seen_by_action_sequence = 2
                 UNION ALL SELECT 'Q6' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           WB_Action_date third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           dim_ED_WB_action_seenby_clinician_key thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE seen_by_action_sequence = 3
                 UNION ALL SELECT 'Q7' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           WB_Action_date forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           dim_ED_WB_action_seenby_clinician_key forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE seen_by_action_sequence = 4
                 UNION ALL SELECT 'Q8' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           WB_Action_date fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           dim_ED_WB_action_seenby_clinician_key fifthsb,
                           NULL SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_ed_wb_action_seen_by_v EM1
                     WHERE seen_by_action_sequence = 5
                 UNION ALL SELECT query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by_date,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb,
                           EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           NULL SpecTfr,
                           EM_first_seen_by_date_new
                      FROM (
                            SELECT 'Q9' query,
                                   attendance_encounter_id ,
                                   specialty_group_sequence,
                                   WB_action_performed,
                                   WB_Action_date EM_first_seen_by_date_new,
                                   row_number() over(PARTITION BY attendance_encounter_id ORDER BY attendance_encounter_id,CASE WHEN WB_action_performed='Nurse Seen By' AND specialty_code_group = 'EMMED' THEN 99 WHEN specialty_code_group <> 'EMMED' THEN 98 WHEN specialty_code_group = 'EMMED' AND WB_action_performed='Doctor Seen By' THEN specialty_group_sequence END) specialty_group_sequence_new,
                                   specialty_code_group,
                                   dim_ED_WB_action_seenby_clinician_key EMSB
                              FROM s_ed_wb_action_seen_by_v --where   attendance_encounter_id in ( 'A1412519700', 'A1412411349')

                           ) EM1
                     WHERE EM1.specialty_code_group = 'EMMED'
                       AND specialty_group_sequence_new = 1
                 UNION ALL SELECT 'Q10' query,
                           em1.attendance_encounter_id,
                           NULL EM_first_seen_by,
                           NULL EM_last_seen_by_date,
                           NULL Oth_first_seen_by_date,
                           NULL Oth_last_seen_by_date,
                           NULL second_sb,
                           NULL third_sb,
                           NULL forth_sb,
                           NULL fifth_sb ,
                           NULL EMSB,
                           NULL OthFSB,
                           NULL Sec_sb,
                           NULL thirdsb,
                           NULL forthsb,
                           NULL fifthsb,
                           WB_action_date SpecTfr,
                           NULL EM_first_seen_by_date_new
                      FROM s_consolidate_whiteboard_action EM1
                     WHERE 1=1
                       AND wb_action_performed = 'Specialty Transfer' --  and attendance_encounter_id = 'A1411617980'

                       AND event_action_type_sequence = 1
                   ) SB --where   attendance_encounter_id in ( 'A1412519700')

             GROUP BY attendance_encounter_id --having case when max(EM_first_seen_by_date) is not null then  max(EM_first_seen_by_date)
            --   else max( Oth_first_seen_by_date) end > '01-Jul-2017'
        dependencies:
          - locationName: TGT
            nodeName: S_ED_WB_ACTION_SEEN_BY_V
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','S_ED_WB_ACTION_SEEN_BY_V') }}
        name: S_ED_WB_ACTION_SEEN_ENCOUNTER_V
        noLinkRefs: []
  name: S_ED_WB_ACTION_SEEN_ENCOUNTER_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
