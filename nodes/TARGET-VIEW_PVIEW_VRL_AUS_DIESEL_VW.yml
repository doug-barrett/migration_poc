fileVersion: 1
id: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa262ff4-60e9-4379-8a13-db23b96fefa6
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 89f8c0fe-e7ef-4146-8b4f-290320e4050a
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5f1bc25a-2900-44b8-a2e4-6ded2420e56d
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2950d899-db6e-4ed7-a2c0-f318a5834611
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1ea5e987-2409-4476-9b03-79ad925d9d86
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_PERCENT_CRANE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2a666c6a-09a6-49b1-8bf3-1ad4365c755f
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_PERCENT_SHAFT2
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 04aa3639-fa2b-4fc7-b6cd-a15c82ec5ee5
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_VOL_CRANE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ac1d14e-a923-4255-8d8c-9887e48c8a71
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c6562c6b-2cb9-4bea-b4c5-7a458971e0a6
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_VOL_SHAFT2
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ac1d14e-a923-4255-8d8c-9887e48c8a71
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0c66c904-76c3-4be6-871e-cc2938ebcfaf
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_IN_STORAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ac1d14e-a923-4255-8d8c-9887e48c8a71
                stepCounter: 33dc51ae-1f19-4512-838c-135daef20125
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 50f7198e-aa1e-4910-a79b-b2f0cc21899e
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_USAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ecf648b-f629-4354-bcf1-57e4e945d81e
                stepCounter: 1fc1f5e3-789a-4d7c-8f90-82afba0e441a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc1aaa48-92a7-4db8-8207-a8c9e27befd9
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_ADD_STORAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ecf648b-f629-4354-bcf1-57e4e945d81e
                stepCounter: 1fc1f5e3-789a-4d7c-8f90-82afba0e441a
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4e0efc72-fce9-4fe3-a430-7329ee88b28b
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DAYS_REMAINING
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d6b8a92-5fba-432b-b905-61d47a2e2bd9
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CRANE_CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8bf7a934-847c-4ba4-945d-5cd239e960ec
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 740daf47-b560-44e8-98f4-a7de30562495
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: SHAFT2_CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8bf7a934-847c-4ba4-945d-5cd239e960ec
                stepCounter: 3076b54f-72ff-4107-bd2a-a02891dfe194
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 91a26ee2-59c2-4ae2-8cb5-dc1aed98a5eb
          stepCounter: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e2461b3f-8900-4460-9da7-dc1b4d0593bc
                stepCounter: a23239e4-617a-4ab9-a42c-1fd9220b7fb3
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_DIESEL_VW: 6a4979f6-a419-4b24-9bfb-2f3a91f5e035
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_DIESEL_VW') }} AS WITH crane_tank AS (
                    SELECT t.idflownet,
                           t.name tank_name,
                           t.volcapacity,
                           CAST(te.dttm AS date) AS date,
                           te.voltotalcalc tank_vol,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE te.voltotalcalc / t.volcapacity * 100
                                 END percent_full
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON u.idrec = t.idrecparent
                       AND t.productname = 'Diesel'
                       AND lower(t.name) like '%crane%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry te
                        ON t.idrec = te.idrecparent
                   ),
                   shaft_tank AS (
                    SELECT t.idflownet,
                           t.name tank_name,
                           t.volcapacity,
                           CAST(te.dttm AS date) AS date,
                           te.voltotalcalc tank_vol,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE te.voltotalcalc / t.volcapacity * 100
                                 END percent_full
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON u.idrec = t.idrecparent
                       AND t.productname = 'Diesel'
                       AND lower(t.name) like '%shaft%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry te
                        ON t.idrec = te.idrecparent
                   ),
                   USAGE AS (
                    SELECT u.idflownet,
                           CAST(le.dttm AS date) AS date,
                           'Usage' AS name,
                           sum(ifnull(le.voltotalcalc, 0)) vol
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND lower(l.name) not like '%storage%'
                       AND lower(u.name) like '%diesel%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry le
                        ON l.idrec = le.idrecparent
                     GROUP BY u.idflownet,
                              le.dttm
                   ),
            STORAGE AS (
                    SELECT u.idflownet,
                           CAST(le.dttm AS date) AS date,
                           'diesel_storage' AS name,
                           sum(ifnull(le.voltotalcalc, 0)) vol
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND lower(u.name) like '%diesel%'
                       AND lower(l.name) like '%storage%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry le
                        ON l.idrec = le.idrecparent
                       AND ifnull(le.voltotalcalc, 0) != 0
                     GROUP BY u.idflownet,
                              le.dttm
                   ) SELECT c.idflownet,
                   c.date,
                   c.percent_full AS diesel_percent_crane,
                   round(s.percent_full, 1) AS diesel_percent_shaft2,
                   c.tank_vol AS diesel_vol_crane,
                   s.tank_vol AS diesel_vol_shaft2,
                   c.tank_vol + s.tank_vol AS diesel_in_storage,
                   u.vol AS diesel_usage,
                   o.vol AS diesel_add_storage,
                   CASE WHEN ifnull(u.vol, 0) = 0 THEN 0
                        ELSE floor((c.tank_vol + s.tank_vol) / u.vol)
                         END days_remaining,
                   c.volcapacity crane_capacity,
                   s.volcapacity shaft2_capacity,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM crane_tank c
             INNER JOIN shaft_tank s
                ON c.date = s.date
               AND c.idflownet = s.idflownet
              LEFT JOIN USAGE u
                ON c.date = u.date
               AND c.idflownet = u.idflownet
              LEFT JOIN
            STORAGE o
                ON c.date = o.date
               AND c.idflownet = o.idflownet
             INNER JOIN DS_PRODVIEW.PVT_pvflownetheader h
                ON h.idflownet = c.idflownet
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVUNITTANK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVUNITTANK') }}
        name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
