fileVersion: 1
id: d2de2bd6-7368-44ac-b071-208d96b79f4e
name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TARGET
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b8a86f7d-a3e4-4d5e-b903-0786eac55e78
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: VARCHAR(32)
        defaultValue: ""
        description: ""
        name: IDFLOWNET
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b31c6a8d-f373-4463-9042-06fca11d3401
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b6872183-2b2e-4ee9-8842-6072ef65b2d0
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: TIMESTAMP
        defaultValue: ""
        description: ""
        name: DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 5131aff1-ed1b-4a7b-9369-0c3088b7d384
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 31027a4d-4d7f-4945-8655-06632db2528b
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_PERCENT_CRANE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4453ba8d-c0f1-4e23-9e70-1b32df9e9f25
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_PERCENT_SHAFT2
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d371cb5a-d5e1-4240-b8a4-76a912c4a6c3
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_VOL_CRANE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c6eab387-faeb-4153-a891-51cc130aeebb
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 344587ef-e562-4d90-b577-f870c5ffa5bf
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_VOL_SHAFT2
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c6eab387-faeb-4153-a891-51cc130aeebb
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c7ffa6f0-211c-4b50-9007-0e75853cdba8
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_IN_STORAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c6eab387-faeb-4153-a891-51cc130aeebb
                stepCounter: 099a450b-5d3f-4ef1-9507-352da0278b56
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b8e13224-b4d9-4181-ba82-86e175c5841e
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_USAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1e81c703-ac3e-4de4-a6b8-8bf88e2451a0
                stepCounter: a42bf1d3-9077-4deb-a421-72cf454785c2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 23fff363-be98-46f2-8736-650d5d8a383f
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DIESEL_ADD_STORAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1e81c703-ac3e-4de4-a6b8-8bf88e2451a0
                stepCounter: a42bf1d3-9077-4deb-a421-72cf454785c2
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 55409592-5059-4695-a04c-a14402e6bc52
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: DAYS_REMAINING
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dcc7af64-3825-476c-8330-57fc6d713be2
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: CRANE_CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4840f1ec-1d30-41ce-9a45-5799dfbc546a
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d62c4909-835d-4d46-8e43-991fd17c6cde
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: DOUBLE(38)
        defaultValue: ""
        description: ""
        name: SHAFT2_CAPACITY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4840f1ec-1d30-41ce-9a45-5799dfbc546a
                stepCounter: fa3b087a-900a-46c3-aefd-7f0e702b371d
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 82cc1a54-3212-431d-b25b-901d539b37fb
          stepCounter: d2de2bd6-7368-44ac-b071-208d96b79f4e
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: BU_SF_ROLE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 748cdf05-5750-44bd-bb7a-77b0769f897d
                stepCounter: bd388a52-3d72-4c70-833d-7de7c6a8abd1
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          VIEW_PVIEW_VRL_AUS_DIESEL_VW: d2de2bd6-7368-44ac-b071-208d96b79f4e
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            CREATE OR REPLACE VIEW {{ ref_no_link('TARGET','VIEW_PVIEW_VRL_AUS_DIESEL_VW') }} AS WITH crane_tank AS (
                    SELECT t.idflownet,
                           t.name tank_name,
                           t.volcapacity,
                           CAST(te.dttm AS date) AS date,
                           te.voltotalcalc tank_vol,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE te.voltotalcalc / t.volcapacity * 100
                                 END percent_full
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON u.idrec = t.idrecparent
                       AND t.productname = 'Diesel'
                       AND lower(t.name) like '%crane%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry te
                        ON t.idrec = te.idrecparent
                   ),
                   shaft_tank AS (
                    SELECT t.idflownet,
                           t.name tank_name,
                           t.volcapacity,
                           CAST(te.dttm AS date) AS date,
                           te.voltotalcalc tank_vol,
                           CASE WHEN t.volcapacity = 0 THEN 0
                                ELSE te.voltotalcalc / t.volcapacity * 100
                                 END percent_full
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunittank t
                        ON u.idrec = t.idrecparent
                       AND t.productname = 'Diesel'
                       AND lower(t.name) like '%shaft%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunittankentry te
                        ON t.idrec = te.idrecparent
                   ),
                   USAGE AS (
                    SELECT u.idflownet,
                           CAST(le.dttm AS date) AS date,
                           'Usage' AS name,
                           sum(ifnull(le.voltotalcalc, 0)) vol
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND lower(l.name) not like '%storage%'
                       AND lower(u.name) like '%diesel%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry le
                        ON l.idrec = le.idrecparent
                     GROUP BY u.idflownet,
                              le.dttm
                   ),
            STORAGE AS (
                    SELECT u.idflownet,
                           CAST(le.dttm AS date) AS date,
                           'diesel_storage' AS name,
                           sum(ifnull(le.voltotalcalc, 0)) vol
                      FROM DS_PRODVIEW.PVT_pvunit u
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquid l
                        ON u.idrec = l.idrecparent
                       AND lower(u.name) like '%diesel%'
                       AND lower(l.name) like '%storage%'
                     INNER JOIN DS_PRODVIEW.PVT_pvunitmeterliquidentry le
                        ON l.idrec = le.idrecparent
                       AND ifnull(le.voltotalcalc, 0) != 0
                     GROUP BY u.idflownet,
                              le.dttm
                   ) SELECT c.idflownet,
                   c.date,
                   c.percent_full AS diesel_percent_crane,
                   round(s.percent_full, 1) AS diesel_percent_shaft2,
                   c.tank_vol AS diesel_vol_crane,
                   s.tank_vol AS diesel_vol_shaft2,
                   c.tank_vol + s.tank_vol AS diesel_in_storage,
                   u.vol AS diesel_usage,
                   o.vol AS diesel_add_storage,
                   CASE WHEN ifnull(u.vol, 0) = 0 THEN 0
                        ELSE floor((c.tank_vol + s.tank_vol) / u.vol)
                         END days_remaining,
                   c.volcapacity crane_capacity,
                   s.volcapacity shaft2_capacity,
                   WS_EDW.PVIEW_SYSSECURITYTYP_VET_BU_ROLE(h.SYSSECURITYTYP) AS BU_SF_ROLE
              FROM crane_tank c
             INNER JOIN shaft_tank s
                ON c.date = s.date
               AND c.idflownet = s.idflownet
              LEFT JOIN USAGE u
                ON c.date = u.date
               AND c.idflownet = u.idflownet
              LEFT JOIN
            STORAGE o
                ON c.date = o.date
               AND c.idflownet = o.idflownet
             INNER JOIN DS_PRODVIEW.PVT_pvflownetheader h
                ON h.idflownet = c.idflownet
        dependencies:
          - locationName: TARGET
            nodeName: ODS_PVIEW_PVT_PVUNITTANK
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TARGET','ODS_PVIEW_PVT_PVUNITTANK') }}
        name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
        noLinkRefs: []
  name: VIEW_PVIEW_VRL_AUS_DIESEL_VW
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
