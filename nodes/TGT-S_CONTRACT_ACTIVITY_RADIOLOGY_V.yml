fileVersion: 1
id: 7ac21694-17d7-476b-965a-4157cf5aa0ba
name: S_CONTRACT_ACTIVITY_RADIOLOGY_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f4743f4c-6504-4f51-aab0-4ab51eb408e3
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PUC_MAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0270527b-0d3b-42bb-b12b-39f95fd6b44b
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Generated column used to join to correct Price Volume Schdule Line
        name: PROVIDER_FUNDER_SPLIT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0270527b-0d3b-42bb-b12b-39f95fd6b44b
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 15d7858f-6866-4c78-b57f-524627097423
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 15d7858f-6866-4c78-b57f-524627097423
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f48d0a10-99e6-4a8a-9940-9f9f788659eb
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(3)
        defaultValue: ""
        description: 'health_specialty_code '
        name: HEALTH_SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f48d0a10-99e6-4a8a-9940-9f9f788659eb
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2803fe97-770e-472b-a614-f68658e46c50
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FACILITY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2803fe97-770e-472b-a614-f68658e46c50
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc3a1e0b-3ded-44d5-89ca-b7543ed97323
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Has twelve months added. Mental Health data was 24 months old so 12 months added int his step and the s_contract_activity_10
        name: REPORTING_DATE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dc3a1e0b-3ded-44d5-89ca-b7543ed97323
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c62ad26b-0c08-4dde-9440-c750682a9134
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: SOURCE_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c62ad26b-0c08-4dde-9440-c750682a9134
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b9ffe676-7911-4c87-a816-dc44d9678fad
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: FUNDED_EVENT_ENCOUNTER
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b9ffe676-7911-4c87-a816-dc44d9678fad
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8c719349-b33f-4d02-8645-7cfcdbc1318c
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: EVENT_ENCOUNTER_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 8c719349-b33f-4d02-8645-7cfcdbc1318c
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c9d6d12-14b1-4146-aad1-5adda4306be7
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient National Health Index (NMPI)
        name: NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6c9d6d12-14b1-4146-aad1-5adda4306be7
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 635d10bf-283d-4ff5-ae60-1f982a0f1778
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: s_in_patient_event_30.patient_reference_no=dim_patient.patient_reference_no
        name: DIM_PATIENT_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 635d10bf-283d-4ff5-ae60-1f982a0f1778
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4c8de677-0411-43b4-8413-82105d10d6f0
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: ADMIN_CATEGORY_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4c8de677-0411-43b4-8413-82105d10d6f0
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b28d5c4d-a4cd-423f-a055-bb1272c5663d
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(80)
        defaultValue: ""
        description: ""
        name: CONTRACT_ADMIT_TYPE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b28d5c4d-a4cd-423f-a055-bb1272c5663d
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7f9001af-40af-45fe-a9a4-bd9481dd3b73
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: ""
        name: ADMISSION_TYPE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 10aa5f3e-4451-4d11-b647-6616a031975c
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: IDF_CLASS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 10aa5f3e-4451-4d11-b647-6616a031975c
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a9f048a4-743b-41f4-9a07-ca82e738fb8b
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: DOMICILE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a9f048a4-743b-41f4-9a07-ca82e738fb8b
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ac0bc08f-87fb-4401-a772-00baf6d729d5
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PURCHASE_UNIT_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ac0bc08f-87fb-4401-a772-00baf6d729d5
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e6582a6b-06e8-49c8-89ca-16d0e7d13def
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: This is the volume of units for the method by which the event is funded. i.e. WIES or 1 for procedure funded purchase units.
        name: PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e6582a6b-06e8-49c8-89ca-16d0e7d13def
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cf496af9-2080-48da-bfcf-1417d2b5d079
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: NUMERIC(19,5)
        defaultValue: ""
        description: Purchase unit volume derived from forecasting
        name: ESTIMATED_PURCHASE_UNIT_VOLUME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cf496af9-2080-48da-bfcf-1417d2b5d079
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 14265271-8b4c-4cbd-ad00-57fa3a4e69fe
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: DIM_AGE_GROUP_KEY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 14265271-8b4c-4cbd-ad00-57fa3a4e69fe
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 66a86f31-116a-4ac6-b3ef-89ac870c6083
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: Generated artificial key
        name: DIM_PLANNED_CARE_KEY
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: '0'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8de4a4fc-5fd6-43d9-8203-8ac1c3340ac0
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: DRG_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: 'NULL'
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bba969ee-91df-45ca-bd96-1c84d45fac86
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: discharging clinician reference no from iPM
        name: CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bba969ee-91df-45ca-bd96-1c84d45fac86
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6cd3870c-f0c4-4bac-81d3-cd3bb9be08a5
          stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: source_system
        name: SOURCE_SYSTEM
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6cd3870c-f0c4-4bac-81d3-cd3bb9be08a5
                stepCounter: 7ac21694-17d7-476b-965a-4157cf5aa0ba
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'provider' [provider_funder_split],
                   cast(replace(fact_RIS_exam_completed.PUC_map_id,'RIS_','') AS integer) PUC_map_id ,
                   '170-1758' [responsibility_centre_code],
                   'R01' [health_specialty_code],
                   CASE WHEN dim_radiology_exam_performed.performed_exam_desc LIKE 'PET Scan %' AND performed_exam_desc LIKE '%ascot%' THEN 'A112'
                        WHEN performed_exam_desc LIKE 'PET Scan %' AND performed_exam_desc LIKE '%Mercy%'                              THEN 'BN71'
                        ELSE CASE WHEN dim_radiology_exam_performed.hospital_location = 'North Shore' THEN '3215' ELSE '3216' END
                         END [facility_code],
                   fact_RIS_exam_completed.exam_date [reporting_date],
                   'RIS' + CAST(fact_RIS_Exam_completed.accession_number AS VARCHAR) source_encounter,
                   fact_RIS_Exam_completed.source_encounter_id [funded_event_encounter],
                   'RIS' [event_encounter_type_code],
                   dim_patient.patient_NHI [NHI],
                   dim_patient.[dim_patient_key] [dim_patient_key],
                   1000008180 [admin_category_reference_no],
                   'OTHER' [contract_admit_type],
                   NULL [admission_type_code],
                   IFNULL(addr.IDF_class, 'Non-IDF') [IDF_class],
                   addr.domicile_code [domicile_code],
                   dim_purchase_unit.purchase_unit_code,
                   CASE WHEN (dim_radiology_exam_performed.modality_code = 'PT' OR dim_radiology_exam_performed.performed_exam_code IN ('CCOL', 'CBSCOL','WOCARCO','WOCTCO','CBSCOL','WOCARCO','WOCTCO','WOCASCO')) AND exam_occurred_flag = 'Y' THEN 1
                        WHEN exam_occurred_flag = 'Y'                                                                                                                                                                                            THEN dim_radiology_exam_performed.relative_value_unit
                        ELSE 0
                         END [purchase_unit_volume],
                   0 [estimated_purchase_unit_volume],
                   [dim_age_group_key],
                   0 dim_planned_care_key,
                   NULL DRG_code,
                   dim_radiology_ordering_clinician.radiology_ordering_clinician_reference_no [clinician_reference_no],
                   'RIS files'
              FROM fact.fact_RIS_exam_completed fact_RIS_exam_completed
             INNER JOIN [fact].[fact_RIS_referral]
                ON [fact_RIS_referral].referral_id = fact_RIS_exam_completed.referral_id
             INNER JOIN [dim].[dim_radiology_patient_status] dim_radiology_patient_status
                ON [fact_RIS_referral].dim_radiology_patient_status_key = dim_radiology_patient_status.dim_radiology_patient_status_key
             INNER JOIN dim.dim_radiology_exam_performed dim_radiology_exam_performed
                ON dim_radiology_exam_performed.dim_radiology_exam_performed_key = fact_RIS_exam_completed.dim_radiology_exam_performed_key
              LEFT JOIN fact.fact_radiology_eOrder fact_radiology_eOrder
                ON fact_radiology_eOrder.radiology_eOrder_id = fact_RIS_exam_completed.referral_id
             INNER JOIN dim.dim_date dim_date
                ON dim_date.calendar_date = CAST(fact_RIS_exam_completed.exam_date AS DATE)
             INNER JOIN dim.dim_patient
                ON fact_RIS_exam_completed.dim_patient_key = dim_patient.dim_patient_key
             INNER JOIN dim.dim_age_group
                ON FLOOR(DATEDIFF(DAY, dim_patient.patient_date_of_birth, fact_RIS_exam_completed.exam_date) / 365.25) = dim_age_group.age_years
             INNER JOIN dim.dim_radiology_ordering_clinician
                ON dim_radiology_ordering_clinician.dim_radiology_ordering_clinician_key = fact_RIS_referral.dim_radiology_ordering_clinician_key
             INNER JOIN dim.dim_purchase_unit
                ON dim_purchase_unit.dim_purchase_unit_key = fact_RIS_exam_completed.dim_purchase_unit_key
              LEFT JOIN (
                    SELECT c.domicile_code,
                           c.IDF_class,
                           a.address_validity_start_date,
                           a.address_validity_end_date,
                           a.patient_NHI
                      FROM db_red.fact.fact_patient_addresses a
                     INNER JOIN dim.dim_patient_address_types b
                        ON a.dim_patient_address_types_key = b.dim_patient_address_types_key
                     INNER JOIN dim.dim_domicile c
                        ON a.dim_domicile_key = c.dim_domicile_key
                     INNER JOIN dim.dim_patient d
                        ON a.dim_patient_key = d.dim_patient_key
                     WHERE 1 = 1
                       AND address_row_num = 1
                       AND address_role_code = 'HOME'
                       AND address_type_code = 'POSTL'
                       AND address_duplicate_reference_no = 0
                   ) addr
                ON dim_patient.patient_NHI = addr.patient_NHI
               AND fact_RIS_exam_completed.exam_date BETWEEN address_validity_start_date AND IFNULL(address_validity_end_date, GETDATE())
             WHERE 1 = 1
               AND dim_patient.NHI_sequence = 1
               AND fact_RIS_exam_completed.exam_occurred_flag = 'Y'
               AND fact_RIS_exam_completed.exam_date >= '2020-07-01'
               AND performed_exam_desc LIKE '%%'
               AND (dim_radiology_patient_status.radiology_patient_status_desc LIKE '%GP%' OR (dim_radiology_patient_status.patient_status_group_code = 'OP' AND dim_radiology_exam_performed.modality_code = 'MAM' AND fact_radiology_eOrder.relevant_information LIKE '%See GP Referral%') OR dim_radiology_exam_performed.modality_code = 'PT' OR dim_radiology_exam_performed.performed_exam_code IN ('CCOL', 'CBSCOL','WOCARCO','WOCTCO','CBSCOL','WOCARCO','WOCTCO','WOCASCO') OR (dim_radiology_patient_status.radiology_patient_status_desc IN ('Outpatient ADHB','Inpatient/Acute ADHB') AND dim_radiology_exam_performed.modality_code <> 'IR'))
        dependencies: []
        join:
          joinCondition: None
        name: S_CONTRACT_ACTIVITY_RADIOLOGY_V
        noLinkRefs: []
  name: S_CONTRACT_ACTIVITY_RADIOLOGY_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
