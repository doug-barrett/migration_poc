fileVersion: 1
id: 637621f1-ebc9-4e62-b367-3187a03d45a5
name: S_EVITALS_OBSERVATION_SET_01
operation:
  config:
    insertStrategy: INSERT
    postSQL: ""
    preSQL: ""
    testsEnabled: true
  database: ""
  deployEnabled: true
  description: "Get details of each observation set and try to link them to a dim_patient row."
  isMultisource: false
  locationName: TGT
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4d57a0f8-8b05-4833-843c-53acf0a310ee
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: Integer ID that uniquely identifies a patient admission in Patientrack. Sourced from admsn_pk.
        name: ADMISSION_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 3f68edb3-1e8d-48b7-8850-2400c40ab4f7
                stepCounter: 6866bc35-1164-43e9-9ff9-15b44d426855
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7bd77763-1ace-482a-8fca-2aa24b6229a1
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Patient NHI number.
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e31b1246-4b2b-4282-8f8f-b1731a705e9e
                stepCounter: 14a9733a-2051-4c6b-b9eb-02e1561188ee
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c5afc370-1985-444c-8869-4c6ee25d0d27
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: 'Internal unique identifier for a patient from the Patient Management System '
        name: PATIENT_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 702dfc9d-df5e-42d8-86f8-9e68f29c462c
                stepCounter: d52dd438-7899-4242-9e38-539d2a1447df
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 008d4082-ab2a-471d-90ae-dead8f8cfa50
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: Inpatient or ED event associated with the observation set for the patient.
        name: ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 358be7ab-ae47-4f66-8400-773a47d32093
                stepCounter: a8e499ca-300b-48a9-9045-922a42433271
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f8b9106e-ffb9-42b3-87c0-d00326b77646
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: Integer ID that uniquely identifies an observation set in Patientrack. Sourced from obset_pk.
        name: OBSERVATION_SET_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e6b716d0-5197-4ac0-92af-0fb734c834ac
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3d65cbb9-e397-4905-ba13-55a263f959f8
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: ""
        name: CURRENT_OBSERVATION_SET_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4636631c-7503-40b5-a7c6-e5cfa7317339
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1ed12009-8632-49c2-be2d-aa9b63c5edf4
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the observation measure started.
        name: OBSERVATION_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e47520ea-2c41-434b-86cd-c7950d612858
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: dbo.fn_convert_utc_datetime2(ds_Patientrack_OBSERVATION_SET.OBS_START_DTTM)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 64026ce4-577b-49a6-9f79-96914ca33825
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the observation measure was due.
        name: OBSERVATION_DUE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 10e0ba82-e120-40f0-8beb-90f2cef6b7eb
                stepCounter: 61f67378-f7ef-4018-87bd-1157919ec89f
            transform: dbo.fn_convert_utc_datetime2(ds_Patientrack_OBSERVATION_DUE_TIME.OBS_DUE_DTTM)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c4499b9e-3da0-4bd0-8a64-c8c99268ed03
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: 'Date and time when the observation measure was taken. '
        name: OBSERVATION_TAKEN_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 88c1b257-80ee-41fc-93fe-f7cb1eb05bb4
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: dbo.fn_convert_utc_datetime2(ds_Patientrack_OBSERVATION_SET.OBS_TAKEN_DTTM)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4a1f7c1a-b461-4190-a081-e120ee9c9539
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Early Warning Score for the observation.
        name: EWS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6339252b-5a0a-412c-817d-50ff971563bd
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cd8ef4a9-3023-4381-a240-0c98d1338a62
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the EWS for the observation is greater than the value of parameter eVitals_EWS_alert.
        name: EWS_ALERT
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 6339252b-5a0a-412c-817d-50ff971563bd
                stepCounter: 2988e8b8-1ea5-46f9-8504-e1b140f344fa
            transform: |-
              CASE WHEN ds_Patientrack_OBSERVATION_SET.OVERALL_RISK_INDEX > 2 THEN 1
                          ELSE 0
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c24966ba-8fdf-4f4b-9767-855a7621f3f7
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: EWSRG_PK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b98e691d-3dc5-45bf-bdd2-5b8c0a4b6cc0
                stepCounter: 6e8c1b7f-4a00-4e50-88a5-b6b4321da72e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 11812ac9-6baf-4112-8f2b-5f0cff6b2b34
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: Parent regime
        name: PARENT_EWSRG_PK
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9d90f576-f7f8-4dd0-b3be-2ebf91026f61
                stepCounter: 46f76334-4cc1-4151-8f51-e6906c364807
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17a1c1e2-4dbc-44c0-8df3-90511bc4fb63
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Set to 1 if the regime for the observation set is set to anything other than NEWS.
        name: EWS_MODIFIED_FLAG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b98e691d-3dc5-45bf-bdd2-5b8c0a4b6cc0
                stepCounter: 6e8c1b7f-4a00-4e50-88a5-b6b4321da72e
            transform: |-
              CASE --1 = old EWS disabled 07-May-2019
               --8005 = NZ_NEWS commenced capture on 07-May-2019

                          WHEN ds_Patientrack_EWS_REGIME_APPLICATION.EWSRG_PK IN (1,8005)                          THEN 0
                          ELSE 1
                           END
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 32099340-752f-4363-9b47-86ebd1791118
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: REGIME_MOD_REASON_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7fed5fa9-82a6-4364-9558-fd937cd8e2d0
                stepCounter: 741e57e6-e7fa-4ed9-8486-e724bc2706b8
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 17434cb4-3f1c-4b5e-9483-8f74a3db5f28
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the patient was admitted to the ward.
        name: ADMIT_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7d87134c-7349-43f3-a3c1-eccf381c964e
                stepCounter: 654ed294-0ff8-4734-804e-ed801147dc35
            transform: dbo.fn_convert_utc_datetime2(ds_Patientrack_EPISODE_WARD.START_DTTM)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 419038a8-df63-4a73-b3d4-09377d288b2c
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: Integer ID that uniquely identifies a specialty in Patientrack. Sourced from wardd_rfval.
        name: WARD_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d227ff07-c731-4c94-87e7-218bc8f78bb7
                stepCounter: 654ed294-0ff8-4734-804e-ed801147dc35
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 27dfac36-0a11-4f6c-9426-d2dd35ec719e
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time when the patient was discharged from the ward.
        name: DISCH_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: d4f0c6b2-6b0f-4701-bf4c-49983ff875c8
                stepCounter: 654ed294-0ff8-4734-804e-ed801147dc35
            transform: dbo.fn_convert_utc_datetime2(ds_Patientrack_EPISODE_WARD.END_DTTM)
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 07ad9648-90c4-4fc9-8378-d57c01345fdb
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Alphanumeric code that uniquely identifies a ward in Patientrack.
        name: WARD_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c30e7937-2552-497e-8ce0-84326aa36f1f
                stepCounter: fd33378b-8099-40d2-8fbf-bd76e1f3e2a9
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 191cc154-67f6-44f5-8fa6-f4987c6f54ed
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: INT
        defaultValue: ""
        description: Integer ID that uniquely identifies a specialty in Patientrack. Sourced from spect_rfval.
        name: SPECIALTY_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 7e3c3bc3-ba21-45ea-b5f4-e602c818f5bb
                stepCounter: 6ebb674f-40d5-4a7b-b97c-cc154a6bf4bf
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ed3352c5-81a1-4b5d-9a17-b464bfadeec1
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: Alphanumeric code that uniquely identifies a specialty in Patientrack.
        name: SPECIALTY_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9dd68b23-5b7f-4138-b3d8-510af9a9b4b5
                stepCounter: cb3d7c0c-136c-45a6-90ab-bffd6512dcc1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 082aa478-1a50-4df0-b5d7-42567ae1a6b1
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: TINYINT
        defaultValue: ""
        description: Numbers rows for each observation set so that a single row can be selected for each set.
        name: ROW_NUM
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ROW_NUMBER() OVER(PARTITION BY ds_Patientrack_OBSERVATION_SET.OBSET_PK ORDER BY IFNULL(ds_Patientrack_episode_WARD.end_dttm, GETDATE()))
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 493d1a5e-6a16-4963-8aab-0c05750a05e0
          stepCounter: 637621f1-ebc9-4e62-b367-3187a03d45a5
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: Date and time the row was updated in the data warehouse.
        isSystemUpdateDate: true
        name: DSS_UPDATE_TIME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: TGT
            nodeName: S_EVITALS_ADMISSION_CHANGES
        join:
          joinCondition: |-
            FROM s_eVitals_admission_changes
              JOIN ds_Patientrack_episode
                ON s_eVitals_admission_changes.admission_id = ds_Patientrack_episode.epsde_pk
              JOIN s_eVitals_patient
                ON ds_Patientrack_episode.patnt_pk = s_eVitals_patient.patnt_pk
              JOIN ds_Patientrack_OBSERVATION_SET
                ON s_eVitals_admission_changes.admission_id = ds_Patientrack_OBSERVATION_SET.epsde_pk
              JOIN ds_Patientrack_episode_WARD
                ON ds_Patientrack_OBSERVATION_SET.epsde_pk = ds_Patientrack_episode_WARD.epsde_pk
               AND ds_Patientrack_OBSERVATION_SET.obs_taken_dttm BETWEEN ds_Patientrack_episode_WARD.start_dttm AND IFNULL(ds_Patientrack_episode_WARD.end_dttm, GETDATE())
               AND ds_Patientrack_episode_WARD.deleted_flag = 0
              JOIN ds_Patientrack_EWS_REGIME_APPLICATION
                ON ds_Patientrack_OBSERVATION_SET.EWSAP_PK = ds_Patientrack_EWS_REGIME_APPLICATION.EWSAP_PK
              LEFT OUTER JOIN s_eVitals_regime_mod_reason
                ON ds_Patientrack_EWS_REGIME_APPLICATION.altpr_rfval = s_eVitals_regime_mod_reason.altpr_rfval
              LEFT OUTER JOIN s_eVitals_ward
                ON ds_Patientrack_episode_WARD.WARDD_RFVAL = s_eVitals_ward.ward_id
              JOIN ds_Patientrack_episode_RESPONSIBLE_CLINICIAN
                ON ds_Patientrack_episode_WARD.epsde_pk = ds_Patientrack_episode_RESPONSIBLE_CLINICIAN.epsde_pk
               AND ds_Patientrack_OBSERVATION_SET.obs_taken_dttm BETWEEN ds_Patientrack_episode_RESPONSIBLE_CLINICIAN.start_dttm AND IFNULL(ds_Patientrack_episode_RESPONSIBLE_CLINICIAN.end_dttm, GETDATE())
               AND ds_Patientrack_episode_RESPONSIBLE_CLINICIAN.deleted_flag = 0
              LEFT OUTER JOIN s_eVitals_specialty
                ON ds_Patientrack_episode_RESPONSIBLE_CLINICIAN.SPECT_RFVAL = s_eVitals_specialty.specialty_id
              LEFT OUTER JOIN dim.dim_patient
                ON dim_patient.patient_NHI = s_eVitals_patient.patient_NHI
               AND dim_patient.NHI_sequence = 1
              LEFT OUTER JOIN ds_Patientrack_OBSERVATION_DUE_TIME
                ON ds_Patientrack_OBSERVATION_DUE_TIME.OBDUT_OBSET_PK = ds_Patientrack_OBSERVATION_SET.OBSET_PK
               AND ds_Patientrack_OBSERVATION_DUE_TIME.deleted_flag = 0
              JOIN s_evitals_regime_parent
                ON s_evitals_regime_parent.EWSRG_PK = ds_Patientrack_EWS_REGIME_APPLICATION.EWSRG_PK
             WHERE ds_Patientrack_OBSERVATION_SET.current_obset_flag = 1
        name: S_EVITALS_OBSERVATION_SET_01
        noLinkRefs: []
  name: S_EVITALS_OBSERVATION_SET_01
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
