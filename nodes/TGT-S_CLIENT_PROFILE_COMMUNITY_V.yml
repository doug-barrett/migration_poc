fileVersion: 1
id: bd08e340-c243-4faa-895f-5085cf932eaf
name: S_CLIENT_PROFILE_COMMUNITY_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 612a1331-c81c-488b-9d1e-f678804940f7
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ad789b0-1af1-49e5-b06b-e698b88f786b
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7b76072f-3180-484b-8876-41ffb6d5f60b
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CONTACT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 89fd690f-ae8f-4934-8cd1-a7893c607815
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: ""
        name: PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1208f895-7868-40d1-b69e-60518eef185f
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0fc8febc-ab78-4b45-9c7d-d7601572c158
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9bc6297d-00ed-48bb-952b-24c3544e139e
                stepCounter: 289da868-88f5-4e61-a975-de3b30517956
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 96187864-e34b-4cc0-af91-a01cf0aff052
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9668f55c-c7a5-4a58-a248-a09453e77eaa
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 783e2f7d-3a25-445d-8760-bac00e61dbb5
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7429b49b-5a50-4d4f-8b41-111e183d6b02
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: DEPARTMENT_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 4db2446e-d0a8-4c95-9106-7c7a71172d00
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SERVICE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e542fba2-332a-4ebe-ace3-eac4f0c77b43
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(15)
        defaultValue: ""
        description: ""
        name: SEEN_BY_CLINICIAN_REFERENCE_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2b8f3a79-f117-4171-adef-1c933c0a05b5
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 893dd19a-092c-4e52-8b53-06e12bb68598
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5de1023-9916-4569-ad46-d203d6bd8b59
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 13e937d0-1c53-4f60-ac19-fd3a3770db5e
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EPISODE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a61b1e4e-250d-4353-8a0b-699237cac645
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dbccef97-684e-4ff8-ae69-bfe97f00f8e3
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_DUE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 289915c5-f796-42dc-bb9a-e3f1e600d747
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e062b704-8bee-4ebf-9f39-44e0732669e2
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 70c2cffe-e8ed-42a2-b76a-091f45433e39
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: CARE_COMPLEXITY_TOTAL_SCORE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a1266e8e-641b-49cd-b856-03d9c27cc64c
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATE
        defaultValue: ""
        description: Date score is to be reviewed
        name: REVIEW_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4320daae-e1ac-4138-92af-3202ebdad5c4
                stepCounter: 75174d9c-78ab-4e2d-b1fc-fa89ec3f8d67
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: bb4e5364-a705-45c8-84fa-e0e07ef701ba
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0f2e33ef-8ae5-4e28-9dbc-6e3089022f15
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: df48d19b-9ddd-4531-aa3f-89e52113cf6a
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CREATE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e11a0bad-b228-417a-b977-da23dcd925b4
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ab8b3a16-ecb8-4f48-ad60-d8ed9477a3e6
          stepCounter: bd08e340-c243-4faa-895f-5085cf932eaf
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CREATE_USER_LOGIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 005077ef-2f46-49d9-8c15-62f319935a6e
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT ds_cdsswe_task_request.taskrequest_id,
                   'CDS'+cast(ds_cdsswe_task_request.taskrequest_id AS varchar(20)) profile_encounter_id,
                   ds_cdsswe_patient_programme.patient_programme_id programme_id,
                   l_cdsswe_patient.NHI_number,
                   MAX(CASE WHEN LEFT (ds_cdsswe_task_request.stream_id,1) = '1' THEN 'R' + ds_cdsswe_task_request.stream_id ELSE ds_cdsswe_task_request.stream_id END) referral_encounter_id,
                   LEFT(MAX(l_cdsswe_programme_role.name),50) role_code,
                   LEFT(MAX(l_cdsswe_programme_dept.name),50) department_desc,
                   LEFT(MAX(l_cdsswe_programme_serv.name),50) service_desc,
                   MAX(ds_cdsswe_observation_report.provider_nzmc) seen_by_clinician_reference_no,
                   MAX(ds_cdsswe_task_request.request_date) task_request_date,
                   MAX(ds_cdsswe_patient_programme.episode_start_date) episode_start_date,
                   MAX(IFNULL(ds_cdsswe_observation_report.due_date,ds_cdsswe_task_request.due_date)) observation_report_due_date,
                   MAX(IFNULL(ds_cdsswe_atomic_observation.date_completed,ds_cdsswe_observation_report.date_completed)) observation_report_completion_date,
                   LEFT(MAX(CASE WHEN ds_cdsswe_atomic_observation.datatype_id = 4469703735080 THEN ds_cdsswe_atomic_observation.value ELSE NULL END),50) care_complexity_total_score,
                   LEFT(MAX(CASE WHEN ds_cdsswe_atomic_observation.datatype_id = 4462680096716 THEN ds_cdsswe_atomic_observation.value ELSE NULL END),50) review_date,
                   MAX(CASE WHEN ds_cdsswe_observation_report.observation_report_status = 'F' THEN 'Completed' WHEN ds_cdsswe_observation_report.observation_report_status = 'A' THEN 'Finalised' WHEN ds_cdsswe_observation_report.observation_report_status = 's' THEN 'In Progress' WHEN ds_cdsswe_observation_report.observation_report_status = 'X' THEN 'Declined' ELSE 'Current' END) observation_report_status,
                   MAX(ds_cdsswe_observation_report.created_date) create_date,
                   REPLACE(MAX(ds_cdsswe_observation_report.created_by),' null','') create_user_login_name
              FROM ds_cdsswe_Observation_Report
             INNER JOIN dbo.ds_cdsswe_task_request
                ON dbo.ds_cdsswe_task_request.taskrequest_id = ds_cdsswe_Observation_Report.taskrequest_id
               AND ds_cdsswe_task_request.record_status = 'A'
             INNER JOIN l_cdsswe_Task_Type
                ON l_cdsswe_Task_Type.tasktype_id = ds_cdsswe_task_request.tasktype_id
               AND l_cdsswe_Task_Type.task_type_class = 'Client Profile'
             INNER JOIN l_cdsswe_patient
                ON l_cdsswe_patient.patient_id = ds_cdsswe_task_request.patient_id
             INNER JOIN ds_cdsswe_patient_programme
                ON ds_cdsswe_patient_programme.patient_programme_id = ds_cdsswe_task_request.patient_programme_id
             INNER JOIN ds_cdsswe_patient_programme ppp
                ON ppp.patient_programme_id = ds_cdsswe_patient_programme.parent_patient_programme_id --  inner join l_cdsswe_patient_programme_provider
             -- on l_cdsswe_patient_programme_provider.patient_programme_id = ds_cdsswe_patient_programme.patient_programme_id
             --  AND l_cdsswe_patient_programme_provider.record_status = 'A'
             --  AND l_cdsswe_patient_programme_provider.sequence_num = '1'
             --inner join l_cdsswe_clinic c on c.clinic_id = l_cdsswe_patient_programme_provider.clinic_id
             --  AND c.record_status = 'A'
             --  AND c.clinic_type = 'CASETEAM'

             INNER JOIN l_cdsswe_programme l_cdsswe_programme_role
                ON l_cdsswe_programme_role.programme_id = ds_cdsswe_patient_programme.programme_id
             INNER JOIN l_cdsswe_programme l_cdsswe_programme_dept
                ON l_cdsswe_programme_dept.programme_id = l_cdsswe_programme_role.parent_programme_id
             INNER JOIN l_cdsswe_programme l_cdsswe_programme_serv
                ON l_cdsswe_programme_serv.programme_id = l_cdsswe_programme_dept.parent_programme_id --inner JOIN l_pims_health_organisations  health_organisations01
             --            ON  heorg_refno  =  external_clinic_id

             INNER JOIN ds_cdsswe_atomic_observation
                ON ds_cdsswe_atomic_observation.observation_report_id = ds_cdsswe_observation_report.observation_report_id
             WHERE 1=1
               AND ((ds_cdsswe_observation_report.date_completed >= '01-Jun-2004' AND ppp.programme_id = 1065050429394) OR (ds_cdsswe_observation_report.date_completed >= '01-APR-2005' AND ppp.programme_id IN (4424329646224,4424329754656)) OR (ds_cdsswe_observation_report.date_completed >= '01-Aug-2005' AND ppp.programme_id IN (4412557328748,4412557403496,4412557439684,4412557533060,4412557487684)) OR (ds_cdsswe_observation_report.date_completed >= '01-Jul-2006' AND ppp.programme_id = (1087533071110)) OR (ds_cdsswe_observation_report.date_completed >= '01-Sep-2004' AND ppp.programme_id = 1065050139306) OR (ds_cdsswe_observation_report.date_completed >= '01-Jul-2011' AND ppp.programme_id = 5235128062548) OR (ds_cdsswe_observation_report.date_completed >= '01-Jul-2011' AND ppp.programme_id = 5610091156464) OR (ds_cdsswe_observation_report.date_completed >= '01-Jul-2011' AND ppp.programme_id = 5832026576332) OR (ds_cdsswe_observation_report.date_completed >= '01-Jul-2011' AND ppp.programme_id = 5786341435716))
               AND ds_cdsswe_Observation_Report.record_status = 'A'
               AND ds_cdsswe_Observation_Report.observation_report_status = 'F'
             GROUP BY ds_cdsswe_task_request.taskrequest_id,
                      ds_cdsswe_task_request.tasktype_id ,
                      ds_cdsswe_patient_programme.patient_programme_id ,
                      l_cdsswe_patient.NHI_number
            HAVING LEFT(MAX(CASE WHEN ds_cdsswe_atomic_observation.datatype_id = 4469703735080 THEN ds_cdsswe_atomic_observation.value ELSE NULL END),50) IS NOT NULL
        dependencies:
          - locationName: TGT
            nodeName: DS_CDSSWE_TASK_REQUEST
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','DS_CDSSWE_TASK_REQUEST') }}
        name: S_CLIENT_PROFILE_COMMUNITY_V
        noLinkRefs: []
  name: S_CLIENT_PROFILE_COMMUNITY_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
