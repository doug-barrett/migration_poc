fileVersion: 1
id: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
name: VW_BUDGETCONTRACTID
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: REPORTS
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a5d1cd41-3033-4f05-b73b-6d175cae4685
          stepCounter: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: CONTRACTID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 472bf41c-b89a-4b98-b3e9-96f7aae24932
          stepCounter: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
        config: {}
        dataType: DATE
        defaultValue: ""
        description: ""
        name: BUDGETDATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cc3b1e0e-a61c-44c5-8467-f637450fb38c
          stepCounter: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETSALESAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9231c750-ebb4-42a6-bfef-db5ab5ba7be8
          stepCounter: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
        config: {}
        dataType: DECIMAL(18,2)
        defaultValue: ""
        description: ""
        name: BUDGETREVENUEAMOUNT
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 11799edc-682e-4a11-801c-dafb6a45f801
          stepCounter: 477ce4f9-5005-49e7-9f8f-54a7f1bf768a
        config: {}
        dataType: VARCHAR
        defaultValue: ""
        description: ""
        name: BUDGETTYPE
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            --------------------------------------------------------------------------------------------------------------------------
            \N--GET AMOUNTS TO USE BY 2019 BUDGET DATE
            \N--------------------------------------------------------------------------------------------------------------------------
            \N \NWITH CTEREPORTSSALESANDREVENUE \N AS (
                    SELECT \N ISNULL([SAR].[TERRITORYDIVISIONID], CASE--THIS CASE STATEMENT IS USED TO ASSIGN CORRECT DIVISION NAME WHEN TERRITORY ASSIGNMENT IS NULL DUE TO DATA OR HIERARCHY ISSUES
            \N WHEN [SAR].[ORGANIZATIONID] IN(1, 5, 6) THEN 1--PUBLIC
            \N WHEN [SAR].[ORGANIZATIONID] IN(2, 3, 4, 7) THEN 2--PRIVATE
            \N ELSE 1 \N END) AS [TERRITORYDIVISIONID], \N [SAR].[RECEIPTDATE], \N [SAR].[SALES], \N [SAR].[REVENUE], \N [SAR].[RECEIPTDATEKEY], \N [SAR].[CONTRACTID] \N
                      FROM [REPORTS].[SALESANDREVENUE] AS [SAR] \N
                     WHERE [SAR].[RECEIPTDATEKEY] BETWEEN 20190101 AND 20191231 -- ACTUALS FOR Q1-Q4 2019
            \N
                   ), \N CTETOTALSALESREVENUE --GET ACTUALS FOR MONTHS CLOSED IN 2019
            \N AS (
                    SELECT \N [SAR].[CONTRACTID], \N [SAR].[RECEIPTDATE], \N CASE YEAR([SAR].[RECEIPTDATE]) \N
                                WHEN 2018                    THEN DATEADD([YY], 1, [SAR].[RECEIPTDATE]) \N
                                ELSE [SAR].[RECEIPTDATE] \N
                                 END AS [BUDGETDATE], \N SUM([SAR].[SALES]) AS [TOTALSALES], \N SUM([SAR].[REVENUE]) AS [TOTALREVENUE] \N
                      FROM [CTEREPORTSSALESANDREVENUE] AS [SAR] \N
                     WHERE [SAR].[TERRITORYDIVISIONID] IN (1, 2) \N
                     GROUP BY \N [SAR].[CONTRACTID], \N [SAR].[RECEIPTDATE]
                   ) \N --SELECT BUDGETDATE, SUM([TOTALREVENUE]) FROM CTETOTALSALESREVENUE AS [CTBR] GROUP BY BUDGETDATE ORDER BY [CTBR].[BUDGETDATE]
            \N , \N [CTETOTALBUDGETREVENUE] --GET BUDGET VALUES FOR 2019
            \N AS (
                    SELECT \N [BD].[CONTRACTID], \N [B].[BUDGETDATE], \N SUM([B].[BUDGETSALESAMOUNT] * [TBG].[ADJUSTMENT]) AS [BUDGETSALESAMOUNT], \N SUM([B].[BUDGETREVENUEAMOUNT] * [TBG].[ADJUSTMENT]) AS [BUDGETREVENUEAMOUNT] \N
                      FROM [FACT].[BUDGET] AS [B] \N
                      LEFT OUTER JOIN [DIM].[BUDGETDETAIL] AS [BD]
                        ON [B].[BUDGETDETAILKEY] = [BD].[BUDGETDETAILKEY] \N
                      LEFT OUTER JOIN [DIM].[SALESTERRITORY_2019] AS [ST]
                        ON [B].[SALESTERRITORYKEY] = [ST].[SALESTERRITORY_2019KEY] \N
                      LEFT OUTER JOIN [DIM].[TERRITORYBUDGETGROWTH] AS [TBG]
                        ON [B].[BUDGETDATE] = [TBG].[BUDGETDATE] \N
                       AND [ST].[TERRITORYDIVISIONID] = [TBG].[TERRITORYDIVISIONID] \N
                     WHERE [B].[BUDGETDATEKEY] BETWEEN 20191001 AND 20191231 \N --AND [ST].[TERRITORYDIVISIONID] IN (1, 2)
            \N
                     GROUP BY \N [BD].[CONTRACTID], \N [B].[BUDGETDATE]
                   ) \N --SELECT BUDGETDATE, SUM([BUDGETREVENUEAMOUNT]) FROM [CTETOTALBUDGETREVENUE] AS [CTBR] GROUP BY BUDGETDATE ORDER BY [CTBR].[BUDGETDATE]
            \N , \N CTEMASTERBUDGETBYBUDGETDATE \N AS (
                    SELECT \N ISNULL([CTBR].[CONTRACTID], [CTSR].[CONTRACTID]) AS [CONTRACTID], \N ISNULL([CTBR].[BUDGETDATE], [CTSR].[BUDGETDATE]) AS [BUDGETDATE], \N [CTSR].[TOTALSALES] AS [BUDGETSALESAMOUNT], \N [CTSR].[TOTALREVENUE] AS [BUDGETREVENUEAMOUNT] \N
                      FROM [CTETOTALBUDGETREVENUE] AS [CTBR] \N
                      FULL OUTER JOIN [CTETOTALSALESREVENUE] AS [CTSR]
                        ON [CTBR].[BUDGETDATE] = [CTSR].[BUDGETDATE] \N
                       AND [CTBR].[CONTRACTID] = [CTSR].[CONTRACTID] \N --ORDER BY [CTBR].[BUDGETDATE]
            \N
                   ) \N --SELECT BUDGETDATE, SUM([CMBBBD].[BUDGETREVENUEAMOUNT]) FROM [CTEMASTERBUDGETBYBUDGETDATE] AS [CMBBBD] GROUP BY BUDGETDATE ORDER BY [CMBBBD].[BUDGETDATE]--, [CONTRACTID]
            \N , \N --------------------------------------------------------------------------------------------------------------------
            \N CTECONTRACTIDBUDGET_2019 \N AS (
                    SELECT --2019 BUDGET BY CONTRACTID
            \N [CLB].[CONTRACTID], \N [CLB].[BUDGETDATE], \N [CLB].[BUDGETSALESAMOUNT], \N [CLB].[BUDGETREVENUEAMOUNT], \N CASE \N
                                WHEN [C].[SOURCEENTITYNAME] = 'INSIGHT GPO' THEN CAST('PD BUDGET - ISG' AS VARCHAR(20)) \N
                                ELSE CAST('PD BUDGET' AS VARCHAR(20)) \N
                                 END AS [BUDGETTYPE] \N
                      FROM [CTEMASTERBUDGETBYBUDGETDATE] AS [CLB] \N
                      LEFT OUTER JOIN [DIM].[CONTRACT] AS [C]
                        ON [CLB].[CONTRACTID] = [C].[CONTRACTID]
                   ) \N --SELECT * FROM CTECONTRACTIDBUDGET_2019 WHERE CONTRACTID = '2014'
            \N --------------------------------------------------------------------------------------------------------------------
            \N , \N CTECONTRACTIDBUDGET_2020 \N AS (
                    SELECT --2020 BUDGET BY CONTRACTID
            \N [CLB].[CONTRACTID], \N [CLB].[BUDGETDATE], \N [CLB].[BUDGETSALESAMOUNT], \N [CLB].[BUDGETREVENUEAMOUNT], \N [CLB].[BUDGETTYPE] \N
                      FROM [FACT].[REVENUEBUDGET] AS [CLB] \N
                     WHERE [CLB].[BUDGETDATEKEY] BETWEEN 20200101 AND 20201231 \N
                       AND [CLB].[BUDGETTYPE] LIKE 'PD BUDGET%'
                   ) \N --SELECT YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE], SUM([CFB].[BUDGETREVENUEAMOUNT]) FROM CTECONTRACTIDBUDGET_2020 AS [CFB] GROUP BY YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE] ORDER BY YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE]
            \N --SELECT YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE], SUM([CFB].[BUDGETREVENUEAMOUNT]) FROM [REPORTS].[VWBUDGETCONTRACTID_ISG] AS [CFB] GROUP BY YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE] ORDER BY YEAR([CFB].[BUDGETDATE]), [CFB].[BUDGETTYPE]
            \N SELECT \N [CLB].[CONTRACTID], \N [CLB].[BUDGETDATE], \N [CLB].[BUDGETSALESAMOUNT], \N [CLB].[BUDGETREVENUEAMOUNT], \N [CLB].[BUDGETTYPE] \N
              FROM [CTECONTRACTIDBUDGET_2019] AS [CLB] \N
             UNION \N SELECT \N [CLB].[CONTRACTID], \N [CLB].[BUDGETDATE], \N [CLB].[BUDGETSALESAMOUNT], \N [CLB].[BUDGETREVENUEAMOUNT], \N [CLB].[BUDGETTYPE] \N
              FROM [CTECONTRACTIDBUDGET_2020] AS [CLB] \N --UNION
            \N --SELECT
            \N --	[CLB].[CONTRACTID],
            \N --	[CLB].[BUDGETDATE],
            \N --	[CLB].[BUDGETSALESAMOUNT],
            \N --	[CLB].[BUDGETREVENUEAMOUNT],
            \N --	[CLB].[BUDGETTYPE]
            \N --FROM   [REPORTS].[VWBUDGETCONTRACTID_ISG] AS [CLB]
        dependencies: []
        join:
          joinCondition: '-- Nodes used in the SQL override:'
        name: VWBUDGETCONTRACTID
        noLinkRefs: []
  name: VW_BUDGETCONTRACTID
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
