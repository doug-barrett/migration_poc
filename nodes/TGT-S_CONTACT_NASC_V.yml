fileVersion: 1
id: d4a22a0b-786e-4106-aa07-f295fc7ed871
name: S_CONTACT_NASC_V
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  customOverride: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: cfee6812-da7d-4aea-a386-10bfc40f8436
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: CONTACT_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f0db8913-ab57-4e35-a72c-40b372863f20
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0ad789b0-1af1-49e5-b06b-e698b88f786b
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8fa45120-ad09-4982-ae7d-28a8865b9df4
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: BIGINT
        defaultValue: ""
        description: patient_programme_id
        name: PROGRAMME_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1dc01ac2-a10c-49ca-90eb-ed32df22cd74
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f65e0d45-4599-4ed2-8eec-ae39fb8fdc69
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(10)
        defaultValue: ""
        description: ""
        name: PATIENT_NHI
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9bc6297d-00ed-48bb-952b-24c3544e139e
                stepCounter: 289da868-88f5-4e61-a975-de3b30517956
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e3c082be-995a-4142-8040-0d8579b99674
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: patient_programme_status
        name: PROGRAMME_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 68ae7343-6636-410f-8f54-d96cc55f2e09
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3afe3921-a022-4b03-9691-5cc3644f57b4
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: TASK_DESC
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e5353c2d-4a44-4e11-bc07-37f02a977a35
                stepCounter: 447055e4-f68c-4b9d-a35b-74f5502fcef1
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e2c80c85-c6c4-48a5-8446-83325e3a7c27
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: HEALTH_ORG_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c12f6696-6dfb-413d-a9e0-108fd7fdb031
                stepCounter: 05ed0e9e-67ad-49bf-b299-f8f341d6b3c4
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a226e4e-4bcf-4dff-b127-671a6c3e4546
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(30)
        defaultValue: ""
        description: ""
        name: SEEN_BY_CLINICIAN_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2b8f3a79-f117-4171-adef-1c933c0a05b5
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a2934a24-4ffa-439d-b1f3-8dd8b6667626
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: REFERRAL_ENCOUNTER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 9668f55c-c7a5-4a58-a248-a09453e77eaa
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d77d841d-c5a8-428e-88fd-3449f65703c2
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(4)
        defaultValue: ""
        description: ""
        name: HOSPITAL_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 980489a9-a2f2-4899-b808-e20222682081
                stepCounter: 0790fdf4-e815-4587-a9cd-954ea13f53c6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 46c120e4-e947-401d-a044-5ab4e1c04434
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: INTEGER
        defaultValue: ""
        description: ""
        name: PROVIDER_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b64f71a4-6818-4fe2-8f71-79ea2097bd8d
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 63081a2e-e215-4456-8efe-8e927e15822f
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: PROVIDER_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e54c5b96-c200-4dd7-85cc-9dc969de2264
                stepCounter: 2a628fe0-7fea-4e78-95b1-e7104461d775
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2172284c-b110-4d54-a8c4-e1a92d7dc5d9
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: PROGRAMME_ROLE_CODE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 838c75fc-c707-4a99-bdf8-247313f1b01f
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: DEPARTMENT_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: d63ab329-ade7-4cd5-8aa9-caf5a903fe66
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: SERVICE_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c5bc6ca3-f93b-4315-b490-d88cb1767760
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: TASK_REQUEST_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: b5de1023-9916-4569-ad46-d203d6bd8b59
                stepCounter: 7b4c3eab-6eaf-440f-890b-2660daed8357
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: deea5b51-907d-4cb4-94cf-1a9975a05eab
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: EPISODE_START_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: a61b1e4e-250d-4353-8a0b-699237cac645
                stepCounter: 2ecdd3a6-b52d-4166-90dd-2155a6b785ca
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ad4b56bb-1176-47e2-a1c3-11e9a4e9bf01
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_DUE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 00375d4d-ac65-428c-a6ed-107ee136ee44
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 632f612b-f150-4801-87ac-a5c1357a9f3d
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_COMPLETION_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e062b704-8bee-4ebf-9f39-44e0732669e2
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f7951fb9-e196-459d-a23a-217662154627
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: OBSERVATION_REPORT_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0f2e33ef-8ae5-4e28-9dbc-6e3089022f15
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 770045cc-594f-4173-b421-40279256c697
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: DATETIME
        defaultValue: ""
        description: ""
        name: CREATE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e11a0bad-b228-417a-b977-da23dcd925b4
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 42c2e00c-b39e-42f0-b623-96fdb8a587ef
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(50)
        defaultValue: ""
        description: ""
        name: CREATE_USER_LOGIN_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 005077ef-2f46-49d9-8c15-62f319935a6e
                stepCounter: 118925c3-58c5-4511-b154-1b1a31b2082e
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ce4903fd-df31-4ffa-bb14-8bb38394d2f3
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(25)
        defaultValue: ""
        description: purchase_unit_code
        name: PURCHASE_UNIT_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: e9fd7e1f-f36b-4e20-a8a5-df3a52756bcb
                stepCounter: 28a98c68-b40c-4589-8655-892bf11924b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c95d3075-4a44-434e-8bf7-4c5fb70936d2
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: VARCHAR(20)
        defaultValue: ""
        description: ""
        name: RESPONSIBILITY_CENTRE_CODE
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 39e298b2-3462-41f2-a0d3-c09c3ff99c02
                stepCounter: 28a98c68-b40c-4589-8655-892bf11924b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 47b2a132-634d-4728-a864-6cdb618e6e97
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: INT
        defaultValue: ""
        description: only brought into stage tables to help with mapping issues
        name: PUCMAP_ID
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1ee97c3b-6c60-4d5c-8991-eeede6907a34
                stepCounter: 28a98c68-b40c-4589-8655-892bf11924b6
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: aa56b29e-1d00-4112-ac90-54d1ed75f5be
          stepCounter: d4a22a0b-786e-4106-aa07-f295fc7ed871
        config: {}
        dataType: INT
        defaultValue: ""
        description: ""
        name: DEFAULT_PURCHASE_UNIT_VOLUME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ab8237a1-ea38-4597-86d4-f99b2a1b2a7c
                stepCounter: 28a98c68-b40c-4589-8655-892bf11924b6
            transform: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('SQL Override') }}
            SELECT 'NA'+SUBSTRING(CONVERT(varchar,10000000000+tr.taskrequest_id),2,10) contact_encounter_id,
                   tr.taskrequest_id task_request_id,
                   pp.patient_programme_id programme_id,
                   pt.NHI_number patient_NHI,
                   MAX(pp.patient_programme_status) programme_status,
                   LEFT(MAX(tt.display_name),30) task_desc,
                   MAX(cl.external_clinic_id) health_org_id,
                   MAX(ob.provider_nzmc) seen_by_clinician_id,
                   MAX(CASE WHEN LEFT (tr.stream_id,1) = '1' THEN 'R' + tr.stream_id ELSE tr.stream_id END) referral_encounter_id,
                   MAX(CASE WHEN og.health_org_desc LIKE '%West%' THEN '3216' ELSE '3215' END) hospital_id,
                   MAX(pr.provider_id) provider_id,
                   MAX(pr.provider_role_code) provider_role_code,
                   LEFT(MAX(rl.name),50) programme_role_code,
                   LEFT(MAX(dp.name),50) department_desc,
                   LEFT(MAX(sv.name),50) service_desc,
                   MAX(tr.request_date) task_request_date,
                   MAX(pp.episode_start_date) episode_start_date,
                   MAX(IFNULL(ob.due_date,tr.due_date)) observation_report_due_date,
                   MAX(ob.date_completed) observation_report_completion_date,
                   MAX(CASE WHEN ob.observation_report_status ='A' THEN 'Finalised' WHEN ob.observation_report_status ='F' THEN 'Completed' WHEN ob.observation_report_status ='S' THEN 'In Progress' WHEN ob.observation_report_status ='X' THEN 'Declined' ELSE 'Current' END) observation_report_status,
                   MAX(ob.created_date) create_date,
                   REPLACE(MAX(ob.created_by),' null','') create_user_login_name,
                   Purchaseunit AS purchase_unit_code,
                   puc.Responsibility_centre AS responsibility_centre_code,
                   puc.rowid AS pucmap_id,
                   puc.default_purchase_unit_volume
              FROM ds_cdsswe_task_request tr
             INNER JOIN l_cdsswe_Task_Type tt
                ON tr.tasktype_id = tt.tasktype_id
               AND tt.name IN ('Needs Assessment','Support Plan','Review')
             INNER JOIN ds_cdsswe_patient_programme pp
                ON tr.patient_programme_id = pp.patient_programme_id
             INNER JOIN l_cdsswe_programme rl
                ON rl.programme_id = pp.programme_id --AND rl.programme_id = 4452666405396  --'Needs Assessors in NASC'

             INNER JOIN l_cdsswe_patient pt
                ON pp.patient_id = pt.patient_id
             INNER JOIN ds_cdsswe_observation_report ob
                ON tr.taskrequest_id = ob.taskrequest_id
               AND ob.record_status = 'A'
               AND ob.observation_report_status IN ('F')
              LEFT OUTER JOIN l_cdsswe_Patient_Programme_Provider pr
                ON pr.patient_programme_id = pp.patient_programme_id
               AND pr.record_status = 'A'
               AND pr.sequence_num = '1'
              LEFT OUTER JOIN l_cdsswe_clinic cl
                ON pr.clinic_id = cl.clinic_id
               AND cl.record_status = 'A'
               AND cl.clinic_type = 'CASETEAM'
              LEFT OUTER JOIN dim.dim_health_organisation og
                ON convert(int,Left(cl.external_clinic_id,10)) = og.health_org_reference_no
              LEFT OUTER JOIN l_cdsswe_programme dp
                ON dp.programme_id = rl.parent_programme_id
              LEFT OUTER JOIN l_cdsswe_programme sv
                ON sv.programme_id = dp.parent_programme_id
              LEFT OUTER JOIN [dbo].[l_mappings_PurchaseUnit_NASC_Contacts] puc
                ON LEFT(tt.display_name,30) = puc.Task_Type
               AND ob.date_completed BETWEEN puc.Start_date AND IFNULL(puc.end_date,dateadd(DAY,100,getdate()))
             GROUP BY tr.taskrequest_id,
                      pt.NHI_number,
                      pp.patient_programme_id,
                      Purchaseunit,
                      puc.Responsibility_centre,
                      puc.rowid,
                      puc.default_purchase_unit_volume
        dependencies:
          - locationName: TGT
            nodeName: DS_CDSSWE_TASK_REQUEST
        join:
          joinCondition: |-
            -- Nodes used in the SQL override:
            {{ ref('TGT','DS_CDSSWE_TASK_REQUEST') }}
        name: S_CONTACT_NASC_V
        noLinkRefs: []
  name: S_CONTACT_NASC_V
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
